<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GRAMMAR</title>
  <style>
    :root{
      --brand: #4CAF50;
      --bg: #f0f0f0;
      --panel: #ffffff;
      --text: #333;
      --border: #e5e5e5;
      --highlight: #fff7a8;
      --shadow: 0 2px 5px rgba(0,0,0,.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background-color: var(--bg);
      background-image: url('../../../../../imagens/fundo.png');
      background-repeat: repeat;
      background-size: auto;
      height: 100vh;
      overflow: hidden;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 16px;
      height: 100vh;
      padding: 16px;
    }
    .content-shell {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    .content-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--brand);
      color: #fff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .content-header h1 { margin: 0; font-size: 1.1rem; letter-spacing: .5px; }
    .button-row { display: none; }
    .btn {
      background-color: #fff;
      color: var(--brand);
      border: 2px solid #fff;
      padding: 6px 10px;
      font-size: .95rem;
      cursor: pointer;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .15s ease;
    }
    .btn:hover { filter: brightness(0.95); }
    .btn-outline {
      background: transparent;
      color: var(--brand) !important;
      border-color: var(--brand) !important;
    }
    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      background-color: #fff;
    }
    h2 { font-size: 1.25rem; color: #555; margin: 0 0 6px; }
    p { font-size: 1rem; line-height: 1.6; margin: 0 0 10px; }
    .spacer { margin: 20px 0; border-top: 2px solid var(--brand); width: 100%; height: 2px; }
    .content-wrapper img { max-width: 100%; display: block; margin: 10px auto; }
    .table-row { display: flex; margin: 4px 0; }
    .table-row .cell { flex: 1; padding: 6px 10px; border: 1px solid #ccc; box-sizing: border-box; background: #fafafa; }
    .table-row .cell:not(:last-child) { border-right: none; }
    .highlight { background-color: var(--highlight) !important; border-radius: 6px; }

    .teacher-panel {
      position: sticky;
      top: 16px;
      align-self: start;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: fit-content;
      max-height: calc(100vh - 32px);
    }
    .teacher-header { display: flex; align-items: center; gap: 10px; justify-content: space-between; }
    .teacher-title { display: flex; align-items: center; gap: 10px; }
    .teacher-title h2 { margin: 0; font-size: 1.1rem; color: #222; }
    .robot-wrap { width: 100%; display: grid; place-items: center; padding: 8px 0; }
    .robot-wrap img { width: 240px; height: auto; display: block; border-radius: 12px; }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #eef8ef;
      color: #1b5e20;
      border: 1px solid #cfe8d1;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .9rem;
      width: fit-content;
    }
    .control-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .tiny { font-size: .82rem; color: #666; }
    .btn:focus { outline: 2px solid #1111; outline-offset: 2px; }
    .btn-muted { background-color: #ffe8e8; border-color: #ffc9c9 !important; color: #c62828 !important; }

    @media (max-width: 768px) {
      .layout { display: block; padding: 0; }
      .teacher-panel {
        position: fixed; top: 0; left: 0; right: 0;
        border-radius: 0 0 16px 16px; z-index: 1000; max-height: none;
        box-shadow: 0 4px 12px rgba(0,0,0,.18);
      }
      .robot-wrap img { width: 180px; }
      .content-shell { margin: 0; border-radius: 0; border-left: none; border-right: none; border-bottom: none;
        height: 100vh; display: flex; flex-direction: column; }
      .content-header { border-radius: 0; padding: 10px 12px; }
      .content-wrapper { padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ESQUERDA -->
    <section class="content-shell">
      <div class="content-header">
        <h1>GRAMMAR</h1>
        <div class="button-row"></div>
      </div>
      <div class="content-wrapper" id="contentWrapper">
        <div id="content"></div>
      </div>
    </section>

    <!-- DIREITA -->
    <aside class="teacher-panel" aria-label="Professor Robô" id="teacherPanel">
      <div class="teacher-header">
        <div class="teacher-title">
          <span style="display:inline-flex;width:10px;height:10px;background:var(--brand);border-radius:50%;"></span>
          <h2>Professor Samuel</h2>
        </div>
        <button class="btn btn-outline" id="exitBtn" onclick="exitLesson()" aria-label="Sair">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
            <path d="M6 2a1 1 0 0 0-1 1v2h2V4h6v8H7v-1H5v2a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H6z"/>
            <path d="M.146 8.354a.5.5 0 0 1 0-.708L3.793 3.999 4.5 4.706 1.707 7.5H10v1H1.707L4.5 11.293l-.707.707L.146 8.354z"/>
          </svg>
          <span id="exitLabel">Sair</span>
        </button>
      </div>

      <div class="robot-wrap">
        <img id="robotImage" src="../../../../../imagens/robo1_staticcopy.png" alt="Robô Professor Samuel">
      </div>

      <div class="status-badge" id="statusBadge" aria-live="polite">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/>
        </svg>
        Ready to start
      </div>

      <div class="control-row">
        <button class="btn" onclick="toggleLesson()" aria-label="Iniciar ou pausar a lição (painel)">
          <span id="panelPlayIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
              <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
            </svg>
          </span>
          <span id="panelPlayLabel">Start Lesson</span>
        </button>

        <button class="btn" id="muteBtn" onclick="toggleMute()" aria-label="Silenciar/Ativar som">
          <span id="muteIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
              <path d="M11.536 14.01a.75.75 0 0 1-1.06-1.06A5.5 5.5 0 0 0 10.5 3.05a.75.75 0 1 1 1.06-1.06 7 7 0 0 1-.024 12.02z"/>
              <path d="M8.717 3.55A.75.75 0 0 1 9 4.19v7.62a.75.75 0 0 1-1.204.6L5.5 10.75H3A1.5 1.5 0 0 1 1.5 9.25v-2.5A1.5 1.5 0 0 1 3 5.25h2.5l2.296-1.66a.75.75 0 0 1 .921-.04z"/>
            </svg>
          </span>
          <span id="muteLabel">Mute</span>
        </button>
      </div>

      <div class="tiny" id="hintText">
        Hint: tap any line to play from that point.
      </div>
    </aside>
  </div>

  <script>
    /* =========================================================
       AVATARES (Samuel + Hannah)
       ========================================================= */
    const ROBOT = {
      talk:  '../../../../../imagens/robo1copy.gif',
      static: '../../../../../imagens/robo1_staticcopy.png',
      idle:  '../../../../../imagens/robo2.gif'
    };

    // Hannah com os seus 3 arquivos
    const HANNAH = {
      talk:  '../../../../../imagens/hannah_talk.gif',
      static:'../../../../../imagens/hannah_static.png',
      idle:  '../../../../../imagens/hannah_idle.gif'
    };

    const IDLE_DELAY_MS = 10000;
    let robotState = 'static';
    let idleTimer;

    // Quem está "no palco": 'samuel' (inglês) ou 'hannah' (outras línguas)
    let currentActor = 'samuel';

    (function preloadAvatars(){
      [ROBOT.talk, ROBOT.static, ROBOT.idle,
       HANNAH.talk, HANNAH.static, HANNAH.idle]
       .forEach(src => { const i=new Image(); i.src=src; });
    })();

    function actorPack(){ return currentActor === 'samuel' ? ROBOT : HANNAH; }

    function setActorByLang(lang){
      currentActor = (lang === 'en-US') ? 'samuel' : 'hannah';
      const titleEl = document.querySelector('.teacher-title h2');
      if (titleEl) titleEl.textContent = (currentActor === 'samuel') ? 'Professor Samuel' : 'Hannah';
      const img = document.getElementById('robotImage');
      if (img) img.alt = (currentActor === 'samuel') ? 'Robô Professor Samuel' : 'Hannah';
    }

    function setAvatar(state){
      if (state === robotState) return;
      robotState = state;
      const img = document.getElementById('robotImage');
      const pack = actorPack();
      if (img) img.src = pack[state] || pack.talk;
    }

    function goIdleSoon(ms = IDLE_DELAY_MS){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        if (audio.paused && !isPlaying){
          setAvatar('idle');
        }
      }, ms);
    }

    /* =========================================================
       TRADUÇÕES
       ========================================================= */
    const SUPPORTED_STUDENT_LANGS = ['pt-BR','th','my','km','zh-CN'];
    const T = {
      'en-US': { ready:'Ready to start', explaining:'Samuel is explaining', start:'Start Lesson', pause:'Pause Lesson', repeat:'Repeat', hint:'Hint: tap any line to play from that point.', mute:'Mute', unmute:'Unmute', exit:'Exit' },
      'pt-BR': { ready:'Pronto para iniciar', explaining:'Samuel está explicando', start:'Iniciar aula', pause:'Pausar aula', repeat:'Repetir', hint:'Dica: toque em qualquer linha do texto para ouvir a partir daquele ponto.', mute:'Silenciar', unmute:'Ativar som', exit:'Sair' },
      'th':    { ready:'พร้อมเริ่ม', explaining:'ซามูเอลกำลังอธิบาย', start:'เริ่มบทเรียน', pause:'หยุดชั่วคราว', repeat:'เล่นซ้ำ', hint:'เคล็ดลับ: แตะบรรทัดใดก็ได้เพื่อเริ่มเล่นจากส่วนนั้น', mute:'ปิดเสียง', unmute:'เปิดเสียง', exit:'ออก' },
      'my':    { ready:'စတင်ရန်အဆင်သင့်', explaining:'ဆမ်မြူးအယ်လ် ဆက်သွယ်ရှင်းလင်းနေသည်', start:'သင်ခန်းစာ စတင်မည်', pause:'ခဏရပ်မည်', repeat:'ထပ်မံဖတ်ပြ', hint:'အကြံပြုချက် - မည်သည့် စာကြောင်းမဆို ကိုထိနှိပ်ပြီး ထိုနေရာမှ စတင်နားထောင်နိုင်သည်', mute:'အသံပိတ်', unmute:'အသံဖွင့်', exit:'ထွက်မည်' },
      'km':    { ready:'រួចរាល់ដើម្បីចាប់ផ្តើម', explaining:'សាំយូអែលកំពុងអធិប្បាយ', start:'ចាប់ផ្តើមមេរៀន', pause:'ផ្អាក', repeat:'ធ្វើម្ដងទៀត', hint:'គន្លឹះ៖ ចុចលើបន្ទាត់ណាមួយ ដើម្បីចាប់ផ្តើមពីចំណុចនោះ។', mute:'បិទសំឡេង', unmute:'បើកសំឡេង', exit:'ចាកចេញ' },
      'zh-CN': { ready:'准备开始', explaining:'Samuel 正在讲解', start:'开始课程', pause:'暂停课程', repeat:'再听一遍', hint:'提示：点击任意一行，从该处开始播放。', mute:'静音', unmute:'取消静音', exit:'退出' },
    };
    function t(key){ const pack=T[studentLang]||T['pt-BR']; return (pack&&pack[key])||T['pt-BR'][key]||key; }

    /* =========================================================
       ESTADO / UTIL
       ========================================================= */
    function getURLParam(name){ const p=new URLSearchParams(window.location.search); return p.get(name)||''; }

    let texts = [];         // [{id,type,lang,text,el}]
    let isPlaying = false;
    let currentIndex = 0;
    let pauseTimeout;
    let studentLang = 'pt-BR';
    let isMuted = false;

    // Áudio HTML5 (no lugar de SpeechSynthesis)
    const audio = new Audio();
    audio.preload = 'auto';
    audio.addEventListener('ended', () => { /* controlado em speakEntry */ });
    function setVolumeFromMute(){ audio.volume = isMuted ? 0 : 1; }

    /* =========================================================
       MANIFEST & RESOLUÇÃO DE ÁUDIO
       ========================================================= */
    let manifest = null;
    let manifestItems = [];
    let lessonDir = '';
    let audioBase = '';

    function basename(p){ return p.split('/').pop().split('\\').pop(); }

    function findAudioFor(text, lang){
      if (!manifestItems.length || !text) return null;
      const tnorm = (text||'').trim();
      let item = manifestItems.find(i => (i.text||'').trim() === tnorm && i.lang === lang);
      if (!item) {
        item = manifestItems.find(i => (i.text||'').trim() === tnorm);
      }
      if (!item) return null;

      if (item.file) {
        const localUrl = `${audioBase}/${item.file}`;
        return { url: localUrl, lang: item.lang, hash: null, fallbackUrl: '' };
      }
      if (item.hash) {
        const localUrl = `${audioBase}/${(item.lang || '').toLowerCase()}-${item.hash}.mp3`;
        return { url: localUrl, lang: item.lang, hash: item.hash, fallbackUrl: item.url || '' };
      }
      return { url: item.url || '', lang: item.lang, hash: null, fallbackUrl: '' };
    }

    /* =========================================================
       UI labels
       ========================================================= */
    function applyUITranslations() {
      const status      = document.getElementById('statusBadge');
      const panelIcon   = document.getElementById('panelPlayIcon');
      const panelLabel  = document.getElementById('panelPlayLabel');
      const muteLabel   = document.getElementById('muteLabel');
      const hintText    = document.getElementById('hintText');

      status.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
             viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg>
        ${t('ready')}
      `;
      const svgPlay = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
             viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
          <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
        </svg>`;
      panelIcon.innerHTML = svgPlay;
      panelLabel.textContent = t('start');
      document.getElementById('exitLabel').textContent = t('exit');
      muteLabel.textContent = t('mute');
      hintText.textContent = t('hint');
    }

    /* =========================================================
       Carregar lesson + manifest
       ========================================================= */
    async function loadTextFile() {
      const lessonPath = getURLParam('lessonPath') || 'lesson.txt';
      const parts = lessonPath.split('/');
      lessonDir = parts.slice(0, -1).join('/');
      audioBase = `${lessonDir}/audio`;

      try {
        const resp = await fetch(lessonPath);
        if (!resp.ok) { alert('Não foi possível carregar a lição.'); return; }
        const data = await resp.text();

        try {
          const mres = await fetch(`${audioBase}/manifest.json`);
          if (mres.ok) {
            manifest = await mres.json();
            manifestItems = Array.isArray(manifest.items) ? manifest.items : [];
          } else {
            console.warn('manifest.json não encontrado em', `${audioBase}/manifest.json`);
          }
        } catch (e) {
          console.warn('Falha ao ler manifest.json:', e);
        }

        const rawLines = data.split('\n');
        studentLang = detectStudentLangFromLines(rawLines);

        applyUITranslations();
        processTextFile(data);
        adjustMobileOverlap();
      } catch (e) {
        alert('Erro ao carregar a lição.');
        console.error(e);
      }
    }

    function processTextFile(data) {
      const lines = data.split('\n');
      const content = document.getElementById('content');
      const basePath = (getURLParam('lessonPath') || 'lesson.txt').split('/').slice(0, -1).join('/');

      lines.forEach((line, idx) => {
        if (!line.trim()) return;
        const parts = line.split('|');
        const type = parts[0];
        const lang = parts[1] || '';
        const raw = parts.slice(2).join('|').trim();
        let el;

        if (type === 'table-row') {
          const cells = raw.split('|').map(c => c.trim());
          el = document.createElement('div');
          el.className = 'table-row';
          cells.forEach(cell => {
            const m = cell.match(/\[([^\]]+)\](.*)/);
            const span = document.createElement('span');
            span.className = 'cell';
            if (m) { span.lang = m[1]; span.textContent = m[2].trim(); }
            else { span.textContent = cell; }
            el.appendChild(span);
          });
          texts.push({ id: idx, type: 'table-row', el });
        } else {
          switch (type) {
            case 'title': el = document.createElement('h1'); el.textContent = raw; break;
            case 'subtitle': el = document.createElement('h2'); el.textContent = raw; break;
            case 'text': el = document.createElement('p'); el.textContent = raw; break;
            case 'text-bold': {
              el = document.createElement('p'); el.style.fontWeight = 'bold'; el.textContent = raw; break;
            }
            case 'text-bold-large': {
              el = document.createElement('p'); el.style.fontWeight = 'bold'; el.style.fontSize = '1.5rem'; el.textContent = raw; break;
            }
            case 'spacer': { el = document.createElement('div'); el.className = 'spacer'; break; }
            case 'image': {
              el = document.createElement('img'); el.alt = raw;
              const p0 = `${basePath}/${raw}`;
              const p1 = `${basePath}/../${raw}`;
              const p2 = `${basePath}/../../${raw}`;
              el.src = p0;
              el.onerror = () => {
                el.onerror = () => {
                  el.onerror = () => { el.style.display = 'none'; };
                  el.src = p2;
                };
                el.src = p1;
              };
              break;
            }
            default: console.warn('Tipo desconhecido:', type);
          }
          if (el && type !== 'image' && type !== 'spacer') {
            texts.push({ id: idx, type, lang, text: raw, el });
          }
        }

        if (el) {
          el.dataset.index = idx;
          content.appendChild(el);
          if (type !== 'image' && type !== 'spacer') {
            el.addEventListener('click', () => handleTextClick(idx));
          }
        }
      });
    }

    /* =========================================================
       DETECÇÃO DE LÍNGUA DO ALUNO
       ========================================================= */
    function detectStudentLangFromLines(lines) {
      for (const line of lines) {
        const parts = line.split('|');
        if (parts.length >= 2) {
          const lang = (parts[1] || '').trim();
          if (lang && lang !== 'en-US' && SUPPORTED_STUDENT_LANGS.includes(lang)) return lang;
        }
      }
      const re = /\[([a-zA-Z\-]+)\]/g;
      for (const line of lines) {
        if (!line.startsWith('table-row')) continue;
        let m; while ((m = re.exec(line)) !== null) {
          const code = m[1];
          if (code && code !== 'en-US' && SUPPORTED_STUDENT_LANGS.includes(code)) return code;
        }
      }
      return 'pt-BR';
    }

    /* =========================================================
       INTERAÇÃO / CONTROLES
       ========================================================= */
    function handleTextClick(idx) {
      audio.pause();
      currentIndex = texts.findIndex(t => t.id === idx);
      isPlaying = true;
      clearTimeout(pauseTimeout);
      updateControls();
      playEntry(currentIndex);
    }

    function replayCurrent() {
      if (!texts.length) return;
      audio.pause();
      isPlaying = true;
      updateControls();
      playEntry(currentIndex);
    }

    function toggleLesson() {
      isPlaying = !isPlaying;
      updateControls();
      if (isPlaying) playEntry(currentIndex);
      else pauseLesson();
    }

    function exitLesson() { history.back(); }

    function toggleMute() {
      isMuted = !isMuted;
      updateMuteUI();
      setVolumeFromMute();
    }

    function updateMuteUI() {
      const muteBtn   = document.getElementById('muteBtn');
      const muteIcon  = document.getElementById('muteIcon');
      const muteLabel = document.getElementById('muteLabel');
      if (isMuted) {
        muteBtn.classList.add('btn-muted');
        muteLabel.textContent = t('unmute');
        muteIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
            <path d="M9 4.19v7.62a.75.75 0 0 1-1.204.6L5.5 10.75H3A1.5 1.5 0 0 1 1.5 9.25v-2.5A1.5 1.5 0 0 1 3 5.25h2.5l2.296-1.66A.75.75 0 0 1 9 4.19z"/>
            <path d="M10.354 5.646 12.707 8l-2.353 2.354-.708-.708L11.293 8l-1.647-1.646.708-.708z"/>
          </svg>`;
      } else {
        muteBtn.classList.remove('btn-muted');
        muteLabel.textContent = t('mute');
        muteIcon.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
            <path d="M11.536 14.01a.75.75 0 0 1-1.06-1.06A5.5 5.5 0 0 0 10.5 3.05a.75.75 0 1 1 1.06-1.06 7 7 0 0 1-.024 12.02z"/>
            <path d="M8.717 3.55A.75.75 0 0 1 9 4.19v7.62a.75.75 0 0 1-1.204.6L5.5 10.75H3A1.5 1.5 0 0 1 1.5 9.25v-2.5A1.5 1.5 0 0 1 3 5.25h2.5l2.296-1.66a.75.75 0 0 1 .921-.04z"/>
          </svg>`;
      }
    }

    function updateControls() {
      const panelIcon  = document.getElementById('panelPlayIcon');
      const panelLabel = document.getElementById('panelPlayLabel');
      const status     = document.getElementById('statusBadge');

      const svgPlay = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
             viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
          <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
        </svg>`;
      const svgPause = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
             viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
          <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
        </svg>`;

      if (isPlaying) {
        panelIcon.innerHTML = svgPause;
        panelLabel.textContent = t('pause');
        status.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
               viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg>
          ${t('explaining')}
        `;
      } else {
        panelIcon.innerHTML = svgPlay;
        panelLabel.textContent = t('start');
        status.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
               viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg>
          ${t('ready')}
        `;
      }
    }

    /* =========================================================
       PLAYER: fila de reprodução por entrada
       ========================================================= */
    const GAP_BETWEEN_LINES_MS = 300;

    async function playAudioUrl(url){
      return new Promise((resolve, reject) => {
        setVolumeFromMute();
        audio.src = url;
        audio.onended = () => resolve();
        audio.onerror = () => reject(new Error('Falha ao carregar áudio: ' + url));
        audio.play().catch(err => reject(err));
      });
    }

    async function playEntry(i) {
      if (i >= texts.length) return pauseLesson();

      const entry = texts[i];
      const el = entry.el;
      const myMarker = Symbol('play-seq');
      playEntry._marker = myMarker;

      document.querySelectorAll('.highlight').forEach(e => e.classList.remove('highlight'));
      el.classList.add('highlight');

      clearTimeout(idleTimer);
      el.scrollIntoView({ block: 'center', behavior: 'smooth' });

      const finish = () => {
        if (playEntry._marker !== myMarker) return;
        el.classList.remove('highlight');
        setAvatar('static');
        setTimeout(() => {
          if (playEntry._marker !== myMarker) return;
          currentIndex++;
          isPlaying ? playEntry(currentIndex) : pauseLesson();
        }, GAP_BETWEEN_LINES_MS);
      };

      try {
        if (entry.type === 'table-row') {
          const spans = Array.from(el.querySelectorAll('.cell'));
          for (let c = 0; c < spans.length; c++) {
            if (!isPlaying || playEntry._marker !== myMarker) return;
            const s = spans[c];
            s.classList.add('highlight');

            const cellLang = s.getAttribute('lang') || 'en-US';
            setActorByLang(cellLang);
            setAvatar('talk');

            const audioInfo = findAudioFor(s.textContent, cellLang);
            if (!audioInfo) { s.classList.remove('highlight'); continue; }

            try {
              await playAudioUrl(audioInfo.url);
            } catch {
              if (audioInfo.fallbackUrl) await playAudioUrl(audioInfo.fallbackUrl);
            }

            s.classList.remove('highlight');
            setAvatar('static');
            await new Promise(r => setTimeout(r, GAP_BETWEEN_LINES_MS));
            // próximo loop definirá o ator/cena correto novamente
          }
          finish();
        } else {
          const lang = entry.lang || 'en-US';
          setActorByLang(lang);
          setAvatar('talk');

          const audioInfo = findAudioFor(entry.text, lang);
          if (audioInfo) {
            try {
              await playAudioUrl(audioInfo.url);
            } catch {
              if (audioInfo.fallbackUrl) await playAudioUrl(audioInfo.fallbackUrl);
            }
          }
          finish();
        }
      } catch (e) {
        console.warn(e);
        finish();
      }
    }

    function pauseLesson() {
      audio.pause();
      isPlaying = false;
      updateControls();
      setAvatar('static');
      clearTimeout(idleTimer);
      goIdleSoon(IDLE_DELAY_MS);
    }

    /* =========================================================
       Foco da aba
       ========================================================= */
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isPlaying) toggleLesson();
    });

    /* =========================================================
       Ajuste MOBILE
       ========================================================= */
    function adjustMobileOverlap() {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const panel = document.getElementById('teacherPanel');
      const wrapper = document.getElementById('contentWrapper');
      if (!wrapper) return;

      if (isMobile && panel) {
        const ph = panel.getBoundingClientRect().height;
        wrapper.style.marginTop = ph + 'px';
        wrapper.style.height = `calc(100vh - ${ph}px - 48px)`;
      } else {
        wrapper.style.marginTop = '';
        wrapper.style.height = '';
      }
    }
    window.addEventListener('resize', adjustMobileOverlap);

    /* =========================================================
       Boot
       ========================================================= */
    window.onload = () => {
      applyUITranslations();
      updateControls();
      loadTextFile();
      // opcional: mostrar estado idle se o usuário não iniciar a aula
      goIdleSoon(IDLE_DELAY_MS);
    };
  </script>
</body>
</html>
