<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GRAMMAR</title>
  <style>
    :root{
      --brand:#4CAF50; --bg:#f0f0f0; --panel:#fff; --text:#333; --border:#e5e5e5;
      --highlight:#fff7a8; --shadow:0 2px 5px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0; font-family:Arial, sans-serif; color:var(--text);
      background:var(--bg) url('../../../../../imagens/fundo.png') repeat;
      height:100vh; overflow:hidden;
    }
    .layout{display:grid; grid-template-columns:1fr 360px; gap:16px; height:100vh; padding:16px}
    .content-shell{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden; min-height:0}
    .content-header{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:var(--brand); color:#fff; border-top-left-radius:12px; border-top-right-radius:12px}
    .content-header h1{margin:0; font-size:1.1rem; letter-spacing:.5px}
    .button-row{display:none}
    .btn{background:#fff; color:var(--brand); border:2px solid #fff; padding:6px 10px; font-size:.95rem; cursor:pointer; border-radius:8px; display:inline-flex; align-items:center; gap:6px; transition:all .15s}
    .btn:hover{filter:brightness(.95)}
    .btn-outline{background:transparent; color:var(--brand)!important; border-color:var(--brand)!important}
    .content-wrapper{flex:1; overflow-y:auto; padding:18px; background:#fff}
    h2{font-size:1.25rem; color:#555; margin:0 0 6px}
    p{font-size:1rem; line-height:1.6; margin:0 0 10px}
    .spacer{margin:20px 0; border-top:2px solid var(--brand); width:100%; height:2px}
    .content-wrapper img{max-width:100%; display:block; margin:10px auto}
    .table-row{display:flex; margin:4px 0}
    .table-row .cell{flex:1; padding:6px 10px; border:1px solid #ccc; background:#fafafa}
    .table-row .cell:not(:last-child){border-right:none}
    .highlight{background:var(--highlight)!important; border-radius:6px}
    .teacher-panel{position:sticky; top:16px; align-self:start; background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:14px; display:flex; flex-direction:column; gap:12px; height:fit-content; max-height:calc(100vh - 32px)}
    .teacher-header{display:flex; align-items:center; gap:10px; justify-content:space-between}
    .teacher-title{display:flex; align-items:center; gap:10px}
    .teacher-title h2{margin:0; font-size:1.1rem; color:#222}
    .robot-wrap{width:100%; display:grid; place-items:center; padding:8px 0}
    .robot-wrap img{width:240px; height:auto; display:block; border-radius:12px}
    .status-badge{display:inline-flex; align-items:center; gap:6px; background:#eef8ef; color:#1b5e20; border:1px solid #cfe8d1; border-radius:999px; padding:6px 10px; font-size:.9rem; width:fit-content}
    .control-row{display:flex; gap:8px; flex-wrap:wrap}
    .tiny{font-size:.82rem; color:#666}
    .btn:focus{outline:2px solid #1111; outline-offset:2px}
    .btn-muted{background:#ffe8e8; border-color:#ffc9c9!important; color:#c62828!important}
    @media (max-width:768px){
      .layout{display:block; padding:0}
      .teacher-panel{position:fixed; top:0; left:0; right:0; border-radius:0 0 16px 16px; z-index:1000; max-height:none; box-shadow:0 4px 12px rgba(0,0,0,.18)}
      .robot-wrap img{width:180px}
      .content-shell{margin:0; border-radius:0; border-left:none; border-right:none; border-bottom:none; height:100vh; display:flex; flex-direction:column}
      .content-header{border-radius:0; padding:10px 12px}
      .content-wrapper{padding:14px}
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- COLUNA ESQUERDA -->
    <section class="content-shell">
      <div class="content-header">
        <h1>GRAMMAR</h1>
        <div class="button-row"></div>
      </div>
      <div class="content-wrapper" id="contentWrapper">
        <div id="content"></div>
      </div>
    </section>

    <!-- COLUNA DIREITA -->
    <aside class="teacher-panel" aria-label="Professor Robô" id="teacherPanel">
      <div class="teacher-header">
        <div class="teacher-title">
          <span style="display:inline-flex;width:10px;height:10px;background:var(--brand);border-radius:50%;"></span>
          <h2>Professor Samuel</h2>
        </div>
        <button class="btn btn-outline" id="exitBtn" onclick="exitLesson()" aria-label="Sair">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
            <path d="M6 2a1 1 0 0 0-1 1v2h2V4h6v8H7v-1H5v2a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H6z"/>
            <path d="M.146 8.354a.5.5 0 0 1 0-.708L3.793 3.999 4.5 4.706 1.707 7.5H10v1H1.707L4.5 11.293l-.707.707L.146 8.354z"/>
          </svg>
          <span id="exitLabel">Sair</span>
        </button>
      </div>

      <div class="robot-wrap">
        <img id="robotImage" src="../../../../../imagens/robo1_static.png" alt="Robô Professor Samuel">
      </div>

      <div class="status-badge" id="statusBadge" aria-live="polite">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg>
        Ready to start
      </div>

      <div class="control-row">
        <button class="btn" onclick="toggleLesson()" aria-label="Iniciar ou pausar a lição">
          <span id="panelPlayIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
              <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
            </svg>
          </span>
          <span id="panelPlayLabel">Start Lesson</span>
        </button>

        <button class="btn" id="muteBtn" onclick="toggleMute()" aria-label="Silenciar/Ativar som">
          <span id="muteIcon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
              <path d="M11.536 14.01a.75.75 0 0 1-1.06-1.06A5.5 5.5 0 0 0 10.5 3.05a.75.75 0 1 1 1.06-1.06 7 7 0 0 1-.024 12.02z"/>
              <path d="M8.717 3.55A.75.75 0 0 1 9 4.19v7.62a.75.75 0 0 1-1.204.6L5.5 10.75H3A1.5 1.5 0 0 1 1.5 9.25v-2.5A1.5 1.5 0 0 1 3 5.25h2.5l2.296-1.66a.75.75 0 0 1 .921-.04z"/>
            </svg>
          </span>
          <span id="muteLabel">Mute</span>
        </button>
      </div>

      <div class="tiny" id="hintText">Hint: tap any line to play from that point.</div>
    </aside>
  </div>

  <script>
    /* ===================== ROBÔ ===================== */
    const ROBOT = {
      talk:  '../../../../../imagens/robo1.gif',
      static:'../../../../../imagens/robo1_static.png',
      idle:  '../../../../../imagens/robo2.gif'
    };
    const IDLE_DELAY_MS = 10000;
    let robotState='static', idleTimer, speakToken=0;

    (function preloadRobot(){[ROBOT.talk,ROBOT.static,ROBOT.idle].forEach(s=>{const i=new Image();i.src=s;});})();

    function setRobot(state){ if(state===robotState) return; robotState=state; const img=document.getElementById('robotImage'); if(img) img.src=ROBOT[state]; }
    function goIdleSoon(ms=IDLE_DELAY_MS){ clearTimeout(idleTimer); idleTimer=setTimeout(()=>{ if(!audioEl || audioEl.paused) setRobot('idle'); }, ms); }

    /* ===================== TRADUÇÕES UI ===================== */
    const SUPPORTED_STUDENT_LANGS=['pt-BR','th','my','km','zh-CN'];
    const T={
      'en-US':{ready:'Ready to start', explaining:'Samuel is explaining', start:'Start Lesson', pause:'Pause Lesson', repeat:'Repeat', hint:'Hint: tap any line to play from that point.', mute:'Mute', unmute:'Unmute', exit:'Exit'},
      'pt-BR':{ready:'Pronto para iniciar', explaining:'Samuel está explicando', start:'Iniciar aula', pause:'Pausar aula', repeat:'Repetir', hint:'Dica: toque em qualquer linha do texto para ouvir a partir daquele ponto.', mute:'Silenciar', unmute:'Ativar som', exit:'Sair'},
      'th':{ready:'พร้อมเริ่ม', explaining:'ซามูเอลกำลังอธิบาย', start:'เริ่มบทเรียน', pause:'หยุดชั่วคราว', repeat:'เล่นซ้ำ', hint:'แตะบรรทัดใดก็ได้เพื่อเริ่มเล่นจากส่วนนั้น', mute:'ปิดเสียง', unmute:'เปิดเสียง', exit:'ออก'},
      'my':{ready:'စတင်ရန်အဆင်သင့်', explaining:'ဆမ်မြူးအယ်လ် ဆက်သွယ်ရှင်းလင်းနေသည်', start:'သင်ခန်းစာ စတင်မည်', pause:'ခဏရပ်မည်', repeat:'ထပ်မံဖတ်ပြ', hint:'မည်သည့် စာကြောင်းမဆို ကိုထိနှိပ်ပြီး ထိုနေရာမှ စတင်နားထောင်နိုင်သည်', mute:'အသံပိတ်', unmute:'အသံဖွင့်', exit:'ထွက်မည်'},
      'km':{ready:'រួចរាល់ដើម្បីចាប់ផ្តើម', explaining:'សាំយូអែលកំពុងអធិប្បាយ', start:'ចាប់ផ្តើមមេរៀន', pause:'ផ្អាក', repeat:'ធ្វើម្ដងទៀត', hint:'ចុចលើបន្ទាត់ណាមួយ ដើម្បីចាប់ផ្តើមពីចំណុចនោះ។', mute:'បិទសំឡេង', unmute:'បើកសំឡេង', exit:'ចាកចេញ'},
      'zh-CN':{ready:'准备开始', explaining:'Samuel 正在讲解', start:'开始课程', pause:'暂停课程', repeat:'再听一遍', hint:'提示：点击任意一行，从该处开始播放。', mute:'静音', unmute:'取消静音', exit:'退出'}
    };
    function t(key){const pack=T[studentLang]||T['pt-BR']; return (pack&&pack[key])||T['pt-BR'][key]||key;}

    /* ===================== ESTADO ===================== */
    function getURLParam(name){const p=new URLSearchParams(location.search); return p.get(name)||'';}
    let texts=[], isPlaying=false, currentIndex=0, studentLang='pt-BR', isMuted=false;
    let MANIFEST=null, audioEl=null;

    function detectStudentLangFromLines(lines){
      for(const line of lines){
        const parts=line.split('|'); if(parts.length>=2){const lang=(parts[1]||'').trim(); if(lang && lang!=='en-US' && SUPPORTED_STUDENT_LANGS.includes(lang)) return lang;}
      }
      const re=/\[([a-zA-Z\-]+)\]/g;
      for(const line of lines){
        if(!line.startsWith('table-row')) continue;
        let m; while((m=re.exec(line))!==null){const code=m[1]; if(code && code!=='en-US' && SUPPORTED_STUDENT_LANGS.includes(code)) return code;}
      }
      return 'pt-BR';
    }

    function applyUITranslations(){
      const status=document.getElementById('statusBadge');
      const panelIcon=document.getElementById('panelPlayIcon');
      const panelLabel=document.getElementById('panelPlayLabel');
      const muteLabel=document.getElementById('muteLabel');
      const hint=document.getElementById('hintText');
      status.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg> ${t('ready')}`;
      panelIcon.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/></svg>`;
      panelLabel.textContent=t('start');
      document.getElementById('exitLabel').textContent=t('exit');
      muteLabel.textContent=t('mute');
      hint.textContent=t('hint');
    }

    /* ===================== ÁUDIO: Manifesto e Player ===================== */
    function playAudioUrl(url, onend){
      try{ if(audioEl){audioEl.pause(); audioEl.src=''; audioEl.remove();} }catch{}
      audioEl=new Audio(url);
      audioEl.volume=isMuted?0:1;
      setRobot('talk'); clearTimeout(idleTimer);
      audioEl.onended=()=>{ setRobot('static'); onend && onend(); };
      audioEl.onerror=()=>{ setRobot('static'); onend && onend(); };
      audioEl.play().catch(()=>{ setRobot('static'); onend && onend(); });
    }

    function speakWithTTS(text, lang, onend){
      const u=new SpeechSynthesisUtterance(text);
      if(lang) u.lang=lang; u.volume=isMuted?0:1;
      u.onend=()=>onend&&onend();
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // casamento robusto pelo conteúdo
    function normalizeType(t){ return t; }
    function findBestAudioByText(manifestItems, entry, candidateLangs){
      const t = normalizeType(entry.type);
      // 1) match exato type/lang/text
      for(const L of candidateLangs){
        const hit = manifestItems.find(it =>
          it.type === (entry.isCell ? 'table-cell' : t) &&
          it.lang === L &&
          it.text === entry.text
        );
        if(hit) return hit.url;
      }
      // 2) lang+text
      for(const L of candidateLangs){
        const hit = manifestItems.find(it => it.lang===L && it.text===entry.text);
        if(hit) return hit.url;
      }
      // 3) qualquer idioma com mesmo texto
      const any = manifestItems.find(it => it.text===entry.text);
      return any ? any.url : null;
    }

    /* ===================== CARREGAR LIÇÃO + MANIFESTO ===================== */
    async function loadTextAndManifest(){
      const lessonPath=getURLParam('lessonPath')||'lesson.txt';
      const baseDir=lessonPath.split('/').slice(0,-1).join('/');
      const audioDir = baseDir + '/audio';
      try{
        // lesson.txt
        const resp=await fetch(lessonPath);
        if(!resp.ok){ alert('Não foi possível carregar a lição.'); return; }
        const data=await resp.text();
        const rawLines=data.split('\n');
        studentLang=detectStudentLangFromLines(rawLines);
        applyUITranslations();
        processTextFile(data, baseDir);

        // manifest.json
        const m = await fetch(audioDir + '/manifest.json');
        MANIFEST = m.ok ? await m.json() : null;
      }catch(e){ console.error(e); alert('Erro ao carregar lição ou manifesto.'); }
      adjustMobileOverlap();
    }

    function processTextFile(data, baseDir){
      const lines=data.split('\n');
      const content=document.getElementById('content');

      lines.forEach((line, idx)=>{
        if(!line.trim()) return;
        const parts=line.split('|');
        const type=parts[0];
        const lang=parts[1]||'';
        const raw=parts.slice(2).join('|').trim();
        let el;

        if(type==='table-row'){
          const row=document.createElement('div'); row.className='table-row';
          const cells=raw.split('|').map(c=>c.trim());
          cells.forEach(cell=>{
            const m=cell.match(/\[([^\]]+)\](.*)/);
            const span=document.createElement('span'); span.className='cell';
            if(m){ span.lang=m[1]; span.textContent=m[2].trim(); }
            else { span.textContent=cell; }
            row.appendChild(span);
          });
          el=row;
          texts.push({ id:idx, type:'table-row', el, isRow:true });
        }else{
          switch(type){
            case 'title': el=document.createElement('h1'); el.textContent=raw; break;
            case 'subtitle': el=document.createElement('h2'); el.textContent=raw; break;
            case 'text': el=document.createElement('p'); el.textContent=raw; break;
            case 'text-bold': el=document.createElement('p'); el.style.fontWeight='bold'; el.textContent=raw; break;
            case 'text-bold-large': el=document.createElement('p'); el.style.fontWeight='bold'; el.style.fontSize='1.5rem'; el.textContent=raw; break;
            case 'spacer': el=document.createElement('div'); el.className='spacer'; break;
            case 'image': {
              el=document.createElement('img'); el.alt=raw;
              const p0=`${baseDir}/${raw}`, p1=`${baseDir}/../${raw}`, p2=`${baseDir}/../../${raw}`;
              el.src=p0; el.onerror=()=>{ el.onerror=()=>{ el.onerror=()=>{el.style.display='none'}; el.src=p2; }; el.src=p1; };
              break;
            }
            default: console.warn('Tipo desconhecido:', type);
          }
          if(el && type!=='image' && type!=='spacer'){
            texts.push({ id:idx, type, lang, text:raw, el });
          }
        }

        if(el){
          el.dataset.index=idx;
          content.appendChild(el);
          if(type!=='image' && type!=='spacer'){
            el.addEventListener('click', ()=>handleTextClick(idx));
          }
        }
      });
    }

    /* ===================== CONTROLES ===================== */
    function updateControls(){
      const panelIcon=document.getElementById('panelPlayIcon');
      const panelLabel=document.getElementById('panelPlayLabel');
      const status=document.getElementById('statusBadge');
      const svgPlay=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/></svg>`;
      const svgPause=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>`;
      if(isPlaying){
        panelIcon.innerHTML=svgPause; panelLabel.textContent=t('pause');
        status.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg> ${t('explaining')}`;
      }else{
        panelIcon.innerHTML=svgPlay; panelLabel.textContent=t('start');
        status.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg> ${t('ready')}`;
      }
    }

    function updateMuteUI(){
      const btn=document.getElementById('muteBtn');
      const label=document.getElementById('muteLabel');
      const icon=document.getElementById('muteIcon');
      if(isMuted){
        btn.classList.add('btn-muted'); label.textContent=t('unmute');
        icon.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M9 4.19v7.62a.75.75 0 0 1-1.204.6L5.5 10.75H3A1.5 1.5 0 0 1 1.5 9.25v-2.5A1.5 1.5 0 0 1 3 5.25h2.5l2.296-1.66A.75.75 0 0 1 9 4.19z"/><path d="M10.354 5.646 12.707 8l-2.353 2.354-.708-.708L11.293 8l-1.647-1.646.708-.708z"/></svg>`;
      }else{
        btn.classList.remove('btn-muted'); label.textContent=t('mute');
        icon.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M11.536 14.01a.75.75 0 0 1-1.06-1.06A5.5 5.5 0 0 0 10.5 3.05a.75.75 0 1 1 1.06-1.06 7 7 0 0 1-.024 12.02z"/><path d="M8.717 3.55A.75.75 0 0 1 9 4.19v7.62a.75.75 0 0 1-1.204.6L5.5 10.75H3A1.5 1.5 0 0 1 1.5 9.25v-2.5A1.5 1.5 0 0 1 3 5.25h2.5l2.296-1.66a.75.75 0 0 1 .921-.04z"/></svg>`;
      }
      if(audioEl) audioEl.volume=isMuted?0:1;
    }

    function handleTextClick(idx){
      stopAnyAudio();
      currentIndex=texts.findIndex(t=>t.id===idx);
      isPlaying=true; updateControls();
      speakEntry(currentIndex);
    }

    function replayCurrent(){
      if(!texts.length) return;
      stopAnyAudio(); isPlaying=true; updateControls();
      speakEntry(currentIndex);
    }

    function toggleLesson(){
      isPlaying=!isPlaying; updateControls();
      if(isPlaying) speakEntry(currentIndex); else pauseLesson();
    }

    function exitLesson(){ history.back(); }

    function toggleMute(){
      isMuted=!isMuted; updateMuteUI();
      if(audioEl){ audioEl.volume=isMuted?0:1; }
    }

    function stopAnyAudio(){
      try{ if(audioEl){ audioEl.pause(); audioEl.src=''; } }catch{}
      window.speechSynthesis.cancel();
      setRobot('static');
    }

    /* ===================== FALA / NAVEGAÇÃO ===================== */
    const GAP_BETWEEN_LINES_MS=300;

    function speakEntry(i){
      if(i>=texts.length) return pauseLesson();
      const entry=texts[i];
      const el=entry.el;
      const myToken=++speakToken;

      document.querySelectorAll('.highlight').forEach(e=>e.classList.remove('highlight'));
      el.classList.add('highlight');
      setRobot('talk'); clearTimeout(idleTimer);
      el.scrollIntoView({block:'center', behavior:'smooth'});

      function finish(){
        if(myToken!==speakToken) return;
        el.classList.remove('highlight'); setRobot('static');
        setTimeout(()=>{ if(myToken!==speakToken) return; currentIndex++; isPlaying ? speakEntry(currentIndex) : pauseLesson(); }, GAP_BETWEEN_LINES_MS);
      }

      // Preferência de línguas para o item
      const candidateLangs=[studentLang,'en-US'];

      // Tabela: falar célula por célula
      if(entry.isRow){
        const spans=Array.from(el.querySelectorAll('.cell'));
        let c=0;
        const nextCell=()=>{ if(!isPlaying || myToken!==speakToken) return; if(++c>=spans.length) return finish(); speakCell(); };
        function speakCell(){
          if(!isPlaying || myToken!==speakToken) return;
          const s=spans[c]; s.classList.add('highlight');
          const cellText=s.textContent; const cellLang=s.getAttribute('lang')||studentLang;
          const entryCell={type:'table-row', text:cellText, lang:cellLang, isCell:true};
          const url = (MANIFEST && MANIFEST.items) ? findBestAudioByText(MANIFEST.items, entryCell, [cellLang, studentLang, 'en-US']) : null;

          const onEnd=()=>{ s.classList.remove('highlight'); setRobot('static'); setTimeout(nextCell, GAP_BETWEEN_LINES_MS); };

          if(url) playAudioUrl(url, onEnd);
          else speakWithTTS(cellText, cellLang, onEnd);
        }
        speakCell();
        return;
      }

      // Linhas comuns
      const url = (MANIFEST && MANIFEST.items) ? findBestAudioByText(MANIFEST.items, entry, candidateLangs) : null;
      const onEnd=finish;

      if(url) playAudioUrl(url, onEnd);
      else speakWithTTS(entry.text, entry.lang||studentLang, onEnd);
    }

    function pauseLesson(){
      stopAnyAudio(); isPlaying=false; updateControls();
      setRobot('static'); clearTimeout(idleTimer); goIdleSoon(IDLE_DELAY_MS);
    }

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden && isPlaying) toggleLesson(); });

    function adjustMobileOverlap(){
      const isMobile=window.matchMedia('(max-width:768px)').matches;
      const panel=document.getElementById('teacherPanel');
      const wrapper=document.getElementById('contentWrapper');
      if(!wrapper) return;
      if(isMobile && panel){
        const ph=panel.getBoundingClientRect().height;
        wrapper.style.marginTop=ph+'px';
        wrapper.style.height=`calc(100vh - ${ph}px - 48px)`;
      }else{
        wrapper.style.marginTop=''; wrapper.style.height='';
      }
    }
    window.addEventListener('resize', adjustMobileOverlap);

    /* ===================== BOOT ===================== */
    window.onload=()=>{
      window.speechSynthesis.getVoices();
      applyUITranslations(); updateControls();
      loadTextAndManifest();
    };
  </script>
</body>
</html>
