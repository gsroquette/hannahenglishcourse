<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GRAMMAR</title>
  <style>
    :root{
      --brand: #4CAF50;
      --bg: #f0f0f0;
      --panel: #ffffff;
      --text: #333;
      --border: #e5e5e5;
      --highlight: #fff7a8;
      --shadow: 0 2px 5px rgba(0,0,0,.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background-color: var(--bg);
      background-image: url('../../../../../imagens/fundo.png');
      background-repeat: repeat;
      background-size: auto;
      height: 100vh;
      overflow: hidden; /* controlamos as rolagens internamente */
    }

    /* ====== LAYOUT GERAL (DESKTOP/TABLET: DUAS COLUNAS) ====== */
    .layout {
      display: grid;
      grid-template-columns: 1fr 360px; /* esquerda maior, direita professor */
      gap: 16px;
      height: 100vh;
      padding: 16px;
    }

    /* Coluna ESQUERDA: conteúdo rolável */
    .content-shell {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden; /* header interno + scroller */
      min-height: 0; /* para o flex/scroll funcionar */
    }

    .content-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--brand);
      color: #fff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    .content-header h1 {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: .5px;
    }

    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      background-color: #fff;
      color: var(--brand);
      border: 2px solid #fff;
      padding: 6px 10px;
      font-size: .95rem;
      cursor: pointer;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all .15s ease;
    }
    .btn:hover { filter: brightness(0.95); }
    .btn-outline {
      background: transparent;
      color: #fff;
      border-color: #fff;
    }

    /* Container rolável do conteúdo */
    .content-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 18px;
      background-color: #fff;
    }

    h2 { font-size: 1.25rem; color: #555; margin: 0 0 6px; }
    p { font-size: 1rem; line-height: 1.6; margin: 0 0 10px; }
    .spacer {
      margin: 20px 0;
      border-top: 2px solid var(--brand);
      width: 100%;
      height: 2px;
    }
    .content-wrapper img {
      max-width: 100%;
      display: block;
      margin: 10px auto;
    }
    .table-row { display: flex; margin: 4px 0; }
    .table-row .cell {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      background: #fafafa;
    }
    .table-row .cell:not(:last-child) { border-right: none; }

    .highlight { background-color: var(--highlight) !important; border-radius: 6px; }

    /* Coluna DIREITA: painel do professor FIXO/visível */
    .teacher-panel {
      position: sticky;
      top: 16px;
      align-self: start;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: fit-content;
      max-height: calc(100vh - 32px);
    }

    .teacher-header {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }

    .teacher-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .teacher-title h2 {
      margin: 0;
      font-size: 1.1rem;
      color: #222;
    }

    .robot-wrap {
      width: 100%;
      display: grid;
      place-items: center;
      padding: 8px 0;
    }

    .robot-wrap img {
      width: 240px; /* avatar GRANDE */
      height: auto;
      display: block;
      border-radius: 12px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #eef8ef;
      color: #1b5e20;
      border: 1px solid #cfe8d1;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: .9rem;
      width: fit-content;
    }

    .control-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tiny {
      font-size: .82rem;
      color: #666;
    }

    /* ====== MOBILE (MODO 7): ROBÔ FIXO NO TOPO + CONTEÚDO ROLÁVEL ====== */
    @media (max-width: 768px) {
      .layout {
        display: block;
        padding: 0;
      }

      /* Professor fixo no topo em mobile */
      .teacher-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        border-radius: 0 0 16px 16px;
        z-index: 1000;
        max-height: none;
        box-shadow: 0 4px 12px rgba(0,0,0,.18);
      }
      .robot-wrap img { width: 180px; } /* compacto em mobile */

      /* Conteúdo com padding-top para não ficar atrás do painel */
      .content-shell {
        margin: 0;
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-bottom: none;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .content-header {
        border-radius: 0;
        padding: 10px 12px;
      }
      .content-wrapper {
        /* altura total - altura estimada do painel do professor (ajustada para 240~280px) - header do conteúdo */
        padding: 14px;
        height: calc(100vh - 280px - 48px);
        margin-top: calc(280px); /* espaço para o painel fixo do topo */
        overflow-y: auto;
      }
    }

    /* Acessibilidade visual leve para foco nos botões */
    .btn:focus { outline: 2px solid #1111; outline-offset: 2px; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- COLUNA ESQUERDA: CONTEÚDO -->
    <section class="content-shell">
      <div class="content-header">
        <h1>GRAMMAR</h1>
        <div class="button-row">
          <button class="btn btn-outline" onclick="history.back()" aria-label="Voltar">
            <!-- Ícone seta esquerda -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
              <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
            </svg>
            Back
          </button>

          <button id="toggleButton" class="btn" onclick="toggleLesson()" aria-label="Iniciar ou pausar a lição">
            <!-- Ícone PLAY padrão na carga -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                 viewBox="0 0 16 16" aria-hidden="true">
              <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
            </svg>
            Start Lesson
          </button>
        </div>
      </div>

      <div class="content-wrapper" id="contentWrapper">
        <div id="content"></div>
      </div>
    </section>

    <!-- COLUNA DIREITA: PROFESSOR SEMPRE VISÍVEL -->
    <aside class="teacher-panel" aria-label="Professor Robô">
      <div class="teacher-header">
        <div class="teacher-title">
          <span style="display:inline-flex;width:10px;height:10px;background:var(--brand);border-radius:50%;"></span>
          <h2>Professor Samuel</h2>
        </div>
        <span class="tiny">en-US / pt-BR</span>
      </div>

      <div class="robot-wrap">
        <img id="robotImage" src="../../../../../imagens/robo1_static.png" alt="Robô Professor Samuel">
      </div>

      <div class="status-badge" id="statusBadge" aria-live="polite">
        <!-- Indicador de status dinâmico -->
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/>
        </svg>
        Pronto para iniciar
      </div>

      <div class="control-row">
        <button class="btn" onclick="toggleLesson()" aria-label="Iniciar ou pausar a lição (painel)">
          <span id="panelPlayIcon">
            <!-- Ícone PLAY -->
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
              <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
            </svg>
          </span>
          <span id="panelPlayLabel">Start Lesson</span>
        </button>
        <button class="btn btn-outline" onclick="replayCurrent()" aria-label="Repetir trecho atual">
          <!-- Ícone replay -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 3a5 5 0 1 1-4.546 2.916.5.5 0 1 1 .894-.448A4 4 0 1 0 8 4V1l3 3-3 3V3z"/>
          </svg>
          Repetir
        </button>
      </div>

      <div class="tiny">
        Dica: toque em qualquer linha do texto para ouvir a partir daquele ponto.
      </div>
    </aside>
  </div>

  <script>
    // ====== Utilitários ======
    function getURLParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || '';
    }

    // ====== Estado ======
    let texts = [];
    let isPlaying = false;
    let currentIndex = 0;
    let pauseTimeout;

    // ====== Carregar lesson ======
    async function loadTextFile() {
      const path = getURLParam('lessonPath') || 'lesson.txt';
      try {
        const resp = await fetch(path);
        if (!resp.ok) { alert('Não foi possível carregar a lição.'); return; }
        const data = await resp.text();
        processTextFile(data);
      } catch (e) {
        alert('Erro ao carregar a lição.');
        console.error(e);
      }
    }

    function processTextFile(data) {
      const lines = data.split('\n');
      const content = document.getElementById('content');
      const basePath = (getURLParam('lessonPath') || '').split('/').slice(0, -1).join('/');

      lines.forEach((line, idx) => {
        if (!line.trim()) return;
        const parts = line.split('|');
        const type = parts[0];
        const lang = parts[1] || '';
        const raw = parts.slice(2).join('|').trim();
        let el;

        if (type === 'table-row') {
          const cells = raw.split('|').map(c => c.trim());
          el = document.createElement('div');
          el.className = 'table-row';
          cells.forEach(cell => {
            const m = cell.match(/\[([^\]]+)\](.*)/);
            const span = document.createElement('span');
            span.className = 'cell';
            if (m) { span.lang = m[1]; span.textContent = m[2].trim(); }
            else { span.textContent = cell; }
            el.appendChild(span);
          });
          texts.push({ id: idx, type: 'table-row', el });
        } else {
          switch (type) {
            case 'title': el = document.createElement('h1'); el.textContent = raw; break;
            case 'subtitle': el = document.createElement('h2'); el.textContent = raw; break;
            case 'text': el = document.createElement('p'); el.textContent = raw; break;
            case 'text-bold': {
              el = document.createElement('p');
              el.style.fontWeight = 'bold';
              el.textContent = raw;
              break;
            }
            case 'text-bold-large': {
              el = document.createElement('p');
              el.style.fontWeight = 'bold';
              el.style.fontSize = '1.5rem';
              el.textContent = raw;
              break;
            }
            case 'spacer': {
              el = document.createElement('div');
              el.className = 'spacer';
              break;
            }
            case 'image': {
              el = document.createElement('img');
              el.alt = raw;

              // caminhos de fallback
              const p0 = `${basePath}/${raw}`;
              const p1 = `${basePath}/../${raw}`;
              const p2 = `${basePath}/../../${raw}`;

              el.src = p0;
              el.onerror = () => {
                el.onerror = () => {
                  el.onerror = () => { el.style.display = 'none'; };
                  el.src = p2; // dois níveis acima
                };
                el.src = p1;   // um nível acima
              };
              break;
            }
            default:
              console.warn('Tipo desconhecido:', type);
          }

          if (el && type !== 'image' && type !== 'spacer') {
            // guardamos o texto bruto para TTS
            texts.push({ id: idx, type, lang, text: raw, el });
          }
        }

        if (el) {
          el.dataset.index = idx;
          content.appendChild(el);
          if (type !== 'image' && type !== 'spacer') {
            el.addEventListener('click', () => handleTextClick(idx));
          }
        }
      });
    }

    // ====== Interação ======
    function handleTextClick(idx) {
      speechSynthesis.cancel();
      currentIndex = texts.findIndex(t => t.id === idx);
      isPlaying = true;
      clearTimeout(pauseTimeout);
      updateControls();
      speakEntry(currentIndex);
    }

    function toggleLesson() {
      isPlaying = !isPlaying;
      updateControls();
      if (isPlaying) speakEntry(currentIndex);
      else pauseLesson();
    }

    function replayCurrent() {
      if (!texts.length) return;
      speechSynthesis.cancel();
      isPlaying = true;
      updateControls();
      speakEntry(currentIndex);
    }

    // Atualiza rótulos/ícones em AMBOS botões (header e painel)
    function updateControls() {
      const mainBtn = document.getElementById('toggleButton');
      const panelIcon = document.getElementById('panelPlayIcon');
      const panelLabel = document.getElementById('panelPlayLabel');
      const status = document.getElementById('statusBadge');

      // Ícones SVG para play/pause
      const svgPlay = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
             viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
          <path d="M11.596 8.697l-6.363 3.692A.5.5 0 0 1 4.5 12.846V3.154a.5.5 0 0 1 .733-.442l6.363 3.692a.5.5 0 0 1 0 .884z"/>
        </svg>`;
      const svgPause = `
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
             viewBox="0 0 16 16" aria-hidden="true" fill="currentColor">
          <path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/>
        </svg>`;

      if (isPlaying) {
        mainBtn.innerHTML = `${svgPause} Pause Lesson`;
        panelIcon.innerHTML = svgPause;
        panelLabel.textContent = 'Pause Lesson';
        status.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
               viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg>
          Samuel está explicando
        `;
      } else {
        mainBtn.innerHTML = `${svgPlay} Start Lesson`;
        panelIcon.innerHTML = svgPlay;
        panelLabel.textContent = 'Start Lesson';
        status.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
               viewBox="0 0 24 24" aria-hidden="true"><path d="M3 9h2v6H3V9zm4-4h2v14H7V5zm4 2h2v10h-2V7zm4-4h2v18h-2V3zm4 8h2v2h-2v-2z"/></svg>
          Pronto para iniciar
        `;
      }
    }

    function speakEntry(i) {
      if (i >= texts.length) return pauseLesson();

      const entry = texts[i];
      const el = entry.el;

      // Limpa highlights
      document.querySelectorAll('.highlight').forEach(e => e.classList.remove('highlight'));
      el.classList.add('highlight');

      // Atualiza avatar para "falando"
      const robot = document.getElementById('robotImage');
      robot.src = '../../../../../imagens/robo1.gif';

      if (entry.type === 'table-row') {
        const spans = Array.from(el.querySelectorAll('.cell'));
        let c = 0;

        function speakCell() {
          if (!isPlaying) return; // se pausar no meio
          if (c >= spans.length) {
            el.classList.remove('highlight');
            currentIndex++;
            return isPlaying ? speakEntry(currentIndex) : pauseLesson();
          }
          const s = spans[c];
          s.classList.add('highlight');
          const u = new SpeechSynthesisUtterance(s.textContent);
          const cellLang = s.getAttribute('lang');
          if (cellLang) u.lang = cellLang;
          u.onend = () => {
            s.classList.remove('highlight');
            c++;
            speakCell();
          };
          speechSynthesis.cancel();
          speechSynthesis.speak(u);
        }
        speakCell();
      } else {
        const u = new SpeechSynthesisUtterance(entry.text);
        if (entry.lang) u.lang = entry.lang;
        u.onend = () => {
          el.classList.remove('highlight');
          currentIndex++;
          isPlaying ? speakEntry(currentIndex) : pauseLesson();
        };
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }

      // Garantir visibilidade do item atual no container de conteúdo
      el.scrollIntoView({ block: 'center', behavior: 'smooth' });
    }

    function pauseLesson() {
      speechSynthesis.cancel();
      isPlaying = false;
      updateControls();

      const robot = document.getElementById('robotImage');
      robot.src = '../../../../../imagens/robo1_static.png';

      clearTimeout(pauseTimeout);
      pauseTimeout = setTimeout(() => {
        // estado ocioso depois de 5s parado
        if (!isPlaying) robot.src = '../../../../../imagens/robo2.gif';
      }, 5000);
    }

    window.onload = () => {
      updateControls();
      loadTextFile();
    };
  </script>
</body>
</html>
