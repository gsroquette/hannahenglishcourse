<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hannah Conversation</title>
    <style>
        body {
            background-image: url('../../../../../imagens/fundo.png');
            background-repeat: repeat;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }

        #header {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px;
        }

        .back-button {
            background-color: black;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            position: relative;
            margin-bottom: 30px;
        }

        #dialogue-container {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: nowrap;
            margin: 20px;
            max-width: 100%;
            gap: 20px;
        }

        .character {
            margin: 20px;
            text-align: center;
            flex: 1 1 300px;
        }

        .character img {
            width: 100%;
            max-width: 150px;
            height: auto;
            border-radius: 50%;
        }

        .character-text {
            font-size: 20px;
            font-weight: bold;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            max-width: 90%;
            position: relative;
            transition: border-color .2s ease, box-shadow .2s ease, background-color .2s ease;
        }

        .audio-button-container {
            margin-top: 10px;
        }

        #navigation {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px;
            width: 100%;
        }

        .nav-button {
            background-color: green;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin: 10px;
            flex: 1;
            max-width: 200px;
        }

        #completion-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border: 2px solid #333;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            text-align: center;
        }

        #completion-modal button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
        }

        #completion-modal button:hover {
            background-color: #555;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }

        h1 { text-align: center; font-size: 2em; margin: 20px; }

        /* ======== VISUAL PROGRESS ======== */
        .progress-badge {
          position: absolute;
          top: -8px;
          right: -8px;
          font-size: 12px;
          padding: 4px 6px;
          border-radius: 999px;
          background: #e0e0e0; /* base */
          color: #000;
          box-shadow: 0 1px 3px rgba(0,0,0,.2);
        }
        .badge-half { background: #ffe08a; }
        .badge-full { background: #a5d6a7; }

        .bubble-0 { border: 2px dashed #bdbdbd; }
        .bubble-1 { border: 2px solid #f2b01e; }
        .bubble-2 { border: 2px solid #2e7d32; box-shadow: 0 0 0 2px rgba(46,125,50,.15); }

        #stepper { display:flex; gap:8px; margin:8px 0; }
        .step-dot { width:10px; height:10px; border-radius:50%; background:#e0e0e0; outline:1px solid #bdbdbd; }
        .step-dot.half { background:#f2b01e; }
        .step-dot.done { background:#2e7d32; }

        /* ======== Prompting animations for audio buttons ======== */
        .audio-button { border-radius: 999px; border: none; padding: 10px 14px; }

        @keyframes pulse {
          0%   { transform: scale(1);    box-shadow: 0 0 0 0 rgba(33,150,243,0.45); }
          70%  { transform: scale(1.08); box-shadow: 0 0 0 12px rgba(33,150,243,0); }
          100% { transform: scale(1);    box-shadow: 0 0 0 0 rgba(33,150,243,0); }
        }
        .pulse { animation: pulse 1.2s ease-in-out infinite; outline: 2px solid rgba(33,150,243,.25); }

        @keyframes highlight {
          0%   { transform: scale(1);    outline: 2px solid rgba(255,193,7,0); }
          30%  { transform: scale(1.06); outline: 3px solid rgba(255,193,7,.8); }
          100% { transform: scale(1);    outline: 2px solid rgba(255,193,7,0); }
        }
        .highlight-once { animation: highlight 900ms ease-in-out 1; }

        @keyframes successFlash {
          0%   { background-color: inherit; }
          20%  { background-color: #a5d6a7; }
          100% { background-color: inherit; }
        }
        .success-flash { animation: successFlash 700ms ease-in-out 1; }

        @media (max-width: 600px) {
            .back-button { font-size: 14px; padding: 8px 16px; }
            .nav-button { font-size: 14px; padding: 8px 16px; }
            .character { flex: 1 1 100%; margin: 10px 0; }
            .character-text { font-size: 16px; }
            #dialogue-container { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div id="header">
        <button class="back-button" onclick="goBack()">Back</button>
        <h1>Hannah Conversation</h1>
        <div id="stepper" aria-label="Dialogues progress"></div>
    </div>

    <div id="dialogue-container">
        <div class="character" id="robot">
            <img id="robot-img" src="../../../../../imagens/robo1_static.png" alt="Robot Lex" />
            <div class="character-text" id="robot-text"></div>
            <div class="audio-button-container">
                <button class="audio-button" id="robot-audio-button">ðŸ”Š</button>
            </div>
        </div>

        <div class="character" id="student">
            <img id="student-img" src="../../../../../imagens/avatar_aluno1.png" alt="Student Avatar" />
            <div class="character-text" id="student-text"></div>
            <div class="audio-button-container">
                <button class="audio-button" id="student-audio-button">ðŸ”Š</button>
            </div>
        </div>
    </div>

    <div id="navigation">
        <button class="nav-button" onclick="previousDialogue()">&lt;&lt; Back</button>
        <button class="nav-button" onclick="nextDialogue()">Forward &gt;&gt;</button>
    </div>

    <div id="overlay"></div>
    <div id="completion-modal">
        <h2>Phase Completed!</h2>
        <p>Congratulations! You have completed this phase.</p>
        <button onclick="closeModal()">Close</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
            authDomain: "hannahenglishcourse.firebaseapp.com",
            projectId: "hannahenglishcourse",
            storageBucket: "hannahenglishcourse.appspot.com",
            messagingSenderId: "449818788486",
            appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
            measurementId: "G-07VVJG9LRS",
            databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);

        // State
        let idleTimer;
        let robotImg = document.getElementById('robot-img');
        let studentImg = document.getElementById('student-img');

        // Parsed dialogue blocks: [{robotText, studentText|null, hasStudent, required}]
        let blocks = [];
        let totalDialogues = 0;      // sum of required utterances (1 or 2 per block)
        let dialoguesRead = 0;
        let userName = "";
        let alertDisplayed = false;
        let currentDialogueIndex = 0;

        // Button refs
        const robotBtn = document.getElementById('robot-audio-button');
        const studentBtn = document.getElementById('student-audio-button');

        // ======== VISUAL PROGRESS STATE ========
        // Per block: { robot: boolean, student: boolean, required: 1|2 }
        let heardStates = [];

        function initHeardStates() {
          heardStates = blocks.map(b => ({ robot: false, student: false, required: b.required }));
          renderStepper();
        }

        function markHeard(idx, who) {
          if (!heardStates[idx]) return;
          if (who === 'robot')  heardStates[idx].robot = true;
          if (who === 'student') heardStates[idx].student = true;

          applyVisualState(idx);

          // Success flash when the block reaches its required count
          const totalHeard = (heardStates[idx].robot?1:0) + (heardStates[idx].student?1:0);
          if (totalHeard >= heardStates[idx].required) successFlashButtons();
        }

        function applyVisualState(idx) {
          const robotBubble   = document.getElementById('robot-text');
          const studentBubble = document.getElementById('student-text');

          const req = heardStates[idx].required;
          const r = heardStates[idx].robot ? 1 : 0;
          const s = heardStates[idx].student ? 1 : 0;
          const total = r + s;

          [robotBubble, studentBubble].forEach(b => {
            b.classList.remove('bubble-0','bubble-1','bubble-2');
          });

          // For badge/border, clamp to [0..2], but use req in label
          const cls = `bubble-${Math.min(total,2)}`;
          robotBubble.classList.add(cls);
          studentBubble.classList.add(cls);

          let badge = robotBubble.querySelector('.progress-badge');
          if (!badge) {
            badge = document.createElement('div');
            badge.className = 'progress-badge';
            robotBubble.appendChild(badge);
          }
          // Badge shows x/req and âœ“ when completed
          badge.textContent = (total >= req) ? `âœ“ ${req}/${req}` : `${total}/${req}`;
          badge.classList.remove('badge-half','badge-full');
          if (total > 0 && total < req) badge.classList.add('badge-half');
          if (total >= req) badge.classList.add('badge-full');

          renderStepper();
        }

        function renderStepper() {
          const wrap = document.getElementById('stepper');
          if (!wrap || !heardStates.length) return;
          wrap.innerHTML = '';
          heardStates.forEach(st => {
            const dot = document.createElement('div');
            dot.className = 'step-dot';
            const total = (st.robot?1:0) + (st.student?1:0);
            if (total >= st.required) {
              dot.classList.add('done');
            } else if (total > 0) {
              dot.classList.add('half');
            }
            wrap.appendChild(dot);
          });
        }

        // ======== Prompting logic for audio buttons ========
        function clearPromptAnimations() {
          robotBtn.classList.remove('pulse','highlight-once','success-flash');
          studentBtn.classList.remove('pulse','highlight-once','success-flash');
          robotBtn.style.outline = '';
          studentBtn.style.outline = '';
        }
        function startRobotPrompt() { robotBtn.classList.add('pulse'); }
        function stopRobotPrompt() { robotBtn.classList.remove('pulse'); }
        function cueStudentOnce() {
          studentBtn.classList.remove('highlight-once');
          // reflow to restart animation
          void studentBtn.offsetHeight;
          studentBtn.classList.add('highlight-once');
        }
        function successFlashButtons() {
          [robotBtn, studentBtn].forEach(btn => {
            btn.classList.remove('success-flash');
            void btn.offsetHeight;
            btn.classList.add('success-flash');
          });
        }

        // AUTH: wait for userName BEFORE initializing dialogue
        firebase.auth().onAuthStateChanged(async function(user) {
            if (user) {
                fetchUserAvatar(user.uid);
                await fetchUserName(user.uid);   // ensures userName is set
                initializeDialogue();            // then load & show dialogue
            } else {
                alert("You are not authenticated. Please log in.");
                window.location.href = '/login.html';
            }
        });

        function goBack() {
            const { level, unit } = getLevelAndUnitFromURL();
            const currentPhase = getPhaseFromURL();
            const userId = firebase.auth().currentUser?.uid;

            if (!userId) {
                alert("You are not authenticated. Please log in.");
                window.location.href = '/login.html';
                return;
            }

            const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}`);
            const nextPhase = parseInt(currentPhase) + 1;

            dbRef.child(`fase${nextPhase}`).once('value')
                .then(snapshot => {
                    const isUnlocked = snapshot.val();
                    if (isUnlocked) {
                        window.history.back();
                    } else {
                        const confirmNavigation = confirm(
                          "The current phase has not been completed.\n\nTo finish, listen to BOTH lines (Robot and Student) in EVERY dialogue block. Use the Back/Forward buttons to navigate and play the audio on each line until it finishes.\n\nAre you sure you want to leave?"
                        );
                        if (confirmNavigation) window.history.back();
                    }
                })
                .catch(() => {
                    alert("An error occurred while checking your progress. Please try again.");
                });
        }

        function speakText(text, callback) {
            clearTimeout(idleTimer);

            const synth = window.speechSynthesis;
            let voices = synth.getVoices();
            let selectedVoice = null;

            function findAndSetVoice() {
                voices = synth.getVoices();
                selectedVoice = voices.find(voice => voice.lang === 'en-US');

                if (!selectedVoice) {
                    if (voices.length === 0) {
                        synth.onvoiceschanged = findAndSetVoice;
                        return;
                    } else if (!alertDisplayed) {
                        alertDisplayed = true;
                        alert("No 'en-US' voice found. Using default voice instead.");
                    }
                }
                createUtterance();
            }

            function createUtterance() {
                const utterance = new SpeechSynthesisUtterance(text.replace(/usuario_nome/g, userName));
                utterance.lang = 'en-US';
                utterance.voice = selectedVoice || null;

                utterance.onstart = () => { robotImg.src = '../../../../../imagens/robo1.gif'; };
                utterance.onend = () => {
                    robotImg.src = '../../../../../imagens/robo1_static.png';
                    if (callback) callback();
                    dialoguesRead++;
                    checkCompletion();
                    startIdleTimer();
                };

                synth.speak(utterance);
            }

            findAndSetVoice();
        }

        function initializeDialogue() {
            const { level, unit } = getLevelAndUnitFromURL();
            const dialoguePath = `../../${level}/${unit}/DataDialogo/dialogo.txt`;

            fetch(dialoguePath)
                .then(res => {
                    if (!res.ok) throw new Error(`Failed to load: ${dialoguePath}`);
                    return res.text();
                })
                .then(text => {
                    // Split by empty line(s), trim lines, allow 1 or 2 lines per block
                    const rawBlocks = text.trim().split(/\n\s*\n/);
                    blocks = rawBlocks.map(b => {
                        const lines = b.split('\n').map(l => l.trim()).filter(Boolean);
                        const robotText = (lines[0] || '').replace(/usuario_nome/g, userName);
                        const studentText = (lines[1] ? lines[1].replace(/usuario_nome/g, userName) : null);
                        const hasStudent = !!studentText;
                        return { robotText, studentText, hasStudent, required: hasStudent ? 2 : 1 };
                    });

                    totalDialogues = blocks.reduce((sum, b) => sum + b.required, 0);
                    initHeardStates();
                    updateDialogue(0);
                })
                .catch(() => {
                    alert("Failed to load the dialogue. Please check the file path or try again later.");
                });
        }

        function getLevelAndUnitFromURL() {
            const params = new URLSearchParams(window.location.search);
            const level = params.get('level');
            const unit  = params.get('unit');
            if (!level || !unit) {
                alert("Missing level or unit parameters in the URL.");
                throw new Error("Missing query params");
            }
            return { level, unit };
        }

        function updateDialogue(index) {
            if (index < 0 || index >= blocks.length) return;
            currentDialogueIndex = index;

            const block = blocks[index];

            // Set texts
            document.getElementById('robot-text').textContent = block.robotText || '';
            document.getElementById('student-text').textContent = block.studentText || '';

            // Show/hide student UI depending on existence of student's line
            const studentArea = document.getElementById('student');
            const studentTextEl = document.getElementById('student-text');
            const studentBtnWrap = document.getElementById('student-audio-button').parentElement;

            if (block.hasStudent) {
                studentArea.style.visibility = 'visible';
                studentTextEl.style.display = '';
                studentBtnWrap.style.display = '';
            } else {
                // hide bubble and button if no student line in this block
                studentTextEl.style.display = 'none';
                studentBtnWrap.style.display = 'none';
                studentArea.style.visibility = 'visible'; // keep avatar visible if you want; change to 'hidden' to hide avatar too
            }

            // Clear prompts, start robot prompt every time
            clearPromptAnimations();
            startRobotPrompt();

            // ROBOT button
            robotBtn.onclick = () => {
                stopRobotPrompt();
                speakText(block.robotText, () => {
                    markHeard(index, 'robot');
                    if (block.hasStudent) cueStudentOnce();
                });
            };

            // STUDENT button only if exists
            if (block.hasStudent) {
                studentBtn.onclick = () => {
                    studentBtn.classList.remove('highlight-once');
                    speakText(block.studentText, () => {
                        markHeard(index, 'student');
                    });
                };
            } else {
                studentBtn.onclick = null;
            }

            applyVisualState(index);
            startIdleTimer();
        }

        function previousDialogue() {
            if (currentDialogueIndex > 0) {
                currentDialogueIndex--;
                updateDialogue(currentDialogueIndex);
            }
        }

        function nextDialogue() {
            if (currentDialogueIndex < blocks.length - 1) {
                currentDialogueIndex++;
                updateDialogue(currentDialogueIndex);
            }
        }

        function startIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(function () {
                robotImg.src = '../../../../../imagens/robo2.gif';
                setTimeout(function () {
                    robotImg.src = '../../../../../imagens/robo1_static.png';
                }, 10000);
            }, 15000);
        }

        function checkCompletion() {
            if (dialoguesRead >= totalDialogues) {
                showModal();
                ensureUserIsAuthenticated(updateNextPhase);
            }
        }

        function showModal() {
            document.getElementById('completion-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('completion-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function fetchUserAvatar(userId) {
            const avatarRef = firebase.database().ref(`usuarios/${userId}`);
            avatarRef.once('value')
                .then(snapshot => {
                    const userData = snapshot.val();
                    if (userData && userData.avatar) {
                        const avatarUrl = `../../../../imagens/${userData.avatar}`;
                        const img = new Image();
                        img.src = avatarUrl;
                        img.onload = () => { studentImg.src = avatarUrl; };
                    }
                })
                .catch(() => {});
        }

        async function fetchUserName(userId) {
            try {
                const snapshot = await firebase.database().ref(`usuarios/${userId}`).once('value');
                const userData = snapshot.val();
                userName = (userData && userData.nome) ? userData.nome : "Aluno";
                return userName;
            } catch (e) {
                userName = "Aluno";
                return userName;
            }
        }

        function ensureUserIsAuthenticated(callback) {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) callback(user.uid);
            });
        }

        function updateNextPhase(userId) {
            const currentPhase = getPhaseFromURL();
            const { level, unit } = getLevelAndUnitFromURL();
            const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}`);
            try {
                if (currentPhase === "last") {
                    const nextUnit = `Unit${parseInt(unit.replace('Unit', '')) + 1}`;
                    dbRef.child(nextUnit).set({ fase1: true });
                } else if (currentPhase === "end") {
                    const nextLevel = `Level${parseInt(level.replace('Level', '')) + 1}`;
                    firebase.database().ref(`usuarios/${userId}/progresso/${nextLevel}/Unit1`).set({ fase1: true });
                } else {
                    const nextPhase = parseInt(currentPhase) + 1;
                    dbRef.update({ [`fase${currentPhase}`]: true, [`fase${nextPhase}`]: true });
                }
            } catch (error) { /* noop */ }
        }

        function getPhaseFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('fase');
        }
    </script>
</body>
</html>
