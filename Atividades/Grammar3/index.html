<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indefinite Articles - The Creation Story</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            background-image: url('../../../imagens/fundo.png');
            background-repeat: repeat;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .check-btn {
            padding: 8px 15px;
            background-color: white;
            color: black;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }
        .check-btn:hover {
            background-color: #f0f0f0;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.2);
        }
        .back-button {            
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        .page-title {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            color: #2c3e50;
            margin-top: 20px;
        }
        .subtitle {
            font-size: 1.3rem;
            font-weight: bold;
            text-transform: uppercase;
            text-align: left;
            margin: 10px 0;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 2rem;
            margin-top: 70px;
        }
        h2 {
            background-color: #28a745;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 1.5rem;
            text-align: center;
        }
        .section {
            background-color: #d4edda;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 5px;
        }
        .section p {
            margin: 0;
            padding: 10px 0;
            font-size: 1.2rem;
        }
        .btn-download {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #218838;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 20px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .btn-download:hover {
            background-color: #1e7e34;
        }
        .image-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .button-container button {
            background-color: transparent;
            border: none;
            margin: 5px;
            cursor: pointer;
        }
        .button-container img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }
        .button-container img:hover {
            transform: scale(1.1);
        }
        .answer {
            font-weight: bold;
            color: green;
            margin-left: 10px;
            display: none;
        }
        .answer-input {
            width: 100px;
            padding: 5px;
            margin-left: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        .show-answer-btn {
            padding: 8px 15px;
            background-color: white;
            color: black;
            border: 1px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }
        .show-answer-btn:hover {
            background-color: #f0f0f0;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.2);
        }
        .see-answer-btn {
            padding: 8px 15px;
            background-color: #f0ad4e;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            margin-left: 10px;
        }
        .see-answer-btn:hover {
            background-color: #ec971f;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.2);
        }

        /* ===================================== */
        /* ESTILO PARA A TABELA DA SEÇÃO GRAMMAR */
        /* ===================================== */
        .grammar-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .grammar-table th,
        .grammar-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        .grammar-table th {
            background-color: #28a745;
            color: #fff;
        }
        .grammar-table td {
            background-color: white;
        }
    </style>
</head>
<body style="visibility:hidden">

<div id="completionModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:9999;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:400px; margin:100px auto; text-align:center;">
        <h2>Congratulations!</h2>
        <p>You have successfully completed the activity!</p>
        <button onclick="closeModal()">OK</button>
    </div>
</div>

<div class="container">

    <div style="margin-bottom: 15px;">
        <a href="javascript:history.back()" class="back-button">Back</a>
    </div>

    <h1 id="title"></h1>

    <div class="image-container">
        <img id="main-image" src="image.png" alt="Example Image">
    </div>

    <div class="button-container">
        <!-- Botões dos professores serão carregados aqui -->
    </div>

    <div id="content">
        <!-- Dynamic content will be loaded here -->
    </div>

    <button class="btn-download" onclick="generatePDF()">Download as PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // Configuração do Firebase (inclui sua apikey)
    const firebaseConfig = {
        apiKey: "AIzaSyDGgo2H_hDKXF88xN7XLFNUj8ikMY7Xdc",
        authDomain: "hannahenglishcourse.firebaseapp.com",
        projectId: "hannahenglishcourse",
        storageBucket: "hannahenglishcourse.appspot.com",
        messagingSenderId: "449818788486",
        appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
        measurementId: "G-07VVJG9LRS",
        databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

firebase.auth().onAuthStateChanged(function(user) {
    if (user && user.uid) {
        console.log('✅ Usuário autenticado:', user.uid);
        document.body.style.visibility = 'visible';
        initializeAppContent();
    } else {
        console.warn('⛔ Nenhum usuário autenticado. Redirecionando para login...');
        window.location.href = 'https://hannahenglishcourse.netlify.app/formulario/login';
    }
});

    let totalAnswers = 0;
    let clickedAnswers = 0;
    let isTextFileLoaded = false;

function initializeAppContent() {
    loadTextFile();
    setupBackButton();
    updateImagePath();
    loadProfessorButtons();
}

    function getLevelAndUnitFromURL() {
        const params = new URLSearchParams(window.location.search);
        return {
            level: params.get('level'),
            unit: params.get('unit')
        };
    }

    function loadTextFile() {
        if (isTextFileLoaded) return;
        totalAnswers = 0;

        const { level, unit } = getLevelAndUnitFromURL();
        const filePath = `../../${level}/${unit}/DataGrammar3/texto.txt`;

        fetch(filePath)
            .then(response => {
                if (!response.ok) throw new Error(response.statusText);
                return response.text();
            })
            .then(data => {
                const contentDiv = document.getElementById('content');
                let html = '', inTable = false, isHeader = true;

                data.split('\n').forEach(line => {
                    const t = line.trim();
                    if (t.startsWith('Title: ')) {
                        document.getElementById('title').innerText = t.replace('Title: ', '');
                        document.getElementById('title').classList.add('page-title');
                    }
                    else if (t.startsWith('## ')) {
                        html += `<h3 class="subtitle">${t.slice(3).toUpperCase()}</h3>`;
                    }
else if (t.startsWith('#IMG:')) {
    const imageName = t.split(':')[1].trim();
    const lessonPath = filePath;
    const basePath = lessonPath.substring(0, lessonPath.lastIndexOf('/'));
    const imagePathPrimary = `${basePath}/${imageName}`;
    const imagePathSecondary = `${basePath}/../${imageName}`;

    html += `
    <img src="${imagePathPrimary}" 
         onerror="this.onerror=null;this.src='${imagePathSecondary}'" 
         alt="${imageName}" 
         style="max-width: 100%; display: block; margin: 20px auto; border-radius: 8px;" />
`;
}
                    else if (t.startsWith('# ')) {
                        if (inTable) { html += '</div>'; inTable = false; }
                        html += `<div class="section"><h2>${t.slice(2)}</h2>`;
                    }
                    else if (t.toLowerCase() === 'tablestart') {
                        inTable = true; isHeader = true;
                        html += '<table class="grammar-table">';
                    }
                    else if (t.toLowerCase() === 'tableend') {
                        inTable = false;
                        html += '</tbody></table>';
                    }
                    else if (inTable) {
                        const cols = t.split('|').map(c => c.trim());
                        if (isHeader) {
                            html += '<thead><tr>' +
                                    cols.map(c => `<th>${c}</th>`).join('') +
                                    '</tr></thead><tbody>';
                            isHeader = false;
                        } else {
                            html += '<tr>' +
                                    cols.map(c => `<td>${c}</td>`).join('') +
                                    '</tr>';
                        }
                    }
                    else if (t.includes('[Answer:')) {
                        const [q, a] = t.split('[Answer:');
                        const ans = a.replace(']', '').trim();
                        const qHtml = q.replace('___', '<input type="text" class="answer-input" placeholder="Type here..." />');
                        html += `<p>${qHtml}
                                    <button class="check-btn" data-answer="${ans}" onclick="checkAnswer(this)">Check</button>
                                    <span class="answer" style="display:none;">${ans}</span>
                                 </p>`;
                        totalAnswers++;
                    }
                    else {
                        const f = t
                            .replace(/\*\*\*(.*?)\*\*\*/g, '<b><i>$1</i></b>')
                            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                            .replace(/\*(.*?)\*/g, '<i>$1</i>');
                        html += `<p>${f}</p>`;
                    }
                });

                contentDiv.innerHTML = html;
                isTextFileLoaded = true;
            })
            .catch(console.error);
    }

    function checkAnswer(btn) {
    const inp = btn.parentNode.querySelector('.answer-input');
    const correct = btn.getAttribute('data-answer').toLowerCase();

    if (inp.value.trim().toLowerCase() === correct) {
        inp.style.background = 'lightgreen';
        if (!btn.disabled) {
            clickedAnswers++;
            btn.disabled = true;
        }
    } else {
        inp.style.background = 'lightcoral';
if (!btn.parentNode.querySelector('.see-answer-btn')) {
    const b = document.createElement('button');
    b.className = 'see-answer-btn';
    b.textContent = 'See Answer';
    b.onclick = () => {
        const ansSpan = btn.parentNode.querySelector('.answer');
        if (ansSpan) ansSpan.style.display = 'inline';
        b.disabled = true;
    };
    btn.parentNode.appendChild(b);
}        
    }

    if (clickedAnswers === totalAnswers) {
        showCompletionMessage();
    }
}

   function closeModal() {
       document.getElementById('completionModal').style.display = 'none';
   }
    
   function showCompletionMessage() {
    document.getElementById('completionModal').style.display = 'block';

    // → grava no Firebase que esta fase (level/unit) foi completada
    const { level, unit } = getLevelAndUnitFromURL();
   firebase.auth().onAuthStateChanged(user => {
    if (user) {
        saveProgress(level, unit);
    } else {
        console.warn('❌ Usuário não logado no momento de salvar.');
    }
});
}

function saveProgress(level, unit) {
    const user = firebase.auth().currentUser;
    if (!user) {
        console.warn('Usuário não autenticado — não será salvo progresso');
        return;
    }

    const userId = user.uid;
    const currentPhase = getPhaseFromURL();
    const phaseKey = currentPhase ? `fase${currentPhase}` : 'fase1'; // padrão para fase1 se não tiver na URL

    firebase.database()
        .ref(`usuarios/${userId}/progresso/${level}/${unit}`)
        .update({ [phaseKey]: true })
        .then(() => console.log(`✅ Progresso salvo em usuarios/${userId}/progresso/${level}/${unit}/${phaseKey}`))
        .catch(error => console.error('Erro ao salvar progresso:', error));
}

    function generatePDF() {
        const { level, unit } = getLevelAndUnitFromURL();
        const filePath = `../../${level}/${unit}/DataGrammar3/texto.txt`;

        fetch(filePath)
            .then(r => r.text())
            .then(data => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 20, margin = 20, maxW = 170;
                doc.addImage('Logo.png','PNG',90,y,30,30); y += 40;

                data.split('\n').forEach(line => {
                    const txt = line.replace(/\[Answer:.*?\]/g,'');
                    doc.setFontSize(line.startsWith('Title: ')?16:12);
                    const lines = doc.splitTextToSize(txt, maxW);
                    doc.text(lines, margin, y);
                    y += lines.length * 10;
                    if (y > doc.internal.pageSize.height - margin) {
                        doc.addPage();
                        y = margin;
                    }
                });
                doc.save('grammar_lesson_creation.pdf');
            })
            .catch(console.error);
    }

    function setupBackButton() {
        const backButton = document.querySelector('.back-button');
        backButton.addEventListener('click', async e => {
            e.preventDefault();
            history.back();
        });
    }

    function loadProfessorButtons() {
        const buttonContainer = document.querySelector('.button-container');
        buttonContainer.innerHTML = '';
        const { level, unit } = getLevelAndUnitFromURL();

        for (let i = 1; i <= 10; i++) {
            const img = new Image();
            img.src = `professores/professor${i}.png`;
            img.alt = `Professor ${i}`;
            img.onload = () => {
                const btn = document.createElement('button');
                btn.appendChild(img);
                btn.onclick = () => {
                    // monta o caminho do lesson.txt daquela aula
                    const lessonPath = `../../${level}/${unit}/DataGrammar3/aulas/aula${i}/lesson.txt`;
                    // redireciona para o index na pasta Aulas_traduzidas,
                    // que vai ler esse lesson.txt via URL
                    window.location.href =
                        `../../../Atividades/Aulas_traduzidas/index.html?lessonPath=${encodeURIComponent(lessonPath)}` +
                        `&level=${level}&unit=${unit}`;
                };
                buttonContainer.appendChild(btn);
            };
        }
    }

    function updateImagePath() {
        const { level, unit } = getLevelAndUnitFromURL();
        const path = `../../${level}/${unit}/DataGrammar3/image.png`;
        const img = document.getElementById('main-image');
        fetch(path)
            .then(r => r.ok ? img.src = path : Promise.reject())
            .catch(() => img.src = 'default-image.png');
    }    

function getPhaseFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('fase');
}
</script>
</body>
</html>
