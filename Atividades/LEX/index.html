<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Talk to Robot Samuel</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      display:flex;flex-direction:column;align-items:center;min-height:100vh;
      background-image:url('../../../../imagens/fundo.png');background-repeat:repeat;
      margin:0;padding:20px;
    }
    h1{margin-top:24px;}
    #robot-img{width:200px}
    input[type="range"]{-webkit-appearance:none;width:200px;height:10px;
      background:linear-gradient(to right,green var(--progress,50%),#ccc var(--progress,50%),#ccc 100%);
      border-radius:5px;outline:none;transition:background .2s}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:green;border-radius:50%;cursor:pointer;border:1px solid #000;margin-top:-5px}
    #speak-button{background:#0a892d;color:#fff;font-size:16px;padding:10px 20px;border:none;border-radius:8px;cursor:pointer}
    #speak-button.listening{background:#ff9300;animation:pulse 1s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    #back-button{margin-top:10px;background:#000;color:#fff;font-size:16px;padding:10px 20px;border:none;border-radius:8px;cursor:pointer}
    #loader-message{font-size:14px;font-style:italic;margin-top:10px;color:red}
    /* token bar */
    #token-bar{width:80%;max-width:420px;margin-top:20px;text-align:center;display:none}
    #token-progress{width:100%;height:12px;background:#ddd;border-radius:8px;overflow:hidden}
    #token-progress-fill{height:100%;width:100%;background:green;transition:width .3s ease}
    #token-info-text{font-size:14px;margin-top:6px}
    #token-warning{color:orange;font-weight:bold;margin-top:4px}
    #token-limit{color:red;font-weight:bold;margin-top:8px}
  </style>
</head>
<body>
  <h1>Talk to Robot Samuel</h1>
  <img id="robot-img" src="../../imagens/robo1_static.png" alt="Robot"/>

  <!-- Tokens -->
  <div id="token-bar">
    <div id="token-progress"><div id="token-progress-fill"></div></div>
    <div id="token-info-text"></div>
    <div id="token-warning"></div>
    <div id="token-limit"></div>
  </div>

  <!-- Playback speed -->
  <div style="margin-top:20px;text-align:center;">
    <label for="voice-speed" style="color:green;">Playback Speed:</label>
    <input id="voice-speed" type="range" min="0.5" max="2" step="0.1" value="1"/>
    <span id="speed-display" style="color:green;">1x</span>
  </div>

  <p id="message" style="visibility:hidden;">Loading...</p>
  <p id="loader-message" style="display:none;"></p>

  <button id="speak-button" style="display:none;">Press to Start</button>
  <button id="back-button">Back</button>

  <div id="fallback-input" style="display:none;margin-top:20px;">
    <input type="text" id="user-input" placeholder="Type your message...">
    <button id="send-button">Send</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain:"hannahenglishcourse.firebaseapp.com",
      databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"hannahenglishcourse",
      storageBucket:"hannahenglishcourse.appspot.com",
      messagingSenderId:"449818788486",
      appId:"1:449818788486:web:8a49d3f68591e6fb3f0707"
    };
    firebase.initializeApp(firebaseConfig);

    // DOM
    const messageElement = document.getElementById("message");
    const robotImg = document.getElementById("robot-img");
    const speakButton = document.getElementById("speak-button");
    const backButton = document.getElementById("back-button");
    const speedSlider = document.getElementById("voice-speed");
    const speedDisplay = document.getElementById("speed-display");
    const loaderMessage = document.getElementById("loader-message");
    const tokenBar = document.getElementById("token-bar");
    const tokenProgressFill = document.getElementById("token-progress-fill");
    const tokenInfoText = document.getElementById("token-info-text");
    const tokenWarning = document.getElementById("token-warning");
    const tokenLimit = document.getElementById("token-limit");

    // Images
    const ROBOT_GIF = "../../imagens/robo1.gif";
    const ROBOT_STATIC = "../../imagens/robo1_static.png";
    const ROBOT_ALTERNATE = "../../imagens/robo2.gif";

    // State
    let recognition, isSpeaking=false, userId=null, chatHistory=[];
    let initialGreeting = null; // <- primeira fala vinda do /api/start
    let audioUnlocked = false;

    // UI helpers
    function updateSliderBackground(){
      const value=((speedSlider.value-speedSlider.min)/(speedSlider.max-speedSlider.min))*100;
      speedSlider.style.setProperty("--progress",`${value}%`);
      speedDisplay.textContent=`${speedSlider.value}x`;
    }
    speedSlider.addEventListener("input",updateSliderBackground);
    window.addEventListener("DOMContentLoaded",updateSliderBackground);
    backButton.addEventListener("click",()=>window.history.back());

    function updateTokenUI(info){
      if(!info||!info.unitCap)return;
      tokenBar.style.display="block";
      const pct=Math.max(0,(info.remainingUnit/info.unitCap)*100);
      tokenProgressFill.style.width=pct+"%";
      tokenInfoText.textContent=`Remaining: ${info.remainingUnit}/${info.unitCap} | Wallet: ${info.walletBalance}`;
      tokenWarning.textContent="";
      tokenLimit.textContent="";
      if(info.remainingUnit<80&&info.remainingUnit>0){
        tokenWarning.textContent="⚠️ Almost finished! About 2 replies left.";
      }
      if(!info.canChat||info.remainingUnit<=0){
        tokenLimit.textContent="You reached the limit for this unit. Do another activity or come back later.";
        speakButton.disabled=true;
      } else {
        speakButton.disabled=false;
      }
    }

    // Speech Recognition
    function checkSpeechRecognitionSupport(){
      if(!('SpeechRecognition'in window||'webkitSpeechRecognition'in window)){
        const fallback=document.getElementById("fallback-input");
        if(fallback) fallback.style.display='block';
        speakButton.style.display='none';
        messageElement.innerText="Speech recognition is not supported or is disabled.";
        messageElement.style.visibility='visible';
        return false;
      }
      return true;
    }
    function setupSpeechRecognition(){
      if(!checkSpeechRecognitionSupport()) return;
      recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
      recognition.lang="en-US";
      recognition.onstart=()=>{
        isSpeaking=true;
        speakButton.classList.add("listening");
        speakButton.innerText="Listening...";
      };
      recognition.onend=()=>{
        isSpeaking=false;
        speakButton.classList.remove("listening");
        speakButton.innerText="Press to Speak";
      };
      recognition.onresult=async (event)=>{
        const userSpeech=event.results[0][0].transcript;
        messageElement.style.visibility="visible";
        messageElement.innerText=`You said: "${userSpeech}"`;
        if(!userId){ alert("User ID missing. Please log in again."); return; }
        try{
          const resp=await fetch('https://hannah-backend.onrender.com/api/chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ uid:userId, message:userSpeech, chatHistory })
          });
          const data=await resp.json();
          if(!data.response) return;
          chatHistory=data.chatHistory;
          messageElement.innerText=data.response;
          if(data.tokenInfo) updateTokenUI(data.tokenInfo);
          if(data.tokenInfo && data.tokenInfo.canChat===false) return;
          speakUsingGoogleTTS(data.response);
        }catch(e){
          console.error(e);
          messageElement.innerText="Error communicating with the server.";
        }
      };
    }

    // Audio unlock (autoplay policy)
    async function unlockAudioOnce(){
      if(audioUnlocked) return;
      try{
        const AC=window.AudioContext||window.webkitAudioContext;
        if(AC){
          const ctx=new AC();
          if(ctx.state==='suspended') await ctx.resume();
        }
      }catch(e){ console.warn('AudioContext unlock failed:', e); }
      audioUnlocked=true;
    }

    // TTS
    async function speakUsingGoogleTTS(text){
      try{
        const playbackSpeed=parseFloat(speedSlider.value)||1.0;
        const resp=await fetch('https://hannah-backend.onrender.com/api/tts',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text, speakingRate: playbackSpeed })
        });
        if(!resp.ok) return;
        const data=await resp.json();
        const audioBase64=data.audioContent;
        if(!audioBase64) return;
        const audio=new Audio(URL.createObjectURL(base64ToBlob(audioBase64,'audio/mp3')));
        audio.onplaying=()=>{ isSpeaking=true; robotImg.src=ROBOT_GIF; speakButton.disabled=true; speakButton.innerText="Samuel is talking"; };
        audio.onended=()=>{ isSpeaking=false; robotImg.src=ROBOT_STATIC; speakButton.disabled=false; speakButton.innerText="Press to Speak"; };
        await audio.play();
      }catch(e){ console.error("TTS error:", e); }
    }
    function base64ToBlob(base64, type){
      const bytes=atob(base64); const arr=new Uint8Array(bytes.length);
      for(let i=0;i<bytes.length;i++) arr[i]=bytes.charCodeAt(i);
      return new Blob([arr],{type});
    }

    // Fallback typed
    document.addEventListener("DOMContentLoaded",()=>{
      const userInput=document.getElementById("user-input");
      const sendButton=document.getElementById("send-button");
      if(sendButton){
        sendButton.addEventListener("click",async ()=>{
          const userMessage=userInput.value.trim();
          if(!userMessage) return;
          messageElement.style.visibility="visible";
          messageElement.innerText=`You said: "${userMessage}"`;
          userInput.value="";
          if(!userId) return;
          try{
            const resp=await fetch('https://hannah-backend.onrender.com/api/chat',{
              method:'POST',headers:{'Content-Type':'application/json'},
              body:JSON.stringify({ uid:userId, message:userMessage, chatHistory })
            });
            const data=await resp.json();
            if(data.response){
              chatHistory=data.chatHistory;
              messageElement.innerText=data.response;
              if(data.tokenInfo) updateTokenUI(data.tokenInfo);
              speakUsingGoogleTTS(data.response);
            }
          }catch(e){
            console.error(e);
            messageElement.innerText="Error communicating with the server.";
          }
        });
      }
    });

    // Init
    async function initializeConversation(){
      firebase.auth().onAuthStateChanged(async (user)=>{
        if(!user){
          messageElement.innerText="Redirecting to login page...";
          messageElement.style.visibility="visible";
          window.location.href="https://hannahenglishcourse.vercel.app/Formulario/login.html";
          return;
        }
        userId=user.uid;

        const params=new URLSearchParams(window.location.search);
        const level=params.get('level')||'Level1';
        const unit=params.get('unit')||'Unit1';

        try{
          loaderMessage.style.display="block";
          loaderMessage.innerText="Waking up Robot Samuel...";

          const r=await fetch(`https://hannah-backend.onrender.com/api/start?uid=${userId}&level=${level}&unit=${unit}`);
          if(!r.ok) throw new Error("Failed to initialize conversation.");
          const data=await r.json();

          chatHistory=data.chatHistory||[];
          initialGreeting=data.response || "Hello! Shall we begin?"; // guarda a 1ª fala
          messageElement.innerText = initialGreeting;

          loaderMessage.style.display="none";
          messageElement.style.visibility="hidden";
          speakButton.style.display="block";

          if(data.tokenInfo) updateTokenUI(data.tokenInfo);

          // Botão (fluxo antigo): primeiro clique fala a saudação, depois ativa STT
          if(!speakButton.hasAttribute('data-initialized')){
            speakButton.setAttribute('data-initialized','true');
            speakButton.addEventListener("click", async ()=>{
              await unlockAudioOnce();
              if (speakButton.innerText === "Press to Start") {
                messageElement.style.visibility = "visible";
                speakUsingGoogleTTS(initialGreeting);
                speakButton.innerText = "Press to Speak";
              } else {
                if (recognition) recognition.start();
              }
            });
          }
        }catch(error){
          console.error("Init error:", error);
          loaderMessage.style.display="none";
          messageElement.innerText="An unexpected error occurred. Try again later.";
          messageElement.style.visibility="visible";
          speakButton.disabled=true;
        }
      });
    }

    window.onload=()=>{ setupSpeechRecognition(); initializeConversation(); };
  </script>
</body>
</html>
