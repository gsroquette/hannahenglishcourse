<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Talk to Robot Samuel</title>
<style>
  body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      background-image: url('../../../../imagens/fundo.png');
      background-repeat: repeat;
      margin: 0;
      padding: 20px;
  }
  #robot-img { width: 200px; }
  .green-text { color: green; }
  input[type="range"] {
      -webkit-appearance: none;
      width: 200px;
      height: 10px;
      background: linear-gradient(to right, green var(--progress, 50%), #ccc var(--progress, 50%), #ccc 100%);
      border-radius: 5px;
      outline: none;
      transition: background 0.2s;
  }
  input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; height: 20px;
      background: green;
      border-radius: 50%; border: 1px solid #000;
      cursor: pointer; margin-top: -5px;
  }
  #speak-button {
      background-color: green; color: white;
      font-size: 16px; padding: 10px 20px;
      border: none; border-radius: 5px;
      cursor: pointer;
  }
  #speak-button.listening { background-color: orange; animation: pulse 1s infinite; }
  @keyframes pulse { 0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);} }
  #back-button {
      margin-top: 10px; background-color: black; color: white;
      font-size: 16px; padding: 10px 20px; border: none;
      border-radius: 5px; cursor: pointer;
  }
  #back-button:hover { background-color: #333; }
  #loader-message { font-size: 14px; font-style: italic; margin-top: 10px; color: red; }
  #token-bar { width: 80%; max-width: 400px; margin-top: 20px; text-align: center; }
  #token-progress {
      width: 100%; height: 12px;
      background: #ddd; border-radius: 8px; overflow: hidden;
  }
  #token-progress-fill {
      height: 100%; width: 100%;
      background-color: green; transition: width 0.3s ease;
  }
  #token-info-text { font-size: 14px; margin-top: 5px; color: #333; }
  #token-warning { color: orange; font-weight: bold; margin-top: 5px; }
  #token-limit { color: red; font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>
  <h1>Talk to Robot Samuel</h1>
  <img id="robot-img" src="../../imagens/robo1_static.png" alt="Robot">

  <div id="token-bar" style="display:none;">
    <div id="token-progress"><div id="token-progress-fill"></div></div>
    <div id="token-info-text"></div>
    <div id="token-warning"></div>
    <div id="token-limit"></div>
  </div>

  <div style="margin-top:20px;text-align:center;">
      <label for="voice-speed" style="color:green;">Playback Speed:</label>
      <input id="voice-speed" type="range" min="0.5" max="2" step="0.1" value="1">
      <span id="speed-display" style="color:green;">1x</span>
  </div>

  <p id="message" style="visibility:hidden;">Loading...</p>
  <p id="loader-message" style="display:none;"></p>

  <button id="speak-button" style="display:none;">Press to Start</button>
  <button id="back-button">Back</button>

  <div id="fallback-input" style="display:none;margin-top:20px;">
      <input type="text" id="user-input" placeholder="Type your message...">
      <button id="send-button">Send</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
  const firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
  };
  firebase.initializeApp(firebaseConfig);

  const messageElement = document.getElementById("message");
  const robotImg = document.getElementById("robot-img");
  const speakButton = document.getElementById("speak-button");
  const backButton = document.getElementById("back-button");
  const speedSlider = document.getElementById("voice-speed");
  const speedDisplay = document.getElementById("speed-display");
  const loaderMessage = document.getElementById("loader-message");
  const tokenBar = document.getElementById("token-bar");
  const tokenProgressFill = document.getElementById("token-progress-fill");
  const tokenInfoText = document.getElementById("token-info-text");
  const tokenWarning = document.getElementById("token-warning");
  const tokenLimit = document.getElementById("token-limit");

  const ROBOT_GIF = "../../imagens/robo1.gif";
  const ROBOT_STATIC = "../../imagens/robo1_static.png";
  const ROBOT_ALTERNATE = "../../imagens/robo2.gif";

  let recognition, isSpeaking=false, staticTime=0, alternateTimeout;
  let userId=null, chatHistory=[], tokenInfo={};

  function updateSliderBackground(){
      const value=((speedSlider.value-speedSlider.min)/(speedSlider.max-speedSlider.min))*100;
      speedSlider.style.setProperty("--progress",`${value}%`);
      speedDisplay.textContent=`${speedSlider.value}x`;
  }
  speedSlider.addEventListener("input",updateSliderBackground);
  window.addEventListener("DOMContentLoaded",updateSliderBackground);
  backButton.addEventListener("click",()=>window.history.back());

  function updateTokenUI(info){
      if(!info||!info.unitCap)return;
      tokenBar.style.display="block";
      const pct=Math.max(0,(info.remainingUnit/info.unitCap)*100);
      tokenProgressFill.style.width=pct+"%";
      tokenInfoText.textContent=`Remaining: ${info.remainingUnit}/${info.unitCap} | Wallet: ${info.walletBalance}`;
      tokenWarning.textContent="";
      tokenLimit.textContent="";
      if(info.remainingUnit<80&&info.remainingUnit>0){
          tokenWarning.textContent="⚠️ Almost finished! About 2 replies left.";
      }
      if(!info.canChat||info.remainingUnit<=0){
          tokenLimit.textContent="You reached the limit for this unit. Do another activity or come back later.";
          speakButton.disabled=true;
      } else speakButton.disabled=false;
  }

  function setupSpeechRecognition(){
      if(!('SpeechRecognition'in window||'webkitSpeechRecognition'in window)){
          document.getElementById("fallback-input").style.display='block';
          speakButton.style.display='none';
          messageElement.innerText="Speech recognition is not supported.";
          messageElement.style.visibility='visible'; return;
      }
      recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
      recognition.lang="en-US";
      recognition.onstart=()=>{isSpeaking=true;speakButton.classList.add("listening");speakButton.innerText="Listening...";};
      recognition.onend=()=>{isSpeaking=false;speakButton.classList.remove("listening");speakButton.innerText="Press to Speak";};
      recognition.onresult=async(e)=>{
          const userSpeech=e.results[0][0].transcript;
          messageElement.style.visibility="visible";
          messageElement.innerText=`You said: "${userSpeech}"`;
          if(!userId)return alert("User ID missing.");
          try{
              const resp=await fetch('https://hannah-backend.onrender.com/api/chat',{
                  method:'POST',headers:{'Content-Type':'application/json'},
                  body:JSON.stringify({uid:userId,message:userSpeech,chatHistory})
              });
              const data=await resp.json();
              if(!data.response)return;
              chatHistory=data.chatHistory;
              messageElement.innerText=data.response;
              if(data.tokenInfo)updateTokenUI(data.tokenInfo);
              if(data.tokenInfo&&!data.tokenInfo.canChat)return;
              speakUsingGoogleTTS(data.response);
          }catch(err){console.error(err);messageElement.innerText="Server error.";}
      };
  }

  async function speakUsingGoogleTTS(text){
      const playbackSpeed=parseFloat(speedSlider.value)||1.0;
      const r=await fetch('https://hannah-backend.onrender.com/api/tts',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({text,speakingRate:playbackSpeed})
      });
      const d=await r.json(); if(!d.audioContent)return;
      const audio=new Audio(URL.createObjectURL(base64ToBlob(d.audioContent,'audio/mp3')));
      audio.onplaying=()=>{isSpeaking=true;robotImg.src=ROBOT_GIF;speakButton.innerText="Samuel is talking";speakButton.disabled=true;};
      audio.onended=()=>{isSpeaking=false;robotImg.src=ROBOT_STATIC;speakButton.innerText="Press to Speak";speakButton.disabled=false;};
      audio.play().catch(e=>console.error(e));
  }
  function base64ToBlob(b64,t){const b=atob(b64);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return new Blob([a],{type:t});}

  async function initializeConversation(){
      firebase.auth().onAuthStateChanged(async user=>{
          if(!user){window.location.href="https://hannahenglishcourse.vercel.app/Formulario/login.html";return;}
          userId=user.uid;
          const urlParams=new URLSearchParams(window.location.search);
          const level=urlParams.get('level')||'Level1';
          const unit=urlParams.get('unit')||'Unit1';
          loaderMessage.style.display="block";
          loaderMessage.innerText="Waking up Robot Samuel...";
          try{
              const r=await fetch(`https://hannah-backend.onrender.com/api/start?uid=${userId}&level=${level}&unit=${unit}`);
              const d=await r.json();
              chatHistory=d.chatHistory||[];
              messageElement.innerText=d.response;
              loaderMessage.style.display="none";
              messageElement.style.visibility="hidden";
              speakButton.style.display="block";
              if(d.tokenInfo)updateTokenUI(d.tokenInfo);
              speakButton.addEventListener("click",()=>{
                  if(tokenInfo&&!tokenInfo.canChat)return;
                  if(speakButton.innerText==="Press to Start"){messageElement.style.visibility="visible";speakUsingGoogleTTS(d.response);speakButton.innerText="Press to Speak";}
                  else if(recognition)recognition.start();
              });
          }catch(e){console.error(e);loaderMessage.style.display="none";messageElement.innerText="Initialization error.";messageElement.style.visibility="visible";}
      });
  }

  window.onload=()=>{setupSpeechRecognition();initializeConversation();};
  </script>
</body>
</html>
