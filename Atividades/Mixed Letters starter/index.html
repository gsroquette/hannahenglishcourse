<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hannah Mixed Letters — Syllable Mode</title>

    <!-- Fonte legível -->
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --brand: #ff4500;
            --bg-soft: #ffe7d1;
            --ok: #2e7d32;
            --focus: #1e88e5;
            --tile: #fff;
            --tile-border: #333;
        }
        * { box-sizing: border-box }
        body {
            font-family: 'Atkinson Hyperlegible', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: url('../../../imagens/fundo.png');
            background-repeat: repeat;
            background-size: auto;
        }
        h1 {
            text-align: center;
            color: var(--brand);
            font-size: clamp(1.8rem, 4vw, 3rem);
            margin: 12px 0 8px;
        }
        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 8px;
        }
        .btn {
            background: #000;
            color: #fff;
            border: 0;
            border-radius: 12px;
            padding: 12px 18px;
            font-size: 1.05rem;
            cursor: pointer;
        }
        .btn--pdf { background: var(--ok) }
        .btn--mode { background: #4a5568 }
        .btn:focus-visible { outline: 3px solid var(--focus) }

        .activity-container { margin-top: 8px; width: 100%; max-width: 960px }
        .activity {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 16px;
            align-items: center;
            position: relative;
            padding: 16px;
            background-color: var(--bg-soft);
            border-radius: 16px;
            box-shadow: 0 6px 12px rgba(0,0,0,.08);
            margin-bottom: 18px;
        }
        .activity img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            border-radius: 12px;
            background: #fff;
            border: 2px solid #eee;
            justify-self: center;
        }
        .word-area { display: grid; gap: 12px }

        /* Linha de slots (unidades: letra ou sílaba) */
        .drop-zone {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 64px;
        }
        .slot {
            min-width: 56px;
            min-height: 64px;
            padding: 0 6px;
            border: 3px dashed #999;
            border-radius: 12px;
            background: #fff;
            display: grid;
            place-items: center;
            position: relative;
        }
        /* Slot largo quando a unidade é sílaba (melhor toque) */
        .slot.syllable { min-width: 84px; }

        .slot[data-ghost]::after{
            content: attr(data-ghost);
            position: absolute;
            color: #bbb;
            font-weight: 700;
            font-size: 1.15rem;
            pointer-events: none;
            white-space: nowrap;
        }
        .tray {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: rgba(255,255,255,.8);
            border: 2px solid #eee;
            border-radius: 12px;
            padding: 8px;
        }

        /* Tile/letra-sílaba */
        .tile {
            min-width: 56px;
            min-height: 64px;
            padding: 0 6px;
            border: 3px solid var(--tile-border);
            border-radius: 12px;
            background: var(--tile);
            display: grid;
            place-items: center;
            font-size: 1.6rem;
            font-weight: 700;
            cursor: grab;
            user-select: none;
            touch-action: none;
            white-space: nowrap;
        }
        .tile.syllable { min-width: 84px; font-size: 1.4rem; }
        .tile:active { cursor: grabbing }
        .tile[aria-grabbed="true"] { outline: 3px solid var(--focus) }

        .controls { display: flex; gap: 8px; flex-wrap: wrap }
        .pill {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 999px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: .95rem;
        }
        .pill:focus-visible { outline: 3px solid var(--focus) }

        .status { font-size: .95rem; color: #444 }
        .good { color: var(--ok); font-weight: 700 }

        /* Modal */
        #overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.6);
            display: none; z-index: 1000;
        }
        #completion-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
            background: #fff; padding: 28px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.25);
            text-align: center; display: none; z-index: 1001; width: min(92vw,520px);
        }
        #completion-modal h2 { margin: 0; font-size: 1.8rem; color: var(--ok) }
        #completion-modal p { font-size: 1rem; margin: 8px 0 0 }
        #completion-modal button {
            margin-top: 16px; padding: 10px 16px; font-size: 1rem; cursor: pointer;
            border: none; border-radius: 10px; background: var(--ok); color: #fff;
        }

        /* Confete simples */
        .confetti {
            position: fixed; pointer-events: none; z-index: 1200;
            width: 8px; height: 12px; background: #ffd54f;
            animation: fall 900ms ease-out forwards;
        }
        @keyframes fall {
            to { transform: translateY(120vh) rotate(540deg); opacity: 0 }
        }
        @media (max-width: 820px) {
            .activity { grid-template-columns: 1fr; justify-items: center }
            .activity img { width: 140px; height: 140px }
            .slot { min-width: 52px; min-height: 60px }
            .slot.syllable { min-width: 76px }
            .tile { min-width: 52px; min-height: 60px }
            .tile.syllable { min-width: 76px }
        }
    </style>
</head>
<body>
    <div class="toolbar" aria-label="Toolbar">
        <button id="backButton" class="btn">Back</button>
        <button id="pdfButton" class="btn btn--pdf" style="display:none" onclick="generatePDF()">Generate PDF</button>
        <button id="modeButton" class="btn btn--mode" title="Alterna entre montagem por letras ou por sílabas">Mode: Syllables</button>
        <button id="reloadButton" class="btn" title="Recarregar atividades com modo atual">Reload</button>
    </div>

    <h1>Hannah Mixed Letters</h1>
    <p class="status" id="sessionStatus" aria-live="polite"></p>

    <div id="activity-container" class="activity-container"></div>

    <!-- Modal de conclusão -->
    <div id="overlay" role="presentation"></div>
    <div id="completion-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title">Phase Completed!</h2>
        <p>Great job! You finished this phase.</p>
        <button onclick="closeModal()">Close</button>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <script>
    // ================== Firebase (mantido) ==================
    const firebaseConfig = {
        apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
        authDomain: "hannahenglishcourse.firebaseapp.com",
        projectId: "hannahenglishcourse",
        storageBucket: "hannahenglishcourse.appspot.com",
        messagingSenderId: "449818788486",
        appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
        measurementId: "G-07VVJG9LRS",
        databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

    document.getElementById('backButton').addEventListener('click', async function () {
        const { level, unit } = getLevelAndUnitFromURL();
        const currentPhase = parseInt(getPhaseFromURL());
        const nextPhase = currentPhase + 1;
        const user = firebase.auth().currentUser;
        if (!user) { alert("You must be logged in to perform this action."); return; }
        const userId = user.uid;
        const progressRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}/fase${nextPhase}`);
        try {
            const snapshot = await progressRef.once('value');
            const isUnlocked = snapshot.val();
            if (isUnlocked) { history.back(); }
            else {
                if (confirm("The next phase is still locked. Leave this page before finishing it?")) history.back();
            }
        } catch (e) { alert("Error checking phase progress."); }
    });

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            const userId = user.uid;
            const userRoleRef = firebase.database().ref(`usuarios/${userId}/role`);
            userRoleRef.once('value').then((snapshot) => {
                const role = snapshot.val();
                if (role === 'professor' || role === 'proprietário') {
                    document.getElementById("pdfButton").style.display = "inline-block";
                }
            });
        }
    });

    // ================== TTS ==================
    let selectedVoice = null, alertDisplayed = false;
    function initializeVoices() {
        const synth = window.speechSynthesis;
        const voices = synth.getVoices();
        selectedVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith("en")) || voices[0];
        if (!selectedVoice && !alertDisplayed) { alertDisplayed = true; alert("No English voice found. Using default voice."); }
    }
    window.speechSynthesis.onvoiceschanged = initializeVoices;
    function speak(text) {
        const synth = window.speechSynthesis;
        synth.cancel();
        if (!selectedVoice) initializeVoices();
        const u = new SpeechSynthesisUtterance(text);
        u.voice = selectedVoice || synth.getVoices()[0];
        synth.speak(u);
    }

    // ================== Estado global e sessão ==================
    const SESSION_LIMIT = 6; // limite de atividades por sessão para crianças pequenas
    let activities = [];        // palavras
    let completedWords = 0;
    let syllableMap = {};       // { wordLower: [ "syll1", "syll2" ] }
    let buildMode = "syllables"; // "letters" | "syllables" (default syllables)

    const sessionStatus = document.getElementById('sessionStatus');
    const modeButton = document.getElementById('modeButton');
    const reloadButton = document.getElementById('reloadButton');

    modeButton.addEventListener('click', () => {
        buildMode = (buildMode === "letters") ? "syllables" : "letters";
        modeButton.textContent = "Mode: " + (buildMode === "letters" ? "Letters" : "Syllables");
    });
    reloadButton.addEventListener('click', () => {
        // recarrega atividades no modo atual
        document.getElementById('activity-container').innerHTML = "";
        completedWords = 0;
        updateSessionStatus();
        loadActivities(true);
    });

    document.addEventListener('DOMContentLoaded', () => {
        initializeVoices();
        loadActivities(false);
    });

    function getPhaseFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('fase');
    }
    function getLevelAndUnitFromURL() {
        const params = new URLSearchParams(window.location.search);
        return { level: params.get('level'), unit: params.get('unit') };
    }

    // ================== Carregamento de palavras e sílabas ==================
    async function loadActivities(forceReload){
        const { level, unit } = getLevelAndUnitFromURL();
        try {
            // palavras
            const wordsPath = `../../${level}/${unit}/data1/words.txt`;
            const resp = await fetch(wordsPath);
            if (!resp.ok) throw new Error(`Erro ao buscar palavras. Status: ${resp.status}`);
            const text = await resp.text();
            let words = text.trim().split('\n').map(w => w.trim()).filter(Boolean);

            // Limite de sessão
            if (words.length > SESSION_LIMIT) words = words.slice(0, SESSION_LIMIT);

            activities = words;

            // tenta ler syllables.json (opcional)
            syllableMap = {};
            try {
                const syllPath = `../../${level}/${unit}/data1/syllables.json`;
                const resS = await fetch(syllPath);
                if (resS.ok) {
                    const data = await resS.json();
                    // normaliza para lower
                    for (const k in data) {
                        if (Array.isArray(data[k])) syllableMap[k.toLowerCase()] = data[k].map(s=>String(s));
                    }
                }
            } catch(e){ /* silencioso, usamos heurística depois */ }

            // cria atividades
            for (let index = 0; index < words.length; index++) {
                const word = words[index];
                const imageUrl = `../../${level}/${unit}/data1/imagens/imagem${index + 1}.png`;
                createActivity(imageUrl, word);
            }

            updateSessionStatus();
        } catch (e) {
            console.error('Erro ao carregar palavras ou imagens:', e);
        }
    }

    // ================== Util: gerar unidades (letras ou sílabas) ==================
    function getUnits(word, mode){
        if (mode === "letters") {
            return word.toUpperCase().split('');
        }
        // SÍLABAS:
        const w = word.toLowerCase();
        if (syllableMap[w]) return syllableMap[w].map(s => s); // mantém caixa do JSON
        // Heurística suave: divide por grupos vogais/consoantes com regra de onset
        return heuristicSyllabify(word);
    }

    // Heurística amigável para crianças (não perfeita foneticamente, mas estável)
    function heuristicSyllabify(word){
        const w = word.toLowerCase();
        const vowels = 'aeiouy';
        // 1) separa por grupos CV aproximados
        const parts = [];
        let buf = '';
        for (let i=0;i<w.length;i++){
            const ch = w[i];
            buf += ch;
            const next = w[i+1] || '';
            const isV = vowels.includes(ch);
            const nextIsV = vowels.includes(next);
            // break points: V + C (início provável da próxima sílaba), double consonant split
            if (isV && next && !nextIsV) {
                // olha 2 à frente para evitar cortar times como "make" em ma-ke
                const next2 = w[i+2] || '';
                const next2IsV = vowels.includes(next2);
                if (next2 && next2IsV) {
                    parts.push(buf);
                    buf = '';
                }
            } else if (!isV && !nextIsV && next && ch !== next) {
                // duplas consonantes diferentes → corta (bas-ket)
                parts.push(buf);
                buf = '';
            }
        }
        if (buf) parts.push(buf);

        // 2) junta pedaços muito curtos ao vizinho (ex.: 't' sozinho)
        const merged = [];
        for (let i=0;i<parts.length;i++){
            const p = parts[i];
            if (p.length === 1 && i>0) merged[merged.length-1] += p;
            else merged.push(p);
        }
        // Capitalização leve para exibição nas tiles
        return merged.map(s => s.length <= 3 ? s.toUpperCase() : s[0].toUpperCase()+s.slice(1));
    }

    // Embaralhar unidades
    function shuffleUnits(units) {
        const arr = units.slice();
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        // evita ficar idêntico
        const same = arr.length === units.length && arr.every((u,idx)=>u===units[idx]);
        if (same && arr.length > 1) [arr[0], arr[1]] = [arr[1], arr[0]];
        return arr;
    }

    // ================== Core da atividade (Drag & Drop + GUIA + Modo) ==================
    function createActivity(imageUrl, word) {
        const container = document.getElementById('activity-container');
        const div = document.createElement('div');
        div.className = 'activity';
        div.dataset.completed = "false";
        div.dataset.word = word; // para PDF e guia

        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = `Image hint for ${word}`;
        img.onerror = () => img.style.display = 'none';
        div.appendChild(img);

        const area = document.createElement('div');
        area.className = 'word-area';
        div.appendChild(area);

        const modeNow = buildMode; // captura o modo no momento da criação
        const units = getUnits(word, modeNow);
        const unitClass = (modeNow === "syllables") ? 'syllable' : '';

        // DROP ZONE (slots)
        const dropZone = document.createElement('div');
        dropZone.className = 'drop-zone';
        area.appendChild(dropZone);

        // Controles
        const revealHintBtn = document.createElement('button');
        revealHintBtn.className = 'pill';
        revealHintBtn.textContent = (modeNow === "letters") ? 'Hint (1st letter)' : 'Hint (1st block)';

        const resetBtn = document.createElement('button');
        resetBtn.className = 'pill';
        resetBtn.textContent = 'Reset';

        // Guia (modelo visível) — ligado por padrão
        const guideBtn = document.createElement('button');
        guideBtn.className = 'pill';
        guideBtn.textContent = 'Hide Guide';
        guideBtn.setAttribute('aria-pressed', 'true');
        let guideOn = true;

        const controls = document.createElement('div');
        controls.className = 'controls';
        controls.appendChild(revealHintBtn);
        controls.appendChild(resetBtn);
        controls.appendChild(guideBtn);
        area.appendChild(controls);

        // Bandeja de unidades
        const tray = document.createElement('div');
        tray.className = 'tray';
        area.appendChild(tray);

        // Cria slots
        const slots = [];
        for (let i = 0; i < units.length; i++) {
            const s = document.createElement('div');
            s.className = 'slot ' + unitClass;
            s.setAttribute('aria-label', `Position ${i+1}`);
            s.setAttribute('role', 'button');
            s.tabIndex = 0;
            s.addEventListener('dragover', (e) => e.preventDefault());
            s.addEventListener('drop', (e) => handleDrop(e, s, i));
            s.addEventListener('click', () => {
                const child = s.querySelector('.tile');
                if (child) {
                    child.setAttribute('draggable', 'true');
                    child.setAttribute('aria-grabbed', 'false');
                    tray.appendChild(child);
                    s.innerHTML = '';
                    s.style.borderColor = '#999';
                    applyGuide();
                }
            });
            slots.push(s);
            dropZone.appendChild(s);
        }

        // Lógicas dos botões
        revealHintBtn.addEventListener('click', () => {
            if (!slots[0].dataset.ghost) {
                slots[0].dataset.ghost = modelUnits()[0];
                revealHintBtn.disabled = true;
            }
        });

        resetBtn.addEventListener('click', () => resetActivity());

        guideBtn.onclick = () => {
            guideOn = !guideOn;
            guideBtn.textContent = guideOn ? 'Hide Guide' : 'Show Guide';
            guideBtn.setAttribute('aria-pressed', String(guideOn));
            applyGuide();
            revealHintBtn.disabled = guideOn; // Hint fica redundante com guia ligado
        };

        function modelUnits(){
            // o "modelo" sempre deriva do modo da atividade no momento da criação
            return units.map(u => u.toString().toUpperCase());
        }

        function applyGuide(){
            const model = modelUnits();
            slots.forEach((s, idx) => {
                const hasTile = !!s.querySelector('.tile');
                if (guideOn && !hasTile) s.dataset.ghost = model[idx];
                else delete s.dataset.ghost;
            });
        }

        // Tiles embaralhadas
        const shuffled = shuffleUnits(modelUnits());
        for (const block of shuffled) {
            const tile = document.createElement('div');
            tile.className = 'tile ' + unitClass;
            tile.textContent = block;
            tile.setAttribute('draggable', 'true');
            tile.setAttribute('role', 'button');
            tile.setAttribute('aria-grabbed', 'false');
            tile.tabIndex = 0;

            tile.addEventListener('dragstart', () => {
                tile.setAttribute('aria-grabbed', 'true');
                // fala a unidade (letra ou sílaba)
                speak(block);
            });
            tile.addEventListener('dragend', () => tile.setAttribute('aria-grabbed', 'false'));
            tile.addEventListener('click', () => speak(block));

            tray.appendChild(tile);
        }

        function handleDrop(e, slotEl, idx) {
            e.preventDefault();
            const tile = document.querySelector('.tile[aria-grabbed="true"]');
            if (!tile) return;

            if (slotEl.firstElementChild) {
                tray.appendChild(slotEl.firstElementChild);
            }
            slotEl.innerHTML = '';
            slotEl.appendChild(tile);
            tile.setAttribute('draggable', 'false');
            slotEl.style.borderColor = '#999';
            delete slotEl.dataset.ghost; // ocupou o slot

            applyGuide(); // atualiza ghosts nos demais

            checkAnswer();
        }

        function currentAnswer(){
            return slots.map(s => (s.querySelector('.tile')?.textContent || '')).join('');
        }

        function checkAnswer(){
            const ans = currentAnswer();
            const target = modelUnits().join('');
            if (ans.length !== target.length) return;

            if (ans === target){
                // sucesso
                celebrate(div);
                // fala palavra inteira (conteúdo original)
                speak(word);
                if (div.dataset.completed === "false") {
                    div.dataset.completed = "true";
                    completedWords++;
                    updateSessionStatus();
                }
                // trava os tiles
                slots.forEach(s => {
                    const t = s.querySelector('.tile');
                    if (t) t.setAttribute('draggable','false');
                    s.style.borderColor = 'var(--ok)';
                });

                if (completedWords === activities.length) {
                    showCompletionModal();
                    firebase.auth().onAuthStateChanged((user) => { if (user) updateNextPhase(user.uid); });
                }
            } else {
                // erro: feedback por posição
                const model = modelUnits();
                // Compara posição com base no comprimento do texto do slot acumulado
                let offset = 0;
                for (let i=0;i<slots.length;i++){
                    const s = slots[i];
                    const t = s.querySelector('.tile');
                    if (!t) { s.style.borderColor = '#999'; continue; }
                    const correct = (t.textContent === model[i]);
                    s.style.borderColor = correct ? 'var(--ok)' : '#e53935';
                    offset += t.textContent.length;
                }
            }
        }

        function resetActivity(){
            slots.forEach((s) => {
                const t = s.querySelector('.tile');
                if (t) {
                    t.setAttribute('draggable','true');
                    t.setAttribute('aria-grabbed','false');
                    tray.appendChild(t);
                }
                s.innerHTML = '';
                s.style.borderColor = '#999';
            });
            applyGuide();
        }

        // Aplica guia inicial e estado do Hint
        applyGuide();
        revealHintBtn.disabled = true; // guia começa ligado → hint redundante

        container.appendChild(div);
    }

    // Confete simples (leve)
    function celebrate(host){
        for (let i=0;i<18;i++){
            const c = document.createElement('div');
            c.className = 'confetti';
            const x = Math.random()*window.innerWidth;
            const y = window.scrollY + (host.getBoundingClientRect().top + 20);
            c.style.left = `${x}px`;
            c.style.top = `${y}px`;
            c.style.background = ['#ffd54f','#4fc3f7','#ce93d8','#81c784','#ff8a65'][i%5];
            document.body.appendChild(c);
            setTimeout(()=>c.remove(), 1000);
        }
    }

    // ================== Progresso (mantido) ==================
    async function updateNextPhase(userId) {
        const currentPhase = getPhaseFromURL();
        const { level, unit } = getLevelAndUnitFromURL();
        const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}`);
        try {
            if (currentPhase === "last") {
                const nextUnit = `Unit${parseInt(unit.replace('Unit','')) + 1}`;
                await firebase.database().ref(`usuarios/${userId}/progresso/${level}/${nextUnit}`).set({ fase1: true });
            } else if (currentPhase === "end") {
                const nextLevel = `Level${parseInt(level.replace('Level','')) + 1}`;
                await firebase.database().ref(`usuarios/${userId}/progresso/${nextLevel}/Unit1`).set({ fase1: true });
            } else {
                const nextPhase = parseInt(currentPhase) + 1;
                await dbRef.update({ [`fase${currentPhase}`]: true, [`fase${nextPhase}`]: true });
            }
        } catch (error) { console.error("Erro ao atualizar o progresso da fase:", error); }
    }

    // ================== HUD de sessão ==================
    function updateSessionStatus(){
        const a = activities.length;
        const c = completedWords;
        sessionStatus.textContent = a ? `Activities: ${c}/${a} — Build by: ${buildMode === 'letters' ? 'Letters' : 'Syllables'}` : '';
        if (c === a && a > 0) {
            sessionStatus.innerHTML = `<span class="good">All done! Great job!</span>`;
        }
    }

    // ================== Modal ==================
    function showCompletionModal() {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('completion-modal').style.display = 'block';
    }
    function closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('completion-modal').style.display = 'none';
    }

    // ================== PDF (com "Guide" e info de modo) ==================
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const logo = new Image();
        logo.src = 'Logo.png';

        function header(){
            doc.setFontSize(12);
            doc.text("Name: __________________________________________ Date: ____________", 50, 20);
            doc.setFontSize(16);
            doc.text("Hannah Mixed Letters", 10, 50);
            doc.setFontSize(11);
            doc.text(`Build mode (at print): ${buildMode === 'letters' ? 'Letters' : 'Syllables'}`, 10, 58);
        }

        function drawActivity(activityEl, y){
            const imgEl = activityEl.querySelector('img');
            if (imgEl) {
                try {
                    const cv = document.createElement('canvas');
                    const ctx = cv.getContext('2d');
                    cv.width = imgEl.naturalWidth || 120;
                    cv.height = imgEl.naturalHeight || 120;
                    ctx.drawImage(imgEl, 0, 0, cv.width, cv.height);
                    const data = cv.toDataURL('image/png');
                    doc.addImage(data, 'PNG', 10, y, 24, 24);
                } catch {}
            }
            const wordModel = (activityEl.dataset.word || '').toUpperCase();
            if (wordModel) {
                doc.setFontSize(10);
                doc.setTextColor(170); // cinza
                doc.text(`Guide: ${wordModel}`, 50, y + 6);
                doc.setTextColor(0);
            }

            // slots como linhas (conta slots pela DOM)
            const slotsCount = activityEl.querySelectorAll('.slot').length;
            let x = 50;
            doc.setFontSize(14);
            for (let i=0;i<slotsCount;i++){
                // linhas maiores se estiver em sílabas
                const line = (buildMode === 'syllables') ? "________" : "_____";
                doc.text(line, x, y + 16);
                x += (buildMode === 'syllables') ? 24 : 16;
            }

            // unidades disponíveis (embaralhadas que estiverem na bandeja + dentro dos slots)
            const trayTiles = [...activityEl.querySelectorAll('.tray .tile')].map(t => t.textContent).join(' ');
            const filledTiles = [...activityEl.querySelectorAll('.slot .tile')].map(t => t.textContent).join(' ');
            const mixed = (trayTiles || filledTiles || '').trim();
            if (mixed) {
                doc.setFontSize(11);
                doc.text(`Units (mixed): ${mixed}`, 50, y + 26);
            }
        }

        logo.onload = function(){
            try { doc.addImage(logo, 'PNG', 10, 10, 30, 30); } catch {}
            header();

            let y = 66;
            document.querySelectorAll('.activity').forEach((a) => {
                if (y > 270) { doc.addPage(); y = 20; header(); y = 66; }
                drawActivity(a, y);
                y += 40;
            });
            doc.save("Hannah_Mixed_Letters.pdf");
        };
        logo.onerror = function(){
            header();
            let y = 66;
            document.querySelectorAll('.activity').forEach((a) => {
                if (y > 270) { doc.addPage(); y = 20; header(); y = 66; }
                drawActivity(a, y);
                y += 40;
            });
            doc.save("Hannah_Mixed_Letters.pdf");
        };
    }
    </script>
</body>
</html>
