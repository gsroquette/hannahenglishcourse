<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Q&A Kids ‚Äì Hannah Neurolearning</title>
<style>
  :root{
    --bg:#f7f9fc;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --ok:#16a34a;
    --warn:#ef4444;
    --brand:#2563eb;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;
  }

  *{box-sizing:border-box}

  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background: url('../../imagens/fundo.png') center/cover no-repeat, var(--bg);
    color:var(--text);
    display:flex;
    min-height:100dvh;
    align-items:center;
    justify-content:center;
    padding:16px;
  }

  .app{
    width:min(980px,100%);
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px;
    position:relative;
    overflow:hidden;
  }

  .header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:14px;
  }

  .avatar{
    width:54px; height:54px; border-radius:50%;
    background:#e5f0ff; border:2px solid #cfe0ff;
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .avatar img{
    width:100%; height:100%;
    object-fit:contain;
    border-radius:50%;
    display:block;
  }

  .title-wrap{flex:1}
  .title{font-weight:700; font-size:20px}
  .subtitle{color:var(--muted); font-size:14px}

  .progress{
    height:8px;
    background:#eef2f7;
    border-radius:999px;
    overflow:hidden;
    margin-top:8px;
  }
  .progress > div{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#60a5fa,#34d399);
    transition:width .3s ease;
  }

  .stage{display:grid; gap:16px; grid-template-columns:1fr}

  .question-card{
    background:#f9fbff;
    border:1px solid #e5eaf5;
    border-radius:16px;
    padding:16px;
  }

  .q-top{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:16px;
  }

  .q-prompt{
    font-size:22px;
    font-weight:700;
    line-height:1.25;
    display:flex;
    align-items:center;
    gap:10px;
  }

  /* === Media grande da pergunta (sem cortes) === */
  .q-media{
    width:100%;
    aspect-ratio:16/10;
    background:#eef4ff;
    border:1px dashed #cfe0ff;
    border-radius:14px;
    padding:8px;
    overflow:hidden;
    display:block;
  }
  .q-media img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }
  @supports not (aspect-ratio: 16/10){
    .q-media{ height: 220px; }
  }

  .q-controls{display:flex; gap:8px; align-items:center; margin-top:8px}

  .icon-btn{
    border:none;
    background:#e6f0ff;
    color:#0f3ea8;
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
    font-weight:700;
  }
  .icon-btn:active{transform:translateY(1px)}

  .options{
    display:grid;
    gap:12px;
    margin-top:4px;
    grid-template-columns:repeat(2,1fr);
  }
  @media (max-width:720px){
    .q-top{grid-template-columns:1fr}
    .options{grid-template-columns:1fr}
  }

  .option{
    display:flex;
    align-items:center;
    gap:12px;
    background:#ffffff;
    border:2px solid #e9eef7;
    border-radius:18px;
    padding:14px;
    cursor:pointer;
    user-select:none;
    min-height:84px;
    box-shadow:0 4px 12px rgba(0,0,0,.03);
    transition:transform .06s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .option:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.06)}
  .option:active{transform:translateY(0)}

  .option .thumb{
    width:68px; height:68px;
    border-radius:14px;
    background:#f3f6ff;
    border:1px solid #e6ecfb;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:30px;
    flex:0 0 68px;
  }
  .option .thumb img{
    width:100%; height:100%;
    object-fit:contain;
    padding:6px;
    display:block;
  }

  .option.img-only{ justify-content:center; gap:0; }
  .option.img-only .thumb{ margin:0 auto; }
  .option.img-only .label{ display:none; }

  .option .label{font-size:20px; font-weight:800; letter-spacing:.2px}
  .option .sub{font-size:13px; color:var(--muted)}
  .option.ok{border-color:#86efac; animation:okPulse .4s ease}
  .option.err{border-color:#fecaca; animation:shake .22s ease}

  @keyframes okPulse{
    0%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}
    100%{box-shadow:0 0 0 18px rgba(34,197,94,0)}
  }
  @keyframes shake{
    0%{transform:translateX(0)}
    25%{transform:translateX(-4px)}
    50%{transform:translateX(4px)}
    75%{transform:translateX(-3px)}
    100%{transform:translateX(0)}
  }

  .footer{
    margin-top:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }

  .pill{
    background:#eef2ff;
    color:#3949ab;
    padding:8px 12px;
    border-radius:999px;
    font-size:12px;
    border:1px solid #d7defc;
  }

  .next-btn{
    border:none;
    background:linear-gradient(90deg, #3b82f6, #22c55e);
    color:white;
    font-weight:800;
    padding:12px 16px;
    border-radius:14px;
    cursor:pointer;
    box-shadow:0 10px 18px rgba(34,197,94,.25);
    opacity:.3;
    pointer-events:none;
    transition:opacity .2s ease, transform .06s ease;
  }
  .next-btn.ready{opacity:1; pointer-events:auto}
  .next-btn:active{transform:translateY(1px)}

  .confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  .piece{
    position:absolute; width:10px; height:10px;
    background:hsl(var(--h) 80% 60%);
    top:-12px; border-radius:2px; animation:drop linear forwards;
  }
  @keyframes drop{to{transform:translateY(120vh) rotate(540deg)}}

  .toast{
    position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
    background:#111827; color:white; padding:10px 14px;
    border-radius:12px; font-size:14px; box-shadow:var(--shadow); opacity:.96;
  }

  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

  /* ORDER */
  .build-wrap{margin-top:8px}
  .build-tray{
    min-height:56px;
    background:#eef4ff;
    border:2px dashed #cfe0ff;
    border-radius:14px;
    padding:10px;
    display:flex; flex-wrap:wrap; gap:8px; align-items:center;
  }
  .word-chip{
    background:#fff;
    border:2px solid #dbe5ff;
    border-radius:12px;
    padding:8px 12px;
    font-weight:800;
    box-shadow:0 2px 6px rgba(0,0,0,.05);
    user-select:none;
  }
  .build-actions{display:flex; gap:8px; margin-top:8px}
  .build-btn{
    border:none; background:#e6f0ff; color:#0f3ea8;
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700;
  }
  .build-btn:active{transform:translateY(1px)}

  /* MATCH */
  .match-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:8px}
  .match-col{display:flex; flex-direction:column; gap:12px}
  .option.selected{outline:3px solid #60a5fa}
  .option.matched{border-color:#86efac; opacity:.65; pointer-events:none}

  .blank{
    display:inline-block; min-width:56px; height:1em;
    border-bottom:3px solid #cfe0ff;
    margin:0 6px -2px;
  }

  .icon-btn[disabled]{ opacity:.4; pointer-events:none; }
  .is-hidden{ display:none !important; }

  .build-grid{ display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr)); }

  @media (max-width:540px){
    .q-media{ aspect-ratio: 4/3; padding:6px; }
    .option{ min-height:68px; padding:12px; }
    .option .thumb{ width:56px; height:56px; }
    .option .label{ font-size:18px; }
    .build-grid{ grid-template-columns: 1fr; }
    .match-grid{ grid-template-columns: 1fr; gap:10px; }
    .match-col{ gap:10px; }
    .option.word-only .label{ font-size:20px; }
    .q-prompt{ font-size:20px; }
  }

  @media (max-height:700px) and (max-width:540px){
    .options{
      max-height: 44vh;
      overflow:auto;
      padding-right: 2px;
    }
  }

  .option .label{ word-break: break-word; }

  .options.is-order{
    max-height: 58vh;
    overflow: auto;
    padding-right: 4px;
  }

  .build-wrap{
    position: sticky;
    top: 0;
    z-index: 3;
    background: #f9fbff;
    padding-bottom: 8px;
    box-shadow: 0 6px 10px -8px rgba(0,0,0,.15);
  }

  .build-wrap .build-tray{ margin-bottom: 8px; }
  .option.word-only{ gap: 0; justify-content: center; }
  .option.word-only .label{
    width: 100%;
    text-align: center;
    font-size: 22px;
    font-weight: 800;
  }
  .build-btn:disabled{ opacity:.45; pointer-events:none; filter: grayscale(0.2); }

  /* Loader overlay */
  .loading{
    position: fixed; inset: 0;
    background: rgba(255,255,255,.75);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(2px);
    font-weight: 700; color:#334155;
  }
  .spinner{
    width: 42px; height: 42px; border-radius: 50%;
    border: 4px solid #c7d2fe; border-top-color:#3b82f6;
    animation: spin 1s linear infinite; margin-right:10px;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="confetti" id="confetti"></div>

    <div class="header">
      <div class="avatar" id="avatar" aria-hidden="true">ü§ñ</div>
      <div class="title-wrap">
        <div class="title">Hannah Questions</div>
        <div class="subtitle" id="subtitle">Carregando conte√∫do‚Ä¶</div>
        <div class="progress"><div id="bar"></div></div>
      </div>
      <div class="pill" id="pill">Unit ‚Äî</div>
    </div>

    <div class="stage">
      <div class="question-card">
        <div class="q-top">
          <div>
            <div class="q-prompt" id="prompt">‚Äî</div>
            <div class="q-controls">
              <button class="icon-btn" id="btnPlayPrompt" title="Listen to question">üîä Listen</button>
              <button class="icon-btn" id="btnRepeat" title="Repeat aloud (optional)">üé§ Repeat</button>
            </div>
          </div>
          <div class="q-media" id="mediaBox" aria-label="Imagem da pergunta"></div>
        </div>

        <div class="options" id="options"></div>

        <div class="footer">
          <span class="pill" id="statusPill">Question ‚Äî/‚Äî</span>
          <button class="next-btn" id="btnNext" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div class="loading" id="loading" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <span>Carregando‚Ä¶</span>
  </div>

  <div class="sr-only" aria-live="polite" id="live"></div>

<script>
(function(){
  // ====== Util: normaliza Level/Unit/Fase vindos da URL ======
  const params = new URLSearchParams(location.search);

  // Aceita "Level0" ou "0"
  const rawLevel = (params.get('level') ?? '').trim();
  const rawUnit  = (params.get('unit')  ?? '').trim();
  const rawFase  = (params.get('fase')  ?? '').trim(); // pode usar depois

  function normalizeDir(prefix, value, fallbackNum){
    // value pode ser "Level0" ou "0" (ou vazio)
    if (!value){
      return prefix + fallbackNum;
    }
    const lower = value.toLowerCase();
    if (lower.startsWith(prefix.toLowerCase())){
      // j√° veio com prefixo correto (Level0/Unit1)
      return value.replace(/^\s+|\s+$/g,'');
    }
    // Se veio s√≥ o n√∫mero, cola o prefixo
    return prefix + value.replace(/\D+/g,'').trim();
  }

  const levelDir = normalizeDir('Level', rawLevel || '0', '0'); // default Level0
  const unitDir  = normalizeDir('Unit',  rawUnit  || '1', '1'); // default Unit1
  const fase     = rawFase || ''; // apenas guardando

  // Ex.: ../../Level0/Unit1/QA
  const BASE  = `../../${levelDir}/${unitDir}/QA`;
  const QFILE = `${BASE}/questions.txt`;

  // ====== Estado ======
  let questions = [];
  let isReading = false;
  let currentAudio = null;
  let idx = 0;
  let answered = false;

  // ====== Elementos ======
  const subtitle   = document.getElementById('subtitle');
  const pill       = document.getElementById('pill');
  const bar        = document.getElementById('bar');
  const promptEl   = document.getElementById('prompt');
  const mediaBox   = document.getElementById('mediaBox');
  const optionsEl  = document.getElementById('options');
  const btnPlayPrompt = document.getElementById('btnPlayPrompt');
  const btnRepeat  = document.getElementById('btnRepeat');
  const btnNext    = document.getElementById('btnNext');
  const statusPill = document.getElementById('statusPill');
  const confettiEl = document.getElementById('confetti');
  const liveEl     = document.getElementById('live');
  const loadingEl  = document.getElementById('loading');

  // Avatar
  (function(){
    const avatarEl = document.getElementById('avatar');
    const img = new Image();
    img.src = '../../imagens/robo1_static.png';
    img.alt = 'Mascote do app';
    img.onload = () => { avatarEl.textContent = ''; avatarEl.appendChild(img); };
    img.onerror = () => { avatarEl.textContent = 'ü§ñ'; };
  })();

  pill.textContent = `${levelDir} ‚Ä¢ ${unitDir}${fase ? ' ‚Ä¢ Fase '+fase : ''}`;

  // Sons (opcional)
  const sCorrect = new Audio(`${BASE}/sounds/correct.mp3`);
  const sWrong   = new Audio(`${BASE}/sounds/wrong.mp3`);
  const sTap     = new Audio(`${BASE}/sounds/tap.mp3`);
  const sNext    = new Audio(`${BASE}/sounds/next.mp3`);
  [sCorrect,sWrong,sTap,sNext].forEach(a=>{a.preload='auto'});

  // ====== Carrega arquivo TXT (JSON) ======
  showLoader(true);
  fetch(QFILE, {cache:'no-store'})
    .then(r => {
      if(!r.ok) throw new Error(`N√£o foi poss√≠vel carregar ${QFILE} (HTTP ${r.status})`);
      return r.text();
    })
    .then(text => {
      const data = JSON.parse(text);
      if(!data || !Array.isArray(data.questions)) throw new Error('Formato inv√°lido em questions.txt');
      questions = data.questions;
      subtitle.textContent = data.title || 'Pratique respondendo r√°pido e com aten√ß√£o!';
      idx = 0;
      renderQuestion();
    })
    .catch(err=>{
      console.error('[Q&A] Falha ao carregar:', err);
      toast('Erro ao carregar quest√µes. Verifique level, unit e o arquivo questions.txt.');
      subtitle.textContent = 'Falha ao carregar conte√∫do';
      // Mostra caminhos calculados para debug
      promptEl.textContent = `Caminho n√£o encontrado.\nBASE: ${BASE}\nArquivo: ${QFILE}`;
      mediaBox.innerHTML = '';
      optionsEl.innerHTML = '';
    })
    .finally(()=> showLoader(false));

  // ====== Fun√ß√µes de √°udio ======
  function stopAllAudio(){
    try { speechSynthesis.cancel(); } catch(e){}
    if (currentAudio){
      try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){}
      currentAudio = null;
    }
  }

  // ====== Renderiza√ß√£o de quest√£o ======
  function renderQuestion(){
    answered = false;
    btnNext.disabled = true;
    btnNext.classList.remove('ready');
    btnPlayPrompt.disabled = false;
    btnRepeat.disabled = false;
    btnPlayPrompt.classList.remove('is-hidden');
    btnRepeat.classList.remove('is-hidden');

    const q = questions[idx];
    if(!q){ finish(); return; }

    const pct = Math.round(((idx)/questions.length)*100);
    bar.style.width = pct + '%';
    statusPill.textContent = `Question ${idx+1}/${questions.length}`;

    promptEl.textContent = q.prompt || '‚Äî';
    if (q.type === 'fillblank' && !/\_\_+/.test(q.prompt || '')) {
      const line = document.createElement('span');
      line.className = 'blank';
      promptEl.appendChild(document.createTextNode(' '));
      promptEl.appendChild(line);
    }

    btnPlayPrompt.onclick = () => { if (!isReading) playPrompt(q); };
    btnRepeat.onclick     = () => {
      if (isReading) return;
      stopAllAudio();
      const t = q.targetWord || q.tts || q.prompt || '';
      speak(t);
    };

    mediaBox.innerHTML = '';
    if(q.image){
      const img = new Image();
      img.alt = 'Imagem da pergunta';
      img.src = absPath(q.image);
      mediaBox.appendChild(img);
    } else {
      const img = new Image();
      img.src = './hannah_pensando.png';
      img.alt = 'Hannah pensando';
      mediaBox.appendChild(img);
    }

    optionsEl.innerHTML = '';
    optionsEl.classList.remove('is-order');

    if (q.type === 'order') {
      renderOrderQuestion(q);
    } else if (q.type === 'match') {
      renderMatchQuestion(q);
    } else {
      const opts = (q.shuffleOptions===false) ? q.options : shuffle([...q.options]);
      opts.forEach(opt => optionsEl.appendChild(makeOption(q, opt)));
    }

    btnNext.onclick = () => {
      sNext.play().catch(()=>{});
      idx++;
      if (idx >= questions.length) { finish(); return; }
      renderQuestion();
    };
  }

  // ====== Cria bot√£o de op√ß√£o ======
  function makeOption(q, opt){
    const o = (typeof opt === 'string') ? { label: opt, value: opt } : { ...opt };

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'option';
    btn.setAttribute('aria-label', o.aria || o.label || 'op√ß√£o');

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    if (o.image){
      const img = new Image();
      img.src = absPath(o.image);
      img.alt = o.label || '';
      thumb.appendChild(img);
    } else if (o.emoji){
      thumb.textContent = o.emoji;
    } else {
      const box = document.createElement('span');
      box.className = 'square-outline';
      box.style.setProperty('--sq', '#7c3aed');
      thumb.textContent = '';
      thumb.appendChild(box);
    }

    const textWrap = document.createElement('div');
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = o.label || '';
    textWrap.appendChild(label);

    if (typeof o.sub === 'string' && o.sub.trim()) {
      const sub = document.createElement('div');
      sub.className = 'sub';
      sub.textContent = o.sub;
      textWrap.appendChild(sub);
    }

    btn.appendChild(thumb);
    btn.appendChild(textWrap);

    btn.onclick = () => {
      sTap.play().catch(()=>{});
      speakSelectedThenCheck(q, o, btn);
    };
    thumb.style.cursor = 'pointer';
    thumb.title = 'Play & choose';
    thumb.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      sTap.play().catch(()=>{});
      speakSelectedThenCheck(q, o, btn);
    };

    return btn;
  }

  // ====== L√≥gica de resposta ======
  function handleAnswer(q, opt, btn){
    if(answered) return;
    const isCorrect = normalize(opt.value) === normalize(q.answer);

    if(isCorrect){
      btn.classList.add('ok');
      confetti(18);
      sCorrect.play().catch(()=>{});
      speakFriendly(['Yes! Great job!','Awesome!','You did it!']);
      try {
        mediaBox.innerHTML = '';
        const gif = new Image();
        gif.src = './hannah_feliz.gif';
        gif.alt = 'Hannah comemorando';
        gif.setAttribute('draggable','false');
        gif.style.pointerEvents = 'none';
        mediaBox.appendChild(gif);
      } catch(e){}
      liveEl.textContent = 'Resposta correta';
      answered = true;
      btnNext.disabled = false;
      btnNext.classList.add('ready');
      disableOthers(btn);
    } else {
      btn.classList.add('err');
      sWrong.play().catch(()=>{});
      speakFriendly(['Hmm‚Ä¶ try again!','Not this one!','Almost!']);
      liveEl.textContent = 'Resposta incorreta, tente novamente';
    }
  }

  function disableOthers(keepBtn){
    Array.from(optionsEl.children).forEach(el=>{
      if(el!==keepBtn){ el.disabled = true; el.style.opacity = .5; }
    });
  }

  // ====== √Åudio do prompt ======
  function playPrompt(q){
    stopAllAudio();
    const ttsText = q.targetWord || q.tts || q.prompt || '';

    if (q.promptAudio){
      const a = new Audio(absPath(q.promptAudio));
      currentAudio = a;
      a.onended = () => { currentAudio = null; };
      a.onerror  = () => { currentAudio = null; speak(ttsText); };
      a.play().catch(() => { currentAudio = null; speak(ttsText); });
    } else {
      speak(ttsText);
    }
  }

  // ====== Fim ======
  function finish(){
    try { stopAllAudio(); } catch(e){}
    try { speechSynthesis.cancel(); } catch(e){}
    isReading = false;

    bar.style.width = '100%';
    promptEl.textContent = "üéâ Congratulations! You've completed all the questions!";
    mediaBox.innerHTML = '<div style="font-size:44px">üèÖ</div>';
    optionsEl.innerHTML = '';
    btnNext.disabled = true;
    btnNext.classList.remove('ready');
    statusPill.textContent = `Conclu√≠do ‚Ä¢ ${questions.length}/${questions.length}`;
    confetti(30);
    speakFriendly(['Great! You finished!','Amazing work!']);

    btnPlayPrompt.disabled = true;
    btnRepeat.disabled = true;
    btnPlayPrompt.classList.add('is-hidden');
    btnRepeat.classList.add('is-hidden');
  }

  // ====== Helpers ======
  function toast(msg){
    const t=document.createElement('div');
    t.className='toast';
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2500);
  }
  function confetti(n=16){
    for(let i=0;i<n;i++){
      const p=document.createElement('div');
      p.className='piece';
      const left = Math.random()*100;
      const dur = 1200 + Math.random()*1400;
      const delay = Math.random()*100;
      p.style.left = left+'%';
      p.style.setProperty('--h', Math.floor(Math.random()*360));
      p.style.animationDuration = dur+'ms';
      p.style.animationDelay = delay+'ms';
      confettiEl.appendChild(p);
      setTimeout(()=>p.remove(), dur+delay+200);
    }
  }
  function speak(text){
    if(!text) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      u.rate = 0.95; u.pitch = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }
  function speakFriendly(pool){
    const pick = pool[(Math.random()*pool.length)|0];
    speak(pick);
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function normalize(v){
    return String(v ?? '').trim().toLowerCase();
  }
  function absPath(p){
    if(!p) return p;
    if(p.startsWith('http')) return p;
    if(p.startsWith('/')) return p;
    return `${BASE}/${p}`.replace(/\/+/g,'/');
  }
  function showLoader(v){
    const el = loadingEl;
    if (!el) return;
    el.style.display = v ? 'flex' : 'none';
  }

  // ====== ORDER ======
  function renderOrderQuestion(q){
    optionsEl.classList.add('is-order');
    const words = q.options.map(w => String(w));
    const answerSeq = (q.answer || []).map(w => String(w));
    let built = [];

    const wrap = document.createElement('div');
    wrap.className = 'build-wrap';

    const tray = document.createElement('div');
    tray.className = 'build-tray';
    tray.id = 'buildTray';
    tray.setAttribute('aria-label','Sentence tray');

    const actions = document.createElement('div');
    actions.className = 'build-actions';
    const undoBtn = document.createElement('button');
    undoBtn.className = 'build-btn'; undoBtn.textContent = 'Undo';
    const clearBtn = document.createElement('button');
    clearBtn.className = 'build-btn'; clearBtn.textContent = 'Clear';

    actions.appendChild(undoBtn); actions.appendChild(clearBtn);
    wrap.appendChild(tray); wrap.appendChild(actions);
    optionsEl.appendChild(wrap);

    const grid = document.createElement('div');
    grid.className = 'build-grid';
    optionsEl.appendChild(grid);

    words.forEach(w=>{
      const b = document.createElement('button');
      b.type='button';
      b.className='option word-only';
      b.innerHTML = `<div class="label">${w}</div>`;
      b.onclick = ()=>{
        sTap.play().catch(()=>{});
        if (built.length >= answerSeq.length) return;
        built.push(w);
        drawTray();
        checkBuilt();
      };
      grid.appendChild(b);
    });

    undoBtn.onclick = ()=>{
      built.pop();
      drawTray();
      btnNext.disabled = true;
      btnNext.classList.remove('ready');
    };
    clearBtn.onclick = ()=>{
      built = [];
      drawTray();
      btnNext.disabled = true;
      btnNext.classList.remove('ready');
    };

    function drawTray(){
      tray.innerHTML = '';
      built.forEach(word=>{
        const chip = document.createElement('span');
        chip.className='word-chip';
        chip.textContent = word;
        tray.appendChild(chip);
      });
    }

    function checkBuilt(){
      const sameLen = built.length === answerSeq.length;
      if (!sameLen) return;

      const ok = built.every((w,i)=> normalize(w) === normalize(answerSeq[i]));
      if (ok){
        try {
          mediaBox.innerHTML = '';
          const gif = new Image();
          gif.src = './hannah_feliz.gif';
          gif.alt = 'Hannah comemorando';
          gif.setAttribute('draggable','false');
          gif.style.pointerEvents = 'none';
          mediaBox.appendChild(gif);
        } catch(e){}
        confetti(18);
        sCorrect.play().catch(()=>{});
        speakFriendly(['Great!','Awesome!']);
        liveEl.textContent = 'Ordem correta';
        btnNext.disabled = false;
        btnNext.classList.add('ready');
        answered = true;
        Array.from(optionsEl.querySelectorAll('.option')).forEach(el=> el.disabled = true);
        undoBtn.disabled = true;
        clearBtn.disabled = true;
      } else {
        sWrong.play().catch(()=>{});
        speakFriendly(['Try again!']);
        liveEl.textContent = 'Ordem incorreta, tente novamente';
      }
    }
  }

  // ====== MATCH ======
  function renderMatchQuestion(q){
    const sourcePairs = Array.isArray(q.pairs) ? q.pairs : [];

    const normItem = (it) => {
      if (typeof it === 'string') return { label: it, value: it };
      const o = {...it};
      if (!o.value) o.value = o.label || o.image || String(Math.random());
      return o;
    };

    const leftItems  = sourcePairs.map(p => normItem(p.left));
    const rightItems = sourcePairs.map(p => normItem(p.right));

    const leftShuf  = shuffle([...leftItems]);
    const rightShuf = shuffle([...rightItems]);

    const grid = document.createElement('div');
    grid.className = 'match-grid';
    const colL = document.createElement('div'); colL.className = 'match-col';
    const colR = document.createElement('div'); colR.className = 'match-col';
    grid.appendChild(colL); grid.appendChild(colR);
    optionsEl.appendChild(grid);

    let selectedLeftBtn = null;
    let selectedLeftVal = null;
    let matched = new Set();

    const makeLeftBtn = (item) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'option word-only';
      b.dataset.value = item.value;

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = item.label || item.value;
      b.appendChild(label);

      b.onclick = () => {
        if (b.classList.contains('matched')) return;
        sTap.play().catch(()=>{});
        Array.from(colL.children).forEach(el => el.classList.remove('selected'));
        b.classList.add('selected');
        selectedLeftBtn = b;
        selectedLeftVal = item.value;
      };

      return b;
    };

    const makeRightBtn = (item) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'option';
      b.dataset.value = item.value;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      if (item.image){
        const img = new Image();
        img.src = absPath(item.image);
        img.alt = item.label || '';
        thumb.appendChild(img);
      } else {
        thumb.textContent = item.label ? 'üî§' : '‚ùî';
      }

      const hasLabel = !!(item.label && String(item.label).trim());
      if (hasLabel){
        const label = document.createElement('div');
        label.className = 'label';
        label.textContent = item.label;
        b.appendChild(thumb);
        b.appendChild(label);
      } else {
        b.classList.add('img-only');
        b.appendChild(thumb);
      }

      b.onclick = ()=>{
        if (b.classList.contains('matched')) return;
        if (!selectedLeftBtn){
          toast('Choose a word first üôÇ');
          return;
        }
        const leftVal  = selectedLeftVal;
        const rightVal = item.value;
        const ok = normalize(leftVal) === normalize(rightVal);

        if (ok){
          sCorrect.play().catch(()=>{});
          confetti(10);
          speakFriendly(['Great!','Nice!']);

          b.classList.add('matched');
          selectedLeftBtn.classList.add('matched');
          selectedLeftBtn.classList.remove('selected');
          matched.add(leftVal);

          selectedLeftBtn = null;
          selectedLeftVal = null;

          if (matched.size === sourcePairs.length){
            try{
              mediaBox.innerHTML = '';
              const gif = new Image();
              gif.src = './hannah_feliz.gif';
              gif.alt = 'Hannah comemorando';
              gif.setAttribute('draggable','false');
              gif.style.pointerEvents = 'none';
              mediaBox.appendChild(gif);
            }catch(e){}
            confetti(18);
            sCorrect.play().catch(()=>{});
            speakFriendly(['Great!','Awesome!']);
            liveEl.textContent = 'All pairs matched';
            answered = true;
            btnNext.disabled = false;
            btnNext.classList.add('ready');
            Array.from(optionsEl.querySelectorAll('.option')).forEach(el => el.disabled = true);
          }
        } else {
          sWrong.play().catch(()=>{});
          speakFriendly(['Try again!']);
          b.classList.add('err');
          setTimeout(()=>b.classList.remove('err'), 250);
        }
      };

      return b;
    };

    leftShuf.forEach(item => colL.appendChild(makeLeftBtn(item)));
    rightShuf.forEach(item => colR.appendChild(makeRightBtn(item)));
  }

  // ====== Fala + verifica√ß√£o depois de tocar ======
  function speakSelectedThenCheck(q, o, btn){
    if (answered || isReading) return;
    isReading = true;

    const allBtns = Array.from(document.querySelectorAll('.option'));
    allBtns.forEach(el => el.disabled = true);
    btnNext.disabled = true;
    btnNext.classList.remove('ready');

    const finish = () => {
      isReading = false;
      if (!answered) allBtns.forEach(el => el.disabled = false);
      handleAnswer(q, o, btn);
    };

    const say = (o.tts || o.label || o.value || '').toString().trim();

    stopAllAudio();

    if (o.audio){
      try{
        const a = new Audio(absPath(o.audio));
        currentAudio = a;

        let done = false;
        const safeFinish = () => { if (!done){ done = true; currentAudio = null; finish(); } };

        a.onended = safeFinish;
        a.onerror = () => { currentAudio = null; speak(say); setTimeout(safeFinish, 600); };
        a.play().catch(() => { currentAudio = null; speak(say); setTimeout(safeFinish, 600); });

        setTimeout(safeFinish, 3500);
      }catch{
        speak(say);
        setTimeout(finish, 600);
      }
    } else {
      try{
        const u = new SpeechSynthesisUtterance(say || ' ');
        u.lang = 'en-US'; u.rate = 0.95; u.pitch = 1.0;
        u.onend   = finish;
        u.onerror = () => setTimeout(finish, 300);
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
        setTimeout(() => { if (isReading) finish(); }, 2500);
      }catch{
        setTimeout(finish, 300);
      }
    }
  }
})();
</script>
</body>
</html>
