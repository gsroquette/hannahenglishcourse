<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hannah Questions — Fill in the Blanks</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
    --ok:#16a34a; --warn:#ef4444; --brand:#2563eb;
    --shadow:0 10px 25px rgba(0,0,0,.08); --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background:url('../../imagens/fundo.png') center/cover no-repeat, var(--bg);
    color:var(--text);display:flex;min-height:100dvh;align-items:center;justify-content:center;padding:16px;
  }
  .app{width:min(980px,100%);background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;position:relative;overflow:hidden}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .avatar{width:54px;height:54px;border-radius:50%;background:#e5f0ff;border:2px solid #cfe0ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:contain;border-radius:50%;display:block}
  .title-wrap{flex:1}.title{font-weight:700;font-size:20px}.subtitle{color:var(--muted);font-size:14px}
  .progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin-top:8px}
  .progress > div{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#34d399);transition:width .3s ease}
  .stage{display:grid;gap:16px;grid-template-columns:1fr}
  .question-card{background:#f9fbff;border:1px solid #e5eaf5;border-radius:16px;padding:16px}
  .q-top{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
  .q-prompt{font-size:22px;font-weight:700;line-height:1.25;display:flex;align-items:center;gap:10px}
  .q-media{width:100%;aspect-ratio:16/10;background:#eef4ff;border:1px dashed #cfe0ff;border-radius:14px;padding:8px;overflow:hidden;display:block}
  .q-media img{width:100%;height:100%;object-fit:contain;display:block}
  @supports not (aspect-ratio:16/10){.q-media{height:220px}}
  .q-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .icon-btn{border:none;background:#e6f0ff;color:#0f3ea8;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  .icon-btn:active{transform:translateY(1px)}
  .options{display:grid;gap:12px;margin-top:4px;grid-template-columns:repeat(2,1fr)}
  @media (max-width:720px){.q-top{grid-template-columns:1fr}.options{grid-template-columns:1fr}}
  .option{display:flex;align-items:center;gap:12px;background:#fff;border:2px solid #e9eef7;border-radius:18px;padding:14px;cursor:pointer;user-select:none;min-height:84px;box-shadow:0 4px 12px rgba(0,0,0,.03);transition:transform .06s ease,border-color .15s ease,box-shadow .15s ease}
  .option:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.06)}
  .option:active{transform:translateY(0)}
  .option .thumb{width:68px;height:68px;border-radius:14px;background:#f3f6ff;border:1px solid #e6ecfb;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:30px;flex:0 0 68px}
  .option .thumb img{width:100%;height:100%;object-fit:contain;padding:6px;display:block}
  .option.img-only{justify-content:center;gap:0}.option.img-only .thumb{margin:0 auto}.option.img-only .label{display:none}
  .option .label{font-size:20px;font-weight:800;letter-spacing:.2px}
  .option .sub{font-size:13px;color:var(--muted)}

  /* Purple square + green tick */
  .square-outline{width:42px;height:42px;border:6px solid var(--sq,#7c3aed);border-radius:10px;background:transparent;display:inline-block;position:relative;transition:border-color .2s ease,background .2s ease,transform .15s ease}
  .option.ok .square-outline{border-color:#16a34a;background:#dcfce7}
  .option.ok .square-outline::after{content:"✔";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#166534;font-size:22px;font-weight:900;animation:pop-in .18s ease-out}
  .option.err .square-outline{border-color:#ef4444;background:#fee2e2}
  @keyframes pop-in{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}

  .option.ok{border-color:#86efac;animation:okPulse .4s ease}
  .option.err{border-color:#fecaca;animation:shake .22s ease}
  @keyframes okPulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}100%{box-shadow:0 0 0 18px rgba(34,197,94,0)}}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}

  .footer{margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .pill{background:#eef2ff;color:#3949ab;padding:8px 12px;border-radius:999px;font-size:12px;border:1px solid #d7defc}
  .next-btn{border:none;background:linear-gradient(90deg,#3b82f6,#22c55e);color:#fff;font-weight:800;padding:12px 16px;border-radius:14px;cursor:pointer;box-shadow:0 10px 18px rgba(34,197,94,.25);opacity:.3;pointer-events:none;transition:opacity .2s ease,transform .06s ease}
  .next-btn.ready{opacity:1;pointer-events:auto}
  .next-btn:active{transform:translateY(1px)}

  .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  .piece{position:absolute;width:10px;height:10px;background:hsl(var(--h) 80% 60%);top:-12px;border-radius:2px;animation:drop linear forwards}
  @keyframes drop{to{transform:translateY(120vh) rotate(540deg)}}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;font-size:14px;box-shadow:var(--shadow);opacity:.96}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  /* ORDER/MATCH infra */
  .build-wrap{margin-top:8px}
  .build-tray{min-height:56px;background:#eef4ff;border:2px dashed #cfe0ff;border-radius:14px;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .word-chip{background:#fff;border:2px solid #dbe5ff;border-radius:12px;padding:8px 12px;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,.05);user-select:none}
  .build-actions{display:flex;gap:8px;margin-top:8px}
  .build-btn{border:none;background:#e6f0ff;color:#0f3ea8;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .build-btn:active{transform:translateY(1px)}
  .match-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .match-col{display:flex;flex-direction:column;gap:12px}
  .option.selected{outline:3px solid #60a5fa}
  .option.matched{border-color:#86efac;opacity:.65;pointer-events:none}

  /* Visual blank line */
  .blank{display:inline-block;min-width:56px;height:1em;border-bottom:3px solid #cfe0ff;margin:0 6px -2px}

  .icon-btn[disabled]{opacity:.4;pointer-events:none}
  .is-hidden{display:none!important}
  .build-grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}

  /* Back button */
  #back-button{
    position:absolute; right:12px; top:12px;
    border:none; background:#eef2ff; color:#0f3ea8;
    padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.06);
  }
  #back-button:active{ transform: translateY(1px); }

  @media (max-width:540px){
    .q-media{aspect-ratio:4/3;padding:6px}
    .option{min-height:68px;padding:12px}
    .option .thumb{width:56px;height:56px}
    .option .label{font-size:18px}
    .build-grid{grid-template-columns:1fr}
    .match-grid{grid-template-columns:1fr;gap:10px}
    .match-col{gap:10px}
    .option.word-only .label{font-size:20px}
    .q-prompt{font-size:20px}
  }
  @media (max-height:700px) and (max-width:540px){
    .options{max-height:44vh;overflow:auto;padding-right:2px}
  }
  .option .label{word-break:break-word}
  .options.is-order{max-height:58vh;overflow:auto;padding-right:4px}
  .build-wrap{position:sticky;top:0;z-index:3;background:#f9fbff;padding-bottom:8px;box-shadow:0 6px 10px -8px rgba(0,0,0,.15)}
  .build-wrap .build-tray{margin-bottom:8px}
  .option.word-only{gap:0;justify-content:center}
  .option.word-only .label{width:100%;text-align:center;font-size:22px;font-weight:800}
  .build-btn:disabled{opacity:.45;pointer-events:none;filter:grayscale(.2)}

  /* Loader */
  .loading{position:fixed;inset:0;background:rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(2px);font-weight:700;color:#334155}
  .spinner{width:42px;height:42px;border-radius:50%;border:4px solid #c7d2fe;border-top-color:#3b82f6;animation:spin 1s linear infinite;margin-right:10px}
  @keyframes spin{to{transform:rotate(360deg)}}
/* reserve espaço à direita do cabeçalho para o botão Back */
.header{
  position: relative;
  padding-right: 110px;   /* << cria “zona livre” para o Back */
}

/* garante que o Back fique por cima e alinhado */
#back-button{
  position: absolute;
  right: 16px;
  top: 10px;
  z-index: 5;
}

/* em telas pequenas, um pouco menos de padding já resolve */
@media (max-width: 540px){
  .header{ padding-right: 92px; }
}
</style>
</head>
<body>
  <div class="app" id="app">
    <button id="back-button" onclick="goBack()">Back</button>

    <div class="confetti" id="confetti"></div>

    <div class="header">
      <div class="avatar" id="avatar" aria-hidden="true">🤖</div>
      <div class="title-wrap">
        <div class="title">Hannah Questions</div>
        <div class="subtitle" id="subtitle">Loading content…</div>
        <div class="progress"><div id="bar"></div></div>
      </div>
      <div class="pill" id="pill">Unit —</div>
    </div>

    <div class="stage">
      <div class="question-card">
        <div class="q-top">
          <div>
            <div class="q-prompt" id="prompt">—</div>
            <div class="q-controls">
              <button class="icon-btn" id="btnPlayPrompt" title="Listen to question">🔊 Listen</button>
              <button class="icon-btn" id="btnRepeat" title="Repeat aloud (optional)">🎤 Repeat</button>
            </div>
          </div>
          <div class="q-media" id="mediaBox" aria-label="Question image"></div>
        </div>

        <div class="options" id="options"></div>

        <div class="footer">
          <span class="pill" id="statusPill">Question —/—</span>
          <button class="next-btn" id="btnNext" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div class="loading" id="loading" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <span>Loading…</span>
  </div>

  <div class="sr-only" aria-live="polite" id="live"></div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* =========================
   Firebase init (v8)
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
};
firebase.initializeApp(firebaseConfig);

// Keep user uid
let currentUserId = null;
firebase.auth().onAuthStateChanged(function(user){
  currentUserId = user ? user.uid : null;
});
</script>

<script>
(function(){
  /* =========================
     2) Helpers essenciais
  ========================= */
  // URL params (must include level=LevelX, unit=UnitY, fase=Z|'last'|'end')
  function getParams(){
    const url = new URL(location.href);
    const level = url.searchParams.get('level');
    const unit  = url.searchParams.get('unit');
    const fase  = url.searchParams.get('fase');
    return { level, unit, fase };
  }

  // Normalização de diretórios para paths (aceita também "0"/"1")
  function normalizeDir(prefix, value, fallbackNum){
    if (!value) return prefix + fallbackNum;
    const lower = value.toLowerCase();
    if (lower.startsWith(prefix.toLowerCase())) return value.trim();
    const onlyNum = (value.match(/\d+/)||[''])[0];
    return prefix + (onlyNum || fallbackNum);
  }

  // ---- WebAudio SFX (feedback curto) ----
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } return !!audioCtx; }
  function tone(freq, durMs, type){
    if(!ensureAudio()) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = type || 'sine'; o.frequency.value = freq;
    o.connect(g); g.connect(audioCtx.destination);
    const t0 = audioCtx.currentTime;
    g.gain.setValueAtTime(0.001, t0);
    g.gain.exponentialRampToValueAtTime(0.16, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, t0 + (durMs/1000));
    o.start(t0); o.stop(t0 + (durMs/1000));
  }
  function sfxTick(){ tone(520, 70, 'square'); if(navigator.vibrate) navigator.vibrate(12); }
  function sfxCorrect(){ tone(880,120,'triangle'); setTimeout(()=>tone(1320,90,'triangle'),110); if(navigator.vibrate) navigator.vibrate(25); }
  function sfxWrong(){ tone(240,140,'sawtooth'); if(navigator.vibrate) navigator.vibrate(15); }
  function sfxWin(){ tone(660,120,'triangle'); setTimeout(()=>tone(990,120,'triangle'),120); setTimeout(()=>tone(1320,150,'triangle'),240); if(navigator.vibrate) navigator.vibrate([30,30,50]); }

  // Toast util
  function toast(msg){
    const t=document.createElement('div');
    t.className='toast';
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2500);
  }

  /* =========================
     3) Progressão de fase
  ========================= */
  function ensureUserIsAuthenticated(callback){
    if(currentUserId){ callback(currentUserId); return; }
    firebase.auth().onAuthStateChanged(function(user){
      if(user){ currentUserId = user.uid; callback(user.uid); }
      else { console.error("[Auth] User not authenticated"); }
    });
  }

  function markPhaseCompleted(){
    ensureUserIsAuthenticated(updateNextPhase);
  }

  async function updateNextPhase(userId){
    const { level, unit, fase } = getParams();
    if(!level || !unit || !fase){ console.warn("[Progress] Missing URL params."); return; }
    const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}`);
    try{
      if(fase === "last"){
        const nextUnit = `Unit${parseInt((unit||'').replace(/\D/g,''),10) + 1}`;
        await firebase.database().ref(`usuarios/${userId}/progresso/${level}/${nextUnit}`).set({ fase1: true });
      } else if(fase === "end"){
        const nextLevel = `Level${parseInt((level||'').replace(/\D/g,''),10) + 1}`;
        await firebase.database().ref(`usuarios/${userId}/progresso/${nextLevel}/Unit1`).set({ fase1: true });
      } else {
        const nextPhase = parseInt(fase,10) + 1;
        await dbRef.update({ [`fase${fase}`]: true, [`fase${nextPhase}`]: true });
      }
      console.log("[Progress] Update successful.");
    } catch(err){
      console.error("[Progress] Error updating next phase:", err);
    }
  }

  // Back button flow
  window.activityCompleted = false; // global for back logic

  window.goBack = async function goBack(){
    const { level, unit, fase } = getParams();

    if(!window.activityCompleted){
      const leave = confirm("You haven't completed this phase yet. Do you want to go back?");
      if(leave){ window.history.back(); }
      return;
    }
    if(!level || !unit || !fase){ window.history.back(); return; }

    firebase.auth().onAuthStateChanged(async (user)=>{
      if(!user){ window.history.back(); return; }
      const nextPhase = `fase${parseInt((fase||'').replace(/\D/g,''),10)+1}`;
      try{
        const snapshot = await firebase.database()
          .ref(`usuarios/${user.uid}/progresso/${level}/${unit}/${nextPhase}`)
          .once("value");
        if(snapshot.val() === true){
          window.history.back();
        } else {
          const confirmExit = confirm("The next phase is locked. Do you still want to go back?");
          if(confirmExit){ window.history.back(); }
        }
      }catch(err){
        console.error("[Back] Firebase error:", err);
        const confirmExit = confirm("Could not verify progress. Do you want to go back anyway?");
        if(confirmExit){ window.history.back(); }
      }
    });
  };

  /* =========================
     7) (Opcional) Helpers para histórias (assets por Level/Unit)
     — prontos para reuso em outras atividades
  ========================= */
  async function imageExists(url){
    return new Promise(res=>{
      const img = new Image();
      img.onload = ()=>res(true);
      img.onerror = ()=>res(false);
      img.src = url + (url.indexOf('?')>-1?'&':'?') + 'v=' + Date.now();
    });
  }
  async function loadSequentialImages(base, start, max){
    const frames = [];
    for(let i=start;i<=max;i++){
      const url = base + 'imagem' + i + '.png';
      /* eslint-disable no-await-in-loop */
      const ok = await imageExists(url);
      if(!ok){ if(i===start){ continue; } else { break; } }
      frames.push({ id:'f'+i, image:url });
    }
    return frames;
  }
  async function loadStoryText(base){
    const names = ['images.txt','imagens.txt'];
    for(let i=0;i<names.length;i++){
      try{
        const res = await fetch(base + names[i] + '?v=' + Date.now());
        if(!res.ok) continue;
        const raw = await res.text();
        return parseImagesTxt(raw);
      }catch(e){}
    }
    return null;
  }
  function parseImagesTxt(raw){
    const lines = raw.split(/\r?\n/);
    let title = null;
    const frames = [];
    let current = null;
    for(let i=0;i<lines.length;i++){
      const line = (lines[i]||'').trim();
      if(!line) continue;
      const mTitle = line.match(/^#title:\s*(.+)$/i);
      if(mTitle){ title = mTitle[1].trim(); continue; }
      const mImg = line.match(/^#(imagem|image)(\d+)$/i);
      if(mImg){
        const idx = parseInt(mImg[2],10) - 1;
        current = { idx, text:[] };
        frames[idx] = current; continue;
      }
      if(current){ current.text.push(line.replace(/^"|"$/g, '')); }
    }
    const ordered = [];
    for(let j=0;j<frames.length;j++){
      ordered[j] = frames[j] ? frames[j].text.join(' ').trim() : '';
    }
    return { title, frames:ordered };
  }

  /* =========================
     Q&A Activity (this file)
  ========================= */
  // Avatar
  (function(){
    const avatarEl = document.getElementById('avatar');
    const img = new Image();
    img.src = '../../imagens/robo1_static.png';
    img.alt = 'App mascot';
    img.onload = () => { avatarEl.textContent = ''; avatarEl.appendChild(img); };
    img.onerror = () => { avatarEl.textContent = '🤖'; };
  })();

  // Params + path base
  const { level, unit, fase } = getParams();
  const levelDir = normalizeDir('Level', level || '0', '0'); // e.g., Level0
  const unitDir  = normalizeDir('Unit',  unit  || '1', '1'); // e.g., Unit1
  const BASE  = `../../${levelDir}/${unitDir}/QA`;
  const QFILE = `${BASE}/questions.txt`;

  // Header crumbs
  const pill = document.getElementById('pill');
  pill.textContent = `${levelDir} • ${unitDir}${fase ? ' • Phase '+fase : ''}`;

  // Activity state
  let questions = [];
  let isReading = false;
  let currentAudio = null;
  let idx = 0;
  let answered = false;

  // Elements
  const subtitle   = document.getElementById('subtitle');
  const bar        = document.getElementById('bar');
  const promptEl   = document.getElementById('prompt');
  const mediaBox   = document.getElementById('mediaBox');
  const optionsEl  = document.getElementById('options');
  const btnPlayPrompt = document.getElementById('btnPlayPrompt');
  const btnRepeat  = document.getElementById('btnRepeat');
  const btnNext    = document.getElementById('btnNext');
  const statusPill = document.getElementById('statusPill');
  const confettiEl = document.getElementById('confetti');
  const liveEl     = document.getElementById('live');
  const loadingEl  = document.getElementById('loading');

  // Light SFX mp3 (fallback if WebAudio blocked)
  const sCorrect = new Audio(`${BASE}/sounds/correct.mp3`);
  const sWrong   = new Audio(`${BASE}/sounds/wrong.mp3`);
  const sTap     = new Audio(`${BASE}/sounds/tap.mp3`);
  const sNext    = new Audio(`${BASE}/sounds/next.mp3`);
  [sCorrect,sWrong,sTap,sNext].forEach(a=>{a.preload='auto'});

  // Loader + fetch
  showLoader(true);
  fetch(QFILE, {cache:'no-store'})
    .then(r => {
      if(!r.ok) throw new Error(`Could not load ${QFILE} (HTTP ${r.status})`);
      return r.text();
    })
    .then(text => {
      const data = JSON.parse(text);
      if(!data || !Array.isArray(data.questions)) throw new Error('Invalid format in questions.txt');
      questions = data.questions;
      subtitle.textContent = data.title || 'Practice answering quickly and carefully!';
      idx = 0;
      renderQuestion();
    })
    .catch(err=>{
      console.error('[Q&A] Load failed:', err);
      toast('Error loading questions. Check level, unit and questions.txt.');
      subtitle.textContent = 'Failed to load content';
      promptEl.textContent = `Path not found.\nBASE: ${BASE}\nFile: ${QFILE}`;
      mediaBox.innerHTML = '';
      optionsEl.innerHTML = '';
    })
    .finally(()=> showLoader(false));

  /* ===== Prompt/blank utilities ===== */
  function renderPromptWithBlanks(str){
    const s = String(str ?? '');
    return s
      .replace(/\{blank\}/g, '<span class="blank" aria-hidden="true"></span>')
      .replace(/\{b\d+\}/gi, '<span class="blank" aria-hidden="true"></span>')
      .replace(/_{3,}/g,     '<span class="blank" aria-hidden="true"></span>');
  }
  function ttsSanitize(str){
    return String(str ?? '')
      .replace(/\{blank\}/g, '')
      .replace(/\{b\d+\}/gi, '')
      .replace(/_{3,}/g, '');
  }
  function stripQuotesForTTS(str){
    return String(str ?? '').replace(/[“”"]/g,'').replace(/\s{2,}/g,' ').trim();
  }

  // Build spoken text with correct answers for fillblank
  function buildSpokenPrompt(q){
    if (q.tts && String(q.tts).trim()) return stripQuotesForTTS(q.tts);
    let text = String(q.prompt || '');
    if (q.type !== 'fillblank'){
      return stripQuotesForTTS(ttsSanitize(text));
    }
    const optMap = new Map();
    (Array.isArray(q.options) ? q.options : []).forEach(op=>{
      const o = (typeof op === 'string') ? {label:op, value:op} : {...op};
      optMap.set(normalize(o.value), o);
    });
    const speakValue = (val)=>{
      const key = normalize(val);
      const o = optMap.get(key);
      return stripQuotesForTTS((o && (o.tts || o.label || o.value)) || String(val||''));
    };
    // {b1},{b2},...
    text = text.replace(/\{b(\d+)\}/gi, (_m, nStr)=>{
      const n = parseInt(nStr,10);
      let ans = null;
      if (Array.isArray(q.answer)) ans = q.answer[n-1];
      else if (q.answer && typeof q.answer==='object') ans = q.answer['b'+n] ?? q.answer[n] ?? q.answer[nStr];
      else ans = q.answer;
      return speakValue(ans);
    });
    // {blank} and ___ (sequential)
    const seqAnswers = (()=>{
      if (Array.isArray(q.answer)) return q.answer.slice();
      if (q.answer && typeof q.answer==='object'){
        const keys = Object.keys(q.answer).sort((a,b)=>{
          const na = parseInt(String(a).replace(/\D/g,'')) || 0;
          const nb = parseInt(String(b).replace(/\D/g,'')) || 0;
          return na-nb;
        });
        return keys.map(k=>q.answer[k]);
      }
      return [q.answer];
    })();
    let seqIdx = 0;
    text = text.replace(/\{blank\}|_{3,}/g, ()=>{
      const val = seqAnswers[Math.min(seqIdx, seqAnswers.length-1)];
      seqIdx++;
      return speakValue(val);
    });
    return stripQuotesForTTS(text);
  }

  /* ===== Audio helpers (prompt & selection) ===== */
  function stopAllAudio(){
    try { speechSynthesis.cancel(); } catch(e){}
    if (currentAudio){
      try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){}
      currentAudio = null;
    }
  }
  function speak(text){
    const t = String(text || '').trim();
    if(!t) return;
    try{
      const u = new SpeechSynthesisUtterance(t);
      u.lang = 'en-US'; u.rate = 0.95; u.pitch = 1.0;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }
  function speakFriendly(pool){ const pick = pool[(Math.random()*pool.length)|0]; speak(pick); }

  /* ===== Render current question ===== */
  function renderQuestion(){
    answered = false;
    btnNext.disabled = true;
    btnNext.classList.remove('ready');
    btnPlayPrompt.disabled = false;
    btnRepeat.disabled = false;
    btnPlayPrompt.classList.remove('is-hidden');
    btnRepeat.classList.remove('is-hidden');

    const q = questions[idx];
    if(!q){ finish(); return; }

    const pct = Math.round(((idx)/questions.length)*100);
    bar.style.width = pct + '%';
    statusPill.textContent = `Question ${idx+1}/${questions.length}`;

    // Prompt UI: show visual blanks in-place, or fallback at end
    const rawPrompt = q.prompt || '—';
    promptEl.innerHTML = renderPromptWithBlanks(rawPrompt);
    if (q.type === 'fillblank' && !/\{blank\}|\{b\d+\}|_{3,}/i.test(rawPrompt)) {
      const span = document.createElement('span');
      span.className = 'blank'; span.setAttribute('aria-hidden','true');
      promptEl.appendChild(document.createTextNode(' '));
      promptEl.appendChild(span);
    }

    // Listen / Repeat — speak full sentence with answers
    btnPlayPrompt.onclick = () => { if (!isReading) playPrompt(q); };
    btnRepeat.onclick     = () => {
      if (isReading) return;
      stopAllAudio();
      speak(buildSpokenPrompt(q));
    };

    // Media
    mediaBox.innerHTML = '';
    if(q.image){
      const img = new Image(); img.alt = 'Question image';
      img.src = absPath(q.image); mediaBox.appendChild(img);
    } else {
      const img = new Image(); img.src = './hannah_pensando.png'; img.alt = 'Hannah thinking';
      mediaBox.appendChild(img);
    }

    // Options
    optionsEl.innerHTML = '';
    optionsEl.classList.remove('is-order');

    if (q.type === 'order') {
      renderOrderQuestion(q);
    } else if (q.type === 'match') {
      renderMatchQuestion(q);
    } else {
      const opts = (q.shuffleOptions===false) ? q.options : shuffle([...q.options]);
      opts.forEach(opt => optionsEl.appendChild(makeOption(q, opt)));
    }

    btnNext.onclick = () => {
      (ensureAudio()? sfxTick() : sNext.play().catch(()=>{}));
      idx++;
      if (idx >= questions.length) { finish(); return; }
      renderQuestion();
    };
  }

  /* ===== Build option button ===== */
  function makeOption(q, opt){
    const o = (typeof opt === 'string') ? { label: opt, value: opt } : { ...opt };

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'option';
    btn.setAttribute('aria-label', o.aria || o.label || 'option');

    const thumb = document.createElement('div'); thumb.className = 'thumb';
    if (o.image){
      const img = new Image(); img.src = absPath(o.image); img.alt = o.label || '';
      thumb.appendChild(img);
    } else if (o.emoji){
      thumb.textContent = o.emoji;
    } else {
      const box = document.createElement('span');
      box.className = 'square-outline';
      box.style.setProperty('--sq', '#7c3aed');
      thumb.textContent = ''; thumb.appendChild(box);
    }

    const textWrap = document.createElement('div');
    const label = document.createElement('div'); label.className = 'label'; label.textContent = o.label || '';
    textWrap.appendChild(label);
    if (typeof o.sub === 'string' && o.sub.trim()){
      const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = o.sub;
      textWrap.appendChild(sub);
    }

    btn.appendChild(thumb); btn.appendChild(textWrap);

    btn.onclick = () => {
      (ensureAudio()? sfxTick() : sTap.play().catch(()=>{}));
      speakSelectedThenCheck(q, o, btn);
    };
    thumb.style.cursor = 'pointer'; thumb.title = 'Play & choose';
    thumb.onclick = (e) => {
      e.preventDefault(); e.stopPropagation();
      (ensureAudio()? sfxTick() : sTap.play().catch(()=>{}));
      speakSelectedThenCheck(q, o, btn);
    };

    return btn;
  }

  /* ===== Answer handling ===== */
  function handleAnswer(q, opt, btn){
    if(answered) return;
    const isCorrect = normalize(opt.value) === normalize(q.answer);

    if(isCorrect){
      btn.classList.add('ok');
      (ensureAudio()? sfxCorrect() : sCorrect.play().catch(()=>{}));
      confetti(18);
      speakFriendly(['Yes! Great job!','Awesome!','You did it!']);
      try{
        mediaBox.innerHTML = '';
        const gif = new Image(); gif.src = './hannah_feliz.gif'; gif.alt = 'Hannah celebrating';
        gif.setAttribute('draggable','false'); gif.style.pointerEvents = 'none';
        mediaBox.appendChild(gif);
      }catch(e){}
      liveEl.textContent = 'Correct answer';
      answered = true;
      btnNext.disabled = false; btnNext.classList.add('ready');
      disableOthers(btn);
    } else {
      btn.classList.add('err');
      (ensureAudio()? sfxWrong() : sWrong.play().catch(()=>{}));
      speakFriendly(['Hmm… try again!','Not this one!','Almost!']);
      liveEl.textContent = 'Incorrect answer, try again';
    }
  }
  function disableOthers(keepBtn){
    Array.from(optionsEl.children).forEach(el=>{
      if(el!==keepBtn){ el.disabled = true; el.style.opacity = .5; }
    });
  }

  /* ===== Prompt playback: mp3 if present, else TTS full sentence ===== */
  function playPrompt(q){
    stopAllAudio();
    const spoken = buildSpokenPrompt(q);
    if (q.promptAudio){
      const a = new Audio(absPath(q.promptAudio));
      currentAudio = a;
      a.onended = () => { currentAudio = null; };
      a.onerror  = () => { currentAudio = null; speak(spoken); };
      a.play().catch(() => { currentAudio = null; speak(spoken); });
    } else {
      speak(spoken);
    }
  }

  /* ===== Selection speaking: mp3 option if present; else TTS ===== */
  function speakSelectedThenCheck(q, o, btn){
    if (answered || isReading) return;
    isReading = true;

    const allBtns = Array.from(document.querySelectorAll('.option'));
    allBtns.forEach(el => el.disabled = true);
    btnNext.disabled = true; btnNext.classList.remove('ready');

    const finish = () => {
      isReading = false;
      if (!answered) allBtns.forEach(el => el.disabled = false);
      handleAnswer(q, o, btn);
    };

    const say = (o.tts || o.label || o.value || '').toString().trim();
    stopAllAudio();

    if (o.audio){
      try{
        const a = new Audio(absPath(o.audio));
        currentAudio = a;
        let done = false;
        const safeFinish = () => { if (!done){ done = true; currentAudio = null; finish(); } };
        a.onended = safeFinish;
        a.onerror = () => { currentAudio = null; speak(say); setTimeout(safeFinish, 600); };
        a.play().catch(() => { currentAudio = null; speak(say); setTimeout(safeFinish, 600); });
        setTimeout(safeFinish, 3500);
      }catch{
        speak(say); setTimeout(finish, 600);
      }
    } else {
      try{
        const u = new SpeechSynthesisUtterance(say || ' '); u.lang = 'en-US'; u.rate = 0.95; u.pitch = 1.0;
        u.onend   = finish; u.onerror = () => setTimeout(finish, 300);
        speechSynthesis.cancel(); speechSynthesis.speak(u);
        setTimeout(() => { if (isReading) finish(); }, 2500);
      }catch{
        setTimeout(finish, 300);
      }
    }
  }

  /* ===== Activity completion ===== */
  function onActivityComplete(){
    if(window.activityCompleted) return;
    window.activityCompleted = true;
    (ensureAudio()? sfxWin() : sCorrect.play().catch(()=>{}));
    markPhaseCompleted();
  }

  function finish(){
    try { stopAllAudio(); } catch(e){} try { speechSynthesis.cancel(); } catch(e){}
    isReading = false;

    bar.style.width = '100%';
    promptEl.textContent = "🎉 Congratulations! You've completed all the questions!";
    mediaBox.innerHTML = '<div style="font-size:44px">🏅</div>';
    optionsEl.innerHTML = '';
    btnNext.disabled = true; btnNext.classList.remove('ready');
    statusPill.textContent = `Completed • ${questions.length}/${questions.length}`;
    confetti(30);
    speakFriendly(['Great! You finished!','Amazing work!']);

    btnPlayPrompt.disabled = true;
    btnRepeat.disabled = true;
    btnPlayPrompt.classList.add('is-hidden');
    btnRepeat.classList.add('is-hidden');

    onActivityComplete(); // <- progressão de fase
  }

  /* ===== General helpers ===== */
  function confetti(n=16){
    for(let i=0;i<n;i++){
      const p=document.createElement('div'); p.className='piece';
      const left = Math.random()*100;
      const dur = 1200 + Math.random()*1400;
      const delay = Math.random()*100;
      p.style.left = left+'%';
      p.style.setProperty('--h', Math.floor(Math.random()*360));
      p.style.animationDuration = dur+'ms';
      p.style.animationDelay = delay+'ms';
      confettiEl.appendChild(p);
      setTimeout(()=>p.remove(), dur+delay+200);
    }
  }
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
  function normalize(v){ return String(v ?? '').trim().toLowerCase(); }
  function absPath(p){ if(!p) return p; if(p.startsWith('http')) return p; if(p.startsWith('/')) return p; return `${BASE}/${p}`.replace(/\/+/g,'/'); }
  function showLoader(v){ if (loadingEl) loadingEl.style.display = v ? 'flex' : 'none'; }

  // Fresh reset on load (no auto-restore)
  window.addEventListener('load', function(){
    window.activityCompleted = false;
  });

})();
</script>
</body>
</html>
