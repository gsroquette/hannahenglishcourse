<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hannah Questions ‚Äî Review</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
    --ok:#16a34a; --warn:#ef4444; --brand:#2563eb;
    --shadow:0 10px 25px rgba(0,0,0,.08); --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background:url('../../imagens/fundo.png') center/cover no-repeat, var(--bg);
    color:var(--text);
  }

  /* ===== App container ===== */
  .app{
    width:100%;
    max-width:1140px;
    margin: 12px auto 24px auto;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
    position:relative;
    overflow:visible;
  }

  /* ===== Back separado (acima do header) ===== */
  #back-button{
    display:inline-flex;
    align-items:center;
    gap:.5rem;
    width:auto !important;
    max-width:none;
    margin-bottom:8px;
    border:none; background:#eef2ff; color:#0f3ea8;
    padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
    box-shadow:0 6px 14px rgba(0,0,0,.06);
  }
  #back-button:active{ transform: translateY(1px); }

  /* ===== Header ===== */
  .header{
    display:grid;
    grid-template-columns:auto 1fr auto;
    align-items:center;
    gap:12px;
    margin-bottom:12px;
  }
  .avatar{
    width:48px;height:48px;border-radius:50%;
    background:#e5f0ff;border:2px solid #cfe0ff;
    display:flex;align-items:center;justify-content:center;overflow:hidden;
  }
  .avatar img{width:100%;height:100%;object-fit:contain;border-radius:50%;display:block}
  .title-wrap{min-width:0}
  .title{font-weight:800;font-size:20px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .subtitle{color:var(--muted);font-size:14px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin-top:8px}
  .progress > div{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#34d399);transition:width .3s ease}

  .badge{
    max-width: 42ch;
    background:#eef2ff;border:1px solid #d7defc;color:#3949ab;
    padding:8px 10px;border-radius:999px;font-size:12px;line-height:1;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }

  /* ===== Question ===== */
  .stage{display:grid;gap:16px}
  .question-card{
    background:#f9fbff;border:1px solid #e5eaf5;border-radius:16px;padding:14px;
    margin: 0 auto;
  }

  .q-top{display:flex;flex-direction:column;gap:14px}

  /* Linha com prompt + √≠cone de √°udio do prompt */
  .q-prompt-row{
    display:flex;
    align-items:flex-start;
    gap:8px;
  }

  .q-prompt{
    font-size:22px;font-weight:800;line-height:1.3;word-break:break-word;
    flex:1 1 auto;
  }

  /* √çcone de √°udio do PROMPT (sempre l√™ o prompt) */
  .prompt-audio-btn{
    flex:0 0 auto;
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:22px;
    line-height:1;
    padding:6px;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition:background .15s ease, transform .1s ease, opacity .15s ease;
    opacity:0.85;
  }
  .prompt-audio-btn:hover{
    background:rgba(37,99,235,.08);
    opacity:1;
  }
  .prompt-audio-btn:active{
    transform:scale(.92);
  }

  .q-media{width:100%;aspect-ratio:16/10;background:#eef4ff;border:1px dashed #cfe0ff;border-radius:14px;padding:8px;overflow:hidden;display:block}
  .q-media img{width:100%;height:100%;object-fit:contain;display:block}
  @supports not (aspect-ratio:16/10){.q-media{height:220px}}

  .q-controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}

  /* Bot√£o LISTEN especial para audio_mcq (resposta) */
  .listen-audio-btn{
    border:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:12px 20px;
    border-radius:999px;
    background:linear-gradient(90deg,#3b82f6,#22c55e);
    color:#fff;
    font-weight:900;
    font-size:16px;
    cursor:pointer;
    box-shadow:0 10px 18px rgba(34,197,94,.35);
  }
  .listen-audio-btn .listen-icon{
    font-size:22px;
  }
  .listen-audio-btn .listen-label{
    letter-spacing:.08em;
  }
  .listen-audio-btn:active{
    transform:translateY(1px);
  }

  .icon-btn{border:none;background:#e6f0ff;color:#0f3ea8;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  .icon-btn:active{transform:translateY(1px)}

  .options{display:grid;gap:10px;margin-top:6px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .option{
    display:flex;align-items:center;gap:12px;background:#fff;border:2px solid #e9eef7;border-radius:18px;
    padding:12px;cursor:pointer;user-select:none;min-height:78px;
    box-shadow:0 4px 12px rgba(0,0,0,.03);
    transition:transform .06s ease,border-color .15s ease,box-shadow .15s ease
  }
  .option:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.06)}
  .option:active{transform:translateY(0)}
  .option .thumb{width:60px;height:60px;border-radius:14px;background:#f3f6ff;border:1px solid #e6ecfb;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:30px;flex:0 0 60px}
  .option .thumb img{width:100%;height:100%;object-fit:contain;padding:6px;display:block}
  .option.img-only{justify-content:center;gap:0}.option.img-only .thumb{margin:0 auto}.option.img-only .label{display:none}
  .option .label{font-size:19px;font-weight:800;letter-spacing:.2px;word-break:break-word}
  .option .sub{font-size:13px;color:var(--muted)}

  .square-outline{width:38px;height:38px;border:6px solid var(--sq,#7c3aed);border-radius:10px;background:transparent;display:inline-block;position:relative;transition:border-color .2s ease,background .2s ease,transform .15s ease}
  .option.ok .square-outline{border-color:#16a34a;background:#dcfce7}
  .option.ok .square-outline::after{content:"‚úî";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#166534;font-size:20px;font-weight:900;animation:pop-in .18s ease-out}
  .option.err .square-outline{border-color:#ef4444;background:#fee2e2}
  @keyframes pop-in{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
  .option.ok{border-color:#86efac;animation:okPulse .4s ease}
  .option.err{border-color:#fecaca;animation:shake .22s ease}
  @keyframes okPulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}100%{box-shadow:0 0 0 18px rgba(34,197,94,0)}}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}

  .footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .pill{background:#eef2ff;color:#3949ab;padding:8px 12px;border-radius:999px;font-size:12px;border:1px solid #d7defc}
  .next-btn{
    border:none;background:linear-gradient(90deg,#3b82f6,#22c55e);
    color:#fff;font-weight:800;padding:12px 16px;border-radius:14px;
    cursor:pointer;box-shadow:0 10px 18px rgba(34,197,94,.25);
    opacity:.3;pointer-events:none;transition:opacity .2s ease,transform .06s ease
  }
  .next-btn.ready{opacity:1;pointer-events:auto}
  .next-btn:active{transform:translateY(1px)}

  .secondary-btn{
    border:none;background:#eef2ff;color:#0f3ea8;font-weight:800;
    padding:12px 16px;border-radius:14px;cursor:pointer;
    box-shadow:0 10px 18px rgba(15,62,168,.12);
  }
  .secondary-btn:active{transform:translateY(1px)}

  .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  .piece{position:absolute;width:10px;height:10px;background:hsl(var(--h) 80% 60%);top:-12px;border-radius:2px;animation:drop linear forwards}
  @keyframes drop{to{transform:translateY(120vh) rotate(540deg)}}

  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;font-size:14px;box-shadow:var(--shadow);opacity:.96}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

  .build-wrap{margin-top:8px;position:sticky;top:0;z-index:3;background:#f9fbff;padding-bottom:8px;box-shadow:0 6px 10px -8px rgba(0,0,0,.15)}
  .build-tray{min-height:56px;background:#eef4ff;border:2px dashed #cfe0ff;border-radius:14px;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .word-chip{background:#fff;border:2px solid #dbe5ff;border-radius:12px;padding:8px 12px;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,.05);user-select:none}
  .build-actions{display:flex;gap:8px;margin-top:8px}
  .build-btn{border:none;background:#e6f0ff;color:#0f3ea8;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .build-btn:active{transform:translateY(1px)}
  .match-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .match-col{display:flex;flex-direction:column;gap:12px}
  .option.selected{outline:3px solid #60a5fa}
  .option.matched{border-color:#86efac;opacity:.65;pointer-events:none}
  .build-grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .option.word-only{gap:0;justify-content:center}
  .option.word-only .label{width:100%;text-align:center;font-size:22px;font-weight:800}

  .blank{
    display:inline-block;
    vertical-align:baseline;
    width:clamp(2ch, 6ch, 11ch);
    height:1.05em;
    border-bottom:3px solid #cfe0ff;
    margin:0 .3em;
  }

  .loading{position:fixed;inset:0;background:rgba(255,255,255,.75);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(2px);font-weight:700;color:#334155}
  .spinner{width:42px;height:42px;border-radius:50%;border:4px solid #c7d2fe;border-top-color:#3b82f6;animation:spin 1s linear infinite;margin-right:10px}
  @keyframes spin{to{transform:rotate(360deg)}}

  .icon-btn[disabled]{opacity:.4;pointer-events:none}
  .is-hidden{display:none!important}

  @media (max-width:720px){
    .options{grid-template-columns:1fr}
    .q-prompt{font-size:20px}
    .badge{grid-column:1/-1;max-width:100%}
  }

  @media (min-width: 1024px){
    .question-card{ padding:12px; }

    .q-top{
      display:grid;
      grid-template-columns: minmax(300px, 40%) 1fr;
      align-items:start;
      gap:16px;
    }

    .q-media{
      aspect-ratio:auto;
      height: clamp(160px, 24vh, 260px);
      max-width:100%;
    }

    .options{
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }

    .option{ min-height:68px; padding:10px 12px; }
    .option .thumb{ width:54px; height:54px; flex-basis:54px; }
    .option .label{ font-size:18px; }

    .q-prompt{ font-size:20px; }
  }

  @media (min-width: 900px) and (max-height: 820px){
    .q-top{ grid-template-columns: minmax(280px, 38%) 1fr; gap:12px; }
    .q-media{ height: clamp(150px, 22vh, 240px); }
    .options{ gap:10px; }
    .option{ min-height:64px; }
    .option .thumb{ width:50px; height:50px; flex-basis:50px; }
    .option .label{ font-size:17px; }
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <button id="back-button" onclick="goBack()">Back</button>

    <div class="confetti" id="confetti"></div>

    <div class="header">
      <div class="avatar" id="avatar" aria-hidden="true">ü§ñ</div>
      <div class="title-wrap">
        <div class="title">Hannah Questions ‚Äî Review</div>
        <div class="subtitle" id="subtitle">Loading content‚Ä¶</div>
        <div class="progress"><div id="bar"></div></div>
      </div>
      <div class="badge" id="pill">Unit ‚Äî</div>
    </div>

    <div class="stage">
      <div class="question-card">
        <div class="q-top">
          <div>
            <!-- Prompt + √≠cone de √°udio do prompt -->
            <div class="q-prompt-row">
              <div class="q-prompt" id="prompt">‚Äî</div>
              <button
                class="prompt-audio-btn"
                id="btnPlayPrompt"
                type="button"
                title="Listen to question"
                aria-label="Listen to the question"
              >
                üîä
              </button>
            </div>

            <!-- Bot√£o LISTEN especial (apenas para audio_mcq) -->
            <div class="q-controls">
              <button
                class="listen-audio-btn is-hidden"
                id="btnListenAnswer"
                type="button"
                title="Listen to the answer"
              >
                <span class="listen-icon">üéß</span>
                <span class="listen-label">LISTEN</span>
              </button>
            </div>
          </div>

          <div class="q-media" id="mediaBox" aria-label="Question image"></div>
        </div>

        <div class="options" id="options"></div>

        <div class="footer" id="footerBar">
          <span class="pill" id="statusPill">Question ‚Äî/‚Äî</span>

          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
            <button class="secondary-btn is-hidden" id="btnAlt1" type="button">Review Oldest</button>
            <button class="secondary-btn is-hidden" id="btnAlt2" type="button">Mixed Quiz</button>
            <button class="next-btn" id="btnNext" disabled>Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading" aria-live="polite" style="display:none">
    <div class="spinner" aria-hidden="true"></div>
    <span>Loading‚Ä¶</span>
  </div>

  <div class="sr-only" aria-live="polite" id="live"></div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
(function(){
  /* =========================
     Firebase init (v8)
  ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
    authDomain: "hannahenglishcourse.firebaseapp.com",
    databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hannahenglishcourse",
    storageBucket: "hannahenglishcourse.appspot.com",
    messagingSenderId: "449818788486",
    appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
  };

  try{
    if(!firebase.apps || !firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }
  }catch(e){
    // ignore init race
  }

  // Keep user uid
  let currentUserId = null;
  firebase.auth().onAuthStateChanged(function(user){
    currentUserId = user ? user.uid : null;
  });

  /* ============================================================
     REVIEW MODE (UPDATED to support audio_mcq + speakFriendly MP3)
  ============================================================ */

  /* =========================
     Helpers essenciais
  ========================= */
  function getParams(){
    const url = new URL(location.href);
    const level = url.searchParams.get('level');
    const unit  = url.searchParams.get('unit');
    const fase  = url.searchParams.get('fase');
    return { level, unit, fase };
  }

  function normalizeDir(prefix, value, fallbackNum){
    if (!value) return prefix + fallbackNum;
    const lower = value.toLowerCase();
    if (lower.startsWith(prefix.toLowerCase())) return value.trim();
    const onlyNum = (value.match(/\d+/)||[''])[0];
    return prefix + (onlyNum || fallbackNum);
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function normalize(v){
    return String(v ?? '')
      .trim()
      .toLowerCase()
      .replace(/\s+/g,' ')
      .replace(/[‚Äú‚Äù"]/g,'"');
  }

  function shuffle(arr){
    const a = Array.isArray(arr) ? arr : [];
    for (let i = a.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function absPath(p){
    const s = String(p ?? '').trim();
    if (!s) return s;
    if (/^https?:\/\//i.test(s)) return s;
    if (s.startsWith('/')) return s;
    return s;
  }

  function showLoader(show){
    const el = document.getElementById('loading');
    if (!el) return;
    el.style.display = show ? 'flex' : 'none';
  }

  /* =========================
     WebAudio SFX (inalterado)
  ========================= */
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    }
    return !!audioCtx;
  }

  function tone(freq, durMs, type){
    if(!ensureAudio()) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = type || 'sine'; o.frequency.value = freq;
    o.connect(g); g.connect(audioCtx.destination);
    const t0 = audioCtx.currentTime;
    g.gain.setValueAtTime(0.001, t0);
    g.gain.exponentialRampToValueAtTime(0.16, t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, t0 + (durMs/1000));
    o.start(t0); o.stop(t0 + (durMs/1000));
  }

  function sfxTick(){ tone(520, 70, 'square'); if(navigator.vibrate) navigator.vibrate(12); }
  function sfxCorrect(){ tone(880,120,'triangle'); setTimeout(()=>tone(1320,90,'triangle'),110); if(navigator.vibrate) navigator.vibrate(25); }
  function sfxWrong(){ tone(240,140,'sawtooth'); if(navigator.vibrate) navigator.vibrate(15); }
  function sfxWin(){ tone(660,120,'triangle'); setTimeout(()=>tone(990,120,'triangle'),120); setTimeout(()=>tone(1320,150,'triangle'),240); if(navigator.vibrate) navigator.vibrate([30,30,50]); }

  function toast(msg){
    const t=document.createElement('div');
    t.className='toast';
    t.textContent=msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2500);
  }

  /* =========================
     Progress√£o de fase
     (inalterada)
  ========================= */
  function ensureUserIsAuthenticated(callback){
    if(currentUserId){ callback(currentUserId); return; }
    firebase.auth().onAuthStateChanged(function(user){
      if(user){ currentUserId = user.uid; callback(user.uid); }
      else { console.error("[Auth] User not authenticated"); }
    });
  }

  async function updateNextPhase(userId){
    const { level, unit, fase } = getParams();
    if(!level || !unit || !fase) return;

    const levelKey = normalizeDir('Level', level || '0', '0');
    const unitKey  = normalizeDir('Unit',  unit  || '1', '1');
    const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${levelKey}/${unitKey}`);

    if(fase === "last"){
      const nextUnit = `Unit${parseInt(unitKey.replace(/\D/g,''),10)+1}`;
      await firebase.database().ref(`usuarios/${userId}/progresso/${levelKey}/${nextUnit}`).set({ fase1:true });
    } else if(fase === "end"){
      const nextLevel = `Level${parseInt(levelKey.replace(/\D/g,''),10)+1}`;
      await firebase.database().ref(`usuarios/${userId}/progresso/${nextLevel}/Unit1`).set({ fase1:true });
    } else {
      const cur = parseInt(fase,10);
      await dbRef.update({ [`fase${cur}`]: true, [`fase${cur+1}`]: true });
    }
  }

  /* =========================
     Config / Estado
  ========================= */
  const appEls = {
    subtitle: document.getElementById('subtitle'),
    pill: document.getElementById('pill'),
    bar: document.getElementById('bar'),
    prompt: document.getElementById('prompt'),
    mediaBox: document.getElementById('mediaBox'),
    options: document.getElementById('options'),
    statusPill: document.getElementById('statusPill'),
    btnNext: document.getElementById('btnNext'),
    btnPlayPrompt: document.getElementById('btnPlayPrompt'),
    btnListenAnswer: document.getElementById('btnListenAnswer'),
    live: document.getElementById('live'),
    confetti: document.getElementById('confetti'),
    btnAlt1: document.getElementById('btnAlt1'),
    btnAlt2: document.getElementById('btnAlt2')
  };

  let QUESTIONS = [];
  let idx = 0;
  let answered = false;
  let lastCorrect = false;

  let currentQuestion = null;
  let currentPromptAudio = '';
  let currentAnswerAudio = '';
  let currentOptionAudios = null; // object map {value: mp3}

  /* =========================
     √Åudio (HTMLAudio) ‚Äî Safari/iOS safe
     - 1 player global
     - troca de src com pause/reset
  ========================= */
  let audioPlayer = null;
  let audioUnlocked = false;

  function getAudioPlayer(){
    if(!audioPlayer){
      audioPlayer = new Audio();
      audioPlayer.preload = 'auto';
      audioPlayer.playsInline = true;
      audioPlayer.setAttribute('playsinline','true');
      audioPlayer.setAttribute('webkit-playsinline','true');
    }
    return audioPlayer;
  }

  function unlockAudioOnce(){
    if(audioUnlocked) return;
    audioUnlocked = true;

    try{
      if(audioCtx && audioCtx.state === 'suspended'){
        audioCtx.resume().catch(()=>{});
      }
    }catch(e){}

    try{
      const p = getAudioPlayer();
      p.muted = true;
      const prom = p.play();
      if(prom && typeof prom.then === 'function'){
        prom.then(()=>{
          p.pause();
          p.currentTime = 0;
          p.muted = false;
        }).catch(()=>{
          p.muted = false;
        });
      } else {
        p.pause();
        p.currentTime = 0;
        p.muted = false;
      }
    }catch(e){}
  }

  document.addEventListener('pointerdown', unlockAudioOnce, { once:true, passive:true });
  document.addEventListener('touchstart', unlockAudioOnce, { once:true, passive:true });

  /* =========================
     STOP ALL AUDIO (MP3 + TTS)
  ========================= */
  function stopAllAudio(){
    // HTMLAudio
    try{
      const p = getAudioPlayer();
      p.pause();
      p.currentTime = 0;
    }catch(e){}

    // SpeechSynthesis
    try{
      if('speechSynthesis' in window){
        window.speechSynthesis.cancel();
      }
    }catch(e){}
  }

  /* =========================
     TTS fallback (Safari safe)
  ========================= */
  function speak(text){
    const msg = String(text || '').trim();
    if(!msg) return;

    try{
      stopAllAudio();
      unlockAudioOnce();

      const u = new SpeechSynthesisUtterance(msg);
      u.lang = 'en-US';
      u.rate = 0.95;
      u.pitch = 1.0;

      setTimeout(()=>{
        try{ window.speechSynthesis.speak(u); }catch(e){}
      }, 50);
    }catch(e){
      console.warn("[TTS] speak error:", e);
    }
  }

  async function playMp3(url){
    stopAllAudio(); // ESSENCIAL: nunca toca 2 audios juntos

    const src = absPath(url);
    if(!src){
      toast("Audio not available.");
      return;
    }
    try{
      const p = getAudioPlayer();
      p.pause();
      p.currentTime = 0;
      p.src = encodeURI(src);
      try{ p.load(); }catch(e){}
      const prom = p.play();
      if(prom && typeof prom.then === 'function'){
        await prom;
      }
    }catch(err){
      console.error("[Audio] playMp3 error:", err);
      toast("Tap again to play audio.");
    }
  }

  /* =========================
   speakFriendly ‚Äî MP3s fixos (mesma pasta do HTML)
   Usa TODOS os arquivos e sorteia conforme o caso.
========================= */
function pickRandom(arr){
  if(!Array.isArray(arr) || !arr.length) return '';
  return arr[Math.floor(Math.random() * arr.length)];
}

// Seus arquivos (EXATOS) da pasta do HTML:
const FRIENDLY_POOLS = {
  correct: [
    "./nice!.mp3",
    "./awesome!.mp3",
    "./amazing-work!.mp3",
    "./great!.mp3",
    "./yes!-great-job!.mp3"
  ],
  wrong: [
    "./try-again!.mp3",
    "./hmm...-try-again!.mp3",
    "./not-this-one!.mp3",
    "./almost!.mp3"
  ],
  great: [
    "./great!.mp3",
    "./awesome!.mp3",
    "./amazing-work!.mp3",
    "./yes!-great-job!.mp3"
  ],
  done: [
    "./you-did-it!.mp3",
    "./great!-you-finished!.mp3"
  ],
  tap: [
    "./try-again!.mp3",
    "./hmm...-try-again!.mp3"
  ]
};

async function playFixedVoiceLine(kind, fallbackText){
  stopAllAudio();
  unlockAudioOnce();

  const list = FRIENDLY_POOLS[kind] || [];
  const file = pickRandom(list);

  if(file){
    try{
      await playMp3(file);
      return;
    }catch(e){}
  }

  // fallback TTS
  speak(fallbackText || kind);
}

function speakFriendly(kind){
  playFixedVoiceLine(kind, kind).catch(()=>{});
}

  /* =========================
     Load do JSON de quest√µes
  ========================= */
  function resolveQuestionsJsonPath(){
    const url = new URL(location.href);
    const { level, unit } = getParams();

    const levelKey = normalizeDir('Level', level || '0', '0');
    const unitKey  = normalizeDir('Unit',  unit  || '1', '1');

    const jsonParam = url.searchParams.get('json');
    if(jsonParam){
      return absPath(jsonParam);
    }

    const qa = url.searchParams.get('qa') || 'QA2';
    const file = url.searchParams.get('file') || 'questions.json';

    return `/${levelKey}/${unitKey}/${qa}/${file}`;
  }

  async function fetchJson(path){
    const p = absPath(path);
    showLoader(true);
    try{
      const res = await fetch(p, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status} ‚Äî ${p}`);
      const data = await res.json();
      return data;
    } finally {
      showLoader(false);
    }
  }

  /* =========================
     Normaliza√ß√£o de "audio_mcq"
  ========================= */
  function deriveAudioMcqFields(q){
    const optionAudios = (q && typeof q.optionAudios === 'object' && q.optionAudios) ? q.optionAudios : null;

    const answerValue = normalize(q.answer);
    let answerAudio = absPath(q.answerAudio);

    if(!answerAudio && optionAudios && answerValue){
      const direct = optionAudios[answerValue];
      if(direct) answerAudio = absPath(direct);
      else{
        const keys = Object.keys(optionAudios);
        for(const k of keys){
          if(normalize(k) === answerValue){
            answerAudio = absPath(optionAudios[k]);
            break;
          }
        }
      }
    }

    if(!answerAudio && Array.isArray(q.options)){
      for(const opt of q.options){
        if(normalize(opt.value) === answerValue || normalize(opt.label) === answerValue){
          if(opt.audio) { answerAudio = absPath(opt.audio); break; }
        }
      }
    }

    return { optionAudios, answerAudio };
  }

  /* =========================
     Render helpers
  ========================= */
  function setProgress(){
    const total = QUESTIONS.length || 1;
    const pct = Math.round(((idx+1) / total) * 100);
    if(appEls.bar) appEls.bar.style.width = pct + '%';
    if(appEls.statusPill) appEls.statusPill.textContent = `Question ${idx+1}/${total}`;
  }

  function setHeaderInfo(meta){
    const { level, unit, fase } = getParams();
    const levelKey = normalizeDir('Level', level || '0', '0');
    const unitKey  = normalizeDir('Unit',  unit  || '1', '1');

    if(appEls.subtitle){
      const title = (meta && meta.title) ? meta.title : 'Review';
      appEls.subtitle.textContent = `${title}`;
    }
    if(appEls.pill){
      appEls.pill.textContent = `${levelKey} ‚Ä¢ ${unitKey}` + (fase ? ` ‚Ä¢ fase ${fase}` : '');
    }
  }

  function clearOptions(){
    appEls.options.innerHTML = '';
  }

  function setMediaImage(src){
    const s = absPath(src);
    if(!s){
      appEls.mediaBox.innerHTML = '';
      appEls.mediaBox.classList.add('is-hidden');
      return;
    }
    appEls.mediaBox.classList.remove('is-hidden');
    appEls.mediaBox.innerHTML = `<img src="${escapeHtml(s)}" alt="" />`;
  }

  function setPromptText(prompt){
    appEls.prompt.innerHTML = escapeHtml(prompt || '‚Äî');
  }

  function setNextReady(isReady){
    if(!appEls.btnNext) return;
    if(isReady){
      appEls.btnNext.classList.add('ready');
      appEls.btnNext.disabled = false;
    } else {
      appEls.btnNext.classList.remove('ready');
      appEls.btnNext.disabled = true;
    }
  }

  function announce(msg){
    if(appEls.live) appEls.live.textContent = msg;
  }

  /* =========================
     Op√ß√µes (MCQ / AUDIO_MCQ)
  ========================= */
  function buildOptionCard(opt, showLabel){
    const img = absPath(opt.image);
    const label = opt.label ?? opt.value ?? '';
    const safeLabel = escapeHtml(label);

    const el = document.createElement('div');
    el.className = 'option' + (showLabel ? '' : ' img-only');

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    if(img){
      thumb.innerHTML = `<img src="${escapeHtml(img)}" alt="">`;
    } else {
      thumb.textContent = 'üî≤';
    }

    const labelWrap = document.createElement('div');
    labelWrap.className = 'label';
    labelWrap.innerHTML = safeLabel;

    const sq = document.createElement('span');
    sq.className = 'square-outline';
    sq.setAttribute('aria-hidden','true');

    el.appendChild(thumb);
    if(showLabel) el.appendChild(labelWrap);
    el.appendChild(sq);

    return el;
  }

  function handleOptionClick(valueNorm){
    if(answered) return;

    const q = currentQuestion;
    const correctNorm = normalize(q.answer);

    answered = true;

    const isCorrect = (valueNorm === correctNorm);
    lastCorrect = isCorrect;

    const optionEls = Array.from(appEls.options.querySelectorAll('.option'));
    for(const el of optionEls){
      const val = el.getAttribute('data-value-norm') || '';
      if(val === correctNorm){
        el.classList.add('ok');
      } else if(val === valueNorm && !isCorrect){
        el.classList.add('err');
      }
    }

    if(isCorrect){
      sfxCorrect();
      announce("Correct!");
      speakFriendly("correct");
    } else {
      sfxWrong();
      announce("Try again next time.");
      speakFriendly("wrong");
    }

    setNextReady(true);
  }

  function tryPlayOptionAudioForQuestion(q, opt){
    const qType = (q.type || '').toLowerCase();
    const optValueNorm = normalize(opt.value || opt.label);

    if(qType === 'audio_mcq'){
      if(currentOptionAudios){
        if(currentOptionAudios[optValueNorm]) return playMp3(currentOptionAudios[optValueNorm]);

        const keys = Object.keys(currentOptionAudios);
        for(const k of keys){
          if(normalize(k) === optValueNorm){
            return playMp3(currentOptionAudios[k]);
          }
        }
      }
      if(opt.audio) return playMp3(opt.audio);
      return;
    }

    if(opt.audio) return playMp3(opt.audio);
  }

  function renderMcqLike(q){
    clearOptions();
    answered = false;
    lastCorrect = false;
    setNextReady(false);

    const showLabel = true;

    const opts = Array.isArray(q.options) ? q.options.slice() : [];
    opts.forEach((opt, i)=>{
      const el = buildOptionCard(opt, showLabel);
      const valueNorm = normalize(opt.value || opt.label || String(i));
      el.setAttribute('data-value-norm', valueNorm);

      el.addEventListener('click', ()=>{
        try{ tryPlayOptionAudioForQuestion(q, opt); }catch(e){}
        handleOptionClick(valueNorm);
      });

      appEls.options.appendChild(el);
    });
  }

  /* =========================
     Bot√µes de √°udio: prompt e "LISTEN" (answerAudio)
  ========================= */
  function configureAudioButtons(q){
    currentPromptAudio = absPath(q.promptAudio);

    // PROMPT: sempre habilitado (MP3 ou fallback TTS)
    if(appEls.btnPlayPrompt){
      appEls.btnPlayPrompt.disabled = false;
      appEls.btnPlayPrompt.onclick = async ()=>{
        unlockAudioOnce();
        sfxTick();

        if(currentPromptAudio){
          await playMp3(currentPromptAudio);
        } else {
          speak(q.prompt);
        }
      };
    }

    const type = (q.type || '').toLowerCase();
    if(type === 'audio_mcq'){
      appEls.btnListenAnswer.classList.remove('is-hidden');

      const derived = deriveAudioMcqFields(q);
      currentOptionAudios = derived.optionAudios;
      currentAnswerAudio = derived.answerAudio;

      appEls.btnListenAnswer.onclick = async ()=>{
        unlockAudioOnce();
        sfxTick();

        // LISTEN (answer): MP3 se existir, sen√£o fallback TTS do answer
        if(currentAnswerAudio){
          await playMp3(currentAnswerAudio);
        } else {
          // fallback: fala a resposta (se existir)
          speak(q.answer);
        }
      };
    } else {
      appEls.btnListenAnswer.classList.add('is-hidden');
      currentOptionAudios = null;
      currentAnswerAudio = '';
    }
  }

  /* =========================
     MATCH (m√≠nimo funcional)
  ========================= */
  let matchState = {
    leftPicked: null,
    rightPicked: null,
    matchedCount: 0,
    total: 0
  };

  function renderMatch(q){
    clearOptions();
    answered = false;
    lastCorrect = false;
    setNextReady(false);

    const pairs = Array.isArray(q.pairs) ? q.pairs : [];
    const leftItems = pairs.map(p => ({
      type: 'left',
      label: (p.left && (p.left.label ?? p.left.value)) ?? '',
      value: (p.left && p.left.value) ?? (p.left && p.left.label) ?? '',
      image: ''
    }));
    const rightItems = pairs.map(p => ({
      type: 'right',
      label: '',
      value: (p.right && p.right.value) ?? '',
      image: (p.right && p.right.image) ?? ''
    }));

    matchState.leftPicked = null;
    matchState.rightPicked = null;
    matchState.matchedCount = 0;
    matchState.total = pairs.length;

    const leftShuf = shuffle(leftItems.slice());
    const rightShuf = shuffle(rightItems.slice());

    const wrap = document.createElement('div');
    wrap.className = 'match-grid';

    const colL = document.createElement('div');
    colL.className = 'match-col';

    const colR = document.createElement('div');
    colR.className = 'match-col';

    function makeLeftCard(item){
      const el = document.createElement('div');
      el.className = 'option word-only';
      const vNorm = normalize(item.value || item.label);
      el.setAttribute('data-match-side','left');
      el.setAttribute('data-value-norm', vNorm);

      const labelDiv = document.createElement('div');
      labelDiv.className = 'label';
      labelDiv.textContent = item.label || item.value || '‚Äî';

      el.appendChild(labelDiv);

      el.addEventListener('click', ()=>{
        if(el.classList.contains('matched')) return;
        Array.from(colL.querySelectorAll('.option')).forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        matchState.leftPicked = { valueNorm: vNorm, el };
        tryResolveMatch();
      });

      return el;
    }

    function makeRightCard(item){
      const el = document.createElement('div');
      el.className = 'option img-only';
      const vNorm = normalize(item.value);
      el.setAttribute('data-match-side','right');
      el.setAttribute('data-value-norm', vNorm);

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      const img = absPath(item.image);
      if(img){
        thumb.innerHTML = `<img src="${escapeHtml(img)}" alt="">`;
      } else {
        thumb.textContent = 'üñºÔ∏è';
      }
      el.appendChild(thumb);

      const sq = document.createElement('span');
      sq.className = 'square-outline';
      sq.setAttribute('aria-hidden','true');
      el.appendChild(sq);

      el.addEventListener('click', ()=>{
        if(el.classList.contains('matched')) return;
        Array.from(colR.querySelectorAll('.option')).forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        matchState.rightPicked = { valueNorm: vNorm, el };
        tryResolveMatch();
      });

      return el;
    }

    function tryResolveMatch(){
      if(!matchState.leftPicked || !matchState.rightPicked) return;

      const ok = matchState.leftPicked.valueNorm === matchState.rightPicked.valueNorm;

      if(ok){
        sfxCorrect();
        matchState.leftPicked.el.classList.add('matched');
        matchState.rightPicked.el.classList.add('matched');
        matchState.leftPicked.el.classList.remove('selected');
        matchState.rightPicked.el.classList.remove('selected');

        matchState.matchedCount++;

        matchState.leftPicked = null;
        matchState.rightPicked = null;

        announce("Matched!");
        speakFriendly("correct");

        if(matchState.matchedCount >= matchState.total){
          answered = true;
          lastCorrect = true;
          setNextReady(true);
          toast("All matched!");
          speakFriendly("great");
        }
      } else {
        sfxWrong();
        announce("Not a match.");
        speakFriendly("wrong");
        setTimeout(()=>{
          if(matchState.leftPicked){ matchState.leftPicked.el.classList.remove('selected'); }
          if(matchState.rightPicked){ matchState.rightPicked.el.classList.remove('selected'); }
          matchState.leftPicked = null;
          matchState.rightPicked = null;
        }, 450);
      }
    }

    leftShuf.forEach(it => colL.appendChild(makeLeftCard(it)));
    rightShuf.forEach(it => colR.appendChild(makeRightCard(it)));

    wrap.appendChild(colL);
    wrap.appendChild(colR);

    appEls.options.appendChild(wrap);
  }

  /* =========================
     Render principal por tipo
  ========================= */
  function renderQuestion(){
    const q = QUESTIONS[idx];
    if(!q){
      finishReview();
      return;
    }

    currentQuestion = q;

    setProgress();
    setPromptText(q.prompt || '‚Äî');
    setMediaImage(q.image);

    configureAudioButtons(q);

    const type = (q.type || '').toLowerCase();

    if(type === 'mcq' || type === 'audio_mcq'){
      renderMcqLike(q);
      return;
    }

    if(type === 'match'){
      renderMatch(q);
      return;
    }

    clearOptions();
    appEls.options.innerHTML = `<div class="pill">Type not supported: ${escapeHtml(type)}</div>`;
    setNextReady(true);
  }

  /* =========================
     Navega√ß√£o
  ========================= */
  function nextQuestion(){
    if(!QUESTIONS.length) return;

    // para n√£o ‚Äúvazar‚Äù √°udio quando troca de quest√£o
    stopAllAudio();

    if(idx < QUESTIONS.length - 1){
      idx++;
      renderQuestion();
    } else {
      finishReview();
    }
  }

  if(appEls.btnNext){
    appEls.btnNext.addEventListener('click', ()=>{
      if(appEls.btnNext.disabled) return;
      nextQuestion();
    });
  }

  /* =========================
     Finaliza√ß√£o
  ========================= */
  function popConfetti(){
    if(!appEls.confetti) return;
    appEls.confetti.innerHTML = '';
    const pieces = 90;
    for(let i=0;i<pieces;i++){
      const d=document.createElement('div');
      d.className='piece';
      d.style.left = Math.random()*100 + 'vw';
      d.style.animationDuration = (Math.random()*1.2 + 1.4) + 's';
      d.style.opacity = String(Math.random()*0.6 + 0.35);
      d.style.setProperty('--h', String(Math.floor(Math.random()*360)));
      d.style.transform = `translateY(0) rotate(${Math.random()*180}deg)`;
      appEls.confetti.appendChild(d);
    }
    setTimeout(()=>{ if(appEls.confetti) appEls.confetti.innerHTML=''; }, 2400);
  }

  function finishReview(){
    ensureUserIsAuthenticated(async (uid)=>{
      try{
        await updateNextPhase(uid);
      }catch(e){
        console.warn("[Progress] updateNextPhase error:", e);
      }
    });

    sfxWin();
    popConfetti();
    toast("Review completed!");
    speakFriendly("done");

    clearOptions();
    setPromptText("Great job!");
    setMediaImage('');
    appEls.btnListenAnswer.classList.add('is-hidden');
    if(appEls.btnPlayPrompt) appEls.btnPlayPrompt.disabled = true;

    if(appEls.btnNext){
      appEls.btnNext.disabled = true;
      appEls.btnNext.classList.remove('ready');
    }
    if(appEls.statusPill) appEls.statusPill.textContent = `Completed`;
  }

  /* =========================
     goBack() (para o bot√£o Back n√£o quebrar)
  ========================= */
  window.goBack = function(){
    try{
      stopAllAudio();
      history.back();
    }catch(e){
      location.href = '../../index.html';
    }
  };

  /* =========================
     Boot
  ========================= */
  async function init(){
    try{
      const { level, unit } = getParams();
      if(!level || !unit){
        toast("Missing URL params: level / unit");
        if(appEls.subtitle) appEls.subtitle.textContent = "Missing URL params.";
        return;
      }

      const jsonPath = resolveQuestionsJsonPath();
      const data = await fetchJson(jsonPath);

      setHeaderInfo(data);

      const qs = (data && Array.isArray(data.questions)) ? data.questions : [];
      QUESTIONS = qs;

      if(!QUESTIONS.length){
        toast("No questions found.");
        if(appEls.subtitle) appEls.subtitle.textContent = "No questions found.";
        return;
      }

      idx = 0;
      renderQuestion();
    } catch(err){
      console.error("[Init] error:", err);
      toast("Error loading questions JSON.");
      speakFriendly("tap");
      if(appEls.subtitle) appEls.subtitle.textContent = "Error loading content.";
    }
  }

  init();

})();
</script>

</body>
</html>

