<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hannah StoryCard</title>

    <!-- Scripts do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Configuração do Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
            authDomain: "hannahenglishcourse.firebaseapp.com",
            projectId: "hannahenglishcourse",
            storageBucket: "hannahenglishcourse.appspot.com",
            messagingSenderId: "449818788486",
            appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
            measurementId: "G-07VVJG9LRS",
            databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);

        // Variáveis globais
        let storyTitle = "Hannah Story"; // Título para o PDF
        let storyText = "";              // Texto da história (para PDF)
        let phaseCompleted = false;
        let showText = false;            // Alternar entre imagem (false) e texto (true)
        let viewedCards = new Set();     // Cards visualizados
        let spokenCards = new Set();     // Cards ouvidos

        // Áudio local (manifest) + player invisível
        let storyManifest = null;
        let currentAudio = null;

        // Estado de cards
        let cardsData = [];
        let currentCardIndex = 0;

        // -------------------- Role e botão de PDF --------------------
        function checkUserRole() {
            firebase.auth().onAuthStateChanged(async function(user) {
                if (user) {
                    const uid = user.uid;
                    const roleRef = firebase.database().ref(`usuarios/${uid}/role`);
                    const snapshot = await roleRef.once('value');
                    const role = snapshot.val();

                    // Exibe o botão PDF se o role for "professor" ou "proprietário"
                    if (role === "professor" || role === "proprietário") {
                        document.getElementById("pdfButton").style.display = "block";
                    }
                } else {
                    console.log("No user is logged in.");
                }
            });
        }

        // -------------------- Params da URL --------------------
        function getParamsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const level = urlParams.get('level');
            const unit  = urlParams.get('unit');
            const fase  = urlParams.get('fase');
            return { level, unit, fase };
        }

        // -------------------- Carrega manifest --------------------
        async function loadStoryManifest() {
            const { level, unit } = getParamsFromURL();
            const manifestPath = `../../${level}/${unit}/DataStory/sounds/storycards-manifest.json`;

            try {
                const resp = await fetch(manifestPath);
                if (!resp.ok) {
                    console.warn("No storycards-manifest.json found. Falling back to TTS.");
                    return null;
                }
                const data = await resp.json();
                console.log("Loaded manifest:", data);
                // Se manifest tiver title, usar como título da história
                if (data.title && typeof data.title === 'string') {
                    storyTitle = data.title;
                }
                return data;
            } catch (e) {
                console.warn("Error loading manifest:", e);
                return null;
            }
        }

        // -------------------- Carrega conteúdo (images.txt + imagens) --------------------
        async function loadContent() {
            const { level, unit } = getParamsFromURL();

            if (!level || !unit) {
                console.error("Level or Unit is missing in the URL parameters.");
                return [];
            }

            const dataStoryPath = `../../${level}/${unit}/DataStory/`;

            try {
                const response = await fetch(`${dataStoryPath}images.txt`);
                if (!response.ok) throw new Error(`Failed to fetch images.txt from ${dataStoryPath}`);
                
                const text = await response.text();
                const lines = text.split('\n');

                let cards = [];
                let currentImage = '';
                let currentText = '';

                lines.forEach(line => {
                    if (line.startsWith('#imagem')) {
                        if (currentImage && currentText) {
                            cards.push({ image: currentImage, text: currentText.trim() });
                        }
                        currentImage = line.replace('#', '').trim(); // e.g., imagem1
                        currentText = '';
                    } else {
                        currentText += line + ' ';
                    }
                });

                if (currentImage && currentText) {
                    cards.push({ image: currentImage, text: currentText.trim() });
                }

                storyText = cards.map(card => card.text).join('\n\n');

                // Atualiza caminhos das imagens
                cards = cards.map(card => ({
                    ...card,
                    image: `${dataStoryPath}images/${card.image}.png`
                }));

                console.log("Final Cards Data:", cards);
                return cards;
            } catch (error) {
                console.error("Error loading content:", error);
                return [];
            }
        }

        // -------------------- Renderização do Card + Sincronização do botão --------------------
        function displayCard(index) {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            const cardData = cardsData[index];

            const cardElement = document.createElement('div');
            cardElement.className = 'card active';
            cardElement.onclick = () => toggleView(); // Alternar entre texto e imagem

            if (showText) {
                const textContainer = document.createElement('div');
                textContainer.className = 'card-text';
                textContainer.innerHTML = `<p>${cardData.text}</p>`;
                cardElement.appendChild(textContainer);
            } else {
                cardElement.innerHTML = `<img src="${cardData.image}" alt="Image">`;
            }

            // Botão do "speaker"
            const businessmanImage = document.createElement('img');
            businessmanImage.src = 'businessman.png';
            businessmanImage.className = 'businessman';
            businessmanImage.onclick = (event) => {
                event.stopPropagation(); // Evita alternar texto/imagem ao clicar no ícone
                toggleSpeech(cardData.text, businessmanImage, index);
            };

            cardElement.appendChild(businessmanImage);
            container.appendChild(cardElement);

            // Marcar o cartão como visualizado
            if (!viewedCards.has(index)) {
                console.log(`Card ${index + 1} marked as viewed.`);
                viewedCards.add(index);
            }
            checkCompletion();

            // Navegação
            document.getElementById('prevBtn').style.display = (index === 0) ? 'none' : 'block';
            document.getElementById('nextBtn').style.display = (index === cardsData.length - 1) ? 'none' : 'block';

            // ✅ FIX: garantir que o rótulo do botão esteja sempre sincronizado após qualquer render
            const toggleBtn = document.getElementById("toggleButton");
            if (toggleBtn) {
                toggleBtn.innerText = showText ? "See the story" : "Read the story";
            }
        }

        // Alterna texto/imagem e atualiza rótulo do botão
        function toggleView() {
            showText = !showText;
            const toggleBtn = document.getElementById("toggleButton");
            if (toggleBtn) {
                toggleBtn.innerText = showText ? "See the story" : "Read the story";
            }
            displayCard(currentCardIndex);
        }

        // Navegação
        function showNextCard() {
            currentCardIndex = (currentCardIndex + 1) % cardsData.length;
            console.log("Showing next card. Current index: ", currentCardIndex);
            displayCard(currentCardIndex);
        }
        function showPreviousCard() {
            currentCardIndex = (currentCardIndex - 1 + cardsData.length) % cardsData.length;
            console.log("Showing previous card. Current index: ", currentCardIndex);
            displayCard(currentCardIndex);
        }

        // -------------------- Botão "Back" com verificação de fase --------------------
        document.addEventListener("DOMContentLoaded", () => {
            const backButton = document.querySelector("button#backButton");
            if (backButton) {
                backButton.addEventListener("click", handleBackButtonClick);
            }
        });

        async function handleBackButtonClick() {
            const { level, unit, fase } = getParamsFromURL();

            if (!level || !unit || !fase) {
                alert("Level, Unit or Fase not identified in the URL.");
                return;
            }

            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    const uid = user.uid;
                    const isPhaseCompleted = await checkPhaseProgress(uid, level, unit, fase);

                    if (isPhaseCompleted) {
                        console.log("Next phase is already unlocked. Going back.");
                        window.history.back();
                    } else {
                        const confirmExit = confirm(
                            "The next phase is not completed.\n\nTo complete this phase, you must view and listen to ALL story cards (open each card and play the audio to the end).\n\nDo you wish to leave anyway?"
                        );
                        if (confirmExit) {
                            console.log("User chose to leave without completing the phase. Going back.");
                            window.history.back();
                        }
                    }
                } else {
                    alert("Please log in to save your progress and continue.");
                }
            });
        }

        async function checkPhaseProgress(uid, level, unit, currentFase) {
            try {
                const currentNumber = parseInt(currentFase.replace("fase", ""));
                const nextFase = `fase${currentNumber + 1}`;
                const dbRef = firebase.database().ref(`usuarios/${uid}/progresso/${level}/${unit}/${nextFase}`);
                const snapshot = await dbRef.once("value");
                return snapshot.val(); // true se estiver liberada, false se não
            } catch (error) {
                console.error("Error checking phase progress:", error);
                return false;
            }
        }

        // -------------------- Áudio: MP3 (prioridade) com fallback TTS --------------------
        function toggleSpeech(text, buttonElement, index) {
            playCardAudio(text, buttonElement, index);
        }

        async function playCardAudio(text, buttonElement, index) {
            stopCurrentAudio();

            const mp3Url = getMp3ForCard(index);
            if (mp3Url) {
                try {
                    console.log("Attempting MP3:", mp3Url);
                    await playMp3(mp3Url, buttonElement, index);
                    return;
                } catch (e) {
                    console.warn("MP3 failed, fallback to TTS:", e);
                }
            }

            // Fallback TTS (sem alertas sobre voz en-US)
            playTTS(text, buttonElement, index);
        }

        function getMp3ForCard(index) {
            if (!storyManifest) return null;
            const card = storyManifest.cards?.find(c => c.index === index + 1);
            if (!card) return null;

            const { level, unit } = getParamsFromURL();
            return `../../${level}/${unit}/DataStory/sounds/${card.audio}`;
        }

        function playMp3(url, buttonElement, index) {
            return new Promise((resolve, reject) => {
                currentAudio = new Audio(url);
                currentAudio.preload = "auto";
                currentAudio.play().then(() => {
                    // Visual opcional durante reprodução
                    buttonElement.src = 'pause.png';
                    markSpokenOnEnd(buttonElement, index, resolve);
                }).catch(reject);
            });
        }

        function stopCurrentAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
        }

        function playTTS(text, buttonElement, index) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'en-US';
            window.speechSynthesis.speak(utter);

            buttonElement.src = 'pause.png';
            utter.onend = () => {
                buttonElement.src = 'businessman.png';
                spokenCards.add(index); // Marca como ouvido
                checkCompletion();
            };
        }

        function markSpokenOnEnd(buttonElement, index, resolve) {
            currentAudio.onended = () => {
                buttonElement.src = 'businessman.png';
                spokenCards.add(index);
                checkCompletion();
                resolve();
            };
        }

        // -------------------- Check Completion --------------------
        async function checkCompletion() {
            console.log("Checking completion...");
            console.log(`Viewed cards: ${viewedCards.size}/${cardsData.length}`);
            console.log(`Spoken cards: ${spokenCards.size}/${cardsData.length}`);

            if (viewedCards.size === cardsData.length && spokenCards.size === cardsData.length) {
                if (!phaseCompleted) {
                    phaseCompleted = true;
                    console.log("All cards viewed and heard. Phase completed.");
                    
                    const user = firebase.auth().currentUser;
                    if (user) {
                        const { fase } = getParamsFromURL();
                        await salvarProgressoAluno(user.uid, fase);
                        alert("Congratulations! You have completed this phase.");
                    } else {
                        console.log("User not logged in. Progress not saved.");
                    }
                }
            }
        }

        // -------------------- PDF --------------------
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Adiciona a logo
            doc.addImage('Logo.png', 'PNG', 85, 10, 40, 40); // Posiciona a logo no PDF

            // Campos de nome e data
            doc.setFontSize(12);
            doc.text("Name:_______________________________________________________  Date:_______________", 10, 60);

            // Título
            doc.setFontSize(20);
            doc.text(storyTitle, 105, 80, { align: "center" });

            // Texto da história
            doc.setFontSize(12);
            let y = 100; // Posição inicial para o texto
            const marginLeft = 10;
            const maxLineWidth = 180;
            const lineHeight = 10;

            const splitText = doc.splitTextToSize(storyText, maxLineWidth);
            splitText.forEach(line => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(line, marginLeft, y);
                y += lineHeight;
            });

            doc.save("story.pdf"); // Salva o PDF com o nome 'story.pdf'
        }

        // -------------------- Boot --------------------
        document.addEventListener("DOMContentLoaded", async () => {
            // Role e manifest/conteúdo
            checkUserRole();
            storyManifest = await loadStoryManifest();
            cardsData = await loadContent();

            // Exibe o primeiro card
            displayCard(0);

            // ✅ FIX: sincroniza o rótulo do botão na carga inicial
            const toggleBtn = document.getElementById("toggleButton");
            if (toggleBtn) {
                toggleBtn.innerText = showText ? "See the story" : "Read the story";
            }
        });
    </script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-image: url('../../../imagens/fundo.png');
            background-repeat: repeat;
            background-size: auto;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 30px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        h1 {
            font-size: 2.5em;
            color: #4CAF50;
            margin-bottom: 30px;
            text-align: center;
        }

        .title {
            font-size: 2em;
            color: #333;
            margin: 20px 0;
            text-align: center;
        }

        .card {
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin: 20px auto;
            padding: 20px 40px 20px 20px;
            background-color: #f0f8ff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 700px;
            min-height: 100px;
            position: relative;
            text-align: center;
            /* Garante espaço extra no fundo, para o botão não cobrir o texto */
            padding-bottom: 120px;
        }

        .active {
            display: flex;
        }

        .card img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .card-text p {
            font-size: 1.5em;
            text-align: center;
            color: #333;
            margin: 0;
        }

        .businessman {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 60px;
            height: 60px;
            cursor: pointer;
        }

        button {
            margin: 20px;
            padding: 15px 30px;
            font-size: 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }

        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Styles remain consistent and functional */
        .card img {
            max-width: 100%; /* Keeps images responsive */
        }
    </style>
</head>
<body>
    <button id="backButton">Back</button>

    <div class="container">
        <h1>Hannah StoryCard</h1>
        <div class="button-container">
            <button id="toggleButton" onclick="toggleView()">Read the story</button>
            <button id="pdfButton" onclick="generatePDF()" style="display: none;">Generate PDF</button>
        </div>
        <div class="title" id="storyTitle"></div>
        <div id="cardsContainer"></div>
        <div class="navigation">
            <button id="prevBtn" onclick="showPreviousCard()">Previous</button>
            <button id="nextBtn" onclick="showNextCard()">Next</button>
        </div>
    </div>
</body>
</html>
