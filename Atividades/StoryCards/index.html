<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hannah StoryCard</title>

  <!-- Firebase & jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#4CAF50;
      --brand-dark:#45a049;
      --ink:#333;
      --card:#f0f8ff;
      --bg:#ffffff;
      --muted:#6b7280;
      --ok:#16a34a;
      --warn:#f59e0b;
      --ring:#60a5fa;
    }

    /* Base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('../../../imagens/fundo.png');
      background-repeat: repeat;
      background-size: auto;
      color: var(--ink);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      width: 100%;
      margin: 30px auto;
      padding: 20px;
      background-color: var(--bg);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    h1 {
      font-size: 2.0rem;
      color: var(--brand);
      margin: 0 0 10px 0;
      text-align: center;
    }

    /* ---------------- Top helper / progress ---------------- */
    .helper-top {
      margin: 6px auto 14px;
      text-align: center;
      font-size: .95rem;
      color: var(--muted);
    }

    .progress-wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 10px 0 2px;
    }
    .progress-box{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .progress-label{
      display:flex;
      justify-content:space-between;
      font-size:.9rem;
      color:#111827;
    }
    .bar-outer{
      width:100%;
      height:10px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
    }
    .bar-inner{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--brand), #22c55e);
      transition: width .35s ease;
    }

    /* Buttons */
    button {
      margin: 12px;
      padding: 12px 22px;
      font-size: 16px;
      background-color: var(--brand);
      color: white;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: transform .12s ease, background-color .15s ease;
    }
    button:hover { background-color: var(--brand-dark); }
    button:active { transform: scale(.98); }

    .button-container {
      display:flex;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      gap:10px;
      margin: 8px 0 14px;
    }

    .title {
      font-size: 1.4rem;
      color: #111827;
      margin: 6px 0 10px;
      text-align: center;
      font-weight:600;
    }

    /* Card */
    .card {
      display: flex;
      flex-direction: column;
      justify-content: center;
      margin: 14px auto;
      padding: 20px 40px 20px 20px;
      background-color: var(--card);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 80%;
      max-width: 700px;
      min-height: 120px;
      position: relative;
      text-align: center;
      padding-bottom: 120px; /* espaÃ§o para o botÃ£o play */
    }
    .active{ display:flex; }

    .card img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .card-text p {
      font-size: 1.35rem;
      text-align: center;
      color: #333;
      margin: 0;
    }

    /* Play button (businessman.png) with pulse when needed */
    .businessman {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 60px;
      height: 60px;
      cursor: pointer;
      border-radius: 999px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
      background:#fff;
      padding:6px;
    }
    .pulse{
      animation: pulse 1.2s ease-in-out infinite;
      outline: 3px solid rgba(76,175,80,.15);
      outline-offset: 2px;
    }
    @keyframes pulse{
      0%{ transform: scale(1); box-shadow: 0 0 0 0 rgba(76,175,80,.35);}
      50%{ transform: scale(1.06); box-shadow: 0 0 0 8px rgba(76,175,80,.08);} 
      100%{ transform: scale(1); box-shadow: 0 0 0 0 rgba(76,175,80,.0);} 
    }

    /* Next button nudge (applied conditionally) */
    .nudge{ animation: nudge 1.1s ease-in-out infinite; }
    @keyframes nudge{ 0%{ transform: translateX(0); } 50%{ transform: translateX(2px); } 100%{ transform: translateX(0); } }

    .navigation {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 6px;
      align-items:center;
    }
    .next-hint{
      font-size:.9rem;
      color:var(--muted);
      margin-right:14px;
      opacity:0;
      transition: opacity .2s ease;
    }
    .next-hint.show{ opacity:1; }

    /* Paginator dots */
    .paginator{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      margin: 8px 0 2px;
    }
    .dot{
      width:18px; height:18px; border-radius:50%;
      background:#e5e7eb; position:relative; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      border:2px solid #d1d5db;
    }
    .dot.viewed{ border-color:#9ca3af; background:#f3f4f6; }
    .dot.spoken{ border-color:#60a5fa; }
    .dot.done{ border-color:#22c55e; background:#dcfce7; }
    .dot::after{ /* inner ring for spoken */
      content:"";
      position:absolute; inset:4px; border-radius:50%;
      border:2px solid transparent;
    }
    .dot.spoken::after{ border-color:#60a5fa; }
    .dot.done::after{ content:"âœ“"; position:static; inset:auto; border:none; font-size:.8rem; color:#065f46; }

    /* Accessibility & motion prefs */
    @media (prefers-reduced-motion: reduce){ .pulse, .nudge{ animation:none !important; } }

    /* Keep images responsive */
    .card img { max-width: 100%; }

    /* Modal (completion) */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:50;
    }
    .modal{
      width:min(520px, 92vw);
      background:#fff; border-radius:16px; padding:20px; box-shadow:0 20px 50px rgba(0,0,0,.25);
    }
    .modal h2{ margin:0 0 8px; font-size:1.4rem; color:#0f172a; text-align:center; }
    .modal p{ margin:6px 0; color:#334155; text-align:center; }
    .checklines{ display:flex; gap:10px; justify-content:center; margin:10px 0 2px; }
    .check{ background:#f8fafc; padding:8px 12px; border-radius:999px; font-size:.95rem; color:#0f766e; border:1px solid #e2e8f0; }
    .modal-actions{ display:flex; gap:10px; justify-content:center; margin-top:12px; }
    .btn-secondary{ background:#111827; color:#fff; }
    .modal-backdrop.show{ display:flex; }
  </style>
</head>
<body>
  <!-- Back button (keeps original behavior) -->
  <button id="backButton">Back</button>

  <div class="container" aria-live="polite">
    <h1>Hannah StoryCard</h1>

    <!-- Helper + Double progress (NEW) -->
    <div class="helper-top" id="helperTop">Complete all cards to unlock the next phase.</div>
    <div class="progress-wrap" aria-describedby="helperTop">
      <div class="progress-box">
        <div class="progress-label"><span>Cards viewed</span><span id="viewedCount">0/0</span></div>
        <div class="bar-outer" aria-label="Cards viewed progress">
          <div class="bar-inner" id="barViewed" style="width:0%"></div>
        </div>
      </div>
      <div class="progress-box">
        <div class="progress-label"><span>Audios finished</span><span id="audioCount">0/0</span></div>
        <div class="bar-outer" aria-label="Audios finished progress">
          <div class="bar-inner" id="barAudio" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="button-container">
      <button id="toggleButton" onclick="toggleView()">Read the story</button>
      <button id="pdfButton" onclick="generatePDF()" style="display: none;">Generate PDF</button>
    </div>

    <div class="title" id="storyTitle"></div>

    <!-- Paginator dots (NEW) -->
    <div class="paginator" id="paginator" role="tablist" aria-label="Cards"></div>

    <div id="cardsContainer"></div>

    <div class="navigation">
      <button id="prevBtn" onclick="showPreviousCard()">Previous</button>
      <div class="next-hint" id="nextHint">Great! Go to the next card â†’</div>
      <button id="nextBtn" onclick="showNextCard()">Next</button>
    </div>
  </div>

  <!-- Completion Modal (NEW) -->
  <div class="modal-backdrop" id="completeModal" role="dialog" aria-modal="true" aria-labelledby="completeTitle">
    <div class="modal">
      <h2 id="completeTitle">Great job! Phase completed ðŸŽ‰</h2>
      <p>You viewed all cards and finished all audios.</p>
      <div class="checklines">
        <div class="check" id="chkViewed">Cards viewed: 0/0 âœ“</div>
        <div class="check" id="chkAudios">Audios finished: 0/0 âœ“</div>
      </div>
      <p>Your next phase is now unlocked.</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="btnBackPhases">Back to phases</button>
        <button id="btnReview">Review the story</button>
        <button id="btnPDF">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    // -------------------- Firebase Config --------------------
    var firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId: "G-07VVJG9LRS",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

    // -------------------- Globals --------------------
    let storyTitle = "Hannah Story";  // used in PDF
    let storyText = "";               // used in PDF
    let phaseCompleted = false;
    let showText = false;
    let viewedCards = new Set();
    let spokenCards = new Set();

    let storyManifest = null;
    let currentAudio = null;

    let cardsData = [];
    let currentCardIndex = 0;

    let nudgeTimer = null;

    // -------------------- Role -> show PDF button --------------------
    function checkUserRole() {
      firebase.auth().onAuthStateChanged(async function(user) {
        if (user) {
          const uid = user.uid;
          const roleRef = firebase.database().ref(`usuarios/${uid}/role`);
          const snapshot = await roleRef.once('value');
          const role = snapshot.val();
          if (role === "professor" || role === "proprietÃ¡rio") {
            document.getElementById("pdfButton").style.display = "block";
          }
        } else {
          console.log("No user is logged in.");
        }
      });
    }

    // -------------------- URL Params --------------------
    function getParamsFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const level = urlParams.get('level');
      const unit  = urlParams.get('unit');
      const fase  = urlParams.get('fase');
      return { level, unit, fase };
    }

    // -------------------- Load Manifest --------------------
    async function loadStoryManifest() {
      const { level, unit } = getParamsFromURL();
      const manifestPath = `../../${level}/${unit}/DataStory/sounds/storycards-manifest.json`;
      try {
        const resp = await fetch(manifestPath);
        if (!resp.ok) {
          console.warn("No storycards-manifest.json found. Falling back to TTS.");
          return null;
        }
        const data = await resp.json();
        if (data.title && typeof data.title === 'string') storyTitle = data.title;
        return data;
      } catch (e) {
        console.warn("Error loading manifest:", e);
        return null;
      }
    }

    // -------------------- Load Content (images.txt) --------------------
    async function loadContent() {
      const { level, unit } = getParamsFromURL();
      if (!level || !unit) {
        console.error("Level or Unit is missing in the URL parameters.");
        return [];
      }
      const dataStoryPath = `../../${level}/${unit}/DataStory/`;
      try {
        const response = await fetch(`${dataStoryPath}images.txt`);
        if (!response.ok) throw new Error(`Failed to fetch images.txt from ${dataStoryPath}`);
        const text = await response.text();
        const lines = text.split('\n');

        let cards = [];
        let currentImage = '';
        let currentText = '';

        lines.forEach(line => {
          if (line.startsWith('#imagem')) {
            if (currentImage && currentText) {
              cards.push({ image: currentImage, text: currentText.trim() });
            }
            currentImage = line.replace('#', '').trim();
            currentText = '';
          } else {
            currentText += line + ' ';
          }
        });
        if (currentImage && currentText) {
          cards.push({ image: currentImage, text: currentText.trim() });
        }

        storyText = cards.map(card => card.text).join('\n\n');
        cards = cards.map(card => ({
          ...card,
          image: `${dataStoryPath}images/${card.image}.png`
        }));
        return cards;
      } catch (error) {
        console.error("Error loading content:", error);
        return [];
      }
    }

    // -------------------- UI Helpers --------------------
    function updateStoryTitle(){
      const el = document.getElementById('storyTitle');
      if (el) el.textContent = storyTitle || 'Hannah Story';
    }

    function updateProgressUI(){
      const total = cardsData.length || 0;
      const v = viewedCards.size;
      const s = spokenCards.size;

      const viewedCount = document.getElementById('viewedCount');
      const audioCount  = document.getElementById('audioCount');
      const barViewed   = document.getElementById('barViewed');
      const barAudio    = document.getElementById('barAudio');

      if (viewedCount) viewedCount.textContent = `${v}/${total}`;
      if (audioCount) audioCount.textContent = `${s}/${total}`;
      if (barViewed) barViewed.style.width = total ? `${Math.round((v/total)*100)}%` : '0%';
      if (barAudio)  barAudio.style.width  = total ? `${Math.round((s/total)*100)}%` : '0%';

      // Update paginator states
      refreshPaginatorStates();
    }

    // -------------------- Paginator --------------------
    function buildPaginator(){
      const pag = document.getElementById('paginator');
      pag.innerHTML = '';
      const total = cardsData.length;
      for (let i=0;i<total;i++){
        const d = document.createElement('button');
        d.className = 'dot';
        d.type = 'button';
        d.setAttribute('role','tab');
        d.setAttribute('aria-controls','cardsContainer');
        d.title = `Card ${i+1}`;
        d.addEventListener('click', ()=> {
          currentCardIndex = i;
          displayCard(currentCardIndex);
        });
        pag.appendChild(d);
      }
      refreshPaginatorStates();
    }

    function refreshPaginatorStates(){
      const pag = document.getElementById('paginator');
      const dots = pag.querySelectorAll('.dot');
      dots.forEach((dot, i)=>{
        dot.classList.remove('viewed','spoken','done');
        const seen = viewedCards.has(i);
        const heard = spokenCards.has(i);
        if (seen) dot.classList.add('viewed');
        if (heard) dot.classList.add('spoken');
        if (seen && heard) dot.classList.add('done');

        // Accessible labels
        let label = `Card ${i+1} â€” `;
        if (seen && heard) label += 'viewed and listened';
        else if (seen) label += 'viewed, audio pending';
        else if (heard) label += 'listened, view pending';
        else label += 'not started yet';
        dot.setAttribute('aria-label', label);
      });
    }

    // -------------------- Display Card --------------------
    function displayCard(index) {
      clearNudge();

      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      const cardData = cardsData[index];

      const cardElement = document.createElement('div');
      cardElement.className = 'card active';
      cardElement.onclick = () => toggleView();

      if (showText) {
        const textContainer = document.createElement('div');
        textContainer.className = 'card-text';
        textContainer.innerHTML = `<p>${cardData.text}</p>`;
        cardElement.appendChild(textContainer);
      } else {
        cardElement.innerHTML = `<img src="${cardData.image}" alt="Image">`;
      }

      // Play button (businessman.png)
      const playBtn = document.createElement('img');
      playBtn.src = 'businessman.png';
      playBtn.className = 'businessman';
      // Pulse only if this card hasn't been fully listened yet
      if (!spokenCards.has(index)) playBtn.classList.add('pulse');

      playBtn.onclick = (event) => {
        event.stopPropagation();
        // stop pulsing when user engages
        playBtn.classList.remove('pulse');
        toggleSpeech(cardData.text, playBtn, index);
      };

      cardElement.appendChild(playBtn);
      container.appendChild(cardElement);

      // Mark as viewed
      if (!viewedCards.has(index)) viewedCards.add(index);
      updateProgressUI();
      checkCompletion(false); // only check; modal only when really finishing

      // Navigation buttons visibility
      document.getElementById('prevBtn').style.display = (index === 0) ? 'none' : 'block';
      document.getElementById('nextBtn').style.display = (index === cardsData.length - 1) ? 'none' : 'block';

      // Sync toggle label
      const toggleBtn = document.getElementById("toggleButton");
      if (toggleBtn) {
        toggleBtn.innerText = showText ? "See the story" : "Read the story";
      }

      // Set title
      updateStoryTitle();

      // Maybe nudge "Next" if user lingers and this card already complete
      scheduleNudgeIfReady();
    }

    // -------------------- Toggle text/image --------------------
    function toggleView() {
      showText = !showText;
      const toggleBtn = document.getElementById("toggleButton");
      if (toggleBtn) {
        toggleBtn.innerText = showText ? "See the story" : "Read the story";
      }
      displayCard(currentCardIndex);
    }

    // -------------------- Navigation --------------------
    function showNextCard() {
      currentCardIndex = (currentCardIndex + 1) % cardsData.length;
      displayCard(currentCardIndex);
    }
    function showPreviousCard() {
      currentCardIndex = (currentCardIndex - 1 + cardsData.length) % cardsData.length;
      displayCard(currentCardIndex);
    }

    // -------------------- Back button with phase check --------------------
    document.addEventListener("DOMContentLoaded", () => {
      const backButton = document.querySelector("button#backButton");
      if (backButton) backButton.addEventListener("click", handleBackButtonClick);
    });

    async function handleBackButtonClick() {
      const { level, unit, fase } = getParamsFromURL();
      if (!level || !unit || !fase) {
        alert("Level, Unit or Fase not identified in the URL.");
        return;
      }
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          const uid = user.uid;
          const isPhaseCompleted = await checkPhaseProgress(uid, level, unit, fase);
          if (isPhaseCompleted) {
            window.history.back();
          } else {
            const confirmExit = confirm(
              "The next phase is not completed.\n\nTo complete this phase, you must view and listen to ALL story cards (open each card and play the audio to the end).\n\nDo you wish to leave anyway?"
            );
            if (confirmExit) window.history.back();
          }
        } else {
          alert("Please log in to save your progress and continue.");
        }
      });
    }

    async function checkPhaseProgress(uid, level, unit, currentFase) {
      try {
        const currentNumber = parseInt(currentFase.replace("fase", ""));
        const nextFase = `fase${currentNumber + 1}`;
        const dbRef = firebase.database().ref(`usuarios/${uid}/progresso/${level}/${unit}/${nextFase}`);
        const snapshot = await dbRef.once("value");
        return snapshot.val();
      } catch (error) {
        console.error("Error checking phase progress:", error);
        return false;
      }
    }

    // -------------------- Audio: MP3 first, fallback to TTS --------------------
    function toggleSpeech(text, buttonElement, index) {
      playCardAudio(text, buttonElement, index);
    }

    async function playCardAudio(text, buttonElement, index) {
      stopCurrentAudio();

      const mp3Url = getMp3ForCard(index);
      if (mp3Url) {
        try {
          await playMp3(mp3Url, buttonElement, index);
          return;
        } catch (e) {
          console.warn("MP3 failed, fallback to TTS:", e);
        }
      }
      playTTS(text, buttonElement, index);
    }

    function getMp3ForCard(index) {
      if (!storyManifest) return null;
      const card = storyManifest.cards?.find(c => c.index === index + 1);
      if (!card) return null;
      const { level, unit } = getParamsFromURL();
      return `../../${level}/${unit}/DataStory/sounds/${card.audio}`;
    }

    function playMp3(url, buttonElement, index) {
      return new Promise((resolve, reject) => {
        currentAudio = new Audio(url);
        currentAudio.preload = "auto";
        currentAudio.play().then(() => {
          buttonElement.src = 'pause.png';
          markSpokenOnEnd(buttonElement, index, resolve);
        }).catch(reject);
      });
    }

    function stopCurrentAudio() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
      }
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
      }
    }

    function playTTS(text, buttonElement, index) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      window.speechSynthesis.speak(utter);

      buttonElement.src = 'pause.png';
      utter.onend = () => {
        buttonElement.src = 'businessman.png';
        spokenCards.add(index);
        updateProgressUI();
        checkCompletion(true);
      };
    }

    function markSpokenOnEnd(buttonElement, index, resolve) {
      currentAudio.onended = () => {
        buttonElement.src = 'businessman.png';
        spokenCards.add(index);
        updateProgressUI();
        checkCompletion(true);
        resolve();
      };
    }

    // -------------------- Completion Check + Modal --------------------
    async function checkCompletion(canShowModal = true) {
      const total = cardsData.length;
      if (total === 0) return;

      const allViewed = viewedCards.size === total;
      const allSpoken = spokenCards.size === total;

      if (allViewed && allSpoken) {
        if (!phaseCompleted) {
          phaseCompleted = true;

          const user = firebase.auth().currentUser;
          if (user) {
            const { fase } = getParamsFromURL();
            await salvarProgressoAluno(user.uid, fase);
          } else {
            console.log("User not logged in. Progress not saved.");
          }

          if (canShowModal) openCompletionModal();
        }
      }
    }

    // Save progress (keeps original flow + safe fallback to next phase)
    async function salvarProgressoAluno(uid, fase) {
      try {
        const { level, unit } = getParamsFromURL();
        const db = firebase.database();

        await db.ref(`usuarios/${uid}/progresso/${level}/${unit}/${fase}`).set(true);

        if (typeof updateNextPhase === "function") {
          await updateNextPhase(uid);
        } else {
          const n = parseInt(fase.replace("fase", ""), 10);
          if (!isNaN(n)) {
            const proxima = `fase${n + 1}`;
            await db.ref(`usuarios/${uid}/progresso/${level}/${unit}/${proxima}`).set(true);
          }
        }
      } catch (err) {
        console.error("Erro ao salvar progresso:", err);
      }
    }

    function openCompletionModal(){
      // Fill counts
      const total = cardsData.length;
      document.getElementById('chkViewed').textContent = `Cards viewed: ${viewedCards.size}/${total} âœ“`;
      document.getElementById('chkAudios').textContent = `Audios finished: ${spokenCards.size}/${total} âœ“`;

      const modal = document.getElementById('completeModal');
      modal.classList.add('show');

      // Focus first action for accessibility
      const btnBack = document.getElementById('btnBackPhases');
      setTimeout(()=> btnBack && btnBack.focus(), 50);
    }

    // Modal actions
    (function attachModalActions(){
      const modal = document.getElementById('completeModal');
      const btnBack = document.getElementById('btnBackPhases');
      const btnReview = document.getElementById('btnReview');
      const btnPDF = document.getElementById('btnPDF');

      btnBack?.addEventListener('click', ()=> window.history.back());
      btnReview?.addEventListener('click', ()=> modal.classList.remove('show'));
      btnPDF?.addEventListener('click', ()=> generatePDF());

      // Close on backdrop click
      modal.addEventListener('click', (e)=>{
        if (e.target === modal) modal.classList.remove('show');
      });
      // Close on Esc
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && modal.classList.contains('show')) modal.classList.remove('show');
      });
    })();

    // -------------------- Next Nudge (idle) --------------------
    function scheduleNudgeIfReady(){
      clearNudge();
      const idx = currentCardIndex;
      const ready = viewedCards.has(idx) && spokenCards.has(idx);
      if (!ready) return;

      nudgeTimer = setTimeout(()=>{
        const nextBtn = document.getElementById('nextBtn');
        const nextHint = document.getElementById('nextHint');
        if (nextBtn) nextBtn.classList.add('nudge');
        if (nextHint) nextHint.classList.add('show');
      }, 4500); // user linger time
    }
    function clearNudge(){
      if (nudgeTimer){ clearTimeout(nudgeTimer); nudgeTimer = null; }
      const nextBtn = document.getElementById('nextBtn');
      const nextHint = document.getElementById('nextHint');
      nextBtn?.classList.remove('nudge');
      nextHint?.classList.remove('show');
    }

    // -------------------- PDF (keeps your original behavior) --------------------
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Logo (try/catch if not found)
      try { doc.addImage('Logo.png', 'PNG', 85, 10, 40, 40); } catch(e){ /* ignore if not found */ }

      // Name / Date fields
      doc.setFontSize(12);
      doc.text("Name:_______________________________________________________  Date:_______________", 10, 60);

      // Title
      doc.setFontSize(20);
      doc.text(storyTitle, 105, 80, { align: "center" });

      // Story text
      doc.setFontSize(12);
      let y = 100;
      const marginLeft = 10;
      const maxLineWidth = 180;
      const lineHeight = 10;

      const splitText = doc.splitTextToSize(storyText, maxLineWidth);
      splitText.forEach(line => {
        if (y > 280) { doc.addPage(); y = 20; }
        doc.text(line, marginLeft, y);
        y += lineHeight;
      });

      doc.save("story.pdf");
    }

    // -------------------- Boot --------------------
    document.addEventListener("DOMContentLoaded", async () => {
      checkUserRole();
      storyManifest = await loadStoryManifest();
      cardsData = await loadContent();

      // Build paginator & show first card
      buildPaginator();
      displayCard(0);

      // Sync toggle label initially
      const toggleBtn = document.getElementById("toggleButton");
      if (toggleBtn) toggleBtn.innerText = showText ? "See the story" : "Read the story";
    });
  </script>
</body>
</html>