<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hannah StoryCard</title>

  <!-- Firebase + jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#4CAF50; --brand-dark:#45a049; --ink:#333; --muted:#6b7280; --ok:#16a34a; --overlay:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background-image:url('../../../imagens/fundo.png');
      background-repeat:repeat; background-size:auto; color:var(--ink);
      display:block; min-height:100vh;
    }
    .container{max-width:900px;width:100%;margin:30px auto;padding:20px;background:#fff;box-shadow:0 8px 16px rgba(0,0,0,.1);border-radius:10px}
    h1{font-size:2.5em;color:var(--brand);margin:0 0 20px;text-align:center}
    .title{font-size:2em;color:#333;margin:10px 0 8px;text-align:center}

    /* Buttons (PDF ao lado do Read) */
    .button-container{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:12px}
    button{padding:12px 24px;font-size:16px;background:var(--brand);color:#fff;border:none;border-radius:50px;cursor:pointer}
    button:hover{background:var(--brand-dark)}

    /* Card: imagem √© o foco absoluto */
    .card{position:relative;margin:6px auto 18px;width:100%;max-width:860px;text-align:center}
    .story-image{width:100%;height:auto;display:block;border-radius:10px}
    .card-text p{font-size:1.5em;text-align:center;color:#333;margin:0;padding:10px 8px}

    /* √çcone play (businessman) pequeno e fixo no canto da imagem */
    .businessman{position:absolute;bottom:12px;right:12px;width:56px;height:56px;cursor:pointer;filter:drop-shadow(0 4px 10px rgba(0,0,0,.35));object-fit:contain}
    .pulse-play{animation:pulsePlay 1.2s ease-in-out infinite}
    @keyframes pulsePlay{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    /* Next pulse ap√≥s concluir o √°udio */
    .pulse-next{animation:pulseNext 1.1s ease-in-out infinite}
    @keyframes pulseNext{0%{transform:translateX(0) scale(1)}50%{transform:translateX(1px) scale(1.04)}100%{transform:translateX(0) scale(1)}}

    .navigation{display:flex;justify-content:space-between;align-items:center;width:100%;margin-top:8px}

    /* Paginador mini (linha √∫nica) e bloqueio de avan√ßo */
    .paginator{display:flex;gap:6px;justify-content:center;align-items:center;flex-wrap:nowrap;overflow:hidden;margin:6px 0 0}
    .dot{width:10px;height:10px;border-radius:50%;background:#e5e7eb;border:1px solid #d1d5db;padding:0;display:inline-block}
    .dot.current{background:#9ca3af}
    .dot.done{background:var(--brand);border-color:var(--brand)}
    .dot.locked{opacity:.45;cursor:not-allowed}

    .gate-hint{font-size:11px;color:var(--muted);text-align:center;margin-top:4px;min-height:14px}

    /* Modal de conclus√£o */
    .modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{width:min(520px,92vw);background:#fff;border-radius:16px;padding:20px;box-shadow:0 20px 50px rgba(0,0,0,.25)}
    .modal h2{margin:0 0 8px;font-size:1.4rem;color:#0f172a;text-align:center}
    .modal p{margin:6px 0;color:#334155;text-align:center}
    .checklines{display:flex;gap:10px;justify-content:center;margin:10px 0 2px}
    .check{background:#f8fafc;padding:8px 12px;border-radius:999px;font-size:.95rem;color:#0f766e;border:1px solid #e2e8f0}
    .modal-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .btn-secondary{background:#111827;color:#fff}

    @media (prefers-reduced-motion:reduce){.pulse-play,.pulse-next{animation:none!important}}
  </style>
</head>
<body>
  <button id="backButton">Back</button>

  <div class="container" aria-live="polite">
    <h1>Hannah StoryCard</h1>
    <div class="button-container">
      <button id="toggleButton" onclick="toggleView()">Read the story</button>
      <button id="pdfButton" onclick="generatePDF()" style="display:none;">Generate PDF</button>
    </div>
    <div class="title" id="storyTitle"></div>

    <!-- Paginador mini + microcopy -->
    <div class="paginator" id="paginator" aria-label="Cards"></div>
    <div class="gate-hint" id="gateHint">Tap <strong>Play</strong> to advance.</div>

    <div id="cardsContainer"></div>

    <div class="navigation">
      <button id="prevBtn" onclick="showPreviousCard()">Previous</button>
      <button id="nextBtn" onclick="showNextCard()">Next</button>
    </div>
  </div>

  <!-- Modal Conclus√£o -->
  <div class="modal-backdrop" id="completeModal" role="dialog" aria-modal="true" aria-labelledby="completeTitle">
    <div class="modal">
      <h2 id="completeTitle">Great job! Phase completed üéâ</h2>
      <p>You viewed all cards and finished all audios.</p>
      <div class="checklines">
        <div class="check" id="chkViewed">Cards viewed: 0/0 ‚úì</div>
        <div class="check" id="chkAudios">Audios finished: 0/0 ‚úì</div>
      </div>
      <p>Your next phase is now unlocked.</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="btnBackPhases">Back to phases</button>
        <button id="btnReview">Review the story</button>
        <button id="btnPDF">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase
    var firebaseConfig={
      apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",authDomain:"hannahenglishcourse.firebaseapp.com",projectId:"hannahenglishcourse",storageBucket:"hannahenglishcourse.appspot.com",messagingSenderId:"449818788486",appId:"1:449818788486:web:8a49d3f68591e6fb3f0707",measurementId:"G-07VVJG9LRS",databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

    // Estado global
    let storyTitle="Hannah Story"; let storyText=""; let phaseCompleted=false; let showText=false;
    let viewedCards=new Set(); let spokenCards=new Set();
    let storyManifest=null; let currentAudio=null; let cardsData=[]; let currentCardIndex=0; let maxVisitedIndex=0;

    // Role -> PDF
    function checkUserRole(){
      firebase.auth().onAuthStateChanged(async function(user){
        if(user){
          const uid=user.uid; const roleRef=firebase.database().ref(`usuarios/${uid}/role`); const snapshot=await roleRef.once('value'); const role=snapshot.val();
          if(role==="professor"||role==="propriet√°rio"){ document.getElementById('pdfButton').style.display='block'; }
        }
      });
    }

    // URL params
    function getParamsFromURL(){ const p=new URLSearchParams(window.location.search); return {level:p.get('level'),unit:p.get('unit'),fase:p.get('fase')}; }

    // Manifest & conte√∫do
    async function loadStoryManifest(){
      const {level,unit}=getParamsFromURL(); const path=`../../${level}/${unit}/DataStory/sounds/storycards-manifest.json`;
      try{const r=await fetch(path); if(!r.ok) return null; const data=await r.json(); if(data.title) storyTitle=data.title; return data;}catch(e){return null}
    }
    async function loadContent(){
      const {level,unit}=getParamsFromURL(); if(!level||!unit) return [];
      const base=`../../${level}/${unit}/DataStory/`;
      try{const res=await fetch(`${base}images.txt`); if(!res.ok) throw new Error('Failed to fetch images.txt');
        const txt=await res.text(); const lines=txt.split('
'); let cards=[]; let curImg=''; let curTxt='';
        lines.forEach(line=>{ if(line.startsWith('#imagem')){ if(curImg&&curTxt) cards.push({image:curImg,text:curTxt.trim()}); curImg=line.replace('#','').trim(); curTxt=''; } else { curTxt+=line+' '; } });
        if(curImg&&curTxt) cards.push({image:curImg,text:curTxt.trim()});
        storyText=cards.map(c=>c.text).join('

');
        return cards.map(c=>({...c,image:`${base}images/${c.image}.png`}));
      }catch(e){return []}
    }

    // Paginador
    function buildPaginator(){
      const pag=document.getElementById('paginator'); pag.innerHTML='';
      for(let i=0;i<cardsData.length;i++){
        const d=document.createElement('span'); d.className='dot'+(i===0?' current':' locked'); d.title=`Card ${i+1}`;
        d.addEventListener('click',()=>{ if(i<=maxVisitedIndex){ currentCardIndex=i; displayCard(currentCardIndex);} });
        pag.appendChild(d);
      }
      refreshPaginator();
    }
    function refreshPaginator(){
      const dots=document.querySelectorAll('#paginator .dot'); dots.forEach((dot,i)=>{
        dot.classList.remove('current','done','locked');
        if(i===currentCardIndex) dot.classList.add('current');
        if(spokenCards.has(i)) dot.classList.add('done'); // verde quando √°udio conclu√≠do
        if(i>maxVisitedIndex) dot.classList.add('locked');
      });
    }

    // Card
    function displayCard(index){
      if(!viewedCards.has(index)) viewedCards.add(index);
      if(index>maxVisitedIndex) maxVisitedIndex=index;

      const container=document.getElementById('cardsContainer'); container.innerHTML='';
      const data=cardsData[index];

      const card=document.createElement('div'); card.className='card'; card.onclick=()=>toggleView();

      if(showText){
        const t=document.createElement('div'); t.className='card-text'; t.innerHTML=`<p>${data.text}</p>`; card.appendChild(t);
      }else{
        const img=document.createElement('img'); img.src=data.image; img.alt='Image'; img.className='story-image'; card.appendChild(img);
      }

      const play=document.createElement('img'); play.src='businessman.png'; play.className='businessman';
      if(!spokenCards.has(index)) play.classList.add('pulse-play');
      play.onclick=(e)=>{ e.stopPropagation(); play.classList.remove('pulse-play'); toggleSpeech(data.text,play,index); };
      card.appendChild(play);

      container.appendChild(card);

      document.getElementById('prevBtn').style.display=(index===0)?'none':'inline-block';
      document.getElementById('nextBtn').style.display=(index===cardsData.length-1)?'none':'inline-block';

      const toggleBtn=document.getElementById('toggleButton'); if(toggleBtn) toggleBtn.innerText=showText?'See the story':'Read the story';
      document.getElementById('storyTitle').textContent=storyTitle||'Hannah Story';

      // microcopy: mostrar apenas se ainda n√£o ouviu este card
      const hint=document.getElementById('gateHint');
      if(hint){ hint.style.visibility = spokenCards.has(index) ? 'hidden' : 'visible'; }

      refreshPaginator();
    }

    // Toggle view
    function toggleView(){ showText=!showText; const t=document.getElementById('toggleButton'); if(t) t.innerText=showText?'See the story':'Read the story'; displayCard(currentCardIndex); }

    // Navega√ß√£o
    function showNextCard(){ const idx=Math.min(currentCardIndex+1,cardsData.length-1); currentCardIndex=idx; displayCard(currentCardIndex); }
    function showPreviousCard(){ const idx=Math.max(currentCardIndex-1,0); currentCardIndex=idx; displayCard(currentCardIndex); }

    // Back + verifica√ß√£o de fase
    document.addEventListener('DOMContentLoaded',()=>{ const back=document.querySelector('button#backButton'); if(back) back.addEventListener('click',handleBackButtonClick); });
    async function handleBackButtonClick(){
      const {level,unit,fase}=getParamsFromURL(); if(!level||!unit||!fase){ alert('Level, Unit or Fase not identified in the URL.'); return; }
      firebase.auth().onAuthStateChanged(async (user)=>{
        if(user){ const uid=user.uid; const ok=await checkPhaseProgress(uid,level,unit,fase); if(ok) window.history.back(); else if(confirm('The next phase is not completed.

To complete this phase, you must view and listen to ALL story cards (open each card and play the audio to the end).

Do you wish to leave anyway?')) window.history.back(); }
        else{ alert('Please log in to save your progress and continue.'); }
      });
    }
    async function checkPhaseProgress(uid,level,unit,currentFase){
      try{ const n=parseInt(currentFase.replace('fase','')); const next=`fase${n+1}`; const snap=await firebase.database().ref(`usuarios/${uid}/progresso/${level}/${unit}/${next}`).once('value'); return snap.val(); }catch(e){ return false }
    }

    // √Åudio (MP3 priorit√°rio + fallback TTS)
    function toggleSpeech(text,buttonElement,index){ playCardAudio(text,buttonElement,index); }
    async function playCardAudio(text,buttonElement,index){
      stopCurrentAudio(); const mp3Url=getMp3ForCard(index);
      if(mp3Url){ try{ await playMp3(mp3Url,buttonElement,index); return; }catch(e){ console.warn('MP3 failed, fallback to TTS',e); } }
      playTTS(text,buttonElement,index);
    }
    function getMp3ForCard(index){ if(!storyManifest) return null; const card=storyManifest.cards?.find(c=>c.index===index+1); if(!card) return null; const {level,unit}=getParamsFromURL(); return `../../${level}/${unit}/DataStory/sounds/${card.audio}`; }
    function playMp3(url,buttonElement,index){ return new Promise((resolve,reject)=>{ currentAudio=new Audio(url); currentAudio.preload='auto'; currentAudio.play().then(()=>{ buttonElement.src='pause.png'; markSpokenOnEnd(buttonElement,index,resolve); }).catch(reject); }); }
    function stopCurrentAudio(){ if(currentAudio){ currentAudio.pause(); currentAudio.currentTime=0; currentAudio=null; } if(window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); } }
    function playTTS(text,buttonElement,index){ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.speak(u); buttonElement.src='pause.png'; u.onend=()=>{ buttonElement.src='businessman.png'; onAudioFinished(index); }; }
    function markSpokenOnEnd(buttonElement,index,resolve){ currentAudio.onended=()=>{ buttonElement.src='businessman.png'; onAudioFinished(index); resolve(); }; }

    // Ao terminar √°udio deste card
    function onAudioFinished(index){
      spokenCards.add(index);
      // microcopy some: esconder
      const hint=document.getElementById('gateHint'); if(hint && index===currentCardIndex){ hint.style.visibility='hidden'; }
      // pulsar Next
      const nextBtn=document.getElementById('nextBtn'); if(nextBtn) nextBtn.classList.add('pulse-next');
      refreshPaginator();
      checkCompletion();
    }

    // Conclus√£o + modal
    async function checkCompletion(){
      const total=cardsData.length; if(total===0) return;
      const allViewed=viewedCards.size===total; const allSpoken=spokenCards.size===total;
      if(allViewed && allSpoken){ if(!phaseCompleted){ phaseCompleted=true; const user=firebase.auth().currentUser; if(user){ const {fase}=getParamsFromURL(); await salvarProgressoAluno(user.uid,fase);} openCompletionModal(); } }
    }
    async function salvarProgressoAluno(uid,fase){
      try{ const {level,unit}=getParamsFromURL(); const db=firebase.database(); await db.ref(`usuarios/${uid}/progresso/${level}/${unit}/${fase}`).set(true);
        if(typeof updateNextPhase==='function'){ await updateNextPhase(uid); }
        else { const n=parseInt(fase.replace('fase',''),10); if(!isNaN(n)){ const prox=`fase${n+1}`; await db.ref(`usuarios/${uid}/progresso/${level}/${unit}/${prox}`).set(true);} }
      }catch(err){ console.error('Erro ao salvar progresso:',err); }
    }
    function openCompletionModal(){
      const total=cardsData.length; document.getElementById('chkViewed').textContent=`Cards viewed: ${viewedCards.size}/${total} ‚úì`;
      document.getElementById('chkAudios').textContent=`Audios finished: ${spokenCards.size}/${total} ‚úì`;
      document.getElementById('completeModal').classList.add('show');
    }
    (function setupModal(){
      const modal=document.getElementById('completeModal');
      document.getElementById('btnBackPhases')?.addEventListener('click',()=>window.history.back());
      document.getElementById('btnReview')?.addEventListener('click',()=>modal.classList.remove('show'));
      document.getElementById('btnPDF')?.addEventListener('click',()=>generatePDF());
      modal.addEventListener('click',(e)=>{ if(e.target===modal) modal.classList.remove('show'); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && modal.classList.contains('show')) modal.classList.remove('show'); });
    })();

    // PDF
    function generatePDF(){ const {jsPDF}=window.jspdf; const doc=new jsPDF(); try{ doc.addImage('Logo.png','PNG',85,10,40,40);}catch(e){} doc.setFontSize(12); doc.text('Name:_______________________________________________________  Date:_______________',10,60); doc.setFontSize(20); doc.text(storyTitle,105,80,{align:'center'}); doc.setFontSize(12); let y=100; const marginLeft=10,maxLineWidth=180,lineHeight=10; const split=doc.splitTextToSize(storyText,maxLineWidth); split.forEach(line=>{ if(y>280){ doc.addPage(); y=20; } doc.text(line,marginLeft,y); y+=lineHeight; }); doc.save('story.pdf'); }

    // Boot
    document.addEventListener('DOMContentLoaded',async()=>{
      checkUserRole();
      storyManifest=await loadStoryManifest();
      cardsData=await loadContent();
      document.getElementById('storyTitle').textContent=storyTitle||'Hannah Story';
      buildPaginator();
      displayCard(0);
      const t=document.getElementById('toggleButton'); if(t) t.innerText=showText?'See the story':'Read the story';
    });
  </script>
</body>
</html>
