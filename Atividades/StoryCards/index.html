<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hannah StoryCard</title>

  <!-- Firebase & jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand:#4CAF50;
      --brand-dark:#45a049;
      --ink:#333;
    }

    *{box-sizing:border-box}
    html, body { margin:0; padding:0; }
    body {
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background-image: url('../../../imagens/fundo.png');
      background-repeat: repeat;
      background-size: auto;
      color: var(--ink);
      display: block;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      width: 100%;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    h1 { font-size: 2.5em; color: var(--brand); margin: 0 0 20px; text-align: center; }
    .title { font-size: 2em; color: #333; margin: 10px 0 20px; text-align: center; }

    /* Buttons */
    .button-container { display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom: 16px; }
    button { margin: 0; padding: 12px 24px; font-size: 16px; background-color: var(--brand); color: white; border: none; border-radius: 50px; cursor: pointer; }
    button:hover { background-color: var(--brand-dark); }

    /* Card: focus on IMAGE (no colored panel that shrinks it) */
    .card { position: relative; margin: 10px auto 20px; width: 100%; max-width: 860px; text-align: center; }
    .card img { width: 100%; height: auto; display:block; border-radius: 10px; }
    .card-text p { font-size: 1.5em; text-align: center; color: #333; margin: 0; padding: 10px 8px; }

    /* Play button (businessman) back to original corner over the image */
    .businessman { position: absolute; bottom: 12px; right: 12px; width: 60px; height: 60px; cursor: pointer; filter: drop-shadow(0 4px 10px rgba(0,0,0,.35)); }

    /* Next pulse after audio finished */
    .pulse-next { animation: pulseNext 1.15s ease-in-out infinite; }
    @keyframes pulseNext { 0%{ transform: translateX(0) scale(1);} 50%{ transform: translateX(1px) scale(1.04);} 100%{ transform: translateX(0) scale(1);} }

    .navigation { display:flex; justify-content:space-between; align-items:center; width: 100%; margin-top: 8px; }

    /* Tiny one-line paginator (dots) */
    .paginator { display:flex; gap:6px; justify-content:center; align-items:center; flex-wrap:nowrap; overflow:hidden; margin: 6px 0 4px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#e5e7eb; border:1px solid #d1d5db; padding:0; display:inline-block; }
    .dot.current { background:#9ca3af; }
    .dot.done { background:#4CAF50; border-color:#4CAF50; }
    .dot.locked { opacity:.45; cursor: not-allowed; }
  </style>
</head>
<body>
  <button id="backButton">Back</button>

  <div class="container" aria-live="polite">
    <h1>Hannah StoryCard</h1>

    <div class="button-container">
      <button id="toggleButton" onclick="toggleView()">Read the story</button>
      <button id="pdfButton" onclick="generatePDF()" style="display: none;">Generate PDF</button>
    </div>

    <div class="title" id="storyTitle"></div>

    <!-- Tiny paginator (single line) -->
    <div class="paginator" id="paginator" aria-label="Cards"></div>

    <div id="cardsContainer"></div>

    <div class="navigation">
      <button id="prevBtn" onclick="showPreviousCard()">Previous</button>
      <button id="nextBtn" onclick="showNextCard()">Next</button>
    </div>
  </div>

  <script>
    // -------------------- Firebase Config --------------------
    var firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId: "G-07VVJG9LRS",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

    // -------------------- Globals --------------------
    let storyTitle = "Hannah Story"; // PDF title
    let storyText = "";              // PDF text
    let phaseCompleted = false;
    let showText = false;
    let viewedCards = new Set();
    let spokenCards = new Set();

    let storyManifest = null;
    let currentAudio = null;

    let cardsData = [];
    let currentCardIndex = 0;
    let maxVisitedIndex = 0; // controls sequential navigation for paginator

    // -------------------- Role -> show PDF button --------------------
    function checkUserRole() {
      firebase.auth().onAuthStateChanged(async function(user) {
        if (user) {
          const uid = user.uid;
          const roleRef = firebase.database().ref(`usuarios/${uid}/role`);
          const snapshot = await roleRef.once('value');
          const role = snapshot.val();
          if (role === "professor" || role === "proprietÃ¡rio") {
            document.getElementById("pdfButton").style.display = "block";
          }
        }
      });
    }

    // -------------------- URL Params --------------------
    function getParamsFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const level = urlParams.get('level');
      const unit  = urlParams.get('unit');
      const fase  = urlParams.get('fase');
      return { level, unit, fase };
    }

    // -------------------- Load Manifest --------------------
    async function loadStoryManifest() {
      const { level, unit } = getParamsFromURL();
      const manifestPath = `../../${level}/${unit}/DataStory/sounds/storycards-manifest.json`;
      try {
        const resp = await fetch(manifestPath);
        if (!resp.ok) return null;
        const data = await resp.json();
        if (data.title && typeof data.title === 'string') storyTitle = data.title;
        return data;
      } catch (e) { return null; }
    }

    // -------------------- Load Content --------------------
    async function loadContent() {
      const { level, unit } = getParamsFromURL();
      if (!level || !unit) return [];
      const dataStoryPath = `../../${level}/${unit}/DataStory/`;
      try {
        const response = await fetch(`${dataStoryPath}images.txt`);
        if (!response.ok) throw new Error('Failed to fetch images.txt');
        const text = await response.text();
        const lines = text.split('\n');
        let cards = []; let currentImage = ''; let currentText = '';
        lines.forEach(line=>{
          if (line.startsWith('#imagem')){
            if (currentImage && currentText) cards.push({ image: currentImage, text: currentText.trim() });
            currentImage = line.replace('#','').trim();
            currentText = '';
          } else { currentText += line + ' '; }
        });
        if (currentImage && currentText) cards.push({ image: currentImage, text: currentText.trim() });
        storyText = cards.map(c=>c.text).join('\n\n');
        return cards.map(c=>({ ...c, image: `${dataStoryPath}images/${c.image}.png` }));
      } catch(e){ return []; }
    }

    // -------------------- Build tiny paginator --------------------
    function buildPaginator(){
      const pag = document.getElementById('paginator');
      pag.innerHTML = '';
      for (let i=0;i<cardsData.length;i++){
        const d = document.createElement('span');
        d.className = 'dot' + (i===0 ? ' current' : ' locked');
        d.title = `Card ${i+1}`;
        d.addEventListener('click', ()=>{
          // Allow clicking only on already visited (<= maxVisitedIndex)
          if (i <= maxVisitedIndex){
            currentCardIndex = i;
            displayCard(currentCardIndex);
          }
        });
        pag.appendChild(d);
      }
      refreshPaginator();
    }

    function refreshPaginator(){
      const dots = document.querySelectorAll('#paginator .dot');
      dots.forEach((dot, i)=>{
        dot.classList.remove('current','done','locked');
        if (i < maxVisitedIndex) dot.classList.add('done');
        if (i === currentCardIndex) dot.classList.add('current');
        if (i > maxVisitedIndex) dot.classList.add('locked');
      });
    }

    // -------------------- Render card --------------------
    function displayCard(index){
      // update max visited (sequential rule)
      if (!viewedCards.has(index)) viewedCards.add(index);
      if (index > maxVisitedIndex) maxVisitedIndex = index;

      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      const data = cardsData[index];

      const card = document.createElement('div');
      card.className = 'card active';
      card.onclick = ()=> toggleView();

      if (showText){
        const t = document.createElement('div');
        t.className = 'card-text';
        t.innerHTML = `<p>${data.text}</p>`;
        card.appendChild(t);
      } else {
        const img = document.createElement('img');
        img.src = data.image; img.alt = 'Image';
        card.appendChild(img);
      }

      const play = document.createElement('img');
      play.src = 'businessman.png';
      play.className = 'businessman';
      play.onclick = (e)=>{ e.stopPropagation(); pulseNext(false); toggleSpeech(data.text, play, index); };
      card.appendChild(play);

      container.appendChild(card);

      document.getElementById('prevBtn').style.display = (index === 0) ? 'none' : 'inline-block';
      document.getElementById('nextBtn').style.display = (index === cardsData.length - 1) ? 'none' : 'inline-block';

      const toggleBtn = document.getElementById('toggleButton');
      if (toggleBtn) toggleBtn.innerText = showText ? 'See the story' : 'Read the story';

      document.getElementById('storyTitle').textContent = storyTitle || 'Hannah Story';
      refreshPaginator();
    }

    // -------------------- Toggle text/image --------------------
    function toggleView(){
      showText = !showText;
      const toggleBtn = document.getElementById('toggleButton');
      if (toggleBtn) toggleBtn.innerText = showText ? 'See the story' : 'Read the story';
      displayCard(currentCardIndex);
    }

    // -------------------- Navigation --------------------
    function showNextCard(){
      pulseNext(false);
      currentCardIndex = Math.min(currentCardIndex + 1, cardsData.length - 1);
      displayCard(currentCardIndex);
    }
    function showPreviousCard(){
      pulseNext(false);
      currentCardIndex = Math.max(currentCardIndex - 1, 0);
      displayCard(currentCardIndex);
    }

    // -------------------- Back button with phase check --------------------
    document.addEventListener('DOMContentLoaded', ()=>{
      const backButton = document.querySelector('button#backButton');
      if (backButton) backButton.addEventListener('click', handleBackButtonClick);
    });

    async function handleBackButtonClick(){
      const { level, unit, fase } = getParamsFromURL();
      if (!level || !unit || !fase) { alert('Level, Unit or Fase not identified in the URL.'); return; }
      firebase.auth().onAuthStateChanged(async (user)=>{
        if (user){
          const uid = user.uid;
          const isPhaseCompleted = await checkPhaseProgress(uid, level, unit, fase);
          if (isPhaseCompleted) window.history.back();
          else{
            const confirmExit = confirm('The next phase is not completed.\n\nTo complete this phase, you must view and listen to ALL story cards (open each card and play the audio to the end).\n\nDo you wish to leave anyway?');
            if (confirmExit) window.history.back();
          }
        } else { alert('Please log in to save your progress and continue.'); }
      });
    }

    async function checkPhaseProgress(uid, level, unit, currentFase){
      try{
        const currentNumber = parseInt(currentFase.replace('fase',''));
        const nextFase = `fase${currentNumber + 1}`;
        const snapshot = await firebase.database().ref(`usuarios/${uid}/progresso/${level}/${unit}/${nextFase}`).once('value');
        return snapshot.val();
      }catch(e){ return false; }
    }

    // -------------------- Audio: MP3 first, fallback TTS --------------------
    function toggleSpeech(text, buttonElement, index){ playCardAudio(text, buttonElement, index); }

    async function playCardAudio(text, buttonElement, index){
      stopCurrentAudio();
      const mp3Url = getMp3ForCard(index);
      if (mp3Url){
        try{ await playMp3(mp3Url, buttonElement, index); return; }
        catch(e){ console.warn('MP3 failed, fallback to TTS', e); }
      }
      playTTS(text, buttonElement, index);
    }

    function getMp3ForCard(index){
      if (!storyManifest) return null;
      const card = storyManifest.cards?.find(c=>c.index === index + 1);
      if (!card) return null;
      const { level, unit } = getParamsFromURL();
      return `../../${level}/${unit}/DataStory/sounds/${card.audio}`;
    }

    function playMp3(url, buttonElement, index){
      return new Promise((resolve, reject)=>{
        currentAudio = new Audio(url);
        currentAudio.preload = 'auto';
        currentAudio.play().then(()=>{
          buttonElement.src = 'pause.png';
          markSpokenOnEnd(buttonElement, index, resolve);
        }).catch(reject);
      });
    }

    function stopCurrentAudio(){
      if (currentAudio){ currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
      if (window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); }
    }

    function playTTS(text, buttonElement, index){
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-US';
      window.speechSynthesis.speak(utter);
      buttonElement.src = 'pause.png';
      utter.onend = ()=>{
        buttonElement.src = 'businessman.png';
        spokenCards.add(index);
        pulseNext(true);
        checkCompletion();
      };
    }

    function markSpokenOnEnd(buttonElement, index, resolve){
      currentAudio.onended = ()=>{
        buttonElement.src = 'businessman.png';
        spokenCards.add(index);
        pulseNext(true);
        checkCompletion();
        resolve();
      };
    }

    // -------------------- Next pulse helper --------------------
    function pulseNext(should){
      const nextBtn = document.getElementById('nextBtn');
      if (!nextBtn) return;
      if (should) nextBtn.classList.add('pulse-next');
      else nextBtn.classList.remove('pulse-next');
    }

    // -------------------- Completion check --------------------
    async function checkCompletion(){
      if (viewedCards.size === cardsData.length && spokenCards.size === cardsData.length){
        if (!phaseCompleted){
          phaseCompleted = true;
          const user = firebase.auth().currentUser;
          if (user){ const { fase } = getParamsFromURL(); await salvarProgressoAluno(user.uid, fase); alert('Congratulations! You have completed this phase.'); }
        }
      }
    }

    async function salvarProgressoAluno(uid, fase){
      try{
        const { level, unit } = getParamsFromURL();
        const db = firebase.database();
        await db.ref(`usuarios/${uid}/progresso/${level}/${unit}/${fase}`).set(true);
        if (typeof updateNextPhase === 'function') { await updateNextPhase(uid); }
        else {
          const n = parseInt(fase.replace('fase',''), 10);
          if (!isNaN(n)) { const proxima = `fase${n+1}`; await db.ref(`usuarios/${uid}/progresso/${level}/${unit}/${proxima}`).set(true); }
        }
      }catch(err){ console.error('Erro ao salvar progresso:', err); }
    }

    // -------------------- PDF --------------------
    function generatePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      try { doc.addImage('Logo.png', 'PNG', 85, 10, 40, 40); } catch(e){}
      doc.setFontSize(12);
      doc.text('Name:_______________________________________________________  Date:_______________', 10, 60);
      doc.setFontSize(20); doc.text(storyTitle, 105, 80, { align: 'center' });
      doc.setFontSize(12);
      let y = 100, marginLeft = 10, maxLineWidth = 180, lineHeight = 10;
      const splitText = doc.splitTextToSize(storyText, maxLineWidth);
      splitText.forEach(line=>{ if (y > 280){ doc.addPage(); y = 20; } doc.text(line, marginLeft, y); y += lineHeight; });
      doc.save('story.pdf');
    }

    // -------------------- Boot --------------------
    document.addEventListener('DOMContentLoaded', async ()=>{
      checkUserRole();
      storyManifest = await loadStoryManifest();
      cardsData = await loadContent();
      // show title
      document.getElementById('storyTitle').textContent = storyTitle || 'Hannah Story';
      // paginator then first card
      buildPaginator();
      displayCard(0);
      const toggleBtn = document.getElementById('toggleButton');
      if (toggleBtn) toggleBtn.innerText = showText ? 'See the story' : 'Read the story';
    });
  </script>
</body>
</html>