<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hannah StoryCard</title>

  <!-- Firebase + jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{ --brand:#4CAF50; --brand-dark:#45a049; --ink:#333; --muted:#6b7280; --ok:#16a34a; --overlay:rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{ font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif; background-image:url('../../../imagens/fundo.png'); background-repeat:repeat; background-size:auto; color:var(--ink); display:block; min-height:100vh; }
    .container{max-width:900px;width:100%;margin:30px auto;padding:20px;background:#fff;box-shadow:0 8px 16px rgba(0,0,0,.1);border-radius:10px}
    h1{font-size:2.5em;color:var(--brand);margin:0 0 20px;text-align:center}
    .title{font-size:2em;color:#333;margin:10px 0 8px;text-align:center}

    .button-container{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:12px}
    button{padding:12px 24px;font-size:16px;background:var(--brand);color:#fff;border:none;border-radius:50px;cursor:pointer}
    button:hover{background:var(--brand-dark)}

    /* Card: imagem √© o foco absoluto */
    .card{position:relative;margin:6px auto 18px;width:100%;max-width:860px;text-align:center}
    .story-image{width:100%;height:auto;display:block;border-radius:10px}
    .card-text p{font-size:1.5em;text-align:center;color:#333;margin:0;padding:10px 8px}

    /* √çcone play (businessman) pequeno e fixo no canto da imagem */
    .businessman{position:absolute;bottom:12px;right:12px;width:56px;height:56px;cursor:pointer;filter:drop-shadow(0 4px 10px rgba(0,0,0,.35));object-fit:contain}
    .pulse-play{animation:pulsePlay 1.2s ease-in-out infinite}
    @keyframes pulsePlay{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    /* Next pulse ap√≥s concluir o √°udio */
    .pulse-next{animation:pulseNext 1.1s ease-in-out infinite}
    @keyframes pulseNext{0%{transform:translateX(0) scale(1)}50%{transform:translateX(1px) scale(1.04)}100%{transform:translateX(0) scale(1)}}

    .navigation{display:flex;justify-content:space-between;align-items:center;width:100%;margin-top:8px}

    /* Paginador mini (linha √∫nica) e bloqueio de avan√ßo */
    .paginator{display:flex;gap:6px;justify-content:center;align-items:center;flex-wrap:nowrap;overflow:hidden;margin:6px 0 0}
    .dot{width:10px;height:10px;border-radius:50%;background:#e5e7eb;border:1px solid #d1d5db;padding:0;display:inline-block}
    .dot.current{background:#9ca3af}
    .dot.done{background:var(--brand);border-color:var(--brand)}
    .dot.locked{opacity:.45;cursor:not-allowed}

    .gate-hint{font-size:11px;color:var(--muted);text-align:center;margin-top:4px;min-height:14px}

    /* Modal de conclus√£o */
    .modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{width:min(520px,92vw);background:#fff;border-radius:16px;padding:20px;box-shadow:0 20px 50px rgba(0,0,0,.25)}
    .modal h2{margin:0 0 8px;font-size:1.4rem;color:#0f172a;text-align:center}
    .modal p{margin:6px 0;color:#334155;text-align:center}
    .checklines{display:flex;gap:10px;justify-content:center;margin:10px 0 2px}
    .check{background:#f8fafc;padding:8px 12px;border-radius:999px;font-size:.95rem;color:#0f766e;border:1px solid #e2e8f0}
    .modal-actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .btn-secondary{background:#111827;color:#fff}

    @media (prefers-reduced-motion:reduce){.pulse-play,.pulse-next{animation:none!important}}
  </style>
</head>
<body>
  <button id="backButton">Back</button>

  <div class="container" aria-live="polite">
    <h1>Hannah StoryCard</h1>
    <div class="button-container">
      <button id="toggleButton" onclick="toggleView()">Read the story</button>
      <button id="pdfButton" onclick="generatePDF()" style="display:none;">Generate PDF</button>
    </div>
    <div class="title" id="storyTitle"></div>

    <!-- Paginador mini + microcopy -->
    <div class="paginator" id="paginator" aria-label="Cards"></div>
    <div class="gate-hint" id="gateHint">Listen to unlock Next</div>

    <div id="cardsContainer"></div>

    <div class="navigation">
      <button id="prevBtn" onclick="showPreviousCard()">Previous</button>
      <button id="nextBtn" onclick="showNextCard()">Next</button>
    </div>
  </div>

  <!-- Modal Conclus√£o -->
  <div class="modal-backdrop" id="completeModal" role="dialog" aria-modal="true" aria-labelledby="completeTitle">
    <div class="modal">
      <h2 id="completeTitle">Great job! Phase completed üéâ</h2>
      <p>You viewed all cards and finished all audios.</p>
      <div class="checklines">
        <div class="check" id="chkViewed">Cards viewed: 0/0 ‚úì</div>
        <div class="check" id="chkAudios">Audios finished: 0/0 ‚úì</div>
      </div>
      <p>Your next phase is now unlocked.</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="btnBackPhases">Back to phases</button>
        <button id="btnReview">Review the story</button>
        <button id="btnPDF">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase
    var firebaseConfig={ apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc", authDomain:"hannahenglishcourse.firebaseapp.com", projectId:"hannahenglishcourse", storageBucket:"hannahenglishcourse.appspot.com", messagingSenderId:"449818788486", appId:"1:449818788486:web:8a49d3f68591e6fb3f0707", measurementId:"G-07VVJG9LRS", databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);

    // Estado global
    let storyTitle="Hannah Story"; let storyText=""; let phaseCompleted=false; let showText=false;
    let viewedCards=new Set(); let spokenCards=new Set();
    let storyManifest=null; let currentAudio=null; let cardsData=[]; let currentCardIndex=0; let maxVisitedIndex=0;

    // Role -> PDF
    function checkUserRole(){
      firebase.auth().onAuthStateChanged(async function(user){
        if(user){
          const uid=user.uid; const roleRef=firebase.database().ref('usuarios/'+uid+'/role'); const snapshot=await roleRef.once('value'); const role=snapshot.val();
          if(role==="professor"||role==="propriet√°rio"){ document.getElementById('pdfButton').style.display='block'; }
        }
      });
    }

    // URL params
    function getParamsFromURL(){ const p=new URLSearchParams(window.location.search); return {level:p.get('level'),unit:p.get('unit'),fase:p.get('fase')}; }

    // Helpers sem regex (evita SyntaxError em alguns ambientes)
    function stripBOM(s){ if(!s) return s; return (s.charCodeAt(0)===65279) ? s.slice(1) : s; }
    function splitLines(s){ // suporta \r\n e \n sem regex
      let arr=s.split('\n');
      for(let i=0;i<arr.length;i++){ if(arr[i].length && arr[i].charAt(arr[i].length-1)==='\r'){ arr[i]=arr[i].slice(0,-1); } }
      return arr;
    }

    // Manifest & conte√∫do
    async function loadStoryManifest(){
      const p=getParamsFromURL(); const path='../../'+p.level+'/'+p.unit+'/DataStory/sounds/storycards-manifest.json';
      try{ const r=await fetch(path); if(!r.ok) return null; const data=await r.json(); if(data.title) storyTitle=data.title; return data; }catch(e){ return null }
    }
    async function loadContent(){
      const p=getParamsFromURL(); if(!p.level||!p.unit) return [];
      const base='../../'+p.level+'/'+p.unit+'/DataStory/';
      try{
        const res=await fetch(base+'images.txt'); if(!res.ok) throw new Error('Failed to fetch images.txt');
        let txt=await res.text(); txt=stripBOM(txt);
        const lines=splitLines(txt).filter(function(l){ return l.trim().length>0; });
        let cards=[]; let curImg=''; let curTxt='';
        for(let i=0;i<lines.length;i++){
          const line=lines[i];
          if(line.indexOf('#imagem')===0 || line.indexOf('#imagem')===1 && line.charAt(0)==='\ufeff'){ // toler√¢ncia
            if(curImg && curTxt){ cards.push({image:curImg, text:curTxt.trim()}); }
            curImg=line.replace('#','').trim();
            curTxt='';
          } else { curTxt+=line+' '; }
        }
        if(curImg && curTxt){ cards.push({image:curImg, text:curTxt.trim()}); }
        storyText=cards.map(function(c){return c.text;}).join('\n\n');
        return cards.map(function(c){ return { image: base+'images/'+c.image+'.png', text: c.text }; });
      }catch(e){ console.error('loadContent error', e); return [] }
    }

    // Paginador
    function buildPaginator(){
      const pag=document.getElementById('paginator'); pag.innerHTML='';
      for(let i=0;i<cardsData.length;i++){
        const d=document.createElement('span'); d.className='dot'+(i===0?' current':' locked'); d.title='Card '+(i+1);
        d.addEventListener('click',function(){ if(i<=maxVisitedIndex){ currentCardIndex=i; displayCard(currentCardIndex);} });
        pag.appendChild(d);
      }
      refreshPaginator();
    }
    function refreshPaginator(){
      const dots=document.querySelectorAll('#paginator .dot');
      for(let i=0;i<dots.length;i++){
        const dot=dots[i]; dot.classList.remove('current'); dot.classList.remove('done'); dot.classList.remove('locked');
        if(i===currentCardIndex) dot.classList.add('current');
        if(spokenCards.has(i)) dot.classList.add('done');
        if(i>maxVisitedIndex) dot.classList.add('locked');
      }
    }

    // Card
    function displayCard(index){
      if(cardsData.length===0){
        const container=document.getElementById('cardsContainer');
        container.innerHTML='<p style="text-align:center;color:#888">No cards found. Check DataStory/images.txt.</p>';
        return;
      }
      if(!viewedCards.has(index)) viewedCards.add(index);
      if(index>maxVisitedIndex) maxVisitedIndex=index;

      const container=document.getElementById('cardsContainer'); container.innerHTML='';
      const data=cardsData[index];

      const card=document.createElement('div'); card.className='card'; card.onclick=function(){ toggleView(); };

      if(showText){
        const t=document.createElement('div'); t.className='card-text'; t.innerHTML='<p>'+data.text+'</p>'; card.appendChild(t);
      }else{
        const img=document.createElement('img'); img.src=data.image; img.alt='Image'; img.className='story-image'; card.appendChild(img);
      }

      const play=document.createElement('img'); play.src='businessman.png'; play.className='businessman';
      if(!spokenCards.has(index)) play.classList.add('pulse-play');
      play.onclick=function(e){ e.stopPropagation(); play.classList.remove('pulse-play'); toggleSpeech(data.text,play,index); };
      card.appendChild(play);

      container.appendChild(card);

      document.getElementById('prevBtn').style.display=(index===0)?'none':'inline-block';
      document.getElementById('nextBtn').style.display=(index===cardsData.length-1)?'none':'inline-block';

      const toggleBtn=document.getElementById('toggleButton'); if(toggleBtn) toggleBtn.innerText=showText?'See the story':'Read the story';
      document.getElementById('storyTitle').textContent=storyTitle||'Hannah Story';

      const hint=document.getElementById('gateHint'); if(hint){ hint.textContent='Listen to unlock Next'; hint.style.visibility = spokenCards.has(index) ? 'hidden' : 'visible'; }

      refreshPaginator();
    }

    // Toggle view
    function toggleView(){ showText=!showText; const t=document.getElementById('toggleButton'); if(t) t.innerText=showText?'See the story':'Read the story'; displayCard(currentCardIndex); }

    // Navega√ß√£o
    function showNextCard(){ const idx=Math.min(currentCardIndex+1,cardsData.length-1); currentCardIndex=idx; displayCard(currentCardIndex); }
    function showPreviousCard(){ const idx=Math.max(currentCardIndex-1,0); currentCardIndex=idx; displayCard(currentCardIndex); }

    // Back + verifica√ß√£o de fase
    document.addEventListener('DOMContentLoaded',function(){ const back=document.querySelector('button#backButton'); if(back) back.addEventListener('click',handleBackButtonClick); });
    async function handleBackButtonClick(){
      const u=getParamsFromURL(); if(!u.level||!u.unit||!u.fase){ alert('Level, Unit or Fase not identified in the URL.'); return; }
      firebase.auth().onAuthStateChanged(async function(user){
        if(user){ const uid=user.uid; const ok=await checkPhaseProgress(uid,u.level,u.unit,u.fase); if(ok) window.history.back(); else if(confirm('The next phase is not completed.\n\nTo complete this phase, you must view and listen to ALL story cards (open each card and play the audio to the end).\n\nDo you wish to leave anyway?')) window.history.back(); }
        else{ alert('Please log in to save your progress and continue.'); }
      });
    }
    async function checkPhaseProgress(uid,level,unit,currentFase){
      try{ const n=parseInt(String(currentFase).replace('fase',''),10); const next='fase'+(n+1); const snap=await firebase.database().ref('usuarios/'+uid+'/progresso/'+level+'/'+unit+'/'+next).once('value'); return snap.val(); }catch(e){ return false }
    }

    // √Åudio (MP3 priorit√°rio + fallback TTS)
    function toggleSpeech(text,buttonElement,index){ playCardAudio(text,buttonElement,index); }
    async function playCardAudio(text,buttonElement,index){
      stopCurrentAudio(); const mp3Url=getMp3ForCard(index);
      if(mp3Url){ try{ await playMp3(mp3Url,buttonElement,index); return; }catch(e){ console.warn('MP3 failed, fallback to TTS',e); } }
      playTTS(text,buttonElement,index);
    }
    function getMp3ForCard(index){ if(!storyManifest) return null; var found=null; var arr=storyManifest.cards||[]; for(var i=0;i<arr.length;i++){ if(arr[i].index===index+1){ found=arr[i]; break; } } if(!found) return null; const u=getParamsFromURL(); return '../../'+u.level+'/'+u.unit+'/DataStory/sounds/'+found.audio; }
    function playMp3(url,buttonElement,index){ return new Promise(function(resolve,reject){ currentAudio=new Audio(url); currentAudio.preload='auto'; currentAudio.play().then(function(){ buttonElement.src='pause.png'; markSpokenOnEnd(buttonElement,index,resolve); }).catch(reject); }); }
    function stopCurrentAudio(){ if(currentAudio){ currentAudio.pause(); currentAudio.currentTime=0; currentAudio=null; } if(window.speechSynthesis.speaking){ window.speechSynthesis.cancel(); } }
    function playTTS(text,buttonElement,index){ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.speak(u); buttonElement.src='pause.png'; u.onend=function(){ buttonElement.src='businessman.png'; onAudioFinished(index); }; }
    function markSpokenOnEnd(buttonElement,index,resolve){ currentAudio.onended=function(){ buttonElement.src='businessman.png'; onAudioFinished(index); resolve(); }; }

    // Ao terminar √°udio deste card
    function onAudioFinished(index){
      spokenCards.add(index);
      const hint=document.getElementById('gateHint'); if(hint && index===currentCardIndex){ hint.style.visibility='hidden'; }
      const nextBtn=document.getElementById('nextBtn'); if(nextBtn) nextBtn.classList.add('pulse-next');
      refreshPaginator();
      checkCompletion();
    }

    // Conclus√£o + modal
    async function checkCompletion(){
      const total=cardsData.length; if(total===0) return;
      const allViewed=viewedCards.size===total; const allSpoken=spokenCards.size===total;
      if(allViewed && allSpoken){ if(!phaseCompleted){ phaseCompleted=true; const user=firebase.auth().currentUser; if(user){ const f=getParamsFromURL().fase; await salvarProgressoAluno(user.uid,f);} openCompletionModal(); } }
    }
    async function salvarProgressoAluno(uid,fase){
      try{ const u=getParamsFromURL(); const db=firebase.database(); await db.ref('usuarios/'+uid+'/progresso/'+u.level+'/'+u.unit+'/'+fase).set(true);
        if(typeof updateNextPhase==='function'){ await updateNextPhase(uid); }
        else { const n=parseInt(String(fase).replace('fase',''),10); if(!isNaN(n)){ const prox='fase'+(n+1); await db.ref('usuarios/'+uid+'/progresso/'+u.level+'/'+u.unit+'/'+prox).set(true);} }
      }catch(err){ console.error('Erro ao salvar progresso:',err); }
    }
    function openCompletionModal(){ const total=cardsData.length; document.getElementById('chkViewed').textContent='Cards viewed: '+viewedCards.size+'/'+total+' ‚úì'; document.getElementById('chkAudios').textContent='Audios finished: '+spokenCards.size+'/'+total+' ‚úì'; document.getElementById('completeModal').classList.add('show'); }
    (function setupModal(){ const modal=document.getElementById('completeModal'); var back=document.getElementById('btnBackPhases'); if(back) back.addEventListener('click',function(){ window.history.back(); }); var rev=document.getElementById('btnReview'); if(rev) rev.addEventListener('click',function(){ modal.classList.remove('show'); }); var pdf=document.getElementById('btnPDF'); if(pdf) pdf.addEventListener('click',function(){ generatePDF(); }); modal.addEventListener('click',function(e){ if(e.target===modal) modal.classList.remove('show'); }); document.addEventListener('keydown',function(e){ if(e.key==='Escape' && modal.classList.contains('show')) modal.classList.remove('show'); }); })();

    // PDF
    function generatePDF(){ const j=window.jspdf; if(!j) return; const doc=new j.jsPDF(); try{ doc.addImage('Logo.png','PNG',85,10,40,40);}catch(e){} doc.setFontSize(12); doc.text('Name:_______________________________________________________  Date:_______________',10,60); doc.setFontSize(20); doc.text(storyTitle,105,80,{align:'center'}); doc.setFontSize(12); var y=100; var marginLeft=10,maxLineWidth=180,lineHeight=10; var split=doc.splitTextToSize(storyText,maxLineWidth); for(var i=0;i<split.length;i++){ var line=split[i]; if(y>280){ doc.addPage(); y=20; } doc.text(line,marginLeft,y); y+=lineHeight; } doc.save('story.pdf'); }

    // Boot
    document.addEventListener('DOMContentLoaded',async function(){
      checkUserRole();
      storyManifest=await loadStoryManifest();
      cardsData=await loadContent();
      document.getElementById('storyTitle').textContent=storyTitle||'Hannah Story';
      if(cardsData.length>0){ buildPaginator(); displayCard(0); } else { document.getElementById('cardsContainer').innerHTML='<p style="text-align:center;color:#888">No cards found. Check DataStory/images.txt.</p>'; }
      const t=document.getElementById('toggleButton'); if(t) t.innerText=showText?'See the story':'Read the story';
    });
  </script>
</body>
</html>