<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hannah Sequence Game â€” Word Drop Express</title>
<link rel="manifest" href="manifest.json">
<!-- Preload to speed up first show -->
<link rel="preload" as="image" href="locomotive.png">
<style>
  /* ===== Base ===== */
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{
    width:100vw;height:100vh;
    background:url('../../../imagens/fundo.png') repeat;
    font-family:"Times New Roman",Times,serif;
  }
  html,body,#game-container{-webkit-user-select:none;user-select:none;touch-action:manipulation}
  #game-container{position:relative;width:100%;height:100%;overflow:hidden}

  /* ===== UI Colors / Feedback ===== */
  :root{
    --accent:#7C3AED;   /* selection accent */
    --ok:#2e7d32;       /* correct */
    --err:#c62828;      /* wrong */
    --shadow:0 6px 18px rgba(0,0,0,.08);

    /* ====== Train layout controls ====== */
    --trainH: 44;
    --wagonFactor: 0.86;
    --wagonScale: 1.12;
    --liftVH: 3.2;

    --windowInset: clamp(10px, 1.2vw, 18px);
    --wheelPadVH: 2.0;

    --pairedImgScale: 0.68;
    --pairedImgLift: -50%;
    --imgSafePad: clamp(16px, 2vw, 26px);

    --labelH: clamp(22px, 3.4vh, 38px);
    --labelBelowVH: 3.4;

    --colGap: clamp(10px, 1.4vw, 20px);
    --sidePad: clamp(12px, 2vw, 26px);

    /* Animation speeds */
    --locoDur: 7s;     /* locomotive crossing */
    --departDur: 4s;   /* wagons leaving */
  }

  /* Orientation overlay */
  #rotate-overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;
    display:none;justify-content:center;align-items:center;text-align:center;padding:1rem;z-index:3000
  }
  #rotate-overlay p{font-size:1.1rem;line-height:1.45}

  /* Header buttons */
  #back-button{
    position:absolute;top:10px;left:10px;z-index:260;
    padding:6px 12px;background:#4b5563;color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:.9em;
    box-shadow:0 4px 8px rgba(0,0,0,.2);transition:filter .2s ease
  }
  #back-button:hover{filter:brightness(1.08)}
  #restart-button{
    position:absolute;top:10px;right:10px;padding:6px 12px;background:#2980b9;color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:.9em;z-index:260;
    box-shadow:0 4px 8px rgba(0,0,0,.2);transition:filter .2s ease
  }
  #restart-button:hover{filter:brightness(1.08)}

  /* ===== Train lane ===== */
  #train{
    position:absolute;left:0;bottom:0;width:100%;
    height: calc(var(--trainH) * 1vh);
    display:grid;
    grid-template-columns: repeat(var(--num-wagons), 1fr);
    align-items:end;
    gap: var(--colGap);
    padding: 0 var(--sidePad) calc(clamp(10px,1.4vw,20px) + var(--labelBelowVH) * 1vh + 6px);
    z-index:100;
    will-change: transform;
  }

  .wagon{
    position:relative;
    height: calc(var(--trainH) * var(--wagonFactor) * 1vh);
    background-image: url('wagon.png');
    background-repeat: no-repeat;
    background-position: center bottom;
    background-size: calc(100% * var(--wagonScale)) auto;
    padding:
      var(--windowInset)
      var(--windowInset)
      calc(var(--windowInset) + (var(--wheelPadVH) * 1vh))
      var(--windowInset);
    transform: translateY(calc(-1 * var(--liftVH) * 1vh));
    overflow: visible;
  }

  .slot-img{
    position:absolute;
    top:    calc(var(--windowInset) + 4px);
    left:   var(--windowInset);
    right:  var(--windowInset);
    bottom: calc(var(--windowInset) + (var(--wheelPadVH) * 1vh) + 10px);
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }

  .slot-img img.paired{
    max-width:  calc((100% - var(--imgSafePad)*2) * var(--pairedImgScale));
    max-height: calc((100% - var(--imgSafePad)*2) * var(--pairedImgScale));
    width:auto;height:auto;object-fit:contain;display:block;pointer-events:none;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.12));
    transform: translateY(calc(-1 * var(--pairedImgLift)));
  }

  /* Label below wheels */
  .word{
    position:absolute; left:var(--windowInset); right:var(--windowInset);
    bottom: calc(-1 * var(--labelBelowVH) * 1vh); height: calc(var(--labelH) - 6px);
    display:flex;align-items:center;justify-content:center;
    text-transform:uppercase;text-align:center;font-weight:700;
    color:#1f2d3a;
    font-size: clamp(14px, calc((100vw / var(--num-wagons))*0.20), 26px);
    background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.88));
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 10px; box-shadow:0 2px 6px rgba(0,0,0,.08);
    pointer-events:none; z-index: 2;
  }

  /* Visual feedback states */
  .wagon.is-correct{ outline:4px solid var(--ok); outline-offset:-2px; }
  .wagon.is-wrong{ outline:4px solid var(--err); outline-offset:-2px; }
  .wagon.correct{ animation:none !important; box-shadow:none !important; } /* keep green glow disabled */

  /* Balloons */
  .balloon{
    position:absolute;
    width:clamp(56px, 10.5vw, 112px);
    height:clamp(68px, 12.5vw, 130px);
    background:url('balloon.png') no-repeat center/contain;
    cursor:pointer;transition:transform .2s ease;z-index:200;
  }
  .balloon:hover{transform:scale(1.1)}
  .balloon img{
    position:absolute;top:calc(90% + 0px);left:50%;transform:translateX(-50%);
    width:clamp(44px,8.5vw,88px);height:clamp(44px,8.5vw,88px);object-fit:contain;pointer-events:none;z-index:201
  }

  /* Feedback badge */
  #feedback{
    position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);
    background:rgba(198,40,40,.92);color:#fff;padding:12px 18px;border-radius:10px;font-size:1rem;display:none;z-index:250
  }

  .falling{
    position:absolute;
    width:  clamp(28px, 5.5vw, 52px);
    height: clamp(28px, 5.5vw, 52px);
    object-fit:contain; pointer-events:none; z-index:150;
  }

  /* Locomotive & departure */
  .locomotive{
    position:absolute;
    bottom: calc(var(--labelBelowVH) * 1vh + 6px);
    left: -30vw;
    width: clamp(260px, 32vw, 640px);
    height: clamp(160px, 20vw, 360px);
    background: url('locomotive.png') no-repeat center/contain;
    z-index:210; pointer-events:none; display:flex; align-items:center; justify-content:center;
    transform: translateX(110vw);
    will-change: transform;
  }
  .locomotive .fallback-emoji{font-size:clamp(40px,6vw,72px);line-height:1}
  .locomotive.run{ animation: loco-pass var(--locoDur) linear forwards; }

  @keyframes loco-pass{
    from{ transform: translateX(110vw); }
    to  { transform: translateX(-120vw); }
  }

  #train.depart{ animation: train-depart var(--departDur) ease-in forwards; }
  @keyframes train-depart{
    to{ transform: translateX(-120vw); opacity:0.98; }
  }

  body.animating, body.animating *{ cursor: default !important; }
  body.animating #game-container{ pointer-events:none; }

  /* Congrats panel */
  #congrats{
    position:absolute; inset:0; display:none;
    align-items:center; justify-content:center;
    backdrop-filter: blur(2px);
    z-index:500;
  }
  #congrats.show{ display:flex; }
  #congrats .panel{
    background:#ffffffee; border:1px solid rgba(0,0,0,.06);
    border-radius:16px; padding:22px 26px; text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,.18);
    animation: pop-in .25s ease-out both;
  }
  #congrats h2{ margin-bottom:8px; font-size:1.35rem; }
  #congrats p{ margin:0 0 14px; }
  #close-congrats{
    background:#16a34a; color:#fff; border:none; border-radius:10px;
    padding:10px 16px; font-weight:700; cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
  }
  #close-congrats:hover{ background:#12823c; }

  @keyframes pop-in{
    from{ transform:scale(.9); opacity:0; }
    to  { transform:scale(1); opacity:1; }
  }
</style>
</head>
<body>
  <div id="rotate-overlay"><p>Please rotate your device to Landscape mode to play.</p></div>

  <div id="game-container">
    <button id="back-button" onclick="goBack()">Back</button>
    <button id="restart-button" onclick="restartGame()">Restart</button>
    <div id="feedback">Try again!</div>
    <div id="train"></div>

    <!-- Congrats -->
    <div id="congrats">
      <div class="panel">
        <h2>Great job!</h2>
        <p>You completed this phase.</p>
        <button id="close-congrats">OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    /* ================= Firebase init (single) ================= */
    const firebaseConfig={
      apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain:"hannahenglishcourse.firebaseapp.com",
      databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"hannahenglishcourse",
      storageBucket:"hannahenglishcourse.appspot.com",
      messagingSenderId:"449818788486",
      appId:"1:449818788486:web:8a49d3f68591e6fb3f0707"
    };
    if(!firebase.apps.length){ firebase.initializeApp(firebaseConfig); }

    let currentUserId = null;
    firebase.auth().onAuthStateChanged(function(user){
      currentUserId = user ? user.uid : null;
    });

    /* ================= State & DOM refs ================= */
    const gameContainer=document.getElementById('game-container');
    const train=document.getElementById('train');
    const feedback=document.getElementById('feedback');
    const overlay=document.getElementById('rotate-overlay');
    const congrats=document.getElementById('congrats');
    const closeCongratsBtn=document.getElementById('close-congrats');

    let wordsList=[], imagesList=[], numWagons=0, correctCount=0;
    const balloons=[];
    let activityCompleted = false;

    const state = { hintUsed:false, completed:false };

    /* ================= URL params helper ================= */
    function getParams(){
      const url = new URL(location.href);
      const level = url.searchParams.get('level');
      const unit  = url.searchParams.get('unit');
      const fase  = url.searchParams.get('fase'); // '1', '2', ... 'last' | 'end'
      return { level, unit, fase };
    }

    /* ================= Micro SFX (WebAudio) ================= */
    let audioCtx=null;
    function ensureAudio(){ if(!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } return !!audioCtx; }
    function tone(freq, durMs, type){
      if(!ensureAudio()) return;
      const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
      o.type = type || 'sine'; o.frequency.value = freq;
      o.connect(g); g.connect(audioCtx.destination);
      const t0 = audioCtx.currentTime;
      g.gain.setValueAtTime(0.001, t0);
      g.gain.exponentialRampToValueAtTime(0.16, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, t0 + (durMs/1000));
      o.start(t0); o.stop(t0 + (durMs/1000));
    }
    function sfxTick(){ tone(520, 70, 'square'); if(navigator.vibrate) navigator.vibrate(12); }
    function sfxCorrect(){ tone(880,120,'triangle'); setTimeout(()=>tone(1320,90,'triangle'),110); if(navigator.vibrate) navigator.vibrate(25); }
    function sfxWrong(){ tone(240,140,'sawtooth'); if(navigator.vibrate) navigator.vibrate(15); }
    function sfxWin(){ tone(660,120,'triangle'); setTimeout(()=>tone(990,120,'triangle'),120); setTimeout(()=>tone(1320,150,'triangle'),240); if(navigator.vibrate) navigator.vibrate([30,30,50]); }

    /* ================= Game audio (files) ================= */
    const SOUND_ENABLED = true;
    const whistle = new Audio('whistle.wav');  // put alongside index.html
    whistle.preload = 'auto'; whistle.volume = 0.65;

    const locoLoop = new Audio('locomotive_loop.wav');
    locoLoop.loop = true; locoLoop.preload = 'auto'; locoLoop.volume = 0.5;

    let mediaPrimed = false;
    function primeAudioOnce(){
      if(mediaPrimed) return;
      ensureAudio(); // prime WebAudio too
      [whistle, locoLoop].forEach(a=>{
        a.volume = 0;
        a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});
      });
      whistle.volume = 0.65; locoLoop.volume = 0.5;
      mediaPrimed = true;
      window.removeEventListener('pointerdown', primeAudioOnce);
      window.removeEventListener('keydown', primeAudioOnce);
    }
    window.addEventListener('pointerdown', primeAudioOnce, { once:true });
    window.addEventListener('keydown', primeAudioOnce, { once:true });

    /* ================= Orientation overlay ================= */
    function checkOrientation(){
      const stand=matchMedia('(display-mode: standalone)').matches||navigator.standalone===true;
      if(stand && screen.orientation?.type){
        overlay.style.display = screen.orientation.type.startsWith('portrait') ? 'flex' : 'none'; return;
      }
      overlay.style.display = (innerHeight > innerWidth) ? 'flex' : 'none';
    }
    addEventListener('resize',checkOrientation);
    addEventListener('orientationchange',checkOrientation);

    /* ================= Assets load (words + images) ================= */
    function preload(src){ return new Promise((res,rej)=>{ const im=new Image(); im.onload=res; im.onerror=rej; im.src=src; }); }
    function rand(a,b){ return a + Math.random()*(b-a); }

    function loadCardsData(cb){
      const {level,unit}=getParams();
      if(!level||!unit){ console.error("[Params] 'level' and 'unit' are required in URL."); return; }
      const wordsPath=`../../${level}/${unit}/data3/words.txt`;
      const imagePathTemplate=`../../${level}/${unit}/data3/imagens/imagem`;

      fetch(wordsPath).then(r=>{if(!r.ok)throw new Error('Failed to load '+wordsPath);return r.text();})
        .then(t=>{
          wordsList = t.split('\n').map(s=>s.trim()).filter(Boolean);
          numWagons = wordsList.length;
          imagesList = wordsList.map((w,i)=>({src:`${imagePathTemplate}${i+1}.png`,pair:`pair${i+1}`,word:w}));
          return Promise.all([preload('wagon.png'), preload('balloon.png'), ...imagesList.map(x=>preload(x.src))]);
        })
        .then(()=>cb())
        .catch(e=>console.error(e));
    }

    /* ================= Reset fresh on load ================= */
    function resetFresh(){
      state.hintUsed = false;
      state.completed = false;
      activityCompleted = false;
    }

    /* ================= Locomotive preload (Option #1) ================= */
    const LOCO_SRC = 'locomotive.png';
    const LOCO_TIMEOUT_MS = 1500;
    const locoImg = new Image();
    let locomotiveLoaded = false;
    const locomotiveReady = new Promise(resolve=>{
      locoImg.onload = ()=>{ locomotiveLoaded = true; resolve(); };
      locoImg.onerror = ()=>{ resolve(); };
      locoImg.src = LOCO_SRC;
      setTimeout(resolve, LOCO_TIMEOUT_MS);
    });

    /* ================= Init ================= */
    addEventListener('load',()=>{
      checkOrientation();
      resetFresh();
      loadCardsData(init);
    });

    function init(){
      correctCount=0; train.innerHTML=''; balloons.length=0;
      train.style.setProperty('--num-wagons', numWagons);

      // build wagons
      wordsList.forEach((word,i)=>{
        const slot=document.createElement('div'); slot.className='wagon'; slot.dataset.pair=`pair${i+1}`;
        const imgBox=document.createElement('div'); imgBox.className='slot-img';
        const label=document.createElement('div'); label.className='word'; label.textContent=word;
        slot.appendChild(imgBox); slot.appendChild(label); train.appendChild(slot);
      });

      // balloons
      imagesList.forEach(obj=>createBalloon(obj));
      requestAnimationFrame(animateBalloons);
    }

    /* ================= Balloons ================= */
    function createBalloon(obj){
      const b=document.createElement('div'); b.className='balloon'; b.dataset.pair=obj.pair; gameContainer.appendChild(b);
      const r=b.getBoundingClientRect(); const w=r.width; const top=innerHeight*0.05; const x=Math.floor(Math.random()*(innerWidth-w-20))+10;
      b.style.top=top+'px'; b.style.left=x+'px';
      const img=document.createElement('img'); img.src=obj.src; b.appendChild(img);
      b.addEventListener('click',()=>{ sfxTick(); popBalloon(b,obj); });
      b._float={speedX:rand(0.03,0.07),dir:Math.random()<0.5?-1:1,amp:rand(10,30),freq:rand(0.002,0.005),phase:Math.random()*Math.PI*2,base:top,w:w,last:null};
      balloons.push(b);
    }

    function popBalloon(b,obj){
      const s=b.getBoundingClientRect(); b.remove();
      const idx=balloons.indexOf(b); if(idx!==-1) balloons.splice(idx,1);
      const f=document.createElement('img'); f.src=obj.src; f.className='falling'; gameContainer.appendChild(f);
      const r=f.getBoundingClientRect();
      f.style.left=(s.left + (s.width - r.width)/2) + 'px';
      f.style.top = s.top + 'px';
      f.dataset.pair=obj.pair;
      animateFall(f);
    }

    function animateFall(el){
      const SPEED=Math.max(250, innerHeight*0.45); let last=null;
      function step(ts){
        if(last==null) last=ts; const dt=(ts-last)/1000; last=ts;
        el.style.top=(parseFloat(el.style.top||'0') + SPEED*dt) + 'px';
        const trainRect=train.getBoundingClientRect(); const ir=el.getBoundingClientRect();

        if(ir.bottom >= trainRect.top){
          const cx=ir.left + ir.width/2;
          const slots=[...train.querySelectorAll('.wagon')];
          const landed=slots.find(s=>{ const r=s.getBoundingClientRect(); return cx>=r.left && cx<=r.right; });
          if(landed){
            if(landed.dataset.pair===el.dataset.pair) correctDrop(landed, el);
            else wrongDrop(el, landed);
          } else wrongDrop(el, null);
          return;
        }
        if(ir.top > innerHeight){ wrongDrop(el, null); return; }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function correctDrop(slot, fallingImg){
      fallingImg.remove();
      const box=slot.querySelector('.slot-img');
      const paired=document.createElement('img'); paired.src=fallingImg.src; paired.className='paired';
      box.innerHTML=''; box.appendChild(paired);

      slot.classList.add('correct','is-correct');
      sfxCorrect();
      setTimeout(()=>slot.classList.remove('is-correct'), 600);

      if(++correctCount===numWagons){
        runDepartureSequence();
      }
    }

    function showFeedback(){
      feedback.style.display='block';
      clearTimeout(showFeedback._t);
      showFeedback._t=setTimeout(()=>feedback.style.display='none',800);
    }
    function wrongDrop(el, slotMaybe){
      sfxWrong();
      if(slotMaybe){ slotMaybe.classList.add('is-wrong'); setTimeout(()=>slotMaybe.classList.remove('is-wrong'), 500); }
      showFeedback();
      const p=el.dataset.pair; el.remove();
      const obj=imagesList.find(x=>x.pair===p); if(obj) createBalloon(obj);
    }

    /* ================= Departure sequence (wait for loco preload) ================= */
    function runDepartureSequence(){
      document.body.classList.add('animating');

      locomotiveReady.then(()=>{
        const loco=document.createElement('div');
        loco.className='locomotive';

        // still not loaded (timeout path): show fallback until image finishes
        if(!locomotiveLoaded){
          const fallback=document.createElement('span');
          fallback.className='fallback-emoji';
          fallback.textContent='ðŸš‚';
          loco.appendChild(fallback);
          locoImg.addEventListener('load', ()=>{ try{ fallback.remove(); }catch(e){} }, { once:true });
        }

        gameContainer.appendChild(loco);

        // start sounds synchronized with animation start
        if(SOUND_ENABLED && mediaPrimed){
          try{ locoLoop.currentTime = 0; locoLoop.play(); }catch(e){}
          try{ whistle.currentTime = 0; whistle.play(); }catch(e){}
        }

        loco.addEventListener('animationend', ()=>{
          train.classList.add('depart');
          train.addEventListener('animationend', ()=>{
            // stop sounds
            try{ locoLoop.pause(); locoLoop.currentTime = 0; }catch(e){}
            try{ whistle.pause(); }catch(e){}
            // activity complete
            onActivityComplete();
            loco.remove();
            document.body.classList.remove('animating');
          }, {once:true});
        }, {once:true});

        requestAnimationFrame(()=>loco.classList.add('run'));
      });
    }

    /* ================= Completion, progress, congrats ================= */
    function ensureUserIsAuthenticated(callback){
      if(currentUserId){ callback(currentUserId); return; }
      firebase.auth().onAuthStateChanged(function(user){
        if(user){ currentUserId = user.uid; callback(user.uid); }
        else { console.error("[Auth] User not authenticated"); }
      });
    }

    function markPhaseCompleted(){ ensureUserIsAuthenticated(updateNextPhase); }

    async function updateNextPhase(userId){
      const { level, unit, fase } = getParams();
      if(!level || !unit || !fase){ console.warn("[Progress] Missing URL params."); return; }
      const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}`);

      try{
        if(fase === "last"){
          const nextUnit=`Unit${parseInt(unit.replace('Unit',''))+1}`;
          await firebase.database().ref(`usuarios/${userId}/progresso/${level}/${nextUnit}`).set({ fase1:true });
        }else if(fase === "end"){
          const nextLevel=`Level${parseInt(level.replace('Level',''))+1}`;
          await firebase.database().ref(`usuarios/${userId}/progresso/${nextLevel}/Unit1`).set({ fase1:true });
        }else{
          const next=parseInt(fase)+1;
          await dbRef.update({[`fase${fase}`]:true,[`fase${next}`]:true});
        }
        console.log("[Progress] Update successful.");
      }catch(err){ console.error("[Progress] Error:", err); }
    }

    function onActivityComplete(){
      if(activityCompleted) return;
      activityCompleted = true;
      state.completed = true;
      sfxWin();
      markPhaseCompleted();
      showCongrats();
    }

    function showCongrats(){ congrats.classList.add('show'); }
    closeCongratsBtn?.addEventListener('click', ()=>{ congrats.classList.remove('show'); });

    /* ================= Back button (with confirmation) ================= */
    async function goBack(){
      const { level, unit, fase } = getParams();

      if(!activityCompleted){
        const leave = confirm("You haven't completed this phase yet. Do you want to go back?");
        if(leave){ window.history.back(); }
        return;
      }

      if(!level || !unit || !fase){ window.history.back(); return; }

      firebase.auth().onAuthStateChanged(async (user)=>{
        if(!user){ window.history.back(); return; }
        const nextPhase = `fase${parseInt(fase)+1}`;
        try{
          const snapshot = await firebase.database()
            .ref(`usuarios/${user.uid}/progresso/${level}/${unit}/${nextPhase}`)
            .once("value");
          if(snapshot.val() === true){
            window.history.back();
          } else {
            const confirmExit = confirm("The next phase is locked. Do you still want to go back?");
            if(confirmExit){ window.history.back(); }
          }
        }catch(err){
          console.error("[Back] Firebase error:", err);
          const confirmExit = confirm("Could not verify progress. Do you want to go back anyway?");
          if(confirmExit){ window.history.back(); }
        }
      });
    }

    /* ================= Balloons float animation ================= */
    function animateBalloons(ts){
      for(const b of balloons){
        const p=b._float; if(!p.last) p.last=ts;
        const d=ts - p.last; p.last=ts;
        let left=parseFloat(b.style.left);
        left += p.speedX * p.dir * d;
        if(left > innerWidth) left = -p.w;
        if(left < -p.w) left = innerWidth;
        const top = p.base + p.amp * Math.sin(p.phase + p.freq * ts);
        b.style.left=left+'px'; b.style.top=top+'px';
      }
      requestAnimationFrame(animateBalloons);
    }

    /* ================= Rebuild balloons (used by restart) ================= */
    function rebuildBalloons(){
      // remove any existing balloons and falling items
      document.querySelectorAll('.balloon, .falling').forEach(el=>el.remove());
      balloons.length = 0;
      // recreate one balloon for each image
      imagesList.forEach(obj=>createBalloon(obj));
    }

    /* ================= Restart ================= */
    function restartGame(){
      // reset counters/flags
      correctCount = 0;
      activityCompleted = false;
      state.completed = false;

      // clear feedback & UI
      feedback.style.display = 'none';
      congrats.classList.remove('show');
      train.classList.remove('depart');
      document.body.classList.remove('animating');

      // stop & reset sounds
      try{ locoLoop.pause(); locoLoop.currentTime = 0; }catch(e){}
      try{ whistle.pause(); whistle.currentTime = 0; }catch(e){}

      // remove any locomotive on screen
      document.querySelectorAll('.locomotive').forEach(l=>l.remove());

      // clear wagonsâ€™ images and visual states
      train.querySelectorAll('.slot-img').forEach(b=>b.innerHTML='');
      train.querySelectorAll('.wagon').forEach(w=>w.classList.remove('correct','is-correct','is-wrong'));

      // rebuild balloons fresh
      rebuildBalloons();
    }
  </script>
</body>
</html>
