<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hist√≥ria Completa</title>
  <link rel="stylesheet" href="css/estilo.css" />
  <script src="js/translations.js"></script>
</head>
<body>
<header>
  <nav class="menu">
    <a href="index.html" id="nav-inicio">In√≠cio</a>
    <a href="impacto.html" id="nav-historias-impacto">Hist√≥rias</a>
    <a href="#" onclick="setLanguage('pt')" id="lang-pt">PT</a>
    <a href="#" onclick="setLanguage('en')" id="lang-en" class="inactive">EN</a>
  </nav>
</header>

<div class="historia-container">
  <img id="historia-img" src="imagens/placeholder.jpg" alt="Imagem da Hist√≥ria" />
  <h1 class="titulo-historia" id="titulo-historia">Carregando t√≠tulo...</h1>
  <div class="texto-historia" id="texto-historia">Carregando texto completo...</div>

  <div class="botoes-acao">
    <button id="btn-compartilhar-historia" onclick="shareThisStory()">
      Compartilhe esta hist√≥ria
    </button>
    <a href="impacto.html" id="btn-voltar-lista">Voltar para Hist√≥rias</a>
  </div>
</div>

<footer>
  <p>¬© 2025 Funda√ß√£o Hannah. Todos os direitos reservados.</p>
</footer>

<script>
function setLanguage(lang) {
  changeLanguage(lang);
  if(lang === 'pt') {
    document.getElementById('lang-pt').classList.remove('inactive');
    document.getElementById('lang-en').classList.add('inactive');
  } else {
    document.getElementById('lang-pt').classList.add('inactive');
    document.getElementById('lang-en').classList.remove('inactive');
  }
}

const translations = {
  "nav-inicio": { pt: "In√≠cio", en: "Home" },
  "nav-historias-impacto": { pt: "Hist√≥rias", en: "Stories" },
  "btn-compartilhar-historia": { pt: "Compartilhe esta hist√≥ria", en: "Share this story" },
  "btn-voltar-lista": { pt: "Voltar para Hist√≥rias", en: "Back to Stories" }
};

function changeLanguage(lang) {
  document.documentElement.setAttribute("lang", lang);
  for (let key in translations) {
    let el = document.getElementById(key);
    if (el) el.innerHTML = translations[key][lang];
  }
}

/* ======================================
   1) PEGAR ?id= da URL
====================================== */
function getQueryParam(param) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(param);
}
const historiaId = getQueryParam("id");

/* ======================================
   2) BUSCAR E PARSEAR .TXT
====================================== */
async function carregarHistoria(id) {
  let url = `impacto/${id}/${id}.txt`;
  try {
    const resp = await fetch(url);
    const text = await resp.text();
    const lang = document.documentElement.getAttribute("lang") || "pt";
    
    // Precisamos pegar o bloco # PT e o bloco # EN
    // E extrair T√çTULO/TEXTO/IMAGEM
    let [ptBlock, enBlock] = separarBlocos(text);

    let dataPT = parseBlocoLongo(ptBlock, "PT");
    let dataEN = parseBlocoLongo(enBlock, "EN");

    // Se quiser, tamb√©m podemos extrair os metadados se precisar exibir
    // (Mas aqui estamos focando no texto completo.)
    
    if (lang === "pt") {
      document.getElementById("titulo-historia").innerText = dataPT.titulo || "Sem t√≠tulo (PT)";
      document.getElementById("texto-historia").innerText = dataPT.texto || "Sem texto (PT)";
      if (dataPT.imagem) {
        document.getElementById("historia-img").src = `impacto/${id}/${dataPT.imagem}`;
      }
    } else {
      document.getElementById("titulo-historia").innerText = dataEN.titulo || "No title (EN)";
      document.getElementById("texto-historia").innerText = dataEN.texto || "No text (EN)";
      if (dataEN.imagem) {
        document.getElementById("historia-img").src = `impacto/${id}/${dataEN.imagem}`;
      }
    }
  } catch (err) {
    document.getElementById("titulo-historia").innerText = "Erro ao carregar hist√≥ria";
    console.error(err);
  }
}

/* ======================================
   3) SEPARAR BLOCOS # PT e # EN
====================================== */
function separarBlocos(conteudo) {
  // Vamos dividir em "# PT" e "# EN"
  // Mas note que antes de # PT pode haver metadados
  // Ent√£o, idealmente, a gente acha a substring "# PT" e "# EN"
  // e separa. Exemplo simples:
  let indicePt = conteudo.indexOf("# PT");
  let indiceEn = conteudo.indexOf("# EN");

  if (indicePt === -1) return ["", ""];
  if (indiceEn === -1) indiceEn = conteudo.length;

  let ptBlock = conteudo.substring(indicePt, indiceEn);
  let enBlock = conteudo.substring(indiceEn);

  return [ptBlock, enBlock];
}

/* ======================================
   4) PARSE DO BLOCO LONGO
   Ex: # PT
       T√çTULO: ...
       TEXTO:
       ...
       IMAGEM: ...
====================================== */
function parseBlocoLongo(bloco, langTag) {
  let data = { titulo: "", texto: "", imagem: "" };

  let lines = bloco.split("\n");
  let isReadingText = false; // se estiver lendo ap√≥s "TEXTO:" (m√∫ltiplas linhas)

  for (let line of lines) {
    let trimmed = line.trim();
    if (trimmed.startsWith("# PT") || trimmed.startsWith("# EN")) {
      continue; // ignora linha do marcador
    }
    if (trimmed.startsWith("T√çTULO:") || trimmed.startsWith("TITLE:")) {
      data.titulo = trimmed.split(":")[1].trim();
      isReadingText = false;
    } else if (trimmed.startsWith("TEXTO:") || trimmed.startsWith("TEXT:")) {
      // pode come√ßar o texto (multi-linha)
      isReadingText = true;
      // Se houver algo depois de "TEXTO:" na mesma linha, concatena
      let partial = trimmed.replace("TEXTO:", "").replace("TEXT:", "").trim();
      data.texto += partial + "\n";
    } else if (trimmed.startsWith("IMAGEM:") || trimmed.startsWith("IMAGE:")) {
      data.imagem = trimmed.split(":")[1].trim();
      isReadingText = false;
    } else {
      // se isReadingText = true, essas linhas pertencem ao texto
      if (isReadingText) {
        data.texto += trimmed + "\n";
      }
    }
  }

  return data;
}

/* ======================================
   5) COMPARTILHAR HIST√ìRIA
====================================== */
function shareThisStory() {
  let lang = document.documentElement.getAttribute("lang") || "pt";
  let textPT = "Essa hist√≥ria me impactou e eu quis compartilhar com voc√™. Leia como Deus transformou essa vida! üôå‚ú®";
  let textEN = "This story touched me deeply, and I wanted to share it with you. Read how God transformed this life! üôå‚ú®";

  let shareText = (lang === "pt") ? textPT : textEN;
  let storyUrl = window.location.href;

  if (navigator.share) {
    navigator.share({
      title: document.title,
      text: shareText,
      url: storyUrl
    }).catch(console.error);
  } else {
    alert(shareText + "\n\n" + storyUrl);
  }
}

/* ======================================
   6) AO CARREGAR
====================================== */
window.addEventListener("DOMContentLoaded", () => {
  setLanguage("pt");
  if (historiaId) {
    carregarHistoria(historiaId);
  }
});
</script>
</body>
</html>
