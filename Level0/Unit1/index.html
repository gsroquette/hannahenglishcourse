<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select an Activity</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId: "G-07VVJG9LRS",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    /* ====== Base ====== */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width: 100%;
      min-height: 100svh;
      background: url('../../imagens/fundo.png') repeat;
      font-family: "Times New Roman", Times, serif;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    /* ====== Barra superior ====== */
    .topbar { position: relative; width: 100%; height: 72px; }
    .back-button {
      position: absolute; top: 16px; left: 16px;
      text-decoration: none; background-color: #000; color: #fff;
      padding: 8px 12px; border-radius: 4px; z-index: 9999;
    }
    .back-button:hover { background-color: #333; }

    /* Avatar + nome */
    .login-container {
      position: absolute; top: 12px; right: 14px; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      background: none; border: none; box-shadow: none; padding: 0; cursor: pointer;
    }
    .user-icon { width: 55px; height: auto; display: block; border: none; border-radius: 0; object-fit: contain; pointer-events: none; }
    .user-name {
      margin: 0; line-height: 1.05; text-align: center; font-size: 13px; font-weight: 700; color: #1a5f34;
      white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
      text-shadow: 0 1px 1px rgba(255,255,255,0.45), 0 1px 2px rgba(0,0,0,0.18);
    }
    .user-dropdown {
      display: none; flex-direction: column; position: absolute; top: 70px; right: 0;
      background-color: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 9999; overflow: hidden; min-width: 220px;
    }
    .dropdown-item { padding: 10px 16px; color: #333; text-decoration: none; font-size: 14px; }
    .dropdown-item:hover { background-color: #f0f0f0; }

    /* ====== Layout geral ====== */
    .map-container {
      width: 100%;
      position: relative;
      background-image: url('../../imagens/fundo.png');
      background-repeat: repeat;
      background-size: 200%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      width: 100%;
      padding: 0;
      text-align: center;
      background: none;
    }

    .title-container {
      text-align: center;
      margin-top: 28px;
      margin-bottom: 8px;
      position: relative;
      z-index: 2;
    }

    .title-container h1 {
      font-size: 2em;
      color: #4CAF50;
      font-family: Arial, sans-serif;
      margin: 0;
      text-shadow: 1px 1px 2px #000000;
    }

    /* ====== Teacher Resources fora do mapa principal ====== */
    .teacher-strip {
      width: 100%;
      max-width: 1080px;
      display: flex;
      justify-content: flex-start;
      padding: 10px 16px 0;
      box-sizing: border-box;
    }

    .teacher-strip a.teacher-resources {
      display: none; /* ser√° liberado por role */
      background: #ffffff;
      border-radius: 12px;
      border: 2px solid #4CAF50;
      padding: 6px 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      text-decoration: none;
    }

    .teacher-strip a.teacher-resources img {
      height: 52px;
      width: auto;
      display: block;
    }

    /* ====== TABULEIRO DO MAPA ====== */
    .activity-buttons {
      position: relative;
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
      /* mapa em formato 1080x2880 */
      background-image: url('../../imagens/map.png');
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% auto;
      /* altura proporcional √† largura */
      height: calc(100vw * 2.6667); /* 2880/1080 */
      max-height: 2880px;
      overflow: visible;
    }

    @media (min-width: 1080px) {
      .activity-buttons {
        height: 2880px;
      }
    }

    /* Bot√µes do mapa */
    .map-btn,
    .activity-button,
    .robot-lex,
    .hannah-video {
      position: absolute;
      transform: translate(-50%, -50%);
      display: flex;
      justify-content: center;
      align-items: center;
      text-decoration: none;
    }

    .map-btn img,
    .activity-button img,
    .robot-lex img,
    .hannah-video img {
      width: 26vw;
      max-width: 230px;
      height: auto;
    }

    @media (min-width: 1080px) {
      .map-btn img,
      .activity-button img,
      .robot-lex img,
      .hannah-video img {
        width: 220px;
      }
    }

    /* Posi√ß√µes em porcentagem (baseado em 1080x2880) */
    .map-pos-1 { left: 20%; top: 10.42%; }  /* linha 1 coluna 1 */
    .map-pos-2 { left: 50%; top: 20.83%; }  /* linha 2 coluna 2 */
    .map-pos-3 { left: 80%; top: 31.25%; }  /* linha 3 coluna 3 */
    .map-pos-4 { left: 50%; top: 41.67%; }  /* linha 4 coluna 2 */
    .map-pos-5 { left: 20%; top: 52.08%; }  /* linha 5 coluna 1 */
    .map-pos-6 { left: 50%; top: 62.50%; }  /* linha 6 coluna 2 */
    .map-pos-7 { left: 80%; top: 72.92%; }  /* linha 7 coluna 3 */
    .map-pos-8 { left: 50%; top: 83.33%; }  /* linha 8 coluna 2 */
    .map-pos-9 { left: 20%; top: 93.75%; }  /* linha 9 coluna 1 */

    /* ====== DESABILITADO ====== */
    .disabled-btn {
      filter: grayscale(100%);
      opacity: 0.55;
      pointer-events: none;
      cursor: not-allowed;
    }

    .disabled-btn img {
      filter: grayscale(100%);
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <a href="javascript:history.back()" class="back-button">Back</a>
    <div id="loginContainer" class="login-container">
      <a href="Formulario/login.html" id="loginLink" class="login-link">Login</a>
      <div id="userDropdown" class="user-dropdown"></div>
    </div>
  </div>

  <div class="map-container">
    <header>
      <div class="title-container"><h1>Select an Activity</h1></div>
    </header>

    <!-- Teacher Resources (fora do caminho principal) -->
    <div class="teacher-strip">
      <a href="teacher/index.html" class="teacher-resources">
        <img src="../../imagens/resources.png" alt="Teacher Resources">
      </a>
    </div>

    <main>
      <!-- Tabuleiro com o map.png de fundo -->
      <div class="activity-buttons" id="activity-buttons">
        <!-- Bot√µes ser√£o inseridos via JS com as classes de posi√ß√£o -->
      </div>
    </main>
  </div>

  <script>
  /* ========== CONFIG DASHBOARDS ========== */
  const DASHBOARD_PATH = {
    aluno: "../../painel_aluno.html",
    professor: "../../painel_professor.html",
    proprietario: "../../painel_professor.html"
  };

  /* ========== Level/Unit da URL (+ normaliza√ß√£o) ========== */
  const __pathParts = window.location.pathname.split("/");
  const __level = __pathParts[1] || "Level1";
  const __unit  = __pathParts[2] || "Unit1";
  const normLU = s => s.replace(/^level(\d+)$/i, 'Level$1')
                       .replace(/^unit(\d+)$/i, 'Unit$1');
  const __levelDB = normLU(__level);
  const __unitDB  = normLU(__unit);

  /* ========== Helpers: cria√ß√£o e (des)bloqueio ========== */
  function createGatedLink({ href, className, imgSrc, imgAlt, requiresPhase, posClass }) {
    const a = document.createElement("a");
    a.className = (className || "") + " map-btn disabled-btn " + (posClass || "");
    a.dataset.href = href;
    if (requiresPhase) a.dataset.requiresPhase = String(requiresPhase);
    const img = document.createElement("img");
    img.src = imgSrc; img.alt = imgAlt;
    a.appendChild(img);
    return a;
  }

  function markDisabled(anchorEl, requiredPhase) {
    if (!anchorEl) return;
    anchorEl.classList.add("disabled-btn");
    anchorEl.removeAttribute("href");
    anchorEl.setAttribute("aria-disabled", "true");
    if (requiredPhase) {
      anchorEl.title = `Unlocked after completing phase ${requiredPhase}.`;
    }
  }

  function markEnabled(anchorEl) {
    if (!anchorEl) return;
    const dh = anchorEl.dataset.href;
    if (dh) anchorEl.href = dh;
    anchorEl.classList.remove("disabled-btn");
    anchorEl.removeAttribute("aria-disabled");
    anchorEl.removeAttribute("title");
  }

  /* ========== Constru√ß√£o dos bot√µes no mapa ========== */
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("activity-buttons");
    if (!container) return;

    /* 1) Hannah Video ‚Äì sempre liberado (map-pos-2) */
    const hannahVideo = document.createElement("a");
    hannahVideo.href = `/Atividades/HannahVideo/index.html?level=${__level}&unit=${__unit}`;
    hannahVideo.className = "hannah-video map-btn map-pos-2";
    hannahVideo.dataset.href = hannahVideo.href;
    const hvImg = document.createElement("img");
    hvImg.src = "../../imagens/botoes/video_button.png";
    hvImg.alt = "Hannah Video";
    hannahVideo.appendChild(hvImg);
    container.appendChild(hannahVideo);

    /* 2) Demais trechos em ordem do mapa:
       pos-3 -> trecho1
       pos-4 -> trecho2
       pos-5 -> trecho3
       pos-6 -> trecho4
       pos-7 -> trecho5
       pos-8 -> trecho6
    */
    const buttonData = [
      { trecho: "trecho1", img: "../../imagens/listening.png", alt: "Story & Listening",  requiresPhase: null, posClass: "map-pos-3" },
      { trecho: "trecho2", img: "../../imagens/grammar.png",   alt: "Grammar",            requiresPhase:  8,   posClass: "map-pos-4" },
      { trecho: "trecho3", img: "../../imagens/speaking.png",  alt: "Words & Spelling",   requiresPhase: 14,   posClass: "map-pos-5" },
      { trecho: "trecho4", img: "../../imagens/writing.png",   alt: "Speak It Clearly",   requiresPhase: 20,   posClass: "map-pos-6" },
      { trecho: "trecho5", img: "../../imagens/Bible.png",     alt: "Real Conversation",  requiresPhase: 25,   posClass: "map-pos-7" },
      { trecho: "trecho6", img: "../../imagens/test.png",      alt: "Final Challenge",    requiresPhase: 29,   posClass: "map-pos-8" }
    ];

    buttonData.forEach(data => {
      const href = `/${__level}/${__unit}/fases.html?trecho=${data.trecho}`;
      if (!data.requiresPhase) {
        const a = document.createElement("a");
        a.href = href;
        a.dataset.href = href;
        a.className = "activity-button map-btn " + data.posClass;
        a.dataset.trecho = data.trecho;
        const img = document.createElement("img");
        img.src = data.img; img.alt = data.alt;
        a.appendChild(img);
        container.appendChild(a);
        return;
      }
      const gated = createGatedLink({
        href,
        className: "activity-button",
        imgSrc: data.img,
        imgAlt: data.alt,
        requiresPhase: data.requiresPhase,
        posClass: data.posClass
      });
      gated.dataset.trecho = data.trecho;
      container.appendChild(gated);
    });

    /* 3) Rob√¥ Lex ‚Äì √∫ltima posi√ß√£o do mapa (map-pos-9), travado at√© fase 27 */
    const robotButton = createGatedLink({
      href: `../../Atividades/LEX/index.html?level=${__level}&unit=${__unit}`,
      className: "robot-lex",
      imgSrc: "../../imagens/botoes/lex_button.png",
      imgAlt: "Robot Samuel",
      requiresPhase: 27,
      posClass: "map-pos-9"
    });
    robotButton.dataset.kind = "robotLex";
    container.appendChild(robotButton);
  });

  /* ========== Leitura do progresso (suporta "fase8", etc.) ========== */
  async function getUnlockedInfo(userId, levelDB, unitDB) {
    const db = firebase.database();
    const candidatePaths = [
      `/progresso/${userId}/${levelDB}/${unitDB}`,
      `/progress/${userId}/${levelDB}/${unitDB}`,
      `/usuarios/${userId}/progresso/${levelDB}/${unitDB}`,
      `/usuarios/${userId}/progress/${levelDB}/${unitDB}`,
    ];

    let lastUnlocked = null;
    const unlockedSet = new Set();

    const keyToNumber = (k) => {
      const m = String(k).match(/(\d+)/);
      return m ? Number(m[1]) : NaN;
    };
    const truthy = (v) => (v === true || v === 1 || v === "true" || v === "True");

    const absorbPhaseObject = (obj) => {
      if (!obj || typeof obj !== 'object') return;
      Object.keys(obj).forEach(k => {
        const n = keyToNumber(k);
        const v = obj[k];
        if (!Number.isNaN(n) && truthy(v)) unlockedSet.add(n);
      });
    };

    for (const base of candidatePaths) {
      try {
        const snap = await db.ref(base).once("value");
        const val = snap.val();
        if (!val) continue;

        if (typeof val.ultimaFaseLiberada === "number") {
          lastUnlocked = Math.max(lastUnlocked ?? -Infinity, val.ultimaFaseLiberada);
        }
        if (typeof val.lastUnlocked === "number") {
          lastUnlocked = Math.max(lastUnlocked ?? -Infinity, val.lastUnlocked);
        }

        absorbPhaseObject(val);
        absorbPhaseObject(val.fasesLiberadas);
        absorbPhaseObject(val.liberadas);
        absorbPhaseObject(val.released);
        absorbPhaseObject(val.fases);
        absorbPhaseObject(val.unlocked);

      } catch (e) {
        console.warn("Falha ao ler", base, e?.message);
      }
    }

    return { lastUnlocked, unlockedSet };
  }

  function isPhaseSatisfied(requiredPhase, lastUnlocked, unlockedSet) {
    if (!requiredPhase) return true;
    const req = Number(requiredPhase);
    if (Number.isNaN(req)) return true;
    if (lastUnlocked != null && typeof lastUnlocked === "number" && lastUnlocked >= req) return true;
    if (unlockedSet.has(req)) return true;
    return false;
  }

  async function applyStudentGates(userId, levelDB, unitDB) {
    const { lastUnlocked, unlockedSet } = await getUnlockedInfo(userId, levelDB, unitDB);
    const container = document.getElementById("activity-buttons");
    if (!container) return;

    const allAnchors = Array.from(
      container.querySelectorAll("a.activity-button, a.robot-lex, a.hannah-video")
    );

    for (const a of allAnchors) {
      const trecho = a.dataset.trecho;
      const req    = a.dataset.requiresPhase;
      const kind   = a.dataset.kind;

      if ((trecho === "trecho2" || trecho === "trecho3" || trecho === "trecho4" || trecho === "trecho5" || trecho === "trecho6") || kind === "robotLex") {
        if (req && !isPhaseSatisfied(req, lastUnlocked, unlockedSet)) {
          markDisabled(a, req);
        } else {
          markEnabled(a);
        }
      } else {
        // trecho1 e Hannah Video sempre liberados
        markEnabled(a);
      }
    }
  }

  /* ========== Dropdown do usu√°rio por role ========== */
  function renderDropdown(role) {
    const userDropdown = document.getElementById("userDropdown");
    if (!userDropdown) return;

    const isTeacher = (role === "professor" || role === "proprietario");
    const dashLabel = isTeacher ? "üìä Teacher Dashboard" : "üìä Student Dashboard";
    const dashHref  = isTeacher ? (DASHBOARD_PATH.professor) : (DASHBOARD_PATH.aluno);

    userDropdown.innerHTML = `
      <a href="${dashHref}" class="dropdown-item">${dashLabel}</a>
      <a href="../../index.html" class="dropdown-item">üîÅ Select a New Level</a>
      <a href="../index.html" class="dropdown-item">üîÑ Select a New Unit</a>
    `;
  }

  /* ========== Login + roles + gates ========== */
  firebase.auth().onAuthStateChanged(async (user) => {
    const loginLink = document.getElementById("loginLink");
    const userDropdown = document.getElementById("userDropdown");

    if (user) {
      const userRef = firebase.database().ref("usuarios/" + user.uid);
      const snap = await userRef.once("value");
      const dados = snap.val() || {};
      const nome = (dados.nome || user.email || "User").trim();
      const displayName = nome.length > 10 ? nome.slice(0, 10) + "‚Ä¶" : nome;
      const avatar = dados.avatar ? `../../imagens/${dados.avatar}` : "../../imagens/bonecologin1.png";

      loginLink.innerHTML = "";
      loginLink.removeAttribute("href");
      const img = document.createElement("img");
      img.src = avatar; img.alt = "User Avatar"; img.className = "user-icon";
      img.onerror = () => { img.src = "../../imagens/bonecologin1.png"; };
      const p = document.createElement("p"); p.className = "user-name"; p.textContent = displayName;
      loginLink.append(img, p);

      const role = dados.role || null;
      renderDropdown(role);

      loginLink.onclick = (e) => {
        e.preventDefault();
        userDropdown.style.display =
          (userDropdown.style.display === "flex" ? "none" : "flex");
      };
      window.addEventListener("click", (e) => {
        if (!loginLink.contains(e.target)) userDropdown.style.display = "none";
      });

      // Teacher Resources + gates
      if (role === "professor" || role === "proprietario") {
        const tr = document.querySelector(".teacher-strip .teacher-resources");
        if (tr) tr.style.display = "block";
        document
          .querySelectorAll(".activity-button, .robot-lex, .hannah-video")
          .forEach(a => markEnabled(a));
      } else if (role === "aluno") {
        try { await applyStudentGates(user.uid, __levelDB, __unitDB); }
        catch (e) { console.warn("Falha ao aplicar travas de aluno:", e?.message); }
      } else {
        document
          .querySelectorAll(".hannah-video, [data-trecho='trecho1']")
          .forEach(a => markEnabled(a));
      }

    } else {
      if (userDropdown) {
        userDropdown.innerHTML = `
          <a href="../../index.html" class="dropdown-item">üîÅ Select a New Level</a>
          <a href="../index.html" class="dropdown-item">üîÑ Select a New Unit</a>
        `;
      }
      const loginLink = document.getElementById("loginLink");
      loginLink.textContent = "Login";
      loginLink.href = "Formulario/login.html";
    }
  });

  // Compat: garantir Teacher Resources para professor/propriet√°rio
  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      const userRoleRef = firebase.database().ref(`/usuarios/${user.uid}/role`);
      userRoleRef.once("value").then((snapshot) => {
        const role = snapshot.val();
        if (role === "professor" || role === "proprietario") {
          const tr = document.querySelector(".teacher-strip .teacher-resources");
          if (tr) tr.style.display = "block";
        }
      }).catch((error) => console.error("Erro ao obter role:", error));
    }
  });
  </script>
</body>
</html>
