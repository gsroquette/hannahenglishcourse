<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Teacher Resources</title>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-image: url('../../../imagens/fundo.png');
            background-repeat: repeat;
            background-size: auto;
            background-color: #f4f4f9; /* Safe background color in case the image fails */
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1, h2 {
            color: #FF6347; 
            text-align: center;
            margin-top: 20px;
            text-shadow: 1px 1px #888;
        }

        h1 {
            font-size: 2.5rem;
        }

        h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .buttons {
            text-align: center;
            margin-bottom: 20px;
        }

        .buttons button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 5px;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .buttons button:hover {
            background-color: #45a049;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        /* Activities section now uses flexbox to reduce horizontal spacing and center items */
        .activities {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px; /* smaller horizontal gap */
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Transparent container for activity buttons */
        .activities a {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent; /* no background */
            width: 150px; /* fix a width to keep them consistent in a row */
            height: 160px;
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .activities a:hover {
            transform: translateY(-5px);
            /* remove box-shadow for full transparency */
        }

        .activities img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* On very small screens, we allow wrapping naturally; spacing should be fine. */
        @media (max-width: 600px) {
            .activities {
                justify-content: center;
            }

            .activities a {
                width: 120px;
                height: 140px;
            }

            .activities img {
                width: 100%;
                max-height: 120px;
            }
        }

        /* Transparent content containers */
        .content {
            max-width: 800px;
            margin: 40px auto;
            /* Added extra top padding to avoid overlap with the close button */
            padding: 40px 20px 20px;
            background-color: transparent; 
            border: none;
            box-shadow: none;
            position: relative;
            display: none; /* hidden by default */
        }

        /* Close button */
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #FF6347; 
            color: #fff;
            border: none;
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: #e0553c;
        }

        /* Print button (novo) */
        .modal-print-btn {
            position: absolute;
            top: 10px;
            right: 90px; /* fica à esquerda do Close */
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        }
        .modal-print-btn:hover {
            background-color: #45a049;
        }

        /* Base class for formatted text, now all bold and slightly larger */
        .formatted-text {
            line-height: 1.6;
            font-size: 1.1rem; /* slightly bigger font */
            font-weight: bold; /* ALL text in bold */
            color: #444;
        }

        .formatted-text h3 {
            color: #333;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .formatted-text strong {
            color: #4CAF50; /* highlight for double-bold is not very visible but kept for color difference */
        }

        .formatted-text em {
            font-style: italic;
        }

        .formatted-text ul {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .formatted-text li {
            margin-bottom: 0.5em;
        }

        .formatted-text hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #ccc;
        }

        .formatted-text p {
            margin-bottom: 1em;
        }

        .formatted-text br {
            margin-bottom: 1em;
        }

        /* Responsive adjustments */
        @media (max-width: 800px) {
            .content {
                padding: 50px 15px 15px;
                margin: 20px auto;
            }

            h1 {
                font-size: 2.2rem;
            }

            h2 {
                font-size: 1.6rem;
            }

            .buttons button {
                font-size: 0.9rem;
            }
        }

        /* Styles for the image modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content img {
            max-width: 80%;
            max-height: 80%;
            display: block;
            margin: auto;
        }

        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ddd;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
        }

        .modal-close-btn:hover {
            background-color: #bbb;
        }
    </style>
</head>
<body>
    <h1>Teacher Resources</h1>
    
    <!-- Top buttons (removed "Lesson Plan" as requested before) -->
    <div class="buttons">
        <button onclick="goBackToLevel()">Back</button>
    </div>

    <!-- Teachers Guide -->
    <h2>Teachers Guide</h2>
    <div class="activities">
        <a href="javascript:void(0);" onclick="showTeachersGuideContent('how_it_works.txt')">
            <img src="../../../imagens/botoes/howitworks_button.png" alt="How It Works">
        </a>
        <a href="javascript:void(0);" onclick="showTeachersGuideContent('lesson_plan.txt')">
            <img src="../../../imagens/botoes/lessonplan_button.png" alt="Lesson Plan">
        </a>
    </div>

    <!-- Teachers Guide container -->
    <div class="content" id="teachersGuideContainer">
        <button class="close-btn" onclick="closeTeachersGuide()">X</button>
        <div id="teachersGuideContent" class="formatted-text"></div>
    </div>

    <!-- Creative Unit Activity -->
    <h2>Creative Unit Activity</h2>
    <div class="activities">
        <a href="javascript:void(0);" onclick="showCreativeActivityContent('atividade_criativa.txt')">
            <img src="../../../imagens/botoes/atividadecriativa_button.png" alt="Creative Activity">
        </a>
        <a href="javascript:void(0);" onclick="showDocuments()">
            <img src="../../../imagens/botoes/documentos.png" alt="Documents">
        </a>
    </div>

    <!-- Creative Activity container -->
    <div class="content" id="creativeActivityContainer">
        <button class="close-btn" onclick="closeCreativeActivity()">X</button>
        <div id="creativeActivityContent" class="formatted-text"></div>
    </div>

    <!-- Choose an Activity -->
    <h2>Choose an Activity</h2>
    <div class="activities">
        <a href="Fine Motor Skills/index.html"><img src="../../../imagens/botoes/Fine_Motor_Skills_Button.png" alt="Fine Motor Skills"></a>
        <a href="Missing Letter/index.html"><img src="../../../imagens/botoes/missing_letter_button.png" alt="Missing Letter"></a>
        <a href="Mixed Letters/index.html"><img src="../../../imagens/botoes/mixed_letters_button.png" alt="Mixed Letters"></a>
        <a href="Colorir/index.html"><img src="../../../imagens/botoes/color_button.png" alt="Color Activity"></a>
    </div>

    <script>
        /**
         * Go back to the previous level
         */
        function goBackToLevel() {
            const currentUrl = window.location.href;
            const url = new URL(currentUrl);

            // Remove "teacher" do final da pathname
            let pathParts = url.pathname.split('/');
            
            // Remove string vazia no final se a URL terminar com /
            if (pathParts[pathParts.length - 1] === "") {
                pathParts.pop();
            }

            if (pathParts[pathParts.length - 1] === "teacher") {
                pathParts.pop(); // remove "teacher"
            }

            // Constrói a nova URL (sem "teacher")
            const newPath = pathParts.join('/') + '/index.html';
            const newUrl = `${url.origin}${newPath}`;

            window.location.href = newUrl;
        }

        /**
         * Convert plain text to basic HTML formatting:
         * - Lines starting with ### => <h3>
         * - Lines with '---' => <hr>
         * - **bold** => <strong>
         * - lines starting with '- ' => <li> inside a <ul>
         * - blank lines => <br>
         * - otherwise => <p> line
         */
        function parsePlainTextToHtml(text) {
            const lines = text.split('\n');
            let html = '';
            let inUl = false;

            for (let line of lines) {
                let trimmed = line.trim();

                // If line is '---'
                if (trimmed === '---') {
                    if (inUl) {
                        html += '</ul>';
                        inUl = false;
                    }
                    html += '<hr>';
                    continue;
                }

                // If line starts with ### => <h3>
                if (trimmed.startsWith('###')) {
                    if (inUl) {
                        html += '</ul>';
                        inUl = false;
                    }
                    let content = trimmed.replace(/^###\s*/, '');
                    content = applyBold(content);
                    html += `<h3>${content}</h3>`;
                    continue;
                }

                // If line starts with '- ' => list item
                if (trimmed.startsWith('- ')) {
                    if (!inUl) {
                        html += '<ul>';
                        inUl = true;
                    }
                    let content = trimmed.replace(/^- /, '');
                    content = applyBold(content);
                    html += `<li>${content}</li>`;
                    continue;
                }

                // If none of the above => treat as a paragraph
                if (inUl) {
                    html += '</ul>';
                    inUl = false;
                }

                if (trimmed.length === 0) {
                    // blank line => <br>
                    html += '<br>';
                } else {
                    let content = applyBold(line);
                    html += `<p>${content}</p>`;
                }
            }

            // close any open <ul>
            if (inUl) {
                html += '</ul>';
            }

            return html;
        }

        /**
         * Convert **text** into <strong>text</strong>
         */
        function applyBold(str) {
            return str.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        /**
         * Show text file content in the Teachers Guide container
         */
        function showTeachersGuideContent(fileName) {
            closeCreativeActivity();
            fetch(fileName)
            .then(response => response.text())
            .then(data => {
                const container = document.getElementById('teachersGuideContainer');
                const contentDiv = document.getElementById('teachersGuideContent');
                const formatted = parsePlainTextToHtml(data);
                contentDiv.innerHTML = formatted;
                container.style.display = 'block';
                // Smooth scroll to container
                container.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error loading text file:', error);
            });
        }

        /**
         * Close the Teachers Guide container
         */
        function closeTeachersGuide() {
            const container = document.getElementById('teachersGuideContainer');
            const contentDiv = document.getElementById('teachersGuideContent');
            contentDiv.innerHTML = '';
            container.style.display = 'none';
        }

        /**
         * Show text file content in the Creative Activity container
         */
        function showCreativeActivityContent(fileName) {
            closeTeachersGuide();
            fetch(fileName)
            .then(response => response.text())
            .then(data => {
                const container = document.getElementById('creativeActivityContainer');
                const contentDiv = document.getElementById('creativeActivityContent');
                const formatted = parsePlainTextToHtml(data);
                contentDiv.innerHTML = formatted;
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error loading text file:', error);
            });
        }

        /**
         * Close the Creative Activity container
         */
        function closeCreativeActivity() {
            const container = document.getElementById('creativeActivityContainer');
            const contentDiv = document.getElementById('creativeActivityContent');
            contentDiv.innerHTML = '';
            container.style.display = 'none';
        }

        /**
         * Show image thumbnails (documents) in the Creative Activity container
         */
        function showDocuments() {
            closeTeachersGuide();
            const container = document.getElementById('creativeActivityContainer');
            const contentDiv = document.getElementById('creativeActivityContent');

            // Example list of image files
            const imageFiles = [
                'imagem1.png',
                'imagem2.png',
                'imagem3.png',
                'imagem4.png',
                'imagem5.png',
                'imagem6.png',
                'imagem7.png'
            ];

            let html = `<h3>Documents</h3>`;
            html += `<p>Click on a thumbnail to enlarge:</p>`;
            html += `<div style="display: flex; flex-wrap: wrap;">`;

            imageFiles.forEach(file => {
                html += `
                    <div style="margin: 10px; text-align: center;">
                        <img 
                            src="${file}" 
                            alt="${file}" 
                            style="width: 100px; cursor: pointer;"
                            onclick="openImageModal('${file}')"
                        >
                    </div>
                `;
            });

            html += `</div>`;

            contentDiv.innerHTML = html;
            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Open modal to show an enlarged image
         * (ATUALIZADO: adiciona botão Print)
         */
        function openImageModal(imgSrc) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close-btn" onclick="closeModal()">Close</button>
                    <button class="modal-print-btn" onclick="printImage('${imgSrc}')">Print</button>
                    <img src="${imgSrc}" alt="Enlarged">
                </div>
            `;
            document.body.appendChild(overlay);
        }

        /**
         * Close the image modal
         */
        function closeModal() {
            const overlay = document.querySelector('.modal-overlay');
            if (overlay) {
                document.body.removeChild(overlay);
            }
        }

        /**
         * Utilitários de detecção para PWA/iOS
         */
        function isStandaloneDisplayMode() {
            return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        }
        function isIOS() {
            const ua = window.navigator.userAgent;
            const iOS = /iP(ad|hone|od)/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            return iOS;
        }

        /**
         * Fallback por <iframe> oculto (funciona bem em PWA Android/desktop)
         */
        function printViaIframe(absoluteSrc) {
            return new Promise((resolve, reject) => {
                try {
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'fixed';
                    iframe.style.right = '0';
                    iframe.style.bottom = '0';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = '0';
                    iframe.setAttribute('aria-hidden', 'true');

                    // Usamos srcdoc para centralizar a imagem na página de impressão
                    iframe.srcdoc = `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Print</title>
<style>
  @media print { html, body { margin: 0; } }
  html, body { height: 100%; }
  body {
    margin: 0; padding: 0;
    display: flex; align-items: center; justify-content: center;
    height: 100vh;
  }
  img { max-width: 100%; max-height: 100vh; display: block; }
</style>
</head>
<body>
  <img src="${absoluteSrc}" alt="Print">
  <script>
    (function() {
      const img = document.querySelector('img');
      function doPrint() {
        try { window.focus(); window.print(); }
        finally {
          // não fechamos a aba; o host removerá o iframe depois
        }
      }
      if (img && !img.complete) { img.onload = doPrint; img.onerror = doPrint; }
      else { doPrint(); }
    })();
  <\/script>
</body>
</html>`;

                    document.body.appendChild(iframe);

                    // Tenta detectar fim da impressão para remover o iframe
                    const cleanup = () => {
                        try { document.body.removeChild(iframe); } catch(e){}
                        resolve();
                    };
                    // onafterprint pode não existir, então removemos com timeout como garantia
                    let printed = false;
                    iframe.onload = () => {
                        // Se em 2s nada acontecer, ainda assim limpar
                        setTimeout(() => { if (!printed) cleanup(); }, 2000);
                    };
                    // Tenta escutar o evento no contexto do iframe
                    setTimeout(() => {
                        try {
                            const iw = iframe.contentWindow;
                            if (iw) {
                                iw.onafterprint = () => { printed = true; cleanup(); };
                            } else {
                                cleanup();
                            }
                        } catch { cleanup(); }
                    }, 100);
                } catch (err) {
                    reject(err);
                }
            });
        }

        /**
         * Print the enlarged image (com fallbacks para PWA/iOS)
         */
        function printImage(imgSrc) {
            const absoluteSrc = new URL(imgSrc, window.location.href).href;
            const inStandalone = isStandaloneDisplayMode();
            const isiOS = isIOS();

            // Caminho 1: Popup + window.print (ótimo em Android/desktop, inclusive PWA)
            // Evitamos em iOS standalone, que costuma bloquear/ignorar.
            if (!(isiOS && inStandalone)) {
                try {
                    const printWin = window.open('', '_blank');
                    if (printWin) {
                        printWin.document.open();
                        printWin.document.write(`<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Print Image</title>
<style>
  @media print { body, html { margin: 0; } }
  html, body { height: 100%; }
  body {
    margin: 0; padding: 0;
    display: flex; align-items: center; justify-content: center;
    height: 100vh;
  }
  img { max-width: 100%; max-height: 100vh; display: block; }
</style>
</head>
<body>
  <img src="${absoluteSrc}" alt="Print">
  <script>
    (function() {
      const img = document.querySelector('img');
      function doPrint() {
        try { window.focus(); window.print(); }
        finally {
          if ('onafterprint' in window) {
            window.onafterprint = function(){ window.close(); };
          } else {
            setTimeout(function(){ window.close(); }, 300);
          }
        }
      }
      if (img && !img.complete) { img.onload = doPrint; img.onerror = doPrint; }
      else { doPrint(); }
    })();
  <\/script>
</body>
</html>`);
                        printWin.document.close();
                        return; // sucesso no caminho 1
                    }
                } catch (e) {
                    // continua para fallback
                }
            }

            // Caminho 2: Fallback via IFRAME (bom para PWA Android/desktop; tenta no iOS também)
            printViaIframe(absoluteSrc).catch(() => {}).finally(() => {
                // Caminho 3: Mensagem de orientação para iOS standalone, se ainda necessário
                if (isiOS && inStandalone) {
                    alert(
`On iOS when using the app in standalone (PWA) mode, printing may not open automatically.
Options:
1) Tap the system "Share" icon and choose "Print".
2) Open this page in Safari and try again.
3) Or tap and hold the image, choose "Save Image", and print it from the Photos app.`
                    );
                }
            });
        }
    </script>
</body>
</html>
