<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Select an Activity</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId: "G-07VVJG9LRS",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    /* ====== Base ====== */
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width: 100%;
      min-height: 100svh;
      background-color: #ffffff; /* laterais brancas */
      font-family: "Times New Roman", Times, serif;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }

    /* ====== Barra superior ====== */
    .topbar { position: relative; width: 100%; height: 72px; }
    .back-button {
      position: absolute; top: 16px; left: 16px;
      text-decoration: none; background-color: #000; color: #fff;
      padding: 8px 12px; border-radius: 4px; z-index: 9999;
    }
    .back-button:hover { background-color: #333; }

    /* Avatar + nome */
    .login-container {
      position: absolute; top: 12px; right: 14px; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      background: none; border: none; box-shadow: none; padding: 0; cursor: pointer;
    }
    .user-icon { width: 55px; height: auto; display: block; border: none; border-radius: 0; object-fit: contain; pointer-events: none; }
    .user-name {
      margin: 0; line-height: 1.05; text-align: center; font-size: 13px; font-weight: 700; color: #1a5f34;
      white-space: nowrap; max-width: 150px; overflow: hidden; text-overflow: ellipsis;
      text-shadow: 0 1px 1px rgba(255,255,255,0.45), 0 1px 2px rgba(0,0,0,0.18);
    }
    .user-dropdown {
      display: none; flex-direction: column; position: absolute; top: 70px; right: 0;
      background-color: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 9999; overflow: hidden; min-width: 220px;
    }
    .dropdown-item { padding: 10px 16px; color: #333; text-decoration: none; font-size: 14px; }
    .dropdown-item:hover { background-color: #f0f0f0; }

    /* ====== Layout principal com MAPA ====== */
    .map-container {
      width: 100%;
      min-height: calc(100svh - 72px);
      display: flex;
      flex-direction: column;
      align-items: center;
      /* sem overflow interno: rola s√≥ a p√°gina inteira */
      -webkit-overflow-scrolling: touch;
      padding-bottom: 24px;
      background-color: #ffffff;
    }

    header {
      width: 100%;
      padding: 0;
      text-align: center;
      background: none;
      margin-top: 12px;
      margin-bottom: 8px;
    }

    .title-container { text-align: center; position: relative; z-index: 2; }
    .title-container h1 {
      font-size: 2.1em;
      color: #4CAF50;
      font-family: Arial, sans-serif;
      margin: 0;
      text-shadow: 1px 1px 2px #000000;
    }

    /* √Årea que cont√©m o fundo map.png e os n√≥s em zigue-zague */
    .map-inner {
      position: relative;
      width: 100%;
      max-width: 540px;          /* MAIS estreito para imitar celular em telas grandes */
      margin: 8px auto 0;
      background-image: url('../../imagens/map.png');
      background-repeat: no-repeat;
      background-position: top center;
      background-size: 100% 100%;
      aspect-ratio: 1080 / 2880;  /* mant√©m propor√ß√£o do mapa */
      /* sem height baseado em viewport: evita esticar em desktop e criar scroll duplo */
    }

    /* Container invis√≠vel que segura os bot√µes/click targets */
    .map-inner main {
      position: absolute;
      inset: 0;
    }

    .activity-buttons {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* os <a> internos recebem os eventos */
    }

    /* Bot√µes circulares sobre o mapa */
    .activity-button,
    .teacher-resources,
    .robot-lex,
    .hannah-video {
      position: absolute;
      transform: translate(-50%, -50%);
      width: 34%;              /* reduzido um pouco em rela√ß√£o aos 40% */
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      background-color: rgba(255,255,255,0.0);
      border: 3px solid transparent;
      box-shadow: none;
      padding: 0;
      display: block;
      text-decoration: none;
      pointer-events: auto;
      transition: transform 0.2s ease, box-shadow 0.2s ease,
                  border-color 0.2s ease, background-color 0.2s ease;
    }

    /* Imagens grandes dentro do bot√£o */
    .activity-button img,
    .teacher-resources img,
    .robot-lex img,
    .hannah-video img {
      position: absolute;
      inset: 6%;              /* mais margem pra n√£o exagerar */
      width: 88%;
      height: 88%;
      object-fit: contain;
      border-radius: 50%;
      pointer-events: none;
      display: block;
    }

    .activity-button:hover,
    .teacher-resources:hover,
    .robot-lex:hover,
    .hannah-video:hover {
      transform: translate(-50%, -50%) scale(1.05);
      box-shadow: 0 0 12px rgba(0,0,0,0.35);
      border-color: rgba(255, 255, 255, 0.7);
      background-color: rgba(255,255,255,0.12);
    }

    /* Posi√ß√µes ZIGUE-ZAGUE ‚Äì valores em % conforme especifica√ß√£o */
    .node-1 { top: 10.42%; left: 20%; }
    .node-2 { top: 20.83%; left: 50%; }
    .node-3 { top: 31.25%; left: 80%; }
    .node-4 { top: 41.67%; left: 50%; }
    .node-5 { top: 52.08%; left: 20%; }
    .node-6 { top: 62.50%; left: 50%; }
    .node-7 { top: 72.92%; left: 80%; }
    .node-8 { top: 83.33%; left: 50%; }
    .node-9 { top: 93.75%; left: 20%; }

    /* SVG opcional (mantido, mas atr√°s dos bot√µes se usado) */
    #linesSvg{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      display: block;
    }

    /* ====== DESABILITADO ====== */
    .disabled-btn {
      filter: grayscale(100%);
      opacity: 0.55;
      pointer-events: none;
      cursor: not-allowed;
      border-color: #999 !important;
      box-shadow: none !important;
      transform: translate(-50%, -50%) !important;
      background-color: rgba(0,0,0,0.15);
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <a href="javascript:history.back()" class="back-button">Back</a>
    <div id="loginContainer" class="login-container">
      <a href="Formulario/login.html" id="loginLink" class="login-link">Login</a>
      <div id="userDropdown" class="user-dropdown"></div>
    </div>
  </div>

  <div class="map-container">
    <header>
      <div class="title-container"><h1>Select an Activity</h1></div>
    </header>

    <div class="map-inner">
      <main>
        <div class="activity-buttons" id="activity-buttons">
          <!-- Teacher Resources (controlado por role) -->
          <a href="teacher/index.html" class="teacher-resources" style="display:none;">
            <img src="../../imagens/resources.png" alt="Teacher Resources">
          </a>
        </div>
      </main>

      <svg id="linesSvg" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
  </div>

  <script>
  /* ==========
     CONFIG AJUST√ÅVEL ‚Äì caminhos dos dashboards
  ========== */
  const DASHBOARD_PATH = {
    aluno: "../../painel_aluno.html",
    professor: "../../painel_professor.html",
    proprietario: "../../painel_professor.html" // proprietario usa o dashboard do professor
  };

  /* ==========
     Level/Unit da URL (+ normaliza√ß√£o para DB)
  ========== */
  const __pathParts = window.location.pathname.split("/");
  const __level = __pathParts[1] || "Level1";
  const __unit  = __pathParts[2] || "Unit1";
  const normLU = s => s.replace(/^level(\d+)$/i, 'Level$1').replace(/^unit(\d+)$/i, 'Unit$1');
  const __levelDB = normLU(__level);
  const __unitDB  = normLU(__unit);

  /* ==========
     Helpers: cria√ß√£o e (des)bloqueio
  ========== */
  function createGatedLink({ href, className, imgSrc, imgAlt, requiresPhase }) {
    const a = document.createElement("a");
    a.className = className + " disabled-btn";
    a.dataset.href = href;
    if (requiresPhase) a.dataset.requiresPhase = String(requiresPhase);
    const img = document.createElement("img");
    img.src = imgSrc; img.alt = imgAlt;
    a.appendChild(img);
    return a; // sem href
  }
  function markDisabled(anchorEl, requiredPhase) {
    if (!anchorEl) return;
    anchorEl.classList.add("disabled-btn");
    anchorEl.removeAttribute("href");
    anchorEl.setAttribute("aria-disabled", "true");
    anchorEl.title = requiredPhase ? `Liberado ap√≥s concluir a fase ${requiredPhase}.` : `Indispon√≠vel.`;
  }
  function markEnabled(anchorEl) {
    if (!anchorEl) return;
    const dh = anchorEl.dataset.href;
    if (dh) anchorEl.href = dh;
    anchorEl.classList.remove("disabled-btn");
    anchorEl.removeAttribute("aria-disabled");
    anchorEl.removeAttribute("title");
  }

  /* ==========
     Constru√ß√£o dos bot√µes (abre travado exceto os livres)
  ========== */
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("activity-buttons");

    // Teacher Resources j√° existe no HTML
    const teacherEl = container.querySelector(".teacher-resources");
    if (teacherEl) {
      teacherEl.classList.add("node-1"); // Bot√£o 1 ‚Üí Teacher Resources
    }

    // Hannah Video (sempre livre)
    const hannahVideo = document.createElement("a");
    hannahVideo.href = `/Atividades/HannahVideo/index.html?level=${__level}&unit=${__unit}`;
    hannahVideo.className = "activity-button hannah-video node-2"; // Bot√£o 2
    const hvImg = document.createElement("img");
    hvImg.src = "../../imagens/botoes/video_button.png";
    hvImg.alt = "Hannah Video";
    hannahVideo.appendChild(hvImg);
    if (teacherEl) teacherEl.insertAdjacentElement("afterend", hannahVideo);
    else container.prepend(hannahVideo);

    // Trechos
    const buttonData = [
      { trecho: "trecho1", img: "../../imagens/listening.png", alt: "Listening" },
      { trecho: "trecho2", img: "../../imagens/grammar.png",   alt: "Grammar" , requiresPhase:  8 },
      { trecho: "trecho3", img: "../../imagens/speaking.png",  alt: "Speaking", requiresPhase: 14 },
      { trecho: "trecho4", img: "../../imagens/writing.png",   alt: "Writing" , requiresPhase: 20 },
      { trecho: "trecho5", img: "../../imagens/Bible.png",     alt: "Bible"   , requiresPhase: 25 },
      { trecho: "trecho6", img: "../../imagens/test.png",      alt: "Test"    , requiresPhase: 29 }
    ];

    let nodeIndexForTrechos = 3; // Bot√£o 3 at√© 8

    buttonData.forEach(data => {
      const href = `/${__level}/${__unit}/fases.html?trecho=${data.trecho}`;
      const nodeClass = `node-${nodeIndexForTrechos++}`;

      if (!data.requiresPhase) {
        const a = document.createElement("a");
        a.href = href;
        a.className = "activity-button " + nodeClass;
        a.dataset.trecho = data.trecho;
        const img = document.createElement("img");
        img.src = data.img; img.alt = data.alt;
        a.appendChild(img);
        container.appendChild(a);
        return;
      }
      const gated = createGatedLink({
        href,
        className: "activity-button " + nodeClass,
        imgSrc: data.img,
        imgAlt: data.alt,
        requiresPhase: data.requiresPhase
      });
      gated.dataset.trecho = data.trecho;
      container.appendChild(gated);
    });

    // Rob√¥ Lex (requer 27) ‚Äì Bot√£o 9
    const robotButton = createGatedLink({
      href: `../../Atividades/LEX/index.html?level=${__level}&unit=${__unit}`,
      className: "activity-button robot-lex node-9",
      imgSrc: "../../imagens/botoes/lex_button.png",
      imgAlt: "Robot Lex",
      requiresPhase: 27
    });
    robotButton.dataset.kind = "robotLex";
    container.appendChild(robotButton);
  });

  /* ==========
     Leitura do progresso (suporta chaves "fase8", etc.)
  ========== */
  async function getUnlockedInfo(userId, levelDB, unitDB) {
    const db = firebase.database();
    const candidatePaths = [
      `/progresso/${userId}/${levelDB}/${unitDB}`,
      `/progress/${userId}/${levelDB}/${unitDB}`,
      `/usuarios/${userId}/progresso/${levelDB}/${unitDB}`,
      `/usuarios/${userId}/progress/${levelDB}/${unitDB}`,
    ];

    let lastUnlocked = null;
    const unlockedSet = new Set();

    const keyToNumber = (k) => {
      const m = String(k).match(/(\d+)/);
      return m ? Number(m[1]) : NaN;
    };
    const truthy = (v) => (v === true || v === 1 || v === "true" || v === "True");

    const absorbPhaseObject = (obj) => {
      if (!obj || typeof obj !== 'object') return;
      Object.keys(obj).forEach(k => {
        const n = keyToNumber(k);
        const v = obj[k];
        if (!Number.isNaN(n) && truthy(v)) unlockedSet.add(n);
      });
    };

    for (const base of candidatePaths) {
      try {
        const snap = await db.ref(base).once("value");
        const val = snap.val();
        if (!val) continue;

        if (typeof val.ultimaFaseLiberada === "number") {
          lastUnlocked = Math.max(lastUnlocked ?? -Infinity, val.ultimaFaseLiberada);
        }
        if (typeof val.lastUnlocked === "number") {
          lastUnlocked = Math.max(lastUnlocked ?? -Infinity, val.lastUnlocked);
        }

        // fases como "fase8: true"
        absorbPhaseObject(val);

        // sub-objetos comuns
        absorbPhaseObject(val.fasesLiberadas);
        absorbPhaseObject(val.liberadas);
        absorbPhaseObject(val.released);
        absorbPhaseObject(val.fases);
        absorbPhaseObject(val.unlocked);

      } catch (e) {
        console.warn("Falha ao ler", base, e?.message);
      }
    }

    return { lastUnlocked, unlockedSet };
  }

  function isPhaseSatisfied(requiredPhase, lastUnlocked, unlockedSet) {
    if (!requiredPhase) return true;
    const req = Number(requiredPhase);
    if (Number.isNaN(req)) return true;
    if (lastUnlocked != null && typeof lastUnlocked === "number" && lastUnlocked >= req) return true;
    if (unlockedSet.has(req)) return true;
    return false;
  }

  async function applyStudentGates(userId, levelDB, unitDB) {
    const { lastUnlocked, unlockedSet } = await getUnlockedInfo(userId, levelDB, unitDB);
    const container = document.getElementById("activity-buttons");
    if (!container) return;

    const allAnchors = Array.from(container.querySelectorAll("a.activity-button, a.robot-lex, a.hannah-video"));
    for (const a of allAnchors) {
      const trecho = a.dataset.trecho;
      const req    = a.dataset.requiresPhase;
      const kind   = a.dataset.kind;

      if ((trecho === "trecho2" || trecho === "trecho3" || trecho === "trecho4" || trecho === "trecho5" || trecho === "trecho6") || kind === "robotLex") {
        if (req && !isPhaseSatisfied(req, lastUnlocked, unlockedSet)) {
          markDisabled(a, req);
        } else {
          markEnabled(a);
        }
      } else {
        // trecho1 e Hannah Video sempre liberados
        markEnabled(a);
      }
    }
  }

  /* ==========
     Util: render do dropdown por role
  ========== */
  function renderDropdown(role) {
    const userDropdown = document.getElementById("userDropdown");
    if (!userDropdown) return;

    // Decide r√≥tulo + link do dashboard
    const isTeacher = (role === "professor" || role === "proprietario");
    const dashLabel = isTeacher ? "üìä Dashboard do Professor" : "üìä Dashboard do Aluno";
    const dashHref  = isTeacher ? (DASHBOARD_PATH.professor) : (DASHBOARD_PATH.aluno);

    userDropdown.innerHTML = `
      <a href="${dashHref}" class="dropdown-item">${dashLabel}</a>
      <a href="../../index.html" class="dropdown-item">üîÅ Select a New Level</a>
      <a href="../index.html" class="dropdown-item">üîÑ Select a New Unit</a>
    `;
  }

  /* ==========
     Login + roles + gates + dropdown din√¢mico
  ========== */
  firebase.auth().onAuthStateChanged(async (user) => {
    const loginLink = document.getElementById("loginLink");
    const userDropdown = document.getElementById("userDropdown");

    if (user) {
      const userRef = firebase.database().ref("usuarios/" + user.uid);
      const snap = await userRef.once("value");
      const dados = snap.val() || {};
      const nome = (dados.nome || user.email || "User").trim();
      const displayName = nome.length > 10 ? nome.slice(0, 10) + "‚Ä¶" : nome;
      const avatar = dados.avatar ? `../../imagens/${dados.avatar}` : "../../imagens/bonecologin1.png";

      // Avatar + nome
      loginLink.innerHTML = "";
      loginLink.removeAttribute("href");
      const img = document.createElement("img");
      img.src = avatar; img.alt = "User Avatar"; img.className = "user-icon";
      img.onerror = () => { img.src = "../../imagens/bonecologin1.png"; };
      const p = document.createElement("p"); p.className = "user-name"; p.textContent = displayName;
      loginLink.append(img, p);

      // Role
      const role = dados.role || null;

      // Renderiza dropdown conforme role
      renderDropdown(role);

      // Toggle dropdown
      loginLink.onclick = (e) => {
        e.preventDefault();
        userDropdown.style.display = (userDropdown.style.display === "flex" ? "none" : "flex");
      };
      window.addEventListener("click", (e) => {
        if (!loginLink.contains(e.target)) userDropdown.style.display = "none";
      });

      // Teacher Resources + gates
      if (role === "professor" || role === "proprietario") {
        const tr = document.querySelector(".teacher-resources");
        if (tr) tr.style.display = "flex";
        document.querySelectorAll(".activity-button, .robot-lex, .hannah-video").forEach(a => markEnabled(a));
      } else if (role === "aluno") {
        try { await applyStudentGates(user.uid, __levelDB, __unitDB); }
        catch (e) { console.warn("Falha ao aplicar travas de aluno:", e?.message); }
      } else {
        // Role desconhecido: libera apenas o que √© sempre livre
        document.querySelectorAll(".hannah-video, [data-trecho='trecho1']").forEach(a => markEnabled(a));
      }

    } else {
      // Usu√°rio n√£o logado
      const userDropdown = document.getElementById("userDropdown");
      if (userDropdown) {
        userDropdown.innerHTML = `
          <a href="../../index.html" class="dropdown-item">üîÅ Select a New Level</a>
          <a href="../index.html" class="dropdown-item">üîÑ Select a New Unit</a>
        `;
      }
      const loginLink = document.getElementById("loginLink");
      loginLink.textContent = "Login";
      loginLink.href = "Formulario/login.html";
    }
  });

  // Compat extra: exibe Teacher Resources se professor/propriet√°rio
  firebase.auth().onAuthStateChanged((user) => {
    if (user) {
      const userRoleRef = firebase.database().ref(`/usuarios/${user.uid}/role`);
      userRoleRef.once("value").then((snapshot) => {
        const role = snapshot.val();
        if (role === "professor" || role === "proprietario") {
          const tr = document.querySelector(".teacher-resources");
          if (tr) tr.style.display = "flex";
        }
      }).catch((error) => console.error("Erro ao obter role:", error));
    }
  });
  </script>
</body>
</html>
