<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hannah Coloring</title>
  <style>
    body {
      background-image: url("../../../../imagens/fundo.png");
      background-repeat: repeat;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-top: 20px;
    }
    .thumbnail {
      width: 100px;
      height: auto;
      margin: 10px;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .thumbnail:hover { transform: scale(1.1); }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    #selectedImageContainer {
      display: none; /* começa oculto */
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }
    #selectedImage {
      max-width: 80%;
      height: auto;
      margin: 20px 0;
    }
    #generatePdfBtn {
      display: none;
      background-color: green;
      color: white;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    #generatePdfBtn:hover { opacity: 0.9; }
    #backBtn {
      position: fixed;
      top: 10px;
      left: 10px;
      background-color: black;
      color: white;
      padding: 10px;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
  </style>
</head>
<body>

<button id="backBtn" onclick="goBack()">Back</button>
<h1>Hannah Coloring</h1>
<p>Choose a drawing to color</p>

<div class="gallery" id="gallery">
  <!-- Thumbnails (somem se a imagem não existir) -->
  <img src="imagens/imagem1.png"  alt="Drawing 1"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem1.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem2.png"  alt="Drawing 2"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem2.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem3.png"  alt="Drawing 3"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem3.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem4.png"  alt="Drawing 4"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem4.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem5.png"  alt="Drawing 5"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem5.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem6.png"  alt="Drawing 6"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem6.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem7.png"  alt="Drawing 7"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem7.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem8.png"  alt="Drawing 8"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem8.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem9.png"  alt="Drawing 9"  class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem9.png')"  onerror="hideIfBroken(this)">
  <img src="imagens/imagem10.png" alt="Drawing 10" class="thumbnail" loading="lazy"
       onclick="selectImage('imagens/imagem10.png')" onerror="hideIfBroken(this)">
</div>

<div id="selectedImageContainer">
  <img id="selectedImage" src="" alt="Selected Drawing" onerror="handleSelectedError()">
  <button id="generatePdfBtn" onclick="generatePDF()">Generate PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script>
  function goBack() {
    window.history.back();
  }

  // Esconde thumbnails quebrados
  function hideIfBroken(imgEl) {
    imgEl.style.display = 'none';
    imgEl.onclick = null;
  }

  // Se a imagem grande falhar, some com o container e botão
  function handleSelectedError() {
    const selectedImageContainer = document.getElementById("selectedImageContainer");
    const generateBtn = document.getElementById("generatePdfBtn");
    selectedImageContainer.style.display = "none";
    generateBtn.style.display = "none";
  }

  function selectImage(src) {
    const selectedImage = document.getElementById("selectedImage");
    const selectedImageContainer = document.getElementById("selectedImageContainer");
    const generateBtn = document.getElementById("generatePdfBtn");

    // Limpa estado anterior
    selectedImage.removeAttribute('src'); // previne mostrar estado antigo
    generateBtn.style.display = "none";

    // Define handlers para este carregamento
    selectedImage.onload = function () {
      selectedImageContainer.style.display = "flex";
      generateBtn.style.display = "inline-block";
      selectedImageContainer.scrollIntoView({ behavior: "smooth", block: "end" });
    };
    selectedImage.onerror = handleSelectedError;

    // Dispara o carregamento
    selectedImage.src = src;
  }

  function generatePDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    const selectedImage = document.getElementById("selectedImage");
    if (!selectedImage || !selectedImage.src) {
      alert("No image selected for the PDF.");
      return;
    }

    // Tenta carregar o logo; se falhar, segue sem ele
    const logo = new Image();
    let logoLoaded = false;
    logo.src = "../../../../imagens/hannah_logo.png";

    logo.onload = function () {
      logoLoaded = true;
      buildPdfWithAssets();
    };
    logo.onerror = function () {
      logoLoaded = false;
      buildPdfWithAssets();
    };

    function buildPdfWithAssets() {
      if (logoLoaded) {
        pdf.addImage(logo, "PNG", 10, 10, 20, 20);
      }
      pdf.setFontSize(12);
      pdf.text("Name:_________________________________________Date:_______", 40, 20);

      pdf.setFontSize(18);
      pdf.text("Hannah Coloring", 105, 40, { align: "center" });

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = selectedImage.src;

      img.onload = function () {
        const pageWidth = pdf.internal.pageSize.getWidth();
        const marginX = 10;
        const maxW = pageWidth - marginX * 2;
        const scaledH = maxW * (img.height / img.width);
        pdf.addImage(img, "PNG", marginX, 60, maxW, scaledH);
        pdf.save("Coloring_Page.pdf");
      };
      img.onerror = function () {
        alert("Failed to load the selected image for the PDF.");
      };
    }
  }
</script>

</body>
</html>
