<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Reading Practice</title>
    <style>
        /* Seu CSS original permanece inalterado */
    </style>
</head>
<body>
    <button id="backButton" class="button">Back</button>
    <h1>Word Reading Practice</h1>
    <div class="container">
        <img id="image" class="image" src="" alt="Image">
        <img id="icon" class="icon" src="businessman.png" alt="Icon">
    </div>
    <div class="word" id="word"></div>
    <button id="startButton">
        <img src="microfone.png" alt="Start Speaking">
    </button>
    <div class="result" id="result"></div>
    <div class="navigation">
        <button id="prevButton" class="button nav-button">Previous</button>
        <button id="nextButton" class="button nav-button">Next</button>
    </div>
    <div id="finalFeedback"></div>
    <button id="restartButton" class="button" style="display: none;">Restart</button>

    <!-- Modal de conclusão -->
    <div id="overlay"></div>
    <div id="completion-modal">
        <h2>Phase Completed!</h2>
        <p>Congratulations! You have completed this phase.</p>
        <button onclick="closeModal()">Close</button>
    </div>

    <!-- Firebase App (SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
            authDomain: "hannahenglishcourse.firebaseapp.com",
            projectId: "hannahenglishcourse",
            storageBucket: "hannahenglishcourse.appspot.com",
            messagingSenderId: "449818788486",
            appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
            measurementId: "G-07VVJG9LRS",
            databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);

        let words = [];
        let currentWordIndex = 0;
        let wordsTried = 0;
        let recognitionTimeout;
        let tryAgainInProgress = false;

        fetch(wordListUrl)
            .then(response => response.text())
            .then(data => {
                words = data.split('\n').map(word => word.trim()).filter(word => word);
                loadWord(currentWordIndex);
            })
            .catch(error => console.error('Error fetching words:', error));

        function checkCompletion() {
            if (wordsTried === words.length) {
                markActivityAsCompleted();
                ensureUserIsAuthenticated(updateNextPhase); // Atualiza o banco de dados
            }
        }

        function ensureUserIsAuthenticated(callback) {
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    callback(user.uid);
                } else {
                    console.error("Usuário não autenticado");
                }
            });
        }

        function updateNextPhase(userId) {
            const currentPhase = getPhaseFromURL();
            const { level, unit } = getLevelAndUnitFromURL();
            const dbRef = firebase.database().ref(`usuarios/${userId}/progresso/${level}/${unit}`);
            
            try {
                if (currentPhase === "last") {
                    const nextUnit = `Unit${parseInt(unit.replace('Unit', '')) + 1}`;
                    dbRef.child(nextUnit).set({ fase1: true });
                } else if (currentPhase === "end") {
                    const nextLevel = `Level${parseInt(level.replace('Level', '')) + 1}`;
                    firebase.database().ref(`usuarios/${userId}/progresso/${nextLevel}/Unit1`).set({ fase1: true });
                } else {
                    const nextPhase = parseInt(currentPhase) + 1;
                    dbRef.update({ [`fase${currentPhase}`]: true, [`fase${nextPhase}`]: true });
                }
            } catch (error) {
                console.error("Erro ao atualizar o progresso da fase:", error);
            }
        }

        function getPhaseFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('fase');
        }

        function getLevelAndUnitFromURL() {
            const url = window.location.pathname;
            const parts = url.split('/');
            const level = parts[1];
            const unit = parts[2];
            return { level, unit };
        }
        
        // As outras funções e lógica do jogo permanecem inalteradas
    </script>
</body>
</html>
