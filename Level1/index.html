<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
        authDomain: "hannahenglishcourse.firebaseapp.com",
        projectId: "hannahenglishcourse",
        storageBucket: "hannahenglishcourse.appspot.com",
        messagingSenderId: "449818788486",
        appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
        measurementId: "G-07VVJG9LRS",
        databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const auth = firebase.auth();

    // Bloquear todas as unidades inicialmente
    function bloquearTodasUnidades() {
        const units = document.querySelectorAll('.unit-button');
        units.forEach(unit => {
            unit.classList.add('disabled');
        });
    }

    // Carregar o progresso do aluno quando ele está autenticado
    auth.onAuthStateChanged(user => {
        if (user) {
            console.log("Usuário autenticado:", user.uid);
            bloquearTodasUnidades(); // Bloqueia todas as unidades antes de liberar conforme o papel
            verificarRole(user.uid); 
        } else {
            console.error("Erro: Usuário não autenticado");
        }
    });

    function verificarRole(userId) {
        db.ref(`usuarios/${userId}/role`).once('value')
            .then(snapshot => {
                const role = snapshot.val();
                console.log("Papel do usuário:", role);

                if (role === 'proprietario' || role === 'professor') {
                    desbloquearTodasUnidades(); // Desbloqueia todas as unidades
                } else {
                    carregarProgresso(userId); // Desbloqueia conforme o progresso do aluno
                }
            })
            .catch(error => {
                console.error("Erro ao acessar o banco de dados para verificar o papel:", error);
            });
    }

    function carregarProgresso(userId) {
        db.ref(`usuarios/${userId}/progresso/Level1`).once('value')
            .then(snapshot => {
                const progresso = snapshot.val();
                console.log("Progresso do usuário:", progresso);

                const units = document.querySelectorAll('.unit-button');
                
                units.forEach(unit => {
                    const unitId = unit.id.replace('unit', 'Unit');
                    
                    if (progresso && progresso[unitId] && progresso[unitId].fase1 === true) {
                        unit.classList.remove('disabled'); // Desbloqueia conforme o progresso
                    }
                });
            })
            .catch(error => {
                console.error("Erro ao acessar o banco de dados:", error);
            });
    }

    function desbloquearTodasUnidades() {
        const units = document.querySelectorAll('.unit-button');
        units.forEach(unit => {
            unit.classList.remove('disabled');
        });
    }
</script>
