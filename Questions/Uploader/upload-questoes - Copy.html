<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hannah Questions ‚Äì Admin Uploader</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --brand:#2563eb; --brand-soft:#dbeafe; --danger:#ef4444; --ok:#16a34a;
    --radius:16px; --shadow:0 10px 25px rgba(15,23,42,.12);
  }
  *{box-sizing:border-box;}
  html,body{margin:0;padding:0;}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
    background:linear-gradient(135deg,#eff6ff,#fef9c3);
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:16px;
    color:var(--text);
  }
  .app{
    width:100%;
    max-width:960px;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px 18px 22px;
  }
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:16px;
  }
  .title{
    font-size:20px;
    font-weight:800;
  }
  .subtitle{
    font-size:13px;
    color:var(--muted);
    margin-top:2px;
  }
  .badge{
    background:var(--brand-soft);
    color:var(--brand);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }

  form{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:14px 16px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .field.full{
    grid-column:1/-1;
  }
  label{
    font-size:13px;
    font-weight:600;
    color:var(--muted);
  }
  input,select,textarea{
    border-radius:10px;
    border:1px solid #e5e7eb;
    padding:8px 10px;
    font-size:14px;
    font-family:inherit;
    resize:vertical;
  }
  textarea{
    min-height:180px;
    line-height:1.4;
  }
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 1px rgba(37,99,235,.3);
  }
  .hint{
    font-size:11px;
    color:var(--muted);
  }

  .buttons{
    grid-column:1/-1;
    display:flex;
    flex-wrap:wrap;
    justify-content:flex-end;
    gap:8px;
    margin-top:4px;
  }
  button{
    border:none;
    border-radius:999px;
    padding:8px 14px;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .btn-secondary{
    background:#e5e7eb;
    color:#111827;
  }
  .btn-primary{
    background:linear-gradient(90deg,#3b82f6,#22c55e);
    color:#fff;
    box-shadow:0 8px 16px rgba(34,197,94,.25);
  }
  .btn-primary[disabled]{
    opacity:.5;
    cursor:default;
    box-shadow:none;
  }

  .status{
    margin-top:12px;
    font-size:13px;
    color:var(--muted);
  }
  .status b{color:#111827;}

  .pill-ok{
    display:inline-block;
    margin-top:4px;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    background:#dcfce7;
    color:#166534;
  }
  .pill-err{
    display:inline-block;
    margin-top:4px;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    background:#fee2e2;
    color:#b91c1c;
  }

  .toast{
    position:fixed;
    left:50%;
    bottom:20px;
    transform:translateX(-50%);
    background:#111827;
    color:#f9fafb;
    padding:10px 14px;
    border-radius:12px;
    font-size:13px;
    box-shadow:var(--shadow);
    z-index:9999;
  }

  .loading-overlay{
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9998;
    backdrop-filter:blur(2px);
  }
  .spinner{
    width:38px;height:38px;
    border-radius:50%;
    border:4px solid #bfdbfe;
    border-top-color:#2563eb;
    animation:spin 1s linear infinite;
    margin-right:10px;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-box{
    display:flex;
    align-items:center;
    background:#111827;
    color:#e5e7eb;
    padding:10px 16px;
    border-radius:999px;
    box-shadow:var(--shadow);
    font-size:13px;
  }

  /* ==== se√ß√£o de busca/listagem ==== */
  .section-box{
    margin-top:22px;
    padding-top:16px;
    border-top:1px solid #e5e7eb;
  }
  .section-title{
    font-size:15px;
    font-weight:700;
    margin-bottom:4px;
  }
  .section-sub{
    font-size:12px;
    color:var(--muted);
    margin-bottom:10px;
  }
  .search-row{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:10px 12px;
    margin-bottom:8px;
  }
  .results-list{
    margin-top:8px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .q-row{
    border-radius:12px;
    border:1px solid #e5e7eb;
    background:#f9fafb;
    padding:8px 10px;
    display:flex;
    flex-direction:column;
    gap:3px;
  }
  .q-row-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }
  .q-row-id{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New", monospace;
    font-size:12px;
  }
  .q-row-meta{
    font-size:11px;
    color:var(--muted);
  }
  .q-row-prompt{
    font-size:12px;
    margin-top:4px;
    color:#111827;
    max-height:3.4em;
    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
  }
  .row-buttons{
    margin-top:4px;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }
  .btn-xs{
    padding:4px 8px;
    font-size:11px;
    border-radius:999px;
  }
  .btn-danger{
    background:#fee2e2;
    color:#b91c1c;
  }

  @media(max-width:720px){
    .app{padding:14px 10px 18px;}
    form{grid-template-columns:1fr;}
    .search-row{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">Hannah Questions ‚Äì Admin</div>
      <div class="subtitle">
        Crie/atualize quest√µes e vincule √† atividade (Level / Unit / Fase).
      </div>
    </div>
    <div class="badge">Owner Dashboard</div>
  </div>

  <!-- ===== FORMUL√ÅRIO DE CADASTRO/EDI√á√ÉO ===== -->
  <form id="q-form">
    <div class="field">
      <label for="level">Level</label>
      <input id="level" type="text" placeholder="Ex.: Level0" required />
      <div class="hint">Se digitar s√≥ ‚Äú0‚Äù, o sistema transforma em ‚ÄúLevel0‚Äù.</div>
    </div>

    <div class="field">
      <label for="unit">Unit</label>
      <input id="unit" type="text" placeholder="Ex.: Unit1" required />
      <div class="hint">Se digitar s√≥ ‚Äú1‚Äù, o sistema transforma em ‚ÄúUnit1‚Äù.</div>
    </div>

    <div class="field">
      <label for="fase">Fase</label>
      <input id="fase" type="number" min="1" step="1" placeholder="Ex.: 7" required />
      <div class="hint">N√∫mero da fase (ex.: 7).</div>
    </div>

    <div class="field">
      <label for="questionId">Question ID (opcional)</label>
      <input id="questionId" type="text" placeholder="Ex.: L0_U1_F7_Q01" />
      <div class="hint">Se vazio, ser√° gerado automaticamente (Q_timestamp).</div>
    </div>

    <div class="field">
      <label for="order">Ordem na atividade</label>
      <input id="order" type="number" min="1" step="1" placeholder="Ex.: 1" />
      <div class="hint">1 = primeira quest√£o; se vazio, ser√° adicionada ao final.</div>
    </div>

    <div class="field">
      <label for="typeQuick">Tipo (r√≥tulo r√°pido)</label>
      <select id="typeQuick">
        <option value="">‚Äî n√£o for√ßar ‚Äî</option>
        <option value="mcq">MCQ (m√∫ltipla escolha)</option>
        <option value="yesno">Yes/No</option>
        <option value="truefalse">True / False</option>
        <option value="image_mcq">Image Choice (MCQ com imagens)</option>
        <option value="audio_mcq">Listen &amp; Choose</option>
        <option value="fillblank">Fill in the blank</option>
        <option value="order">Order sentence</option>
        <option value="match">Match pairs</option>
      </select>
      <div class="hint">S√≥ preenche o campo type dentro do JSON se voc√™ quiser.</div>
    </div>

    <div class="field full">
      <label for="json">Objeto da quest√£o (JSON)</label>
      <textarea id="json" spellcheck="false"></textarea>
      <div class="hint">
        Cole/edite aqui um objeto JSON com os campos da quest√£o.<br>
        Exemplo b√°sico para MCQ:
        <code>
{"type":"mcq","prompt":"What is this?","image":"images/apple.png","options":[{"label":"Apple","value":"apple"},{"label":"Banana","value":"banana"}],"answer":"apple","grammarTag":"vocabulary-fruits","skillType":"vocabulary","difficulty":"easy"}
        </code>
      </div>
    </div>

    <div class="buttons">
      <!-- 8 templates + Preview + Salvar -->
      <button type="button" class="btn-secondary" id="btnTemplateMcq">MCQ template</button>
      <button type="button" class="btn-secondary" id="btnTemplateYesNo">Yes/No template</button>
      <button type="button" class="btn-secondary" id="btnTemplateTrueFalse">True/False template</button>
      <button type="button" class="btn-secondary" id="btnTemplateImageMcq">Image Choice template</button>
      <button type="button" class="btn-secondary" id="btnTemplateAudioMcq">Listen &amp; Choose template</button>
      <button type="button" class="btn-secondary" id="btnTemplateFill">Fillblank template</button>
      <button type="button" class="btn-secondary" id="btnTemplateOrder">Order sentence template</button>
      <button type="button" class="btn-secondary" id="btnTemplateMatch">Match pairs template</button>

      <button type="button" class="btn-secondary" id="btnPreview">üëÄ Preview</button>

      <button type="submit" class="btn-primary" id="btnSave">
        üíæ Salvar quest√£o
      </button>
    </div>
  </form>

  <!-- ===== SE√á√ÉO DE BUSCA / LISTAGEM ===== -->
  <div class="section-box">
    <div class="section-title">Pesquisar / editar quest√µes existentes</div>
    <div class="section-sub">
      Informe Level, Unit e Fase para ver todas as quest√µes daquela atividade.  
      Voc√™ pode carregar qualquer quest√£o para o formul√°rio acima ou apag√°-la.
    </div>

    <div class="search-row">
      <div class="field">
        <label for="search-level">Level</label>
        <input id="search-level" type="text" placeholder="Ex.: Level0" />
      </div>
      <div class="field">
        <label for="search-unit">Unit</label>
        <input id="search-unit" type="text" placeholder="Ex.: Unit1" />
      </div>
      <div class="field">
        <label for="search-fase">Fase</label>
        <input id="search-fase" type="number" min="1" step="1" placeholder="Ex.: 7" />
      </div>
    </div>

    <button type="button" class="btn-secondary" id="btnSearchQuestions">
      üîç Carregar quest√µes da fase
    </button>

    <div id="searchResults" class="results-list"></div>
  </div>

  <div class="status" id="status">
    <b>Status:</b> aguardando dados‚Ä¶
  </div>
</div>

<div class="loading-overlay" id="loading">
  <div class="loading-box">
    <div class="spinner"></div>
    <span>Processando no Firebase‚Ä¶</span>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // ==== Firebase init (mesma config do app) ====
  const firebaseConfig = {
    apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
    authDomain: "hannahenglishcourse.firebaseapp.com",
    databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hannahenglishcourse",
    storageBucket: "hannahenglishcourse.appspot.com",
    messagingSenderId: "449818788486",
    appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  let currentUserId = null;
  firebase.auth().onAuthStateChanged(user => {
    currentUserId = user ? user.uid : null;
    const st = document.getElementById('status');
    if (!user) {
      st.innerHTML = "<b>Status:</b> usu√°rio n√£o autenticado. Fa√ßa login em outra aba.";
    } else {
      st.innerHTML = "<b>Status:</b> autenticado como: " + (user.email || user.uid);
    }
  });

  // ==== helpers ====
  function normalizeDir(prefix, value, fallbackNum){
    if (!value) return prefix + fallbackNum;
    const lower = String(value).toLowerCase().trim();
    if (lower.startsWith(prefix.toLowerCase())) return value.trim();
    const onlyNum = (lower.match(/\d+/)||[''])[0];
    return prefix + (onlyNum || fallbackNum);
  }

  function showToast(msg){
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2600);
  }

  function setStatus(html){
    const st = document.getElementById('status');
    st.innerHTML = html;
  }

  function showLoading(flag){
    const el = document.getElementById('loading');
    if (!el) return;
    el.style.display = flag ? 'flex' : 'none';
    document.getElementById('btnSave').disabled = !!flag;
    const btnSearch = document.getElementById('btnSearchQuestions');
    if (btnSearch) btnSearch.disabled = !!flag;
  }

    // ==== Templates r√°pidos para JSON ====
  const txtJson = document.getElementById('json');

  // 1) MCQ
  document.getElementById('btnTemplateMcq').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "mcq",
      prompt: "What is this?",
      image: "images/example.png",
      options: [
        { label: "Apple",  value: "apple" },
        { label: "Banana", value: "banana" },
        { label: "Orange", value: "orange" },
        { label: "Grape",  value: "grape" }
      ],
      answer: "apple",
      grammarTag: "vocabulary-fruits",
      skillType: "vocabulary",
      difficulty: "easy"
    }, null, 2);
  };

  // 2) Yes/No
  document.getElementById('btnTemplateYesNo').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "yesno",
      prompt: "Is this Mary?",
      image: "images/mary.png",
      options: [
        { label: "Yes", value: "yes" },
        { label: "No",  value: "no"  }
      ],
      answer: "yes",
      grammarTag: "yesno-questions",
      skillType: "listening",
      difficulty: "easy"
    }, null, 2);
  };

  // 3) True/False
  document.getElementById('btnTemplateTrueFalse').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "truefalse",
      prompt: "Mary visits Elizabeth.",
      image: "images/mary_elizabeth.png",
      options: [
        { label: "True",  value: "true" },
        { label: "False", value: "false" }
      ],
      answer: "true",
      grammarTag: "statements",
      skillType: "reading",
      difficulty: "easy"
    }, null, 2);
  };

  // 4) Image Choice (MCQ com imagens)
  document.getElementById('btnTemplateImageMcq').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "image_mcq",
      prompt: "Click on Mary.",
      options: [
        { label: "Mary",      value: "mary",      image: "images/mary.png" },
        { label: "Elizabeth", value: "elizabeth", image: "images/elizabeth.png" }
      ],
      answer: "mary",
      grammarTag: "names",
      skillType: "vocabulary",
      difficulty: "easy"
    }, null, 2);
  };

  // 5) Listen & Choose
  document.getElementById('btnTemplateAudioMcq').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "audio_mcq",
      prompt: "Listen and choose the correct sentence.",
      promptAudio: "audio/mary_visits_elizabeth.mp3",
      options: [
        { label: "Mary visits Elizabeth.",   value: "a" },
        { label: "Elizabeth visits Mary.",   value: "b" }
      ],
      answer: "a",
      grammarTag: "present-simple",
      skillType: "listening",
      difficulty: "medium"
    }, null, 2);
  };

  // 6) Fill in the blank
  document.getElementById('btnTemplateFill').onclick = () => {
    txtJson.value = JSON.stringify({
      "type": "fillblank",
    "prompt": "Elizabeth said, \"God ___ you!\"",
    "image": "/Level0/Unit1/DataStory/images/imagem5.png",
    "options": [
      { "label": "bless", "value": "bless", "audio": "/Level0/Unit1/data2/sounds/som6.mp3" },
      { "label": "welcome", "value": "welcome", "audio": "/Level0/Unit1/data2/sounds/som3.mp3" }
    ],
    "answer": "bless",
    "promptAudio": "/Level0/Unit1/QA/prompt10.mp3",
    "grammarTag": "vocabulary-greetings",
    "skillType": "listening",
    "difficulty": "easy"
    }, null, 2);
  };

  // 7) Order sentence
  document.getElementById('btnTemplateOrder').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "order",
      prompt: "Put the words in order.",
      image: "images/order_sentence.png",
      // O preview usa "options" para montar os bot√µes de palavras
      options: ["Mary", "visits", "Elizabeth"],
      // (opcional) manter tamb√©m "chunks" se quiser para organiza√ß√£o futura
      chunks: ["Mary", "visits", "Elizabeth"],
      answer: ["Mary", "visits", "Elizabeth"],
      grammarTag: "word-order",
      skillType: "grammar",
      difficulty: "medium"
    }, null, 2);
  };

  // 8) Match pairs
  document.getElementById('btnTemplateMatch').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "match",
      prompt: "Match the character with the description.",
      // left.value e right.value precisam ser IGUAIS em cada par
      pairs: [
        {
          left:  { label: "Mary",      value: "mary" },
          right: { label: "Mother of Jesus", value: "mary" }
        },
        {
          left:  { label: "Elizabeth", value: "elizabeth" },
          right: { label: "Mother of John",  value: "elizabeth" }
        }
      ],
      grammarTag: "relationships",
      skillType: "vocabulary",
      difficulty: "medium"
    }, null, 2);
  };

  // ==== Fun√ß√£o para montar payload de preview (meta + question) ====
  function buildPreviewPayload(){
    const levelRaw = document.getElementById('level').value.trim();
    const unitRaw  = document.getElementById('unit').value.trim();
    const faseRaw  = document.getElementById('fase').value.trim();
    let   qId      = document.getElementById('questionId').value.trim();
    const orderRaw = document.getElementById('order').value.trim();
    const typeQuick= document.getElementById('typeQuick').value;
    const jsonStr  = txtJson.value.trim();

    if (!levelRaw || !unitRaw || !faseRaw || !jsonStr) {
      showToast("Preencha Level, Unit, Fase e o JSON da quest√£o antes de fazer o preview.");
      return null;
    }

    const levelKey = normalizeDir("Level", levelRaw, "0");
    const unitKey  = normalizeDir("Unit",  unitRaw,  "1");
    const faseKey  = String(parseInt(faseRaw, 10) || 1);

    if (!qId) {
      qId = `Q_${Date.now()}`;
    }

    let orderNum = null;
    if (orderRaw) {
      const n = parseInt(orderRaw, 10);
      if (!isNaN(n) && n > 0) orderNum = n;
    }

    let obj;
    try {
      obj = JSON.parse(jsonStr);
    } catch (err) {
      console.error("JSON inv√°lido para preview:", err);
      showToast("Erro: JSON inv√°lido. Verifique a sintaxe antes do preview.");
      return null;
    }

    // aplica metadados b√°sicos (mesma l√≥gica do submit)
    obj.id    = obj.id || qId;
    obj.level = obj.level || levelKey;
    obj.unit  = obj.unit  || unitKey;
    obj.fase  = obj.fase  || faseKey;
    if (orderNum != null) {
      obj.order = orderNum;
    }
    if (typeQuick && !obj.type) {
      obj.type = typeQuick;
    }

    const meta = {
      level: levelKey,
      unit:  unitKey,
      fase:  faseKey,
      questionId: obj.id,
      order: obj.order || orderNum || 1,
      difficulty: obj.difficulty || "easy",
      tags: {
        grammar:   obj.grammarTag || null,
        vocabulary: obj.vocabTag || obj.vocabularyTag || null,
        skill:     obj.skillType || null
      }
    };

    return { meta, question: obj };
  }

  // ==== Bot√£o Preview: salva em localStorage e abre qa-preview.html ====
  const btnPreview = document.getElementById('btnPreview');
  btnPreview.addEventListener('click', () => {
    const payload = buildPreviewPayload();
    if (!payload) return;

    try {
      // chave usada pelo qa-preview.html (mensagem: hannahQA_preview)
      localStorage.setItem('hannahQA_preview', JSON.stringify(payload));
    } catch (err) {
      console.error("Erro ao salvar preview no localStorage:", err);
      showToast("Erro ao salvar dados no navegador para o preview.");
      return;
    }

    // abre nova aba com a tela de preview
    window.open('qa-preview.html', '_blank');
  });

  // ==== Salvando quest√£o + activity (Firebase) ====
  document.getElementById('q-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentUserId) {
      showToast("Voc√™ n√£o est√° autenticado. Fa√ßa login primeiro.");
      setStatus("<b>Status:</b> n√£o autenticado.");
      return;
    }

    const levelRaw = document.getElementById('level').value.trim();
    const unitRaw  = document.getElementById('unit').value.trim();
    const faseRaw  = document.getElementById('fase').value.trim();
    let   qId      = document.getElementById('questionId').value.trim();
    const orderRaw = document.getElementById('order').value.trim();
    const typeQuick= document.getElementById('typeQuick').value;
    const jsonStr  = txtJson.value.trim();

    if (!levelRaw || !unitRaw || !faseRaw || !jsonStr) {
      showToast("Preencha Level, Unit, Fase e o JSON da quest√£o.");
      return;
    }

    const levelKey = normalizeDir("Level", levelRaw, "0");
    const unitKey  = normalizeDir("Unit",  unitRaw,  "1");
    const faseKey  = String(parseInt(faseRaw, 10) || 1);
    const activityKey = `${levelKey}_${unitKey}_Fase${faseKey}`;

    if (!qId) {
      qId = `Q_${Date.now()}`;
    }

    let orderNum = null;
    if (orderRaw) {
      const n = parseInt(orderRaw, 10);
      if (!isNaN(n) && n > 0) orderNum = n;
    }

    let obj;
    try {
      obj = JSON.parse(jsonStr);
    } catch (err) {
      console.error("JSON inv√°lido:", err);
      showToast("Erro: JSON inv√°lido. Verifique a sintaxe.");
      setStatus("<b>Status:</b> erro ao fazer parse do JSON (veja console).<span class='pill-err'>JSON inv√°lido</span>");
      return;
    }

    // For√ßa alguns metadados importantes
    obj.id    = qId;
    obj.level = obj.level || levelKey;
    obj.unit  = obj.unit  || unitKey;
    obj.fase  = obj.fase  || faseKey;
    if (orderNum != null) {
      obj.order = orderNum;
    } else if (obj.order == null) {
      obj.order = null;
    }

    if (typeQuick && !obj.type) {
      obj.type = typeQuick;
    }

    showLoading(true);
    setStatus("<b>Status:</b> salvando quest√£o em <code>questions/"+qId+"</code>‚Ä¶");

    try {
      // 1) salva em questions/{qId}
      await firebase.database().ref("questions/"+qId).set(obj);

      // 2) atualiza activities/{activityKey}/questionIds
      const actRef = firebase.database().ref("activities/"+activityKey);
      const snap = await actRef.once("value");
      const act  = snap.val() || {};
      let ids    = Array.isArray(act.questionIds) ? act.questionIds.slice() : [];

      if (!ids.includes(qId)) {
        if (orderNum != null) {
          // insere na posi√ß√£o (order-1), limitado ao tamanho
          const idx = Math.max(0, Math.min(orderNum - 1, ids.length));
          ids.splice(idx, 0, qId);
        } else {
          ids.push(qId);
        }
      }

      act.level      = act.level      || levelKey;
      act.unit       = act.unit       || unitKey;
      act.fase       = act.fase       || faseKey;
      act.questionIds= ids;

      await actRef.set(act);

      showToast("Quest√£o salva com sucesso!");
      setStatus(
        "<b>Status:</b> salvo com sucesso.<br>" +
        "questions/<code>" + qId + "</code><br>" +
        "activities/<code>" + activityKey + "</code> " +
        "<span class='pill-ok'>OK</span>"
      );
    } catch (err) {
      console.error("Erro ao salvar no Firebase:", err);
      showToast("Erro ao salvar no Firebase. Veja o console.");
      setStatus("<b>Status:</b> erro ao salvar no Firebase.<span class='pill-err'>Erro</span>");
    } finally {
      showLoading(false);
    }
  });

  // ===== BUSCA / LISTAGEM =====
  const searchLevelEl = document.getElementById('search-level');
  const searchUnitEl  = document.getElementById('search-unit');
  const searchFaseEl  = document.getElementById('search-fase');
  const searchBtn     = document.getElementById('btnSearchQuestions');
  const resultsEl     = document.getElementById('searchResults');

  let lastSearch = null; // guarda √∫ltima busca (para recarregar ap√≥s apagar)

  async function performSearch(levelRaw, unitRaw, faseRaw){
    const lvl = levelRaw.trim();
    const unt = unitRaw.trim();
    const fs  = faseRaw.trim();

    if (!lvl || !unt || !fs){
      showToast("Preencha Level, Unit e Fase para buscar.");
      return;
    }

    const levelKey = normalizeDir("Level", lvl, "0");
    const unitKey  = normalizeDir("Unit",  unt, "1");
    const faseKey  = String(parseInt(fs,10) || 1);
    const activityKey = `${levelKey}_${unitKey}_Fase${faseKey}`;

    showLoading(true);
    resultsEl.innerHTML = "";
    setStatus("<b>Status:</b> carregando quest√µes de <code>activities/"+activityKey+"</code>‚Ä¶");

    try{
      const actRef = firebase.database().ref("activities/"+activityKey);
      const snap = await actRef.once("value");
      const act  = snap.val();

      if (!act || !Array.isArray(act.questionIds) || act.questionIds.length === 0){
        resultsEl.innerHTML = "<div class='hint'>Nenhuma quest√£o cadastrada para esta atividade ainda.</div>";
        setStatus("<b>Status:</b> nenhuma quest√£o encontrado em <code>activities/"+activityKey+"</code>.");
        lastSearch = {activityKey, levelKey, unitKey, faseKey, items: []};
        return;
      }

      const ids = act.questionIds;
      const promises = ids.map(id => firebase.database().ref("questions/"+id).once("value"));
      const snaps = await Promise.all(promises);

      const items = snaps.map((s, index) => {
        const data = s.val() || {};
        return {
          id: ids[index],
          data,
          pos: index + 1
        };
      });

      lastSearch = {activityKey, levelKey, unitKey, faseKey, items};
      renderResults(activityKey, items);

      setStatus(
        "<b>Status:</b> carregadas " + items.length +
        " quest√£o(√µes) de <code>activities/"+activityKey+"</code>."
      );
    } catch(err){
      console.error("Erro ao buscar quest√µes:", err);
      showToast("Erro ao buscar quest√µes. Veja o console.");
      setStatus("<b>Status:</b> erro ao buscar quest√µes.<span class='pill-err'>Erro</span>");
    } finally{
      showLoading(false);
    }
  }

  function renderResults(activityKey, items){
    resultsEl.innerHTML = "";
    if (!items || items.length === 0){
      resultsEl.innerHTML = "<div class='hint'>Nenhuma quest√£o encontrada.</div>";
      return;
    }

    items.forEach(item => {
      const q   = item.data || {};
      const div = document.createElement('div');
      div.className = 'q-row';

      const header = document.createElement('div');
      header.className = 'q-row-header';

      const idSpan = document.createElement('div');
      idSpan.className = 'q-row-id';
      idSpan.textContent = item.id;

      const meta = document.createElement('div');
      meta.className = 'q-row-meta';
      const ord = (q.order != null ? q.order : item.pos);
      meta.textContent =
        "ordem: " + ord +
        (q.type ? " | type: " + q.type : "") +
        (q.grammarTag ? " | " + q.grammarTag : "") +
        (q.difficulty ? " | " + q.difficulty : "");

      header.appendChild(idSpan);
      header.appendChild(meta);
      div.appendChild(header);

      if (q.prompt){
        const p = document.createElement('div');
        p.className = 'q-row-prompt';
        p.textContent = q.prompt;
        div.appendChild(p);
      }

      const btnRow = document.createElement('div');
      btnRow.className = 'row-buttons';

      const btnEdit = document.createElement('button');
      btnEdit.type = 'button';
      btnEdit.className = 'btn-secondary btn-xs';
      btnEdit.textContent = '‚úèÔ∏è Editar';
      btnEdit.onclick = () => editQuestionFromList(item.id);

      const btnDel = document.createElement('button');
      btnDel.type = 'button';
      btnDel.className = 'btn-danger btn-xs';
      btnDel.textContent = 'üóëÔ∏è Apagar';
      btnDel.onclick = () => deleteQuestionFromList(activityKey, item.id);

      btnRow.appendChild(btnEdit);
      btnRow.appendChild(btnDel);
      div.appendChild(btnRow);

      resultsEl.appendChild(div);
    });
  }

  searchBtn.addEventListener('click', () => {
    performSearch(
      searchLevelEl.value || document.getElementById('level').value || "",
      searchUnitEl.value  || document.getElementById('unit').value  || "",
      searchFaseEl.value  || document.getElementById('fase').value  || ""
    );
  });

  // ===== Editar: carrega dados para o formul√°rio principal =====
  function editQuestionFromList(questionId){
    if (!lastSearch || !lastSearch.items) return;
    const item = lastSearch.items.find(it => it.id === questionId);
    if (!item){
      showToast("Quest√£o n√£o encontrada no cache da busca.");
      return;
    }
    const q = item.data || {};

    // Preenche Level/Unit/Fase com base na √∫ltima busca
    document.getElementById('level').value = lastSearch.levelKey;
    document.getElementById('unit').value  = lastSearch.unitKey;
    document.getElementById('fase').value  = lastSearch.faseKey;

    document.getElementById('questionId').value = questionId;
    document.getElementById('order').value      = (q.order != null ? q.order : item.pos) || "";

    const selType = document.getElementById('typeQuick');
    if (q.type && Array.from(selType.options).some(o => o.value === q.type)){
      selType.value = q.type;
    } else {
      selType.value = "";
    }

    txtJson.value = JSON.stringify(q, null, 2);

    window.scrollTo({top:0, behavior:'smooth'});
    showToast("Quest√£o carregada para edi√ß√£o.");
  }

  // ===== Apagar quest√£o =====
  async function deleteQuestionFromList(activityKey, questionId){
    if (!confirm("Tem certeza que deseja apagar esta quest√£o?\n\nID: " + questionId)){
      return;
    }

    showLoading(true);
    try{
      // remove question
      await firebase.database().ref("questions/"+questionId).remove();

      // atualiza activity
      const actRef = firebase.database().ref("activities/"+activityKey);
      const snap = await actRef.once("value");
      const act  = snap.val() || {};
      let ids    = Array.isArray(act.questionIds) ? act.questionIds : [];
      ids = ids.filter(id => id !== questionId);
      act.questionIds = ids;
      await actRef.set(act);

      showToast("Quest√£o apagada.");
      setStatus("<b>Status:</b> quest√£o apagada de <code>questions/"+questionId+"</code> e atualizada em <code>activities/"+activityKey+"</code>.");

      // recarrega a lista com a √∫ltima busca
      if (lastSearch){
        await performSearch(lastSearch.levelKey, lastSearch.unitKey, lastSearch.faseKey);
      }
    } catch(err){
      console.error("Erro ao apagar quest√£o:", err);
      showToast("Erro ao apagar quest√£o. Veja o console.");
      setStatus("<b>Status:</b> erro ao apagar quest√£o.<span class='pill-err'>Erro</span>");
    } finally{
      showLoading(false);
    }
  }

  // exp√µe fun√ß√µes no escopo global (caso precise no console)
  window.editQuestionFromList = editQuestionFromList;
  window.deleteQuestionFromList = deleteQuestionFromList;
</script>
</body>
</html>
