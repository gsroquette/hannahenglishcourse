<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>English Word Guess Game</title>

  <!-- Firebase (v8.x) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* RESET BÁSICO */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #e3f2fd, #bbdefb);
      padding: 20px; 
      overflow-y: auto;
    }

    /* ROBOT FIXO NO CANTO SUPERIOR ESQUERDO */
    #robot-section {
      position: fixed;
      top: 20px; 
      left: 20px;
      width: 220px;
      z-index: 200; 
      display: flex; 
      flex-direction: column;
      align-items: center;
    }
    #robot-image {
      width: 100%;
    }
    #robot-balloon {
      position: absolute;
      top: 220px; 
      left: 0; 
      max-width: 220px;
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }

    /* BOTÃO INVITE FRIENDS */
    .btn-invite {
      margin-top: 8px;
      border: none;
      background-color: #ff9800;
      color: #fff;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .btn-invite:hover {
      background-color: #fb8c00;
    }

    /* LAYOUT DO JOGO (CENTRO) */
    #main-content {
      margin-left: 260px; 
      margin-right: 260px; 
      padding: 20px;
    }

    #top-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    #start-game {
      background-color: #03a9f4;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #start-game:disabled {
      background-color: #bbb;
      cursor: not-allowed;
    }
    #difficulty-select {
      padding: 6px;
    }
    #message {
      color: #444;
      font-style: italic;
    }

    #board {
      min-height: 200px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .attempt-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      gap: 5px;
    }
    .letter-block {
      width: 45px; 
      height: 45px;
      background-color: #cfd8dc;
      border: 1px solid #999;
      border-radius: 4px;
      font-weight: bold;
      font-size: 18px;
      text-transform: uppercase;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #000;
    }
    .player-name {
      font-size: 14px;
      margin-left: 6px;
      font-style: italic;
      color: #666;
    }
    /* FEEDBACK CORES */
    .green {
      background-color: #66bb6a;
      color: #fff;
    }
    .yellow {
      background-color: #ffeb3b;
      color: #000;
    }
    .red {
      background-color: #f44336;
      color: #fff;
    }

    /* BOTÃO TRY => FIXO NO CANTO INFERIOR DIREITO */
    #try-button {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 999;
      border: none;
      background-color: #4caf50;
      color: #fff;
      padding: 12px 18px;
      border-radius: 50px;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer;
    }
    #try-button:hover {
      background-color: #388e3c;
    }

    /* SCOREBOARD SIMPLES (DIREITA) */
    #scoreboard-section {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 220px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      z-index: 200;
    }
    #scoreboard-section h3 {
      margin-bottom: 8px;
      text-align: center;
    }
    #score-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #score-list li {
      border-bottom: 1px solid #eee;
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    #score-list li span {
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- ROBÔ FIXO -->
<div id="robot-section">
  <img id="robot-image" src="imagens/robo_estatico.png" alt="Robot Samuel">
  <div id="robot-balloon"></div>
  <button class="btn-invite" id="invite-button">Invite Friends</button>
</div>

<!-- SCOREBOARD FIXO (DIREITA) -->
<div id="scoreboard-section">
  <h3>Top 20</h3>
  <ol id="score-list"></ol>
</div>

<!-- CONTEÚDO PRINCIPAL (CENTRO) -->
<div id="main-content">
  <div id="top-controls">
    <label for="difficulty-select">Difficulty:</label>
    <select id="difficulty-select">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>
    <button id="start-game">Start Game</button>
    <span id="message"></span>
  </div>

  <div id="board"></div>
</div>

<!-- BOTÃO TRY FIXO -->
<button id="try-button">Try</button>

<script>
/*****************************************************
 * 1) Evitar múltipla inicialização do Firebase
 *****************************************************/
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.database();
const auth = firebase.auth();

/*****************************************************
 * 2) Variáveis Globais
 *****************************************************/
let dictionarySet = new Set(); // Ex.: Pode ser carregado via fetch no futuro
let userName  = "Guest";
let userUid   = null;
let isGuest   = true;
let userRole  = "aluno"; 
let currentWord = "";
let currentStatus = "idle"; 
let currentDifficulty = "easy";
let totalPoints = 0;
let attemptsLocal = []; // array de tentativas { guess, feedback, playerName }

/*****************************************************
 * 3) Robot / TTS
 *****************************************************/
const robotImage   = document.getElementById("robot-image");
const robotBalloon = document.getElementById("robot-balloon");
const synth        = window.speechSynthesis;

function speakText(text) {
  if (!text) return;
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = "en-US";
  utt.onstart = () => {
    robotImage.src = "imagens/robo_fala.gif";
    robotBalloon.textContent = text;
    robotBalloon.style.display = "block";
  };
  utt.onend = () => {
    robotImage.src = "imagens/robo_estatico.png";
    setTimeout(() => {
      robotBalloon.style.display = "none";
    }, 800);
  };
  synth.speak(utt);
}

/*****************************************************
 * 4) Auth - Quem é o usuário
 *****************************************************/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    userUid = user.uid;
    isGuest = false;
    const snap = await db.ref("usuarios/" + userUid).once("value");
    const data = snap.val() || {};
    userName  = data.nome  || data.email || "User";
    userRole  = data.role  || "aluno";
    totalPoints = data.points || 0;
  } else {
    userUid = null;
    isGuest = true;
    userName = "Guest";
    userRole = "guest";
  }
  loadScoreboard();
  listenGameState(); // Carrega estado do jogo
});

/*****************************************************
 * 5) Scoreboard (Top 20)
 *****************************************************/
function loadScoreboard() {
  const scoreList = document.getElementById("score-list");
  db.ref("usuarios").orderByChild("points").limitToLast(20).on("value", (snap) => {
    const val = snap.val() || {};
    let arr = [];
    Object.keys(val).forEach(uid => {
      const u = val[uid];
      const nm = u.nome || u.email || "User";
      const pts= u.points || 0;
      arr.push({ name: nm, points: pts });
    });
    // Ordenar decrescente
    arr.sort((a,b) => b.points - a.points);
    scoreList.innerHTML = "";
    arr.forEach((item, i) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${i+1}.</span> ${item.name} <span>${item.points} pts</span>`;
      scoreList.appendChild(li);
    });
  });
}

/*****************************************************
 * 6) Sincronizar Partida (games/currentGame)
 *****************************************************/
function listenGameState() {
  db.ref("games/currentGame").on("value", (snap) => {
    const data = snap.val();
    if (!data) {
      // Não existe partida -> estado idle
      currentStatus = "idle";
      currentWord   = "";
      attemptsLocal = [];
      renderAttempts();
      updateUI();
      return;
    }
    currentWord   = data.word   || "";
    currentStatus = data.status || "idle";
    currentDifficulty = data.difficulty || "easy";
    
    const attemptsObj = data.attempts || {};
    attemptsLocal = Object.keys(attemptsObj).map(key => attemptsObj[key]);

    renderAttempts();
    updateUI();
  });
}

/*****************************************************
 * 7) Start Game
 *****************************************************/
document.getElementById("start-game").addEventListener("click", startGame);

async function startGame() {
  if (currentStatus === "in_progress" && userRole !== "proprietario") {
    speakText("A game is already in progress. Please wait.");
    return;
  }
  // Limpar no DB
  await db.ref("games/currentGame").remove();

  currentDifficulty = document.getElementById("difficulty-select").value;
  const word = await pickWordWithDefinition(currentDifficulty);
  
  db.ref("games/currentGame").set({
    word,
    status: "in_progress",
    difficulty: currentDifficulty,
    attempts: {}
  });
  speakText(`${userName} started a new game! Difficulty: ${currentDifficulty}. Good luck!`);
}

/*****************************************************
 * 8) Pick Word (Filtro + Definição)
 *****************************************************/
async function pickWordWithDefinition(diff) {
  // easy = 3 letras, medium=4..5, hard=6..7
  let minLen = 3, maxLen = 3;
  if (diff === "medium") { minLen=4; maxLen=5; }
  if (diff === "hard")   { minLen=6; maxLen=7; }

  // Exemplo: filtra do dictionarySet
  const allWords = [...dictionarySet].filter(w => w.length >= minLen && w.length <= maxLen);
  if (allWords.length < 1) return "cat"; // fallback

  // Tenta achar uma c/ definição
  for (let i = 0; i < 30; i++) {
    const rand = allWords[Math.floor(Math.random()*allWords.length)];
    if (await hasDefinition(rand)) {
      return rand;
    }
  }
  // Se não achou, devolve qualquer
  return allWords[Math.floor(Math.random()*allWords.length)];
}

async function hasDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return false;
    const data = await res.json();
    return !!(data[0]?.meanings?.[0]?.definitions?.[0]?.definition);
  } catch {
    return false;
  }
}

/*****************************************************
 * 9) Render Attempts
 *****************************************************/
function renderAttempts() {
  const board = document.getElementById("board");
  board.innerHTML = "";

  attemptsLocal.forEach((attemptObj) => {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("attempt-row");

    const guessArr = attemptObj.guess.split("");
    guessArr.forEach((letter, i) => {
      const block = document.createElement("div");
      block.classList.add("letter-block");
      block.textContent = letter.toUpperCase();
      if (attemptObj.feedback && attemptObj.feedback[i]) {
        block.classList.add(attemptObj.feedback[i]);
      }
      rowDiv.appendChild(block);
    });

    const playerSpan = document.createElement("span");
    playerSpan.classList.add("player-name");
    playerSpan.textContent = `- ${attemptObj.playerName || "Unknown"}`;
    rowDiv.appendChild(playerSpan);

    board.appendChild(rowDiv);
  });
}

/*****************************************************
 * 10) Update UI
 *****************************************************/
function updateUI() {
  const startBtn = document.getElementById("start-game");
  if (currentStatus === "in_progress") {
    if (userRole === "proprietario") {
      startBtn.disabled = false; 
    } else {
      startBtn.disabled = true;
    }
  } else {
    // ended ou idle
    startBtn.disabled = false;
  }
}

/*****************************************************
 * 11) TRY BUTTON
 *****************************************************/
document.getElementById("try-button").addEventListener("click", handleTry);

async function handleTry() {
  if (currentStatus !== "in_progress") {
    speakText("No active game right now.");
    return;
  }
  if (!currentWord) {
    speakText("No word chosen yet!");
    return;
  }

  // Exemplo simples: prompt
  const guess = prompt("Type your guess (all letters filled):") || "";
  const guessClean = guess.trim().toLowerCase();

  if (guessClean.length !== currentWord.length) {
    speakText(`You must type exactly ${currentWord.length} letters!`);
    return;
  }
  if (!dictionarySet.has(guessClean)) {
    speakText("That word is not in our dictionary!");
    return;
  }

  const feedback = getFeedback(guessClean, currentWord);
  const pushRef = db.ref("games/currentGame/attempts").push();
  await pushRef.set({
    guess: guessClean,
    feedback,
    playerName: userName,
    timestamp: Date.now()
  });

  const allGreen = feedback.every(c => c === "green");
  if (allGreen) {
    const definition = await getDefinition(guessClean);
    let msg = `Congratulations, ${userName}! You found the word "${guessClean}".`;
    if (definition) {
      msg += ` Definition: ${definition}`;
    }
    speakText(msg);

    let pts = 10; 
    if (currentDifficulty === "medium") pts = 20;
    if (currentDifficulty === "hard")   pts = 35;

    if (!isGuest && userUid) {
      totalPoints += pts;
      await db.ref("usuarios/"+userUid).update({ points: totalPoints });
    }

    db.ref("games/currentGame").update({ status: "ended" });
  }
}

/*****************************************************
 * 12) getFeedback
 *****************************************************/
function getFeedback(guess, realWord) {
  const feedback = Array(guess.length).fill("red");
  const realArr  = realWord.split("");

  // greens
  for (let i = 0; i < guess.length; i++) {
    if (guess[i] === realArr[i]) {
      feedback[i] = "green";
      realArr[i] = "*";
    }
  }
  // yellows
  for (let i = 0; i < guess.length; i++) {
    if (feedback[i] === "green") continue;
    const idx = realArr.indexOf(guess[i]);
    if (idx !== -1) {
      feedback[i] = "yellow";
      realArr[idx] = "*";
    }
  }
  return feedback;
}

/*****************************************************
 * 13) getDefinition
 *****************************************************/
async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return "";
    const data = await res.json();
    return data[0]?.meanings?.[0]?.definitions?.[0]?.definition || "";
  } catch {
    return "";
  }
}

/*****************************************************
 * 14) Invite Friends
 *****************************************************/
document.getElementById("invite-button").addEventListener("click", () => {
  const shareData = {
    title: "Hannah English Course",
    text: "Come play this English word game with me!",
    url: "https://hannahenglishcourse.vercel.app/"
  };
  if (navigator.share) {
    navigator.share(shareData).catch(() => {});
  } else {
    const wUrl = "https://wa.me/?text=" + encodeURIComponent(shareData.text + " " + shareData.url);
    window.open(wUrl, "_blank");
  }
});
</script>
</body>
</html>
