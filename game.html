<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>English Word Guess Game</title>

  <!-- Firebase (v8.x) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* RESET BÁSICO */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #e3f2fd, #bbdefb);
      padding: 20px; 
      overflow-y: auto; 
    }

    /* ROBÔ FIXO NO CANTO SUPERIOR ESQUERDO */
    #robot-section {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 220px;
      z-index: 200;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #robot-image {
      width: 100%;
    }
    #robot-balloon {
      position: absolute;
      top: 220px;
      left: 0;
      max-width: 220px;
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }

    /* BOTÃO INVITE FRIENDS */
    .btn-invite {
      margin-top: 8px;
      border: none;
      background-color: #ff9800;
      color: #fff;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .btn-invite:hover {
      background-color: #fb8c00;
    }

    /* SCOREBOARD FIXO (CANTO SUPERIOR DIREITO) */
    #scoreboard-section {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 220px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      z-index: 200;
    }
    #scoreboard-section h3 {
      margin-bottom: 8px;
      text-align: center;
    }
    #score-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #score-list li {
      border-bottom: 1px solid #eee;
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    #score-list li span {
      font-weight: bold;
    }

    /* ÁREA PRINCIPAL DO JOGO */
    #main-content {
      margin-left: 260px;
      margin-right: 260px;
      padding: 20px;
    }
    #top-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    #difficulty-select {
      padding: 6px;
    }
    #start-game {
      background-color: #03a9f4;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #start-game:disabled {
      background-color: #bbb;
      cursor: not-allowed;
    }
    #board {
      min-height: 200px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    /* TOWER */
    .attempt-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      gap: 5px;
    }
    .letter-block {
      width: 45px;
      height: 45px;
      background-color: #cfd8dc;
      border: 1px solid #999;
      border-radius: 4px;
      font-weight: bold;
      font-size: 18px;
      text-transform: uppercase;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #000;
    }
    .player-name {
      font-size: 14px;
      margin-left: 6px;
      font-style: italic;
      color: #666;
    }

    /* CORES DE FEEDBACK */
    .green {
      background-color: #66bb6a;
      color: #fff;
    }
    .yellow {
      background-color: #ffeb3b;
      color: #000;
    }
    .red {
      background-color: #f44336;
      color: #fff;
    }
  </style>
</head>
<body>

<!-- ROBÔ NO CANTO ESQUERDO -->
<div id="robot-section">
  <img id="robot-image" src="imagens/robo_estatico.png" alt="Robot Samuel">
  <div id="robot-balloon"></div>
  <button class="btn-invite" id="invite-button">Invite Friends</button>
</div>

<!-- SCOREBOARD NO CANTO DIREITO -->
<div id="scoreboard-section">
  <h3>Top 20</h3>
  <ol id="score-list"></ol>
</div>

<!-- ÁREA PRINCIPAL -->
<div id="main-content">
  <div id="top-controls">
    <label for="difficulty-select">Difficulty:</label>
    <select id="difficulty-select">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>
    <button id="start-game">Start Game</button>
  </div>

  <div id="board"><!-- Linha(s) de blocos --></div>

  <!-- BOTÃO TRY ABAIXO DA TORRE -->
  <button id="try-button" style="margin-top: 15px; padding: 8px 14px; border:none; background-color:#4caf50; color:#fff; border-radius:4px; font-weight:bold; cursor:pointer;">
    Try
  </button>
</div>

<script>
/*******************************************************
 * 1) CONFIGURANDO FIREBASE (API KEY EXATA)
 *******************************************************/
var firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
  measurementId: "G-07VVJG9LRS"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.database();
const auth = firebase.auth();

/*******************************************************
 * 2) VARIÁVEIS GLOBAIS
 *******************************************************/
let dictionarySet = new Set(); 
let userName  = "Guest";
let userUid   = null;
let isGuest   = true;
let userRole  = "aluno"; 
let currentWord = "";
let currentStatus = "idle"; 
let currentDifficulty = "easy";
let totalPoints = 0;

// Função para carregar o dicionário do servidor
async function loadDictionary() {
  try {
    const response = await fetch("dictionaries/words_alpha.txt"); // Verifique o caminho correto do arquivo
    if (!response.ok) {
      throw new Error(`Failed to load dictionary: ${response.statusText}`);
    }
    const text = await response.text();
    dictionarySet = new Set(text.split("\n").map(word => word.trim().toLowerCase()));
    console.log("Dicionário carregado com sucesso. Total de palavras:", dictionarySet.size);
  } catch (error) {
    console.error("Erro ao carregar o dicionário:", error);
  }
}

// Chamar a função para carregar o dicionário
loadDictionary();

// Guardamos TODAS as linhas (tentativas) vindas do DB
let attemptsArray = []; 
// A linha atual (blocos que o usuário está digitando agora):
let currentRowIndex = 0; 
let currentLetters  = []; 

/*******************************************************
 * 3) ROBÔ E TTS
 *******************************************************/
const robotImage   = document.getElementById("robot-image");
const robotBalloon = document.getElementById("robot-balloon");
const synth        = window.speechSynthesis;

function speakText(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "en-US";

  utterance.onstart = () => {
    robotImage.src = "imagens/robo_fala.gif";
    robotBalloon.textContent = text;
    robotBalloon.style.display = "block";
  };
  utterance.onend = () => {
    robotImage.src = "imagens/robo_estatico.png";
    setTimeout(() => {
      robotBalloon.style.display = "none";
    }, 800);
  };
  synth.speak(utterance);
}

/*******************************************************
 * 4) LOGIN
 *******************************************************/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    userUid = user.uid;
    isGuest = false;
    const snap = await db.ref("usuarios/" + userUid).once("value");
    const data = snap.val() || {};
    userName = data.nome || data.email || "User";
    userRole = data.role || "aluno";
    totalPoints = data.points || 0;
  } else {
    userUid = null;
    isGuest = true;
    userName = "Guest";
    userRole = "guest";

    // Informa ao jogador não logado que ele é um "Guest"
    speakText("You're playing as a guest. Your progress won't be saved.");
  }
  loadScoreboard();
  listenGameState();
});

/*******************************************************
 * 5) SCOREBOARD
 *******************************************************/
function loadScoreboard() {
  const scoreList = document.getElementById("score-list");
  db.ref("usuarios").orderByChild("points").limitToLast(20).on("value", (snap) => {
    const val = snap.val() || {};
    let arr = [];
    Object.keys(val).forEach(uid => {
      const u = val[uid];
      const nm = u.nome || u.email || "User";
      const pts= u.points || 0;
      arr.push({ name: nm, points: pts });
    });
    arr.sort((a,b) => b.points - a.points);
    scoreList.innerHTML = "";
    arr.forEach((item, i) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${i+1}.</span> ${item.name} <span>${item.points} pts</span>`;
      scoreList.appendChild(li);
    });
  });
}

/*******************************************************
 * 6) ESTADO DO JOGO (games/currentGame)
 *******************************************************/
function listenGameState() {
  db.ref("games/currentGame").on("value", (snap) => {
    const data = snap.val();

    if (!data) {
      // Se não há partida, reseta tudo para estado inicial
      currentStatus = "idle";
      currentWord = "";
      attemptsArray = [];
      currentRowIndex = 0;
      currentLetters = [];
      renderAllAttempts();
      updateUI();
      disableInput(); // Certifique-se de desabilitar os inputs ao reiniciar
      return;
    }

    // Atualiza o estado da partida
    currentWord = data.word || "";
    currentStatus = data.status || "idle";
    currentDifficulty = data.difficulty || "easy";

    // Converte as tentativas do banco em array local
    const attemptsObj = data.attempts || {};
    attemptsArray = Object.keys(attemptsObj).map((key) => attemptsObj[key]);

    // Renderiza o estado sincronizado
    renderAllAttempts();
    updateUI();

    // Exibe a mensagem para usuários não logados apenas uma vez
    if (isGuest && !localStorage.getItem("guestMessageShown")) {
      speakText("You're playing as a guest. Your progress won't be saved.");
      localStorage.setItem("guestMessageShown", "true"); // Evita repetição da mensagem
    }

    // Permitir input apenas se a partida está ativa
    if (currentStatus === "in_progress" && currentWord) {
      enableInput(); // Habilita inputs para todos os jogadores
    } else {
      disableInput(); // Desabilita inputs caso o jogo tenha terminado ou esteja ocioso
    }

    // Atualização adicional para o guest:
    // Garante que a tentativa do guest seja registrada no Firebase
    if (isGuest) {
      db.ref("games/currentGame/attempts").on("child_added", (snapshot) => {
        const attempt = snapshot.val();
        if (!attemptsArray.some((a) => a.timestamp === attempt.timestamp)) {
          attemptsArray.push(attempt);
          renderAllAttempts();
        }
      });
    }
  });
}

function enableInput() {
  document.addEventListener("keydown", handleKeyPress); // Habilita eventos de teclado
}

function disableInput() {
  document.removeEventListener("keydown", handleKeyPress); // Remove eventos de teclado
}

/*******************************************************
 * 7) START GAME
 *******************************************************/
document.getElementById("start-game").addEventListener("click", startGame);

async function startGame() {
  // Verifica se já existe um jogo em andamento e impede novos jogos (exceto para o proprietário)
  if (currentStatus === "in_progress" && userRole !== "proprietario") {
    speakText("A game is already in progress. Please wait.");
    return;
  }

  // Remove o jogo atual (se houver)
  await db.ref("games/currentGame").remove();

  // Define a dificuldade escolhida
  currentDifficulty = document.getElementById("difficulty-select").value;
  const chosenWord = await pickWordWithDefinition(currentDifficulty);

  // Configura o novo jogo no banco de dados
  await db.ref("games/currentGame").set({
    word: chosenWord,
    status: "in_progress",
    difficulty: currentDifficulty,
    attempts: {}
  });

  // Mensagem inicial para todos os jogadores
  speakText(`${userName} started a new game! Difficulty: ${currentDifficulty}. Good luck!`);

  // Mensagem adicional para jogadores convidados
  if (isGuest) {
    speakText("You're playing as a guest. Your progress won't be saved.");
  }

  // Atualiza o estado local do jogo
  currentWord = chosenWord;
  currentStatus = "in_progress";
  currentLetters = [];
  attemptsArray = [];

  // Renderiza o jogo e habilita os inputs
  renderAllAttempts();
  updateUI();
  enableInput();
}

/*******************************************************
 * 8) SORTEAR PALAVRA + DEFINIÇÃO
 *******************************************************/
async function pickWordWithDefinition(diff) {
  let minLen=3, maxLen=3;
  if (diff === "medium") { minLen=4; maxLen=5; }
  if (diff === "hard")   { minLen=6; maxLen=7; }

  // Exemplo: filtrar no dictionarySet
  const allWords = [...dictionarySet].filter(w => w.length >= minLen && w.length <= maxLen);
  if (allWords.length < 1) return "cat";

  for (let i=0; i<30; i++) {
    const cand = allWords[Math.floor(Math.random()*allWords.length)];
    if (await hasDefinition(cand)) return cand;
  }
  return allWords[Math.floor(Math.random()*allWords.length)];
}

async function hasDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return false;
    const data = await res.json();
    return !!(data[0]?.meanings?.[0]?.definitions?.[0]?.definition);
  } catch {
    return false;
  }
}

/*******************************************************
 * 9) RENDERIZAR (BLOCOS) => attempts + "current row"
 *******************************************************/
function renderAllAttempts() {
  const board = document.getElementById("board");
  board.innerHTML = "";

  // Render as tentativas antigas (do DB)
  attemptsArray.forEach((att) => {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("attempt-row");

    let guessArr = att.guess.split("");
    guessArr.forEach((letter, i) => {
      const block = document.createElement("div");
      block.classList.add("letter-block");
      block.textContent = letter.toUpperCase();
      if (att.feedback && att.feedback[i]) {
        block.classList.add(att.feedback[i]);
      }
      rowDiv.appendChild(block);
    });

    // Nome do jogador
    const playerSpan = document.createElement("span");
    playerSpan.classList.add("player-name");
    playerSpan.textContent = `- ${att.playerName || "Unknown"}`;
    rowDiv.appendChild(playerSpan);

    board.appendChild(rowDiv);
  });

  // Render a "current row" (blocos vazios para a tentativa atual)
  if (currentStatus === "in_progress" && currentWord) {
    const newRowDiv = document.createElement("div");
    newRowDiv.classList.add("attempt-row");

    // Gera os blocos vazios para a palavra atual
    for (let i = 0; i < currentWord.length; i++) {
      const block = document.createElement("div");
      block.classList.add("letter-block");
      block.textContent = currentLetters[i] ? currentLetters[i].toUpperCase() : ""; // Insere apenas letras digitadas
      newRowDiv.appendChild(block);
    }
    board.appendChild(newRowDiv);
  }
}

/*******************************************************
 * 10) UPDATE UI => habilitar/desabilitar Start
 *******************************************************/
function updateUI() {
  const startBtn = document.getElementById("start-game");
  const tryBtn = document.getElementById("try-button");

  // Ativa "Start Game" para todos os jogadores
  if (currentStatus === "in_progress" && userRole !== "proprietario") {
    startBtn.disabled = true;
  } else {
    startBtn.disabled = false;
  }

  // Ativa "Try" apenas se o jogo está ativo
  if (currentStatus === "in_progress") {
    tryBtn.disabled = false;
  } else {
    tryBtn.disabled = true;
  }
}

/*******************************************************
 * 11) DIGITAR LETRAS => Keydown
 *******************************************************/
function handleKeyPress(e) {
  if (currentStatus !== "in_progress" || !currentWord) return; // Apenas se o jogo estiver ativo

  if (e.key === "Backspace" && currentLetters.length > 0) {
    currentLetters.pop();
    renderAllAttempts();
    return;
  }

  if (e.key.match(/^[a-z]$/i) && currentLetters.length < currentWord.length) {
    currentLetters.push(e.key.toLowerCase());
    renderAllAttempts();
    return;
  }

  if (e.key === "Enter") {
    submitCurrentRow();
  }
}

/*******************************************************
 * 12) BOTÃO "TRY" => submete a linha
 *******************************************************/
document.getElementById("try-button").addEventListener("click", () => {
  if (currentStatus !== "in_progress") {
    speakText("No active game right now.");
    return;
  }
  submitCurrentRow();
});

/*******************************************************
 * 13) SUBMETER A LINHA (blocos digitados)
 *******************************************************/
async function submitCurrentRow() {
  if (!currentWord || currentLetters.length !== currentWord.length) {
    speakText(`You must fill exactly ${currentWord.length} letters!`);
    return;
  }

  const guessClean = currentLetters.join("").toLowerCase();

  if (!dictionarySet.has(guessClean)) {
    speakText("That word is not in our dictionary!");
    return;
  }

  const feedback = getFeedback(guessClean, currentWord);

  // Salva tentativa no Firebase (para todos os jogadores, incluindo convidados)
  const pushRef = db.ref("games/currentGame/attempts").push();
  await pushRef.set({
    guess: guessClean,
    feedback,
    playerName: isGuest ? "Guest" : userName, // Nome será "Guest" para jogadores não logados
    timestamp: Date.now()
  });

  // Limpa o array de letras digitadas para a próxima tentativa
  currentLetters = [];

  // Verifica se a palavra foi encontrada
  if (feedback.every(c => c === "green")) {
    const definition = await getDefinition(guessClean);
    let msg = `Congratulations, ${isGuest ? "Guest" : userName}! You found the word "${guessClean}".`;
    if (definition) msg += ` Definition: ${definition}`;
    speakText(msg);

    // Adiciona pontos apenas para jogadores logados
    if (!isGuest && userUid) {
      let pts = currentDifficulty === "medium" ? 20 : currentDifficulty === "hard" ? 35 : 10;
      totalPoints += pts;
      await db.ref("usuarios/" + userUid).update({ points: totalPoints });
    }

    // Finaliza o jogo no Firebase
    db.ref("games/currentGame").update({ status: "ended" });
    disableInput(); // Desabilita inputs ao terminar o jogo
  }

  // Renderiza as tentativas (incluindo a tentativa atual)
  renderAllAttempts();
}

/*******************************************************
 * 14) FUNÇÃO getFeedback => green, yellow, red
 *******************************************************/
function getFeedback(guess, realWord) {
  const feedback = Array(guess.length).fill("red");
  const realArr  = realWord.split("");

  // green
  for (let i=0; i<guess.length; i++) {
    if (guess[i] === realArr[i]) {
      feedback[i] = "green";
      realArr[i]  = "*";
    }
  }
  // yellow
  for (let i=0; i<guess.length; i++) {
    if (feedback[i] === "green") continue;
    const idx = realArr.indexOf(guess[i]);
    if (idx !== -1) {
      feedback[i] = "yellow";
      realArr[idx] = "*";
    }
  }
  return feedback;
}

/*******************************************************
 * 15) BUSCAR DEFINIÇÃO => FREE DICTIONARY
 *******************************************************/
async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return "";
    const data = await res.json();
    return data[0]?.meanings?.[0]?.definitions?.[0]?.definition || "";
  } catch {
    return "";
  }
}

/*******************************************************
 * 16) BOTÃO INVITE FRIENDS
 *******************************************************/
document.getElementById("invite-button").addEventListener("click", () => {
  const shareData = {
    title: "Hannah English Course",
    text: "Come play this English word game with me!",
    url: "https://hannahenglishcourse.vercel.app/"
  };
  if (navigator.share) {
    navigator.share(shareData).catch(() => {});
  } else {
    const wUrl = "https://wa.me/?text=" + encodeURIComponent(shareData.text + " " + shareData.url);
    window.open(wUrl, "_blank");
  }
});
</script>
</body>
</html>
