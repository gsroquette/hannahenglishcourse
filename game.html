<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>English Word Guess Game</title>

  <!-- Firebase (v8.x) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* RESET BÁSICO */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      min-height: 100vh;
      font-family: Arial, sans-serif;
      /* AUMENTANDO TRANSPARÊNCIA DO FUNDO */
      background: linear-gradient(to bottom right, rgba(227,242,253,0.5), rgba(187,222,251,0.5));
      padding: 20px;
      overflow-y: auto;
    }

    /* ROBÔ NO TOPO (AGORA ESTÁTICO) */
    #robot-section {
      width: 100%;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #robot-image {
      width: 220px;
    }
    #robot-balloon {
      position: absolute;
      top: 180px; /* ajustado */
      left: 30px; /* ajustado */
      max-width: 220px;
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }
    .btn-invite {
      margin-top: 8px;
      border: none;
      background-color: #ff9800;
      color: #fff;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .btn-invite:hover {
      background-color: #fb8c00;
    }

    /* ÁREA PRINCIPAL (O JOGO, BOTÕES, ETC) */
    #main-content {
      margin-bottom: 30px; /* para dar espaço antes do top20 */
    }
    #top-controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    #difficulty-select {
      padding: 6px;
    }
    #start-game {
      background-color: #03a9f4;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #start-game:disabled {
      background-color: #bbb;
      cursor: not-allowed;
    }
    #rules-button {
      background-color: #009688;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #rules-button:hover {
      background-color: #00897b;
    }
    #player-score-display {
      font-weight: bold;
      margin-left: 10px;
    }

    /* TABULEIRO */
    #board {
      min-height: 200px;
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .attempt-row {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
      gap: 5px;
      flex-wrap: wrap;
    }
    .letter-block {
      width: 45px;
      height: 45px;
      background-color: #cfd8dc;
      border: 1px solid #999;
      border-radius: 4px;
      font-weight: bold;
      font-size: 18px;
      text-transform: uppercase;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #000;
      cursor: pointer; /* para indicar que é clicável */
    }
    .player-name {
      font-size: 14px;
      margin-left: 6px;
      font-style: italic;
      color: #666;
    }

    /* BOTÃO TRY */
    #try-button {
      margin-top: 15px;
      padding: 8px 14px;
      border: none;
      background-color: #4caf50;
      color: #fff;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }

    /* CORES DE FEEDBACK */
    .green {
      background-color: #66bb6a;
      color: #fff;
    }
    .yellow {
      background-color: #ffeb3b;
      color: #000;
    }
    .red {
      background-color: #f44336;
      color: #fff;
    }

    /* SCOREBOARD (AGORA NO FINAL) */
    #scoreboard-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
    }
    #scoreboard-section h3 {
      margin-bottom: 8px;
      text-align: center;
    }
    #score-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #score-list li {
      border-bottom: 1px solid #eee;
      padding: 4px 0;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    #score-list li span {
      font-weight: bold;
    }

    /* MOSTRADOR DE PONTOS PESSOAIS DO USUÁRIO */
    #personal-score-section {
      margin-top: 10px;
      text-align: center;
      display: none;
    }
    /* CONTADOR DE PARTIDAS VISÍVEL PARA TODOS */
    #owner-game-counter {
      margin-top: 6px;
      text-align: center;
      display: block; /* agora sempre visível */
    }

    /* RESPONSIVIDADE - até 768px */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      #robot-balloon {
        position: static;
        margin-top: 10px;
      }
      .btn-invite {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>

<!-- SEÇÃO DO ROBÔ -->
<div id="robot-section">
  <img id="robot-image" src="imagens/robo_estatico.png" alt="Robot Samuel">
  <div id="robot-balloon"></div>
  <button class="btn-invite" id="invite-button">Invite Friends</button>
</div>

<!-- ÁREA PRINCIPAL (O JOGO) -->
<div id="main-content">
  <div id="top-controls">
    <label for="difficulty-select">Difficulty:</label>
    <select id="difficulty-select">
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="hard">Hard</option>
    </select>
    <button id="start-game">Start Game</button>
    <button id="rules-button">Rules</button>
    <span id="player-score-display" style="display:none;"></span>
  </div>

  <div id="board"></div>
  <button id="try-button">Try</button>
</div>

<!-- SCOREBOARD POR ÚLTIMO -->
<div id="scoreboard-section">
  <h3>Top 20</h3>
  <ol id="score-list"></ol>

  <!-- MOSTRADOR DE PONTOS DO USUÁRIO (APENAS PARA O PRÓPRIO USUÁRIO) -->
  <div id="personal-score-section">
    <p>Your Points: <span id="personalScore"></span></p>
  </div>

  <!-- CONTADOR DE PARTIDAS (VISÍVEL PARA TODOS) -->
  <div id="owner-game-counter">
    <p>Total Games: <span id="ownerGamesCount"></span></p>
  </div>
</div>

<!-- INPUT OCULTO PARA DIGITAÇÃO NO MOBILE/DESKTOP -->
<input 
  type="text"
  id="hidden-input"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="none"
  spellcheck="false"
  style="position:absolute; left:-9999px; top:-9999px; opacity:0;"
>

<script>
/*******************************************************
 * 1) CONFIGURANDO FIREBASE
 *******************************************************/
var firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
  measurementId: "G-07VVJG9LRS"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const db = firebase.database();
const auth = firebase.auth();

/*******************************************************
 * 2) VARIÁVEIS GLOBAIS
 *******************************************************/
let dictionarySet    = new Set();
let userName         = "Guest";
let userUid          = null;
let isGuest          = true;
let userRole         = "aluno";
let currentWord      = "";
let currentStatus    = "idle";
let currentDifficulty= "easy";
let totalPoints      = 0;
let totalGames       = 0; 
let attemptsArray    = [];
let currentLetters   = [];
let activeIndex      = 0; // posição atual para digitação

const hiddenInput    = document.getElementById("hidden-input");

/*******************************************************
 * 3) CARREGAR O DICIONÁRIO
 *******************************************************/
async function loadDictionary() {
  try {
    const response = await fetch("dictionaries/words_alpha.txt");
    if (!response.ok) {
      throw new Error(`Failed to load dictionary: ${response.statusText}`);
    }
    const text = await response.text();
    dictionarySet = new Set(text.split("\n").map(word => word.trim().toLowerCase()));
  } catch (error) {
    console.error("Erro ao carregar o dicionário:", error);
  }
}
loadDictionary();

/*******************************************************
 * 4) ROBÔ E TTS
 *******************************************************/
const robotImage   = document.getElementById("robot-image");
const robotBalloon = document.getElementById("robot-balloon");
const synth        = window.speechSynthesis;

function speakText(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang  = "en-US";
  utterance.onstart = () => {
    robotImage.src = "imagens/robo_fala.gif";
    robotBalloon.textContent = text;
    robotBalloon.style.display = "block";
  };
  utterance.onend = () => {
    robotImage.src = "imagens/robo_estatico.png";
    setTimeout(() => {
      robotBalloon.style.display = "none";
    }, 800);
  };
  synth.speak(utterance);
}

const encouragementMessages = [
  "Nice attempt!",
  "Keep going!",
  "You're almost there!",
  "Don't give up!",
  "Keep trying!"
];

/*******************************************************
 * 5) BOTÃO RULES
 *******************************************************/
document.getElementById("rules-button").addEventListener("click", () => {
  alert(
    "Simple Rules of the Game:\n\n" +
    "1. A random English word is chosen.\n" +
    "2. Tap any square and type letters to form your guess.\n" +
    "3. Press 'Try' to submit.\n" +
    "4. Green = correct letter & position.\n" +
    "5. Yellow = correct letter, wrong position.\n" +
    "6. Red = letter not in the word.\n\n" +
    "Good luck!"
  );
});

/*******************************************************
 * 6) LOGIN
 *******************************************************/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    userUid   = user.uid;
    isGuest   = false;
    const snap= await db.ref("usuarios/" + userUid).once("value");
    const data= snap.val() || {};
    userName  = data.nome || data.email || "User";
    userRole  = data.role || "aluno";
    totalPoints = data.points || 0;
    totalGames  = data.gamesPlayed || 0;
  } else {
    userUid  = null;
    isGuest  = true;
    userName = "Guest";
    userRole = "guest";
    speakText("You're playing as a guest. Your progress won't be saved.");
  }
  loadScoreboard();
  listenGameState();
  showPersonalScore();
  updatePlayerScoreDisplay();
});

/*******************************************************
 * 7) ATUALIZAR EXIBIÇÃO DO SCORE (TOPO)
 *******************************************************/
function updatePlayerScoreDisplay() {
  const scoreDisplay = document.getElementById("player-score-display");
  if (!isGuest) {
    scoreDisplay.style.display = "inline-block";
    scoreDisplay.textContent   = `Your Score: ${totalPoints}`;
  } else {
    scoreDisplay.style.display = "none";
  }
}

/*******************************************************
 * 8) SCOREBOARD
 *******************************************************/
function loadScoreboard() {
  const scoreList = document.getElementById("score-list");
  db.ref("usuarios").orderByChild("points").limitToLast(20).on("value", (snap) => {
    const val = snap.val() || {};
    let arr   = [];
    Object.keys(val).forEach(uid => {
      const u = val[uid];
      const nm= u.nome || u.email || "User";
      const pts= u.points || 0;
      arr.push({ name: nm, points: pts });
    });
    arr.sort((a,b) => b.points - a.points);
    scoreList.innerHTML = "";
    arr.forEach((item, i) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${i+1}.</span> ${item.name} <span>${item.points} pts</span>`;
      scoreList.appendChild(li);
    });
  });
}

/*******************************************************
 * 9) OUVIR ESTADO DO JOGO
 *******************************************************/
function listenGameState() {
  db.ref("games/currentGame").on("value", (snap) => {
    const data = snap.val();
    if (!data) {
      currentStatus   = "idle";
      currentWord     = "";
      attemptsArray   = [];
      currentLetters  = [];
      activeIndex     = 0;
      renderAllAttempts();
      updateUI();
      return;
    }
    currentWord       = data.word || "";
    currentStatus     = data.status || "idle";
    currentDifficulty = data.difficulty || "easy";
    const attemptsObj = data.attempts || {};
    attemptsArray     = Object.keys(attemptsObj).map((key) => attemptsObj[key]);

    renderAllAttempts();
    updateUI();

    if (isGuest && !localStorage.getItem("guestMessageShown")) {
      speakText("You're playing as a guest. Your progress won't be saved.");
      localStorage.setItem("guestMessageShown", "true");
    }
  });

  // Sempre que uma nova tentativa chega
  db.ref("games/currentGame/attempts").on("child_added", (snapshot) => {
    const attempt = snapshot.val();
    if (!attemptsArray.some((a) => a.timestamp === attempt.timestamp)) {
      attemptsArray.push(attempt);
      renderAllAttempts();
    }
  });
}

/*******************************************************
 * 10) START GAME
 *******************************************************/
document.getElementById("start-game").addEventListener("click", startGame);

async function startGame() {
  if (currentStatus === "in_progress" && userRole !== "proprietario") {
    speakText("A game is already in progress. Please wait.");
    return;
  }

  // Se for proprietário, incrementa o contador
  if (userUid) {
    if (userRole === "proprietario") {
      totalGames++;
      await db.ref("usuarios/" + userUid).update({ gamesPlayed: totalGames });
    }
  }

  await db.ref("games/currentGame").remove();
  currentDifficulty = document.getElementById("difficulty-select").value;
  const chosenWord   = await pickWordWithDefinition(currentDifficulty);

  await db.ref("games/currentGame").set({
    word: chosenWord,
    status: "in_progress",
    difficulty: currentDifficulty,
    attempts: {}
  });

  speakText(`${userName} started a new game! Difficulty: ${currentDifficulty}. Good luck!`);
  if (isGuest) {
    speakText("You're playing as a guest. Your progress won't be saved.");
  }

  currentWord     = chosenWord;
  currentStatus   = "in_progress";
  currentLetters  = [];
  activeIndex     = 0;
  attemptsArray   = [];

  renderAllAttempts();
  updateUI();
  showPersonalScore();
}

/*******************************************************
 * 11) ESCOLHER PALAVRA
 *******************************************************/
async function pickWordWithDefinition(diff) {
  let minLen=3, maxLen=3;
  if (diff === "medium") { minLen=4; maxLen=5; }
  if (diff === "hard")   { minLen=6; maxLen=7; }

  const allWords = [...dictionarySet].filter(w => w.length >= minLen && w.length <= maxLen);
  if (allWords.length < 1) return "cat";

  for (let i=0; i<30; i++) {
    const cand = allWords[Math.floor(Math.random()*allWords.length)];
    if (await hasDefinition(cand)) return cand;
  }
  return allWords[Math.floor(Math.random()*allWords.length)];
}

async function hasDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return false;
    const data = await res.json();
    return !!(data[0]?.meanings?.[0]?.definitions?.[0]?.definition);
  } catch {
    return false;
  }
}

/*******************************************************
 * 12) RENDERIZAR
 *******************************************************/
function renderAllAttempts() {
  const board = document.getElementById("board");
  board.innerHTML = "";

  // Render tentativas passadas
  attemptsArray.forEach((att) => {
    const rowDiv = document.createElement("div");
    rowDiv.classList.add("attempt-row");

    let guessArr = att.guess.split("");
    guessArr.forEach((letter, i) => {
      const block = document.createElement("div");
      block.classList.add("letter-block");
      block.textContent = letter.toUpperCase();
      if (att.feedback && att.feedback[i]) {
        block.classList.add(att.feedback[i]);
      }
      rowDiv.appendChild(block);
    });

    const playerSpan = document.createElement("span");
    playerSpan.classList.add("player-name");
    playerSpan.textContent = `- ${att.playerName || "Unknown"}`;
    rowDiv.appendChild(playerSpan);

    board.appendChild(rowDiv);
  });

  // Render a linha atual se o jogo estiver ativo
  if (currentStatus === "in_progress" && currentWord) {
    const newRowDiv = document.createElement("div");
    newRowDiv.classList.add("attempt-row");
    for (let i = 0; i < currentWord.length; i++) {
      const block = document.createElement("div");
      block.classList.add("letter-block");
      block.textContent = currentLetters[i] ? currentLetters[i].toUpperCase() : "";

      // Ao clicar, mudamos a posição ativa e focamos no hidden input
      block.addEventListener("click", () => {
        activeIndex = i;
        hiddenInput.focus();
      });

      newRowDiv.appendChild(block);
    }
    board.appendChild(newRowDiv);
  }
}

/*******************************************************
 * 13) UPDATE UI
 *******************************************************/
function updateUI() {
  const startBtn = document.getElementById("start-game");
  const tryBtn   = document.getElementById("try-button");

  if (currentStatus === "in_progress" && userRole !== "proprietario") {
    startBtn.disabled = true;
  } else {
    startBtn.disabled = false;
  }

  if (currentStatus === "in_progress") {
    tryBtn.disabled = false;
    hiddenInput.focus(); 
  } else {
    tryBtn.disabled = true;
  }
}

/*******************************************************
 * 14) INPUT EVENT (PARA MOBILE E DESKTOP)
 *******************************************************/
// Quando digitamos algo no hiddenInput
hiddenInput.addEventListener("input", (e) => {
  if (currentStatus !== "in_progress" || !currentWord) return;
  const val = e.target.value;
  if (!val) return; // se estiver vazio, ignore

  // Pegamos apenas o último char digitado
  const char = val[val.length - 1].toLowerCase();
  if (char.match(/[a-z]/i)) {
    currentLetters[activeIndex] = char;
    if (activeIndex < currentWord.length - 1) {
      activeIndex++;
    }
    e.target.value = ""; 
    renderAllAttempts();
  } else {
    // se for algo que não é letra, limpamos
    e.target.value = "";
  }
});

// Para backspace e Enter
hiddenInput.addEventListener("keydown", (e) => {
  if (currentStatus !== "in_progress" || !currentWord) return;
  if (e.key === "Backspace") {
    e.preventDefault();
    if (currentLetters[activeIndex]) {
      // se o bloco atual tiver letra, limpe
      currentLetters[activeIndex] = "";
    } else if (activeIndex > 0) {
      // senão, volte um
      activeIndex--;
      currentLetters[activeIndex] = "";
    }
    renderAllAttempts();
  }
  if (e.key === "Enter") {
    e.preventDefault();
    submitCurrentRow();
  }
});

/*******************************************************
 * 15) BOTÃO TRY
 *******************************************************/
document.getElementById("try-button").addEventListener("click", () => {
  if (currentStatus !== "in_progress") {
    speakText("No active game right now.");
    return;
  }
  submitCurrentRow();
});

/*******************************************************
 * 16) SUBMETER TENTATIVA
 *******************************************************/
async function submitCurrentRow() {
  if (!currentWord || currentLetters.length !== currentWord.length) {
    speakText(`You must fill exactly ${currentWord.length} letters!`);
    return;
  }

  const guessClean = currentLetters.join("").toLowerCase();
  if (!dictionarySet.has(guessClean)) {
    speakText("That word is not in our dictionary!");
    return;
  }

  const feedback = getFeedback(guessClean, currentWord);
  const pushRef  = db.ref("games/currentGame/attempts").push();
  await pushRef.set({
    guess: guessClean,
    feedback,
    playerName: isGuest ? "Guest" : userName,
    timestamp: Date.now()
  });

  currentLetters = [];
  activeIndex    = 0;

  if (feedback.every(c => c === "green")) {
    const definition = await getDefinition(guessClean);
    let msg = `Congratulations, ${isGuest ? "Guest" : userName}! You found the word "${guessClean}".`;
    if (definition) msg += ` Definition: ${definition}`;
    speakText(msg);

    if (!isGuest && userUid) {
      let pts = 10;
      if (currentDifficulty === "medium") pts = 20;
      if (currentDifficulty === "hard")   pts = 35;
      totalPoints += pts;
      await db.ref("usuarios/" + userUid).update({ points: totalPoints });
      showPersonalScore();
      updatePlayerScoreDisplay();
    }

    db.ref("games/currentGame").update({ status: "ended" });
  } else {
    const randomMsg = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
    speakText(randomMsg);
  }

  renderAllAttempts();
}

/*******************************************************
 * 17) FEEDBACK (green, yellow, red)
 *******************************************************/
function getFeedback(guess, realWord) {
  const feedback = Array(guess.length).fill("red");
  const realArr  = realWord.split("");

  // Green
  for (let i=0; i<guess.length; i++) {
    if (guess[i] === realArr[i]) {
      feedback[i] = "green";
      realArr[i]  = "*";
    }
  }
  // Yellow
  for (let i=0; i<guess.length; i++) {
    if (feedback[i] === "green") continue;
    const idx = realArr.indexOf(guess[i]);
    if (idx !== -1) {
      feedback[i] = "yellow";
      realArr[idx]= "*";
    }
  }
  return feedback;
}

/*******************************************************
 * 18) DEFINIÇÃO
 *******************************************************/
async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return "";
    const data = await res.json();
    return data[0]?.meanings?.[0]?.definitions?.[0]?.definition || "";
  } catch {
    return "";
  }
}

/*******************************************************
 * 19) CONVITE
 *******************************************************/
document.getElementById("invite-button").addEventListener("click", () => {
  const shareData = {
    title: "Hannah English Course",
    text: "Come play this English word game with me!",
    url: "https://hannahenglishcourse.vercel.app/"
  };
  if (navigator.share) {
    navigator.share(shareData).catch(() => {});
  } else {
    const wUrl = "https://wa.me/?text=" + encodeURIComponent(shareData.text + " " + shareData.url);
    window.open(wUrl, "_blank");
  }
});

/*******************************************************
 * 20) MOSTRAR PONTOS & CONTADOR PARTIDAS
 *******************************************************/
function showPersonalScore() {
  const personalScoreSection = document.getElementById("personal-score-section");
  const ownerCounterSection  = document.getElementById("owner-game-counter");

  // Sempre mostra o contador de partidas (para todos)
  document.getElementById("ownerGamesCount").textContent = totalGames;

  // Se não é guest, mostra pontuação
  if (!isGuest) {
    personalScoreSection.style.display = "block";
    document.getElementById("personalScore").textContent = totalPoints;
  } else {
    personalScoreSection.style.display = "none";
  }
}
</script>
</body>
</html>
