<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>English Word Guess Game</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #e3f2fd, #bbdefb);
      padding: 20px;
    }

    /* Main container */
    #game-container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      background-color: #fafafa;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      border-radius: 8px;
      overflow: hidden;
    }

    /* Robot section (left) */
    #robot-section {
      width: 200px;
      background: #fff;
      padding: 20px;
      position: relative;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #robot-image {
      width: 120px;
      margin-bottom: 10px;
    }
    #robot-balloon {
      position: absolute;
      top: 20px;
      left: 180px;
      max-width: 230px;
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      display: none;
    }
    .btn-invite {
      margin-top: 20px;
      border: none;
      background-color: #ff9800;
      color: #fff;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .btn-invite:hover {
      background-color: #fb8c00;
    }

    /* Board section (center) */
    #board-section {
      flex: 1;
      padding: 20px;
    }
    #difficulty-container {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      gap: 10px;
    }
    #difficulty-select {
      padding: 6px;
    }
    #start-game {
      background-color: #03a9f4;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #start-game:hover {
      background-color: #0288d1;
    }

    #board {
      min-height: 200px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .attempt-row {
      display: flex;
      margin-bottom: 5px;
      justify-content: flex-start;
      gap: 5px;
    }

    .letter-block {
      width: 45px;
      height: 45px;
      background-color: #cfd8dc;
      border: 1px solid #999;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      font-weight: bold;
      font-size: 18px;
      color: #000;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      transition: transform 0.1s;
    }
    .letter-block:hover {
      transform: translate(-2px, -2px);
    }

    /* Colors feedback */
    .correct {
      background-color: #66bb6a; 
      color: #fff; 
    }
    .exists {
      background-color: #ffeb3b;
      color: #000;
    }
    .wrong {
      background-color: #f44336;
      color: #fff;
    }

    .player-label {
      margin-top: 5px;
      font-size: 14px;
      font-style: italic;
      color: #666;
    }

    /* Scoreboard (right) */
    #scoreboard-section {
      width: 250px;
      background: #fff;
      border-left: 1px solid #ddd;
      padding: 20px;
    }
    #scoreboard-section h3 {
      margin-bottom: 10px;
      text-align: center;
    }
    #score-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #score-list li {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    #score-list li span {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="game-container">
  <!-- LEFT: Robot -->
  <div id="robot-section">
    <img id="robot-image" src="imagens/robo_estatico.png" alt="Robot Samuel">
    <div id="robot-balloon"></div>
    <button class="btn-invite" id="invite-button">Invite Friends</button>
  </div>

  <!-- CENTER: Board -->
  <div id="board-section">
    
    <!-- Difficulty + Start -->
    <div id="difficulty-container">
      <label for="difficulty-select">Choose difficulty:</label>
      <select id="difficulty-select">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
      <button id="start-game">Start Game</button>
    </div>

    <!-- Where attempts (rows) appear -->
    <div id="board"></div>
  </div>

  <!-- RIGHT: Scoreboard -->
  <div id="scoreboard-section">
    <h3>Top 20</h3>
    <ol id="score-list"></ol>
  </div>
</div>

<script>
/******************************************************
 * 1) FIREBASE CONFIG (Your exact keys)
 ******************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
  measurementId: "G-07VVJG9LRS",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

/******************************************************
 * 2) GLOBAL VARIABLES
 ******************************************************/
// Local dictionary. You can expand with more words.
const WORDS = {
  easy:   ["fire", "chair", "apple", "water", "light"],
  medium: ["coffee", "orange", "banana", "purple", "flight"],
  hard:   ["software", "question", "terrible", "mountain", "elephant"]
};

let chosenWord      = ""; // The target word
let currentRow      = 0;  // Which row the user is editing
let currentCol      = 0;  // Which col within the row
let maxAttempts     = 30; // Arbitrary high, so we build a "tower" if needed
let rowBlocks       = []; // Will hold arrays of divs for each row
let userName        = "Guest";
let userUid         = null; 
let isGuest         = true;
let totalPoints     = 0;
let difficulty      = "easy";

const robotImage     = document.getElementById("robot-image");
const robotBalloon   = document.getElementById("robot-balloon");
const synth          = window.speechSynthesis;
const boardEl        = document.getElementById("board");
const scoreboardList = document.getElementById("score-list");

/******************************************************
 * 3) SPEECH
 ******************************************************/
function speakText(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "en-US";

  utterance.onstart = () => {
    robotImage.src = "imagens/robo_fala.gif";
    robotBalloon.textContent = text;
    robotBalloon.style.display = "block";
  };
  utterance.onend = () => {
    robotImage.src = "imagens/robo_estatico.png";
    setTimeout(() => {
      robotBalloon.style.display = "none";
    }, 700);
  };
  synth.speak(utterance);
}

/******************************************************
 * 4) CHECK AUTH
 ******************************************************/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    isGuest = false;
    userUid = user.uid;
    const snap = await db.ref("usuarios/" + userUid).once("value");
    const data = snap.val() || {};
    userName  = data.nome || data.email || "User";
    totalPoints = data.points || 0;
  } else {
    isGuest = true;
    userName = "Guest";
    userUid  = null;
  }
  loadScoreboard();
});

/******************************************************
 * 5) SCOREBOARD
 ******************************************************/
function loadScoreboard() {
  scoreboardList.innerHTML = "...";
  db.ref("usuarios").orderByChild("points").limitToLast(20).on("value", (snap) => {
    const val = snap.val() || {};
    const arr = [];
    Object.keys(val).forEach((uid) => {
      const u = val[uid];
      const nm = u.nome || u.email || "Unknown";
      const pts= u.points || 0;
      arr.push({ name: nm, points: pts });
    });
    // Sort descending
    arr.sort((a,b) => b.points - a.points);

    scoreboardList.innerHTML = "";
    arr.forEach((item, idx) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${idx+1}.</span> ${item.name} <span>${item.points} pts</span>`;
      scoreboardList.appendChild(li);
    });
  });
}

/******************************************************
 * 6) PICK WORD AND BUILD INITIAL ROW
 ******************************************************/
function startGame() {
  difficulty = document.getElementById("difficulty-select").value;
  const dict = WORDS[difficulty];
  chosenWord = dict[Math.floor(Math.random() * dict.length)].toLowerCase();

  // Clear old data
  rowBlocks = [];
  boardEl.innerHTML = "";
  currentRow = 0;
  currentCol = 0;

  speakText(`Hello, ${userName}. Difficulty is ${difficulty}. The word has ${chosenWord.length} letters. Let's play!`);

  // Create the first row right away
  createRow();
}

/******************************************************
 * 7) CREATE A NEW ROW OF BLOCKS
 ******************************************************/
function createRow() {
  const rowDiv = document.createElement("div");
  rowDiv.classList.add("attempt-row");

  const blocksArr = [];
  for (let i = 0; i < chosenWord.length; i++) {
    const block = document.createElement("div");
    block.classList.add("letter-block");
    block.textContent = ""; 
    rowDiv.appendChild(block);
    blocksArr.push(block);
  }
  boardEl.appendChild(rowDiv);
  rowBlocks.push(blocksArr);

  // We can show player's name on the side if you want:
  const playerLabel = document.createElement("div");
  playerLabel.classList.add("player-label");
  playerLabel.textContent = `- Attempt by ${userName}`;
  rowDiv.appendChild(playerLabel);
}

/******************************************************
 * 8) HANDLE KEYBOARD FOR FILLING BLOCKS
 ******************************************************/
document.addEventListener("keydown", (e) => {
  // If no chosenWord, do nothing
  if (!chosenWord) return;

  // If we've already built too many rows, do nothing
  if (currentRow >= maxAttempts) return;

  // Get current row blocks
  const blocks = rowBlocks[currentRow];
  if (!blocks) return;

  // Letters A-Z
  if (e.key.match(/^[a-z]$/i) && currentCol < chosenWord.length) {
    blocks[currentCol].textContent = e.key.toUpperCase();
    currentCol++;
  }
  // Backspace
  else if (e.key === "Backspace" && currentCol > 0) {
    currentCol--;
    blocks[currentCol].textContent = "";
  }
  // Enter => submit attempt
  else if (e.key === "Enter") {
    // If row not fully filled, ignore
    if (currentCol < chosenWord.length) {
      speakText("Please fill all letters!");
      return;
    }
    submitRow();
  }
});

/******************************************************
 * 9) SUBMIT ROW => CHECK WORD
 ******************************************************/
async function submitRow() {
  const blocks = rowBlocks[currentRow];
  const guess = blocks.map(b => b.textContent.toLowerCase()).join("");

  // 9.1 Validate if guess is in dictionary
  if (!isValidWord(guess)) {
    speakText("This word doesn't exist in our dictionary!");
    return;
  }

  // 9.2 Color feedback
  const feedback = getFeedback(guess, chosenWord);
  for (let i = 0; i < feedback.length; i++) {
    if (feedback[i] === "green") blocks[i].classList.add("correct");
    else if (feedback[i] === "yellow") blocks[i].classList.add("exists");
    else blocks[i].classList.add("wrong");
  }

  // 9.3 Check if success
  const allGreen = feedback.every(f => f === "green");
  if (allGreen) {
    // Definition
    const definition = await getDefinition(guess);
    let msg = `Congratulations, ${userName}! You found the word "${guess}".`;
    if (definition) msg += ` Definition: ${definition}`;
    speakText(msg);

    // Points
    let pts = 10;
    if (difficulty === "medium") pts = 20;
    if (difficulty === "hard")   pts = 30;
    if (!isGuest && userUid) {
      totalPoints += pts;
      await db.ref("usuarios/" + userUid).update({ points: totalPoints });
    }

    // Start new game after short delay
    setTimeout(startGame, 3000);
    return;
  }

  // Not all green => motivational
  const motivational = [
    "Almost there, NAME! Keep trying!",
    "Nice try, NAME! You're getting closer!",
    "Don't give up, NAME! You can do it!",
    "You're on the right track, NAME!",
    "Stay focused, NAME! You're doing great!"
  ];
  const rIndex = Math.floor(Math.random() * motivational.length);
  const phrase = motivational[rIndex].replace("NAME", userName);
  speakText(phrase);

  // Create new row
  currentRow++;
  currentCol = 0;
  createRow();
}

/******************************************************
 * 10) CHECK WORD AGAINST LOCAL DICTIONARY
 ******************************************************/
function isValidWord(w) {
  w = w.toLowerCase();
  const all = [...WORDS.easy, ...WORDS.medium, ...WORDS.hard].map(x=>x.toLowerCase());
  return all.includes(w);
}

/******************************************************
 * 11) COLOR FEEDBACK
 ******************************************************/
function getFeedback(guess, real) {
  const feedback = Array(guess.length).fill("");
  const guessLetters = guess.split("");
  const realLetters  = real.split("");

  // Mark greens
  for (let i = 0; i < guessLetters.length; i++) {
    if (guessLetters[i] === realLetters[i]) {
      feedback[i] = "green";
      realLetters[i] = "*"; // used
      guessLetters[i] = "#"; 
    }
  }
  // Mark yellows/reds
  for (let i = 0; i < guessLetters.length; i++) {
    if (guessLetters[i] === "#") continue; // already green
    const idx = realLetters.indexOf(guessLetters[i]);
    if (idx !== -1) {
      feedback[i] = "yellow";
      realLetters[idx] = "*";
    } else {
      feedback[i] = "red";
    }
  }
  return feedback;
}

/******************************************************
 * 12) FREE DICTIONARY API
 ******************************************************/
async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    const def = data[0]?.meanings?.[0]?.definitions?.[0]?.definition || "";
    return def;
  } catch {
    return "";
  }
}

/******************************************************
 * 13) INVITE FRIENDS
 ******************************************************/
function inviteFriends() {
  const shareData = {
    title: "Hannah English Course",
    text: "Come play this English word game with me!",
    url: "https://hannahenglishcourse.vercel.app/"
  };
  if (navigator.share) {
    navigator.share(shareData).catch(() => {});
  } else {
    // fallback: WhatsApp
    const wUrl = "https://wa.me/?text=" + encodeURIComponent(shareData.text + " " + shareData.url);
    window.open(wUrl, "_blank");
  }
}
document.getElementById("invite-button").addEventListener("click", inviteFriends);

/******************************************************
 * 14) START GAME ON BUTTON CLICK
 ******************************************************/
document.getElementById("start-game").addEventListener("click", startGame);
</script>
</body>
</html>
