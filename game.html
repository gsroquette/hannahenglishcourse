<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>English Word Guess Game</title>
  
  <!-- Firebase v8.x -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* ===== Reset básico ===== */
    * {
      margin: 0; 
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, #e3f2fd, #bbdefb);
      padding: 20px;
    }

    /* ===== Container principal ===== */
    #game-container {
      width: 100%;
      max-width: 1200px;
      display: flex;
      background-color: #fafafa;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      border-radius: 8px;
      overflow: hidden;
    }

    /* ===== Seção do robô (esquerda) ===== */
    #robot-section {
      width: 200px;
      background: #fff;
      padding: 20px;
      position: relative;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #robot-image {
      width: 120px;
      margin-bottom: 10px;
    }
    #robot-balloon {
      position: absolute;
      top: 20px;
      left: 180px;
      max-width: 230px;
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      display: none;
    }
    .btn-invite {
      margin-top: 20px;
      border: none;
      background-color: #ff9800;
      color: #fff;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    .btn-invite:hover {
      background-color: #fb8c00;
    }

    /* ===== Seção do jogo (centro) ===== */
    #board-section {
      flex: 1;
      padding: 20px;
    }
    #top-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    #difficulty-select {
      padding: 6px;
    }
    #start-game {
      background-color: #03a9f4;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #start-game:hover {
      background-color: #0288d1;
    }

    #board {
      min-height: 200px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .attempt-row {
      display: flex;
      margin-bottom: 5px;
      justify-content: flex-start;
      gap: 5px;
    }

    .letter-block {
      width: 45px;
      height: 45px;
      background-color: #cfd8dc;
      border: 1px solid #999;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      font-weight: bold;
      font-size: 18px;
      color: #000;
      box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }

    /* Cores de feedback */
    .green {
      background-color: #66bb6a; 
      color: #fff;
    }
    .yellow {
      background-color: #ffeb3b;
      color: #000;
    }
    .red {
      background-color: #f44336;
      color: #fff;
    }

    /* Botão TRY */
    #try-button {
      background-color: #4caf50;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    #try-button:hover {
      background-color: #388e3c;
    }

    /* ===== Seção do placar (direita) ===== */
    #scoreboard-section {
      width: 250px;
      background: #fff;
      border-left: 1px solid #ddd;
      padding: 20px;
    }
    #scoreboard-section h3 {
      margin-bottom: 10px;
      text-align: center;
    }
    #score-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #score-list li {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    #score-list li span {
      font-weight: bold;
    }
  </style>
</head>
<body>

<div id="game-container">

  <!-- ESQUERDA: ROBÔ -->
  <div id="robot-section">
    <img id="robot-image" src="imagens/robo_estatico.png" alt="Robot Samuel">
    <div id="robot-balloon"></div>
    <button class="btn-invite" id="invite-button">Invite Friends</button>
  </div>

  <!-- CENTRO: BOARD -->
  <div id="board-section">
    <div id="top-controls">
      <label for="difficulty-select">Difficulty:</label>
      <select id="difficulty-select">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
      <button id="start-game">Start Game</button>
      <!-- Botão TRY -->
      <button id="try-button">Try</button>
    </div>
    <div id="board"></div>
  </div>

  <!-- DIREITA: PLACAR -->
  <div id="scoreboard-section">
    <h3>Top 20</h3>
    <ol id="score-list"></ol>
  </div>

</div>

<script>
/*****************************************************
 * 1) FIREBASE CONFIG (SUAS CHAVES)
 *****************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
  measurementId: "G-07VVJG9LRS"
};
firebase.initializeApp(firebaseConfig);

const db   = firebase.database();
const auth = firebase.auth();

/*****************************************************
 * 2) VARIÁVEIS GLOBAIS
 *****************************************************/
let dictionarySet = new Set();  // Carregado de words_alpha.txt
let chosenWord    = "";         // Palavra escolhida para a rodada
let rowBlocks     = [];         // Cada linha de blocos
let currentRow    = 0;          // Linha atual
let currentCol    = 0;          // Coluna atual (bloco)
let userName      = "Guest";
let userUid       = null;
let isGuest       = true;
let totalPoints   = 0;
let difficulty    = "easy";

// Robot
const robotImage   = document.getElementById("robot-image");
const robotBalloon = document.getElementById("robot-balloon");
const synth        = window.speechSynthesis;

// Elementos
const boardEl      = document.getElementById("board");
const scoreboardEl = document.getElementById("score-list");

/*****************************************************
 * 3) CARREGAR DICIONÁRIO (words_alpha.txt)
 *****************************************************/
async function loadDictionary() {
  try {
    const response = await fetch("dictionaries/words_alpha.txt");
    if (!response.ok) throw new Error("Failed to load dictionary file.");
    const text = await response.text();
    const words = text.split("\n").map(w => w.trim().toLowerCase()).filter(Boolean);
    dictionarySet = new Set(words);
    console.log("Dictionary loaded:", dictionarySet.size, "words");
  } catch (err) {
    console.error("Error loading dictionary:", err);
  }
}

/*****************************************************
 * 4) AUTH STATE (para saber se é Guest ou usuário)
 *****************************************************/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    isGuest = false;
    userUid = user.uid;
    const snap = await db.ref("usuarios/" + userUid).once("value");
    const data = snap.val() || {};
    userName   = data.nome || data.email || "User";
    totalPoints= data.points || 0;
  } else {
    isGuest = true;
    userName= "Guest";
    userUid = null;
  }
  loadScoreboard();
});

/*****************************************************
 * 5) PLACAR TOP 20
 *****************************************************/
function loadScoreboard() {
  scoreboardEl.innerHTML = "...";
  db.ref("usuarios").orderByChild("points").limitToLast(20).on("value", (snap) => {
    const val = snap.val() || {};
    let arr = [];
    Object.keys(val).forEach((uid) => {
      const u = val[uid];
      const nm= u.nome || u.email || "Unknown";
      const pts= u.points || 0;
      arr.push({ name: nm, points: pts });
    });
    // Ordenar decrescente
    arr.sort((a,b) => b.points - a.points);

    scoreboardEl.innerHTML = "";
    arr.forEach((item, idx) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${idx+1}.</span> ${item.name} <span>${item.points} pts</span>`;
      scoreboardEl.appendChild(li);
    });
  });
}

/*****************************************************
 * 6) ESCOLHER PALAVRA (com definição garantida)
 *****************************************************/
async function pickWordWithDefinition() {
  // Faz um filtro simples de tamanho (4 a 8 letras) para não ficar muito grande
  const candidates = [...dictionarySet].filter(w => w.length >= 4 && w.length <= 8);
  // Tentamos no máximo 50 vezes achar uma com definição
  for (let i = 0; i < 50; i++) {
    const randomWord = candidates[Math.floor(Math.random() * candidates.length)].toLowerCase();
    const defOk = await hasDefinition(randomWord);
    if (defOk) {
      return randomWord;
    }
  }
  // Se não achou nenhuma com definição, pega qualquer uma
  return candidates[Math.floor(Math.random() * candidates.length)];
}

/*****************************************************
 * 7) VERIFICAR SE TEM DEFINIÇÃO NA FREE DICTIONARY
 *****************************************************/
async function hasDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return false;
    const data = await res.json();
    // Verifica se realmente tem algo
    if (!data || !data[0]?.meanings?.[0]?.definitions?.[0]?.definition) return false;
    return true;
  } catch (err) {
    return false;
  }
}

/*****************************************************
 * 8) START GAME
 *****************************************************/
async function startGame() {
  boardEl.innerHTML = "";
  rowBlocks = [];
  currentRow = 0;
  currentCol = 0;
  difficulty = document.getElementById("difficulty-select").value;

  speakText(`Hello, ${userName}. Difficulty is ${difficulty}. Please wait while I pick a word...`);

  chosenWord = await pickWordWithDefinition();
  console.log("Chosen word:", chosenWord); // debug

  // Cria a primeira linha de blocos
  createRow();
  speakText(`I have chosen a word with ${chosenWord.length} letters. Type your guess and press Try!`);
}

/*****************************************************
 * 9) CRIAR LINHA DE BLOCOS
 *****************************************************/
function createRow() {
  const rowDiv = document.createElement("div");
  rowDiv.classList.add("attempt-row");

  const blocksArr = [];
  for (let i = 0; i < chosenWord.length; i++) {
    const block = document.createElement("div");
    block.classList.add("letter-block");
    block.textContent = "";
    rowDiv.appendChild(block);
    blocksArr.push(block);
  }

  boardEl.appendChild(rowDiv);
  rowBlocks.push(blocksArr);
}

/*****************************************************
 * 10) DIGITAR LETRAS
 *****************************************************/
document.addEventListener("keydown", (e) => {
  // Se não temos chosenWord, não faz nada
  if (!chosenWord) return;

  // Linha atual
  const blocks = rowBlocks[currentRow];
  if (!blocks) return;

  // Entrada A-Z
  if (e.key.match(/^[a-z]$/i) && currentCol < chosenWord.length) {
    blocks[currentCol].textContent = e.key.toUpperCase();
    currentCol++;
  }
  // Backspace
  else if (e.key === "Backspace" && currentCol > 0) {
    currentCol--;
    blocks[currentCol].textContent = "";
  }
  // Se digitar Enter, faz "submitRow()"
  else if (e.key === "Enter") {
    submitRow();
  }
});

/*****************************************************
 * 11) BOTÃO TRY
 *****************************************************/
document.getElementById("try-button").addEventListener("click", () => {
  submitRow();
});

/*****************************************************
 * 12) SUBMIT ROW
 *****************************************************/
async function submitRow() {
  const blocks = rowBlocks[currentRow];
  if (!blocks) return;

  // Verifica se todos os blocos estão preenchidos
  for (let i = 0; i < blocks.length; i++) {
    if (!blocks[i].textContent.trim()) {
      speakText("Please fill all letters first!");
      return;
    }
  }

  // Monta a string do palpite
  const guess = blocks.map(b => b.textContent.toLowerCase()).join("");
  // Checa se existe no dicionário
  if (!dictionarySet.has(guess)) {
    speakText("That word is not in our dictionary. Try again!");
    return;
  }

  // Aplica o feedback
  const feedback = getFeedback(guess, chosenWord);
  for (let i = 0; i < feedback.length; i++) {
    blocks[i].classList.add(feedback[i]);
  }

  // Verifica se acertou tudo
  const allGreen = feedback.every(c => c === "green");
  if (allGreen) {
    // Buscar definição
    const definition = await getDefinition(guess);
    let msg = `Congratulations, ${userName}! You found the word "${guess}".`;
    if (definition) {
      msg += ` Definition: ${definition}`;
    }
    speakText(msg);

    // Pontos
    let points = 10;
    if (difficulty === "medium") points = 20;
    if (difficulty === "hard")   points = 30;
    if (!isGuest && userUid) {
      totalPoints += points;
      await db.ref("usuarios/" + userUid).update({ points: totalPoints });
    }

    // Inicia novo jogo
    setTimeout(startGame, 3000);
  } else {
    // Frase motivacional
    const phrases = [
      "Almost there, NAME! Keep trying!",
      "Nice try, NAME! You're getting closer!",
      "Don't give up, NAME! You can do it!",
      "You're on the right track, NAME!",
      "Stay focused, NAME! You're doing great!"
    ];
    const idx = Math.floor(Math.random() * phrases.length);
    const phrase = phrases[idx].replace("NAME", userName);
    speakText(phrase);

    // Cria nova linha
    currentRow++;
    currentCol = 0;
    createRow();
  }
}

/*****************************************************
 * 13) FEEDBACK DE CORES
 *****************************************************/
function getFeedback(guess, real) {
  // feedback[i] = "green" | "yellow" | "red"
  const feedback = Array(guess.length).fill("red");
  const realArr  = real.split("");

  // Marcar green
  for (let i = 0; i < guess.length; i++) {
    if (guess[i] === realArr[i]) {
      feedback[i] = "green";
      realArr[i] = "*"; // remove do "estoque"
    }
  }

  // Marcar yellow
  for (let i = 0; i < guess.length; i++) {
    if (feedback[i] === "green") continue;
    const char = guess[i];
    const idx  = realArr.indexOf(char);
    if (idx !== -1) {
      feedback[i] = "yellow";
      realArr[idx] = "*";
    }
  }
  return feedback;
}

/*****************************************************
 * 14) GET DEFINITION (FREE DICTIONARY)
 *****************************************************/
async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    if (!res.ok) return "";
    const data = await res.json();
    return data[0]?.meanings?.[0]?.definitions?.[0]?.definition || "";
  } catch {
    return "";
  }
}

/*****************************************************
 * 15) FALA DO ROBÔ
 *****************************************************/
function speakText(text) {
  if (!text) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "en-US";

  utterance.onstart = () => {
    robotImage.src = "imagens/robo_fala.gif";
    robotBalloon.textContent = text;
    robotBalloon.style.display = "block";
  };
  utterance.onend = () => {
    robotImage.src = "imagens/robo_estatico.png";
    setTimeout(() => {
      robotBalloon.style.display = "none";
    }, 800);
  };
  synth.speak(utterance);
}

/*****************************************************
 * 16) COMPARTILHAR (INVITE FRIENDS)
 *****************************************************/
document.getElementById("invite-button").addEventListener("click", () => {
  const shareData = {
    title: "Hannah English Course",
    text: "Come play this English word game with me!",
    url: "https://hannahenglishcourse.vercel.app/"
  };
  if (navigator.share) {
    navigator.share(shareData).catch(() => {});
  } else {
    // fallback: WhatsApp
    const wUrl = "https://wa.me/?text=" + encodeURIComponent(shareData.text + " " + shareData.url);
    window.open(wUrl, "_blank");
  }
});

/*****************************************************
 * 17) ON LOAD
 *****************************************************/
document.addEventListener("DOMContentLoaded", async () => {
  await loadDictionary();
  // Assim que carrega o dicionário, o usuário pode clicar em "Start Game"
});
document.getElementById("start-game").addEventListener("click", startGame);

</script>
</body>
</html>
