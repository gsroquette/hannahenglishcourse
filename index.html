<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah English - Learning English through Bible Stories</title>
  <!-- Favicon padr√£o -->
  <link rel="icon" type="image/x-icon" href="favicon.ico"/>

  <!-- Favicon para navegadores com tamanhos espec√≠ficos -->
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/>

  <!-- Favicon para Android (Web App Manifest) -->
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png"/>

  <!-- √çcone para dispositivos Apple -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>

  <link rel="stylesheet" href="CSS/styles.css"/>
  <!-- Manifesto para PWA -->
  <link rel="manifest" href="manifest.json"/>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* Remove o fundo do body e ajusta para o container */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: auto;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
      position: relative;
      background-image: url('imagens/fundo.png');
      background-repeat: repeat;
      background-size: 200%;
      overflow: auto;
    }

.subtitle {
  margin-top: 40px;
  font-family: Arial, sans-serif;
  font-size: 24px;
  font-weight: bold;
  color: #333;
  text-align: center;
}    

    html, body {
      height: 100%;
    }

    .levels {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }

    .level-button {
      width: 200px;
      height: 200px;
      background-size: cover;
      background-repeat: no-repeat;
      display: inline-block;
    }

    .level0 { background-image: url('imagens/Level0_button.png'); }
    .levelA { background-image: url('imagens/levelA.png'); }
    .levelB { background-image: url('imagens/levelB.png'); }
    .levelC { background-image: url('imagens/levelC.png'); }
    .levelD { background-image: url('imagens/levelD.png'); }
    
    /* Estilo da caixa de login */
    .login-container {
      display: flex;
      align-items: center;
      gap: 10px;
      position: absolute;
      top: 20px;
      right: 60px;
      z-index: 10;
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .user-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-name {
      font-size: 14px;
      color: #333;
      margin: 0;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 0;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1;
      border-radius: 4px;
      min-width: 150px;
    }

    .dropdown a {
      display: block;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-size: 16px;
      text-align: left;
    }

    .dropdown a:hover {
      background-color: #f2f2f2;
    }

    /* Cont√™iner para o rob√¥ e bot√£o (logo abaixo do t√≠tulo) */
    .robo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px auto;
    }

    .robo-img {
      width: 300px;
      height: auto;
      cursor: default;
    }

    .play-button {
      margin-top: -40px;
      padding: 8px 16px;
      border: 2px solid #ccc;
      border-radius: 20px;
      background-color: #fff;
      color: #000; 
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .play-button:hover {
      background-color: #eee;
    }

.invitation-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin: 20px 0;
}

.invitation-button, .free-games-button {
  max-width: 40%;
  height: auto;
  cursor: pointer;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.invitation-button:hover, .free-games-button:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

/* --- Bot√£o flutuante de instala√ß√£o do PWA --- */
#installBtn {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  background-color: #007bff;
  color: #fff;
  border: none;
  padding: 10px 15px;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  cursor: pointer;
  font-size: 16px;
}
#installBtn:hover {
  background-color: #0056b3;
}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <!-- Cont√™iner para login ou √≠cone de usu√°rio -->
      <div class="login-container" id="loginContainer">
        <a href="Formulario/login.html" class="login-button" id="loginLink">Login</a>
        <div class="dropdown" id="userDropdown"></div>
      </div>

      <div class="logo-title">
        <img src="imagens/hannah_logo.png" alt="Hannah English Logo" class="logo"/>
        <h1>Hannah English<br>Learning English through Bible Stories</h1>
      </div>
    </header>

    <!-- ROB√î e BOT√ÉO PLAY -->
    <div class="robo-container" id="roboContainer">
      <img src="imagens/robo_estatico.png" alt="Rob√¥" class="robo-img" id="roboImage">
      <button class="play-button" id="playTTSBtn">
        <span>‚ñ∂</span> Play
      </button>
    </div>

    <!-- CONVITE -->
    <div class="invitation-container" id="invitationContainer">
      <img src="imagens/convite.gif" 
           alt="Convite Animado" 
           class="invitation-button" 
           id="invitationButton"/>
      <img src="imagens/Free_Games.gif" 
           alt="Jogos Gr√°tis" 
           class="free-games-button" 
           id="freeGamesButton"/>
    </div>

    <main>          
      <h2 class="subtitle" id="subtitleLoggedOut">Login and Start Learning English While Playing</h2>
      <h2 class="subtitle" id="subtitleLoggedIn" style="display: none;">Choose your level and Start Learning English While Playing</h2>

      <div class="levels">
        <a href="Level0/index.html" class="level-button level0" id="Level0"></a>
        <a href="Level1/index.html" class="level-button levelA" id="Level1"></a>
        <a href="Level2/index.html" class="level-button levelB" id="Level2"></a>
        <a href="Level3/index.html" class="level-button levelC" id="Level3"></a>
        <a href="Level4/index.html" class="level-button levelD" id="Level4"></a>
      </div>
    </main>
  </div>

  <!-- Bot√£o flutuante de instala√ß√£o do PWA -->
  <button id="installBtn">üì≤ Instalar App</button>

  <!-- Firebase Auth Script -->
  <script>
    // ------------------------------------------------------
    // 1) Configura√ß√£o do Firebase
    // ------------------------------------------------------
    var firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId: "G-07VVJG9LRS"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    // ------------------------------------------------------
    // 2) Vari√°veis globais TTS + PWA
    // ------------------------------------------------------
    let englishVoice = null;     
    let hasEnglishVoice = false; 
    let deferredPrompt; // <-- para instala√ß√£o PWA

    // ------------------------------------------------------
    // 3) Fun√ß√£o para buscar voz em ingl√™s
    // ------------------------------------------------------
    function pickAnyEnglishVoice() {
      const voices = speechSynthesis.getVoices() || [];
      for (let v of voices) {
        if (v.lang.toLowerCase().includes("en")) {
          hasEnglishVoice = true;
          return v;
        }
      }
      hasEnglishVoice = false;
      return null;
    }

    // ------------------------------------------------------
    // 4) Fala do rob√¥ ao clicar em "PLAY"
    // ------------------------------------------------------
    function speakRobotMessage() {
      const text = "Hi, I'm Samuel! Click to discover the best and most fun way to learn English, or join us to play an exciting game!";
      const utterance = new SpeechSynthesisUtterance(text);

      if (englishVoice) {
        utterance.voice = englishVoice;
      }

      utterance.onstart = function() {
        document.getElementById("roboImage").src = "imagens/robo_fala.gif";
      };

      utterance.onend = function() {
        document.getElementById("roboImage").src = "imagens/robo_estatico.png";
      };

      speechSynthesis.speak(utterance);
    }

    // ------------------------------------------------------
    // 5) Observa mudan√ßa de login do Firebase
    // ------------------------------------------------------
    firebase.auth().onAuthStateChanged(function(user) {
      const loginLink = document.getElementById("loginLink");
      const userDropdown = document.getElementById("userDropdown");

      const roboContainer       = document.getElementById("roboContainer");
      const invitationContainer = document.getElementById("invitationContainer");

      const subtitleLoggedOut = document.getElementById("subtitleLoggedOut");
      const subtitleLoggedIn  = document.getElementById("subtitleLoggedIn");

      if (user) {
        subtitleLoggedOut.style.display = "none";
        subtitleLoggedIn.style.display  = "block";   
           
        roboContainer.style.display       = "flex";
        invitationContainer.style.display = "flex";

        const userRef = firebase.database().ref("usuarios/" + user.uid);
        userRef.once("value").then((snapshot) => {
          const userData = snapshot.val() || {};
          const userName = userData.nome || user.email;
          const userAvatar = userData.avatar 
            ? `imagens/${userData.avatar}`
            : "imagens/bonecologin1.png";

          loginLink.innerHTML = `
            <img src="${userAvatar}" alt="User Icon" class="user-icon">
            <p class="user-name">${userName}</p>
          `;
          loginLink.removeAttribute("href");

          let dashboardLink = "";
          if (userData.role === "proprietario") {
            dashboardLink = '<a href="painel_proprietario.html" class="dashboard-link">OWNER DASHBOARD</a>';
            liberarNiveis(["Level0", "Level1", "Level2", "Level3", "Level4"]);
          } else if (userData.role === "professor") {
            dashboardLink = '<a href="painel_professor.html" class="dashboard-link">TEACHER DASHBOARD</a>';
            liberarNiveis(["Level0", "Level1", "Level2", "Level3", "Level4"]);
          } else if (userData.role === "aluno") {
            dashboardLink = '<a href="painel_aluno.html" class="dashboard-link">STUDENT DASHBOARD</a>';
            if (userData.atrelado_professor) {
              const professorRef = firebase.database().ref("usuarios/" + userData.atrelado_professor);
              professorRef.once("value").then((profSnapshot) => {
                const professorData = profSnapshot.val();
                const turmaId = "-O8mdLgStvNqNf6x-O5l";
                const alunoId = user.uid;

                const profStudent = 
                  professorData &&
                  professorData.turmas &&
                  professorData.turmas[turmaId] &&
                  professorData.turmas[turmaId].students &&
                  professorData.turmas[turmaId].students[alunoId];

                const nivelLiberado = (profStudent && profStudent.nivel_em_curso)
                  ? profStudent.nivel_em_curso
                  : null;

                if (nivelLiberado) {
                  liberarNiveis([nivelLiberado]);
                } else {
                  console.error("Nenhum n√≠vel definido pelo professor.");
                  liberarNiveis(["Level1"]);
                }
              }).catch((err) => {
                console.error("Erro ao buscar dados do professor:", err);
                liberarNiveis(["Level1"]);
              });
            } else {
              if (userData.progresso) {
                liberarNiveis(Object.keys(userData.progresso));
              } else {
                liberarNiveis(["Level1"]);
              }
            }
          }

          userDropdown.innerHTML = `
            ${dashboardLink}
            <a href="#" id="logout">LEAVE</a>
          `;
          document.querySelectorAll(".dashboard-link").forEach((link) => {
            link.addEventListener("click", function(event) {
              event.preventDefault();
              window.location.href = this.getAttribute("href");
            });
          });
        });
      } else {
        subtitleLoggedOut.style.display = "block";
        subtitleLoggedIn.style.display  = "none";
        roboContainer.style.display       = "flex";
        invitationContainer.style.display = "flex";

        loginLink.setAttribute("href", "Formulario/login.html");
        bloquearTodosNiveis();
      }
    });

    // ------------------------------------------------------
    // 6) Bloquear/liberar n√≠veis
    // ------------------------------------------------------
    function bloquearTodosNiveis() {
      document.querySelectorAll(".level-button").forEach((button) => {
        button.style.filter = "grayscale(100%)";
        button.style.pointerEvents = "none";
      });
    }
    function liberarNiveis(niveis) {
      document.querySelectorAll(".level-button").forEach((button) => {
        const level = button.id;
        if (niveis.includes(level)) {
          button.style.filter = "none";
          button.style.pointerEvents = "auto";
        } else {
          button.style.filter = "grayscale(100%)";
          button.style.pointerEvents = "none";
        }
      });
    }

    // ------------------------------------------------------
    // 7) Dropdown do usu√°rio
    // ------------------------------------------------------
    document.getElementById("loginContainer").addEventListener("click", function(event) {
      const user = firebase.auth().currentUser;
      if (!user) return; 
      event.preventDefault();
      const dropdown = document.getElementById("userDropdown");
      dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
    });

    // ------------------------------------------------------
    // 8) Clique no convite -> propaganda
    // ------------------------------------------------------
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("invitationButton").addEventListener("click", function() {
        window.location.href = "Apresentacao/propaganda.html";
      });
      document.getElementById("freeGamesButton").addEventListener("click", function() {
        window.location.href = "https://hannahenglishcourse.vercel.app/game.html";
      });
    });

    // ------------------------------------------------------
    // 9) Fecha dropdown ao clicar fora
    // ------------------------------------------------------
    window.addEventListener("click", function(event) {
      const dropdown = document.getElementById("userDropdown");
      const loginContainer = document.getElementById("loginContainer");
      if (!loginContainer.contains(event.target)) {
        dropdown.style.display = "none";
      }
    });

    // ------------------------------------------------------
    // 10) Logout
    // ------------------------------------------------------
    document.addEventListener("click", function(event) {
      if (event.target.id === "logout") {
        firebase.auth().signOut().then(() => {
          console.log("Usu√°rio deslogado");
          location.reload(); 
        }).catch((error) => {
          console.error("Erro ao deslogar:", error);
        });
      }
    });

    // ------------------------------------------------------
    // 11) Set up voices (TTS)
    // ------------------------------------------------------
    function setupVoices() {
      englishVoice = pickAnyEnglishVoice();
    }
    speechSynthesis.onvoiceschanged = setupVoices;
    document.addEventListener("DOMContentLoaded", function() {
      setupVoices();
      document.getElementById("playTTSBtn").addEventListener("click", speakRobotMessage);

      // Scroll suave ao clicar no subt√≠tulo
      document.getElementById("subtitleLoggedOut").addEventListener("click", function() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    // ------------------------------------------------------
    // 12) Parar TTS ao sair da p√°gina
    // ------------------------------------------------------
    window.addEventListener("beforeunload", function() {
      speechSynthesis.cancel();
    });

    // ------------------------------------------------------
    // 13) Bot√£o de instala√ß√£o do PWA
    // ------------------------------------------------------
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installBtn').style.display = 'block';
    });

    document.getElementById('installBtn').addEventListener('click', () => {
      document.getElementById('installBtn').style.display = 'none';
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          console.log('Resultado da instala√ß√£o:', choiceResult.outcome);
          deferredPrompt = null;
        });
      }
    });
  </script>

<!-- REGISTRO DO SERVICE WORKER -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('‚úÖ Service Worker registrado:', reg))
      .catch(err => console.error('‚ùå Falha ao registrar Service Worker:', err));
  }
</script>
</body>
</html>
