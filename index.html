<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah English - Learning English through Bible Stories</title>

  <!-- ‚ñ∏‚ñ∏ FAVICONS ‚óÇ‚óÇ -->
  <link rel="icon" type="image/x-icon" href="favicon.ico"/>
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/>
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>

  <!-- ‚ñ∏‚ñ∏ CSS PRINCIPAL ‚óÇ‚óÇ -->
  <link rel="stylesheet" href="CSS/styles.css"/>

  <!-- ‚ñ∏‚ñ∏ MANIFESTO PWA ‚óÇ‚óÇ -->
  <link rel="manifest" href="manifest.json"/>

  <!-- ‚ñ∏‚ñ∏ FIREBASE ‚óÇ‚óÇ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* ---------- layout original ---------- */
    body{margin:0;font-family:Arial, sans-serif;overflow:auto;}
    html,body{height:100%;}
    .container{width:100%;max-width:1200px;margin:0 auto;padding:20px;text-align:center;position:relative;
      background-image:url('imagens/fundo.png');background-repeat:repeat;background-size:200%;overflow:auto;}
    .subtitle{margin-top:40px;font-size:24px;font-weight:bold;color:#333;text-align:center;}
    .levels{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px;}
    .level-button{width:200px;height:200px;background-size:cover;background-repeat:no-repeat;display:inline-block;}
    .level0{background-image:url('imagens/Level0_button.png');}
    .levelA{background-image:url('imagens/levelA.png');}
    .levelB{background-image:url('imagens/levelB.png');}
    .levelC{background-image:url('imagens/levelC.png');}
    .levelD{background-image:url('imagens/levelD.png');}

    /* ---------- HEADER EM GRID para o chip n√£o invadir o t√≠tulo ---------- */
    header{display:grid;grid-template-columns:1fr auto;align-items:start;}

    /* ==== LOGIN CONTAINER ‚Äì visual novo (glass) ==== */
    .login-container{
      position:sticky; /* desktop: acompanha o topo dentro do header */
      top:16px;
      margin-left:auto; /* encosta √† direita */
      right:0;
      display:flex;align-items:center;gap:10px;
      background:rgba(255,255,255,0.65);
      backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
      padding:8px 12px;border-radius:999px;cursor:pointer;
      border:1px solid rgba(255,255,255,.6);
      box-shadow:0 4px 20px rgba(0,0,0,.12);
      transition:transform .15s ease, box-shadow .15s ease, background .2s ease;
      z-index:30;
    }
    .login-container:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.16);}    
    .user-icon{width:28px;height:28px;border-radius:50%;object-fit:cover;}
    .user-name{max-width:120px;font-size:14px;color:#222;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1;}
    .login-caret{width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid #333;margin-left:2px;opacity:.7;transition:transform .15s ease;}
    .login-container[aria-expanded="true"] .login-caret{transform:rotate(180deg);}    

    /* Dropdown refinado */
    .dropdown{display:none;position:absolute;top:100%;right:0;margin-top:8px;background:rgba(255,255,255,.95);
      backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);box-shadow:0 12px 28px rgba(0,0,0,.16);
      border-radius:12px;min-width:220px;overflow:hidden;z-index:40;border:1px solid rgba(0,0,0,.06);}    
    .dropdown a{display:block;padding:12px 14px;text-decoration:none;color:#222;font-size:15px;}
    .dropdown a:hover{background:rgba(0,0,0,.04);}    

    /* ---------- BOT√ÉO PWA ---------- */
    #installBtn{
      display:none;position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 24px);right:24px;z-index:9999;
      background:linear-gradient(135deg,#ff9800 0%,#ff5722 100%);color:#fff;border:none;padding:14px 24px;border-radius:50px;
      font-size:18px;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,.25);cursor:pointer;display:flex;align-items:center;gap:10px;}
    #installBtn::before{content:"üì≤";font-size:24px;}
    #installBtn:hover{transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,.35);}    
    @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,.7);}70%{transform:scale(1.05);box-shadow:0 0 0 12px rgba(255,87,34,0);}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,0);}}
    #installBtn.pulse{animation:pulse 2s infinite;}

    /* ---------- banner iOS ---------- */
    #iosInstallBanner{display:none;position:fixed;bottom:0;left:0;right:0;background:#fffbe8;border-top:1px solid #ccc;
      padding:12px 16px;text-align:center;font-size:16px;z-index:10000;}
    #iosInstallBanner button{margin-left:10px;background:#ff5722;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}

    /* Mobile: chip compacto e ‚Äúdockado‚Äù */
    @media (max-width:768px){
      .login-container{position:fixed;top:max(12px, env(safe-area-inset-top));right:12px;padding:6px 10px;gap:8px;z-index:50;}
      .user-name{max-width:90px;font-size:13px;}
      .dropdown{right:0;}
      .login-container.minified .user-name, .login-container.minified .login-caret{display:none;}
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ======= Cabe√ßalho / Login ======= -->
    <header>
      <div class="login-container" id="loginContainer">
        <a href="Formulario/login.html" class="login-button" id="loginLink">Login</a>
        <div class="dropdown" id="userDropdown"></div>
      </div>

      <div class="logo-title">
        <img src="imagens/hannah_logo.png" alt="Hannah English Logo" class="logo"/>
        <h1>Hannah English<br>Learning English through Bible Stories</h1>
      </div>
    </header>

    <!-- ======= Rob√¥ + Play ======= -->
    <div class="robo-container" id="roboContainer">
      <img src="imagens/robo_estatico.png" alt="Rob√¥" class="robo-img" id="roboImage">
      <button class="play-button" id="playTTSBtn"><span>‚ñ∂</span> Play</button>
    </div>

    <!-- ======= Convites ======= -->
    <div class="invitation-container" id="invitationContainer">
      <img src="imagens/convite.gif" alt="Convite Animado" class="invitation-button" id="invitationButton"/>
      <img src="imagens/Free_Games.gif" alt="Jogos Gr√°tis" class="free-games-button" id="freeGamesButton"/>
    </div>

    <!-- ======= Conte√∫do principal ======= -->
    <main>
      <h2 class="subtitle" id="subtitleLoggedOut">Login and Start Learning English While Playing</h2>
      <h2 class="subtitle" id="subtitleLoggedIn" style="display:none;">Choose your level and Start Learning English While Playing</h2>

      <div class="levels">
        <a href="Level0/index.html" class="level-button level0" id="Level0"></a>
        <a href="Level1/index.html" class="level-button levelA" id="Level1"></a>
        <a href="Level2/index.html" class="level-button levelB" id="Level2"></a>
        <a href="Level3/index.html" class="level-button levelC" id="Level3"></a>
        <a href="Level4/index.html" class="level-button levelD" id="Level4"></a>
      </div>
    </main>
  </div>

  <!-- Bot√£o flutuante PWA -->
  <button id="installBtn" disabled>Install App</button>

  <!-- Banner iOS -->
  <div id="iosInstallBanner">
    To install the app, tap the <strong>Share</strong> button and choose ‚ÄúAdd to Home Screen‚Äù.
    <button id="iosBannerClose">OK</button>
  </div>

  <!-- ================== SCRIPTS ================== -->
  <script>
    /* ---------- Firebase ---------- */
    var firebaseConfig={
      apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain:"hannahenglishcourse.firebaseapp.com",
      databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"hannahenglishcourse",
      storageBucket:"hannahenglishcourse.appspot.com",
      messagingSenderId:"449818788486",
      appId:"1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId:"G-07VVJG9LRS"
    };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);}    
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

    /* ---------- Fun√ß√£o robusta para detectar standalone ---------- */
    function isInStandaloneMode(){
      return window.matchMedia('(display-mode: standalone)').matches ||
             window.navigator.standalone === true;
    }

    /* ---------- Vari√°veis globais ---------- */
    let englishVoice=null;
    let deferredPrompt=null;
    const installBtn=document.getElementById("installBtn");

    /* ---------- Detec√ß√£o de ambiente ---------- */
    const ua=navigator.userAgent.toLowerCase();
    const isIOS=/iphone|ipad|ipod/.test(ua);

    /* ---------- Utilit√°rios de n√≠veis ---------- */
    const VALID_LEVELS=["Level0","Level1","Level2","Level3","Level4"];

    function normalizarNivel(n){
      if(!n) return null;
      const m=String(n).trim().toLowerCase();
      if(m==="level0"||m==="0"||m==="starter") return "Level0";
      if(m==="level1"||m==="1") return "Level1";
      if(m==="level2"||m==="2") return "Level2";
      if(m==="level3"||m==="3") return "Level3";
      if(m==="level4"||m==="4") return "Level4";
      return null;
    }
    function normalizarListaLevels(v){
      if(Array.isArray(v)){
        const set=new Set();
        v.forEach(x=>{const n=normalizarNivel(x); if(n) set.add(n);});
        return Array.from(set);
      }
      const single=normalizarNivel(v);
      return single ? [single] : [];
    }
    // Infere a partir de progresso/LevelX/UnitY/*: se houver qualquer fase true, considera liberado
    function levelsAPartirDoProgresso(progresso){
      if(!progresso||typeof progresso!=="object") return [];
      const liberados=[];
      VALID_LEVELS.forEach(L=>{
        const units=progresso[L];
        if(!units||typeof units!=="object") return;
        for(const uk of Object.keys(units)){
          const fases=units[uk];
          if(fases && typeof fases==="object" && Object.values(fases).some(Boolean)){liberados.push(L);break;}
        }
      });
      return Array.from(new Set(liberados));
    }

    /* ---------- PWA bot√£o instalar ---------- */
    function showInstallButton(){installBtn.disabled=false;installBtn.style.display='flex';installBtn.classList.add('pulse');}
    function hideInstallButton(){installBtn.style.display='none';installBtn.classList.remove('pulse');installBtn.disabled=true;}
    function controlPWAButtons(){ if(isInStandaloneMode()){hideInstallButton();return;} if(deferredPrompt){showInstallButton();} else {hideInstallButton();}}
    if(isIOS && !isInStandaloneMode()){const iosBanner=document.getElementById("iosInstallBanner");iosBanner.style.display="block";document.getElementById("iosBannerClose").onclick=()=>iosBanner.style.display="none";}
    window.addEventListener('beforeinstallprompt',e=>{ if(isInStandaloneMode()) return; e.preventDefault(); deferredPrompt=e; showInstallButton();});
    installBtn.addEventListener('click',async ()=>{ if(!deferredPrompt) return; hideInstallButton(); deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; setTimeout(controlPWAButtons,500);});
    window.addEventListener('appinstalled',()=>{deferredPrompt=null;hideInstallButton();});
    async function verificarInstalacaoInicial(){ if(isInStandaloneMode()){hideInstallButton();return;} if('getInstalledRelatedApps' in navigator){ try{ const apps=await navigator.getInstalledRelatedApps(); if(apps.length>0){hideInstallButton();} }catch(err){console.error(err);} } controlPWAButtons(); }
    function updateNetworkStatus(){ if(!navigator.onLine) installBtn.disabled=true; else if(deferredPrompt) installBtn.disabled=false; }
    window.addEventListener('online',updateNetworkStatus);window.addEventListener('offline',updateNetworkStatus);

    /* ---------- TTS util ---------- */
    function pickVoice(){return (speechSynthesis.getVoices()||[]).find(v=>v.lang.toLowerCase().includes('en'))||null;}
    function speakRobot(){
      const utt=new SpeechSynthesisUtterance("Hi, I'm Samuel! Click to discover the best and most fun way to learn English, or join us to play an exciting game!");
      if(englishVoice) utt.voice=englishVoice;
      utt.onstart=()=>document.getElementById("roboImage").src="imagens/robo_fala.gif";
      utt.onend  =()=>document.getElementById("roboImage").src="imagens/robo_estatico.png";
      speechSynthesis.speak(utt);
    }
    speechSynthesis.onvoiceschanged=()=>englishVoice=pickVoice();

    /* ---------- UI: bloquear/liberar n√≠veis ---------- */
    function bloquearTodosNiveis(){document.querySelectorAll(".level-button").forEach(b=>{b.style.filter="grayscale(100%)";b.style.pointerEvents="none";});}
    function liberarNiveis(arr){const alvo=new Set(arr||[]);document.querySelectorAll(".level-button").forEach(b=>{if(alvo.has(b.id)){b.style.filter="none";b.style.pointerEvents="auto";}else{b.style.filter="grayscale(100%)";b.style.pointerEvents="none";}});}    
    function enviarNivel(n){ n ? liberarNiveis([n]) : liberarNiveis(["Level1"]); }

    /* ---------- Firebase Auth & N√≠veis ---------- */
    firebase.auth().onAuthStateChanged(async (user)=>{
      const loginLink=document.getElementById("loginLink");
      const userDropdown=document.getElementById("userDropdown");
      const subtitleLoggedOut=document.getElementById("subtitleLoggedOut");
      const subtitleLoggedIn=document.getElementById("subtitleLoggedIn");
      const roboContainer=document.getElementById("roboContainer");
      const invitationContainer=document.getElementById("invitationContainer");
      const loginContainer=document.getElementById("loginContainer");

      if(user){
        subtitleLoggedOut.style.display="none";
        subtitleLoggedIn.style.display="block";
        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";

        try{
          const snap=await firebase.database().ref("usuarios/"+user.uid).once("value");
          const d=snap.val()||{};
          const name=d.nome||user.email;
          const avatar=d.avatar?`imagens/${d.avatar}`:"imagens/bonecologin1.png";

          // Monta o chip de usu√°rio de forma segura (sem innerHTML com dados de BD)
          loginLink.innerHTML=""; loginLink.removeAttribute("href");
          const img=document.createElement("img"); img.className="user-icon"; img.alt="User avatar"; img.src=avatar; img.onerror=()=>{img.src='imagens/bonecologin1.png';};
          const p=document.createElement("p"); p.className="user-name"; p.textContent=name;
          const caret=document.createElement("span"); caret.className="login-caret";
          loginLink.append(img,p,caret);
          // acessibilidade do cont√™iner
          loginContainer.setAttribute("role","button");
          loginContainer.setAttribute("tabindex","0");
          loginContainer.setAttribute("aria-expanded","false");

          let dash="";
          if(d.role==="proprietario"||d.role==="professor"){
            dash=`<a href="painel_${d.role==='proprietario'?'proprietario':'professor'}.html" class="dashboard-link">${d.role.toUpperCase()} DASHBOARD</a>`;
            liberarNiveis(VALID_LEVELS);
          }else if(d.role==="aluno"){
            dash='<a href="painel_aluno.html" class="dashboard-link">STUDENT DASHBOARD</a>';

            // ===== Estrat√©gia de leitura =====
            const liberarPorPreferencia=(lista)=>{ if(Array.isArray(lista)&&lista.length){liberarNiveis(lista);return true;} return false;};
            const tentarAlunoDireto=()=>{
              const arrAluno=normalizarListaLevels(d.levels_liberados);
              if(liberarPorPreferencia(arrAluno)) return;
              const nAluno=normalizarNivel(d.nivel_em_curso);
              if(nAluno){ enviarNivel(nAluno); return; }
              const arrFromProg=levelsAPartirDoProgresso(d.progresso);
              if(liberarPorPreferencia(arrFromProg)) return;
              enviarNivel();
            };

            if(d.atrelado_professor){
              try{
                const turmasSnap=await firebase.database().ref("usuarios/"+d.atrelado_professor+"/turmas").once("value");
                const turmas=turmasSnap.val()||{}; let registroAluno=null;
                for(const turmaId in turmas){ const st=turmas[turmaId]?.students?.[user.uid]; if(st){registroAluno=st; break;} }
                if(registroAluno){
                  const arrProf=normalizarListaLevels(registroAluno.levels_liberados);
                  if(liberarPorPreferencia(arrProf)){} else {
                    const nProf=normalizarNivel(registroAluno.nivel_em_curso);
                    if(nProf){enviarNivel(nProf);} else {tentarAlunoDireto();}
                  }
                } else {tentarAlunoDireto();}
              }catch(e){tentarAlunoDireto();}
            }else{tentarAlunoDireto();}
          }
          userDropdown.innerHTML=`${dash}<a href="#" id="logout">LEAVE</a>`;
          document.querySelectorAll(".dashboard-link").forEach(l=>{l.onclick=e=>{e.preventDefault();window.location.href=l.getAttribute("href");};});

          // Dropdown / toggle
          const dd=userDropdown; const lc=loginContainer;
          function toggleDropdown(open){
            const shouldOpen=(typeof open==="boolean")?open:(dd.style.display!=="block");
            dd.style.display=shouldOpen?"block":"none";
            lc.setAttribute("aria-expanded", shouldOpen?"true":"false");
          }
          lc.onclick=(e)=>{ if(!firebase.auth().currentUser) return; e.preventDefault(); toggleDropdown(); };
          lc.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); toggleDropdown(); }});
          window.addEventListener("click",(e)=>{ if(!lc.contains(e.target)) toggleDropdown(false); });

          // Minificar no scroll (mobile)
          let lastY=window.scrollY; window.addEventListener("scroll",()=>{ const down=window.scrollY>lastY; lastY=window.scrollY; if(window.innerWidth<=768){ if(window.scrollY>40 && down) lc.classList.add("minified"); else if(window.scrollY<20) lc.classList.remove("minified"); }});
        }catch(e){ console.error(e); bloquearTodosNiveis(); }
      }else{
        subtitleLoggedOut.style.display="block";
        subtitleLoggedIn.style.display="none";
        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";
        loginLink.setAttribute("href","Formulario/login.html");
        bloquearTodosNiveis();
      }
    });

    /* ---------- Logout ---------- */
    document.addEventListener("click",e=>{ if(e.target && e.target.id==="logout"){ firebase.auth().signOut().then(()=>location.reload()); }});

    /* ---------- DOM Ready (Netlify) ---------- */
    document.addEventListener("DOMContentLoaded",()=>{
      englishVoice=pickVoice();
      document.getElementById("playTTSBtn").onclick=speakRobot;
      document.getElementById("invitationButton").onclick=()=>location.href="Apresentacao/propaganda.html";
      document.getElementById("freeGamesButton").onclick   =()=>location.href="https://hannahenglishcourse.netlify.app/game.html";
      document.getElementById("subtitleLoggedOut").onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
      updateNetworkStatus();
      verificarInstalacaoInicial();
    });
    window.addEventListener("beforeunload",()=>speechSynthesis.cancel());

    /* ---------- Service Worker ---------- */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js')
        .then(r=>console.log("SW registrado:",r.scope))
        .catch(err=>console.error("SW erro:",err));
    }
  </script>
</body>
</html>
