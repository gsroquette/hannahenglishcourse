<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah English - Learning English through Bible Stories</title>

  <!-- FAVICONS -->
  <link rel="icon" type="image/x-icon" href="favicon.ico"/>
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/>
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>

  <!-- CSS PRINCIPAL -->
  <link rel="stylesheet" href="CSS/styles.css"/>

  <!-- MANIFESTO PWA -->
  <link rel="manifest" href="manifest.json"/>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    *, *::before, *::after{
      box-sizing:border-box;
    }

    body{
      margin:0;
      font-family:Arial, sans-serif;
      overflow-x:hidden;
      overflow-y:auto;
    }
    html,body{height:100%;}

    .container{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:20px;
      text-align:center;
      position:relative;
      background-image:url('imagens/fundo.png');
      background-repeat:repeat;
      background-size:200%;
      overflow-x:hidden;
      overflow-y:auto;
    }

    .container img{
      max-width:100%;
      height:auto;
    }

    .subtitle{
      margin-top:40px;
      font-size:24px;
      font-weight:bold;
      color:#333;
      text-align:center;
    }

    .levels{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:20px;
      padding:20px;
    }

    .level-button{
      width:200px;
      height:200px;
      background-size:cover;
      background-repeat:no-repeat;
      display:inline-block;
      filter:grayscale(100%);
      pointer-events:none;
    }

    .level0{background-image:url('imagens/Level0_button.png');}
    .levelA{background-image:url('imagens/levelA.png');}
    .levelB{background-image:url('imagens/levelB.png');}
    .levelC{background-image:url('imagens/levelC.png');}
    .levelD{background-image:url('imagens/levelD.png');}

    .login-container{
      position:absolute;
      top:16px;
      right:14px;
      z-index:20;
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      background:none;
      cursor:pointer;
    }

    .user-icon{
      width:55px;
      height:auto;
      display:block;
      object-fit:contain;
      pointer-events:none;
    }

    .user-name{
      margin:0;
      text-align:center;
      font-size:13px;
      font-weight:700;
      color:#1a5f34;
      max-width:180px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .dropdown{
      display:none;
      position:absolute;
      right:0;
      top:calc(100% + 10px);
      z-index:25;
      min-width:220px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 14px 30px rgba(0,0,0,0.16);
      border:1px solid rgba(0,0,0,0.06);
    }

    .dropdown a{
      display:block;
      padding:12px 14px;
      font-size:15px;
      color:#222;
      text-decoration:none;
      text-align:left;
    }

    .dropdown a:hover{
      background:#f2f2f2;
    }

    .robo-container{
      display:flex;
      flex-direction:column;
      align-items:center;
      margin:20px auto;
    }

    .robo-img{
      width:300px;
      height:auto;
    }

    .play-button{
      margin-top:-40px;
      padding:8px 16px;
      border:2px solid #ccc;
      border-radius:20px;
      background:#fff;
      color:#000;
      font-weight:bold;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(0,0,0,.3);
    }

    .invitation-container{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:20px;
      margin:20px 0;
      flex-wrap:wrap;
    }

    .invitation-button,.free-games-button{
      max-width:40%;
      cursor:pointer;
      border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,.2);
      transition:.3s;
    }

    #installBtn{
      display:none;
      position:fixed;
      bottom:calc(env(safe-area-inset-bottom,0px) + 24px);
      right:24px;
      z-index:9999;
      background:linear-gradient(135deg,#ff9800 0%,#ff5722 100%);
      color:#fff;
      border:none;
      padding:14px 24px;
      border-radius:50px;
      font-size:18px;
      font-weight:700;
      box-shadow:0 6px 12px rgba(0,0,0,.25);
      cursor:pointer;
      align-items:center;
      gap:10px;
    }

    @keyframes pulse{
      0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,.7);}
      70%{transform:scale(1.05);box-shadow:0 0 0 12px rgba(255,87,34,0);}
      100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,0);}
    }

    #iosInstallBanner{
      display:none;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#fffbe8;
      border-top:1px solid #ccc;
      padding:12px 16px;
      text-align:center;
      font-size:16px;
      z-index:10000;
    }

    #iosInstallBanner button{
      margin-left:10px;
      background:#ff5722;
      color:#fff;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
    }

    #permOverlay{
      position:fixed;
      inset:0;
      display:none;
      background:rgba(255,255,255,.6);
      backdrop-filter:saturate(180%) blur(2px);
      z-index:30;
    }

    #permOverlay .inner{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:#fff;
      border-radius:12px;
      padding:12px 16px;
      font-weight:600;
      box-shadow:0 10px 24px rgba(0,0,0,.15);
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- LOGIN -->
    <header>
      <div class="login-container" id="loginContainer">
        <a href="Formulario/login.html" class="login-button" id="loginLink">Login</a>
        <div class="dropdown" id="userDropdown"></div>
      </div>

      <div class="logo-title">
        <img src="imagens/hannah_logo.png" class="logo"/>
        <h1>Hannah English<br>Learning English through Bible Stories</h1>
      </div>
    </header>

    <div class="robo-container" id="roboContainer">
      <img src="imagens/robo_estatico.png" id="roboImage" class="robo-img">
      <button class="play-button" id="playTTSBtn"><span>▶</span> Play</button>
    </div>

    <div class="invitation-container" id="invitationContainer">
      <img src="imagens/convite.gif" class="invitation-button" id="invitationButton"/>
      <img src="imagens/Free_Games.gif" class="free-games-button" id="freeGamesButton"/>
    </div>

    <main>
      <h2 class="subtitle" id="subtitleLoggedOut">
        Login and Start Learning English While Playing
      </h2>
      <h2 class="subtitle" id="subtitleLoggedIn" style="display:none;">
        Choose your level and Start Learning English While Playing
      </h2>

      <div class="levels">
        <a href="Level0/index.html" id="Level0" class="level-button level0"></a>
        <a href="Level1/index.html" id="Level1" class="level-button levelA"></a>
        <a href="Level2/index.html" id="Level2" class="level-button levelB"></a>
        <a href="Level3/index.html" id="Level3" class="level-button levelC"></a>
        <a href="Level4/index.html" id="Level4" class="level-button levelD"></a>
      </div>
    </main>

  </div>

  <div id="permOverlay"><div class="inner">Loading your permissions…</div></div>

  <button id="installBtn" disabled>Install App</button>

  <!-- Banner iOS com ícone inline share-icon.png -->
  <div id="iosInstallBanner">
    To install the app, tap the 
    <img src="imagens/share-icon.png" height="22" style="vertical-align:middle;">
    Share button and choose “Add to Home Screen”.
    <br>
    <span style="font-size:14px;">
      Para instalar o app, clique no ícone 
      <img src="imagens/share-icon.png" height="22" style="vertical-align:middle;">
      ou toque no botão <strong>Compartilhar</strong> e depois em “Adicionar à Tela de Início”.
    </span>
    <button id="iosBannerClose">OK</button>
  </div>

  <script>
    /* FIREBASE CONFIG */
    var firebaseConfig={ apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain:"hannahenglishcourse.firebaseapp.com",
      databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"hannahenglishcourse",
      storageBucket:"hannahenglishcourse.appspot.com",
      messagingSenderId:"449818788486",
      appId:"1:449818788486:web:8a49d3f68591e6fb3f0707"
    };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);}

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .catch(console.error);
    /* ------- PWA FUNCTIONS ------- */
    let deferredPrompt=null;
    const installBtn=document.getElementById("installBtn");

    function isInStandaloneMode(){
      return (window.matchMedia('(display-mode: standalone)').matches ||
              window.navigator.standalone===true);
    }

    const ua=navigator.userAgent.toLowerCase();
    const isIOS=/iphone|ipad|ipod/.test(ua);

    function showInstallButton(){
      installBtn.disabled=false;
      installBtn.style.display='flex';
      installBtn.classList.add('pulse');
    }

    function hideInstallButton(){
      installBtn.style.display='none';
      installBtn.classList.remove('pulse');
      installBtn.disabled=true;
    }

    function controlPWAButtons(){
      if(isInStandaloneMode()){
        hideInstallButton();
        return;
      }
      if(deferredPrompt){
        showInstallButton();
      }else{
        hideInstallButton();
      }
    }

    if(isIOS && !isInStandaloneMode()){
      const b=document.getElementById("iosInstallBanner");
      b.style.display="block";
      document.getElementById("iosBannerClose").onclick=()=>b.style.display="none";
    }

    window.addEventListener('beforeinstallprompt',(e)=>{
      if(isInStandaloneMode()) return;
      e.preventDefault();
      deferredPrompt=e;
      showInstallButton();
    });

    installBtn.addEventListener("click",async()=>{
      if(!deferredPrompt) return;
      hideInstallButton();
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt=null;
      setTimeout(controlPWAButtons,500);
    });

    window.addEventListener('appinstalled',()=>{
      deferredPrompt=null;
      hideInstallButton();
    });

    async function verificarInstalacaoInicial(){
      if(isInStandaloneMode()){
        hideInstallButton();
        return;
      }
      if('getInstalledRelatedApps' in navigator){
        try{
          const apps=await navigator.getInstalledRelatedApps();
          if(apps.length>0){
            hideInstallButton();
          }
        }catch(e){}
      }
      controlPWAButtons();
    }

    function updateNetworkStatus(){
      if(!navigator.onLine){
        installBtn.disabled=true;
      }else if(deferredPrompt){
        installBtn.disabled=false;
      }
    }

    window.addEventListener('online',updateNetworkStatus);
    window.addEventListener('offline',updateNetworkStatus);

    /* ------- TTS (Robot Samuel) ------- */
    let englishVoice=null;

    function pickVoice(){
      return (speechSynthesis.getVoices()||[])
        .find(v=>v.lang.toLowerCase().includes('en'))||null;
    }

    function speakRobot(){
      const utt=new SpeechSynthesisUtterance(
        "Hi, I'm Samuel! Click to discover the best and most fun way to learn English, or join us to play an exciting game!"
      );
      if(englishVoice) utt.voice=englishVoice;

      utt.onstart=()=>document.getElementById("roboImage").src="imagens/robo_fala.gif";
      utt.onend  =()=>document.getElementById("roboImage").src="imagens/robo_estatico.png";

      speechSynthesis.speak(utt);
    }

    speechSynthesis.onvoiceschanged=()=>englishVoice=pickVoice();

    /* ------- Níveis / Permissões ------- */
    const VALID_LEVELS=["Level0","Level1","Level2","Level3","Level4"];

    function normalizarNivel(n){
      if(!n) return null;
      n=String(n).trim().toLowerCase();
      if(n==="level0"||n==="0"||n==="starter") return "Level0";
      if(n==="level1"||n==="1") return "Level1";
      if(n==="level2"||n==="2") return "Level2";
      if(n==="level3"||n==="3") return "Level3";
      if(n==="level4"||n==="4") return "Level4";
      return null;
    }

    function normalizarListaLevels(v){
      if(Array.isArray(v)){
        const set=new Set();
        v.forEach(x=>{
          const n=normalizarNivel(x);
          if(n) set.add(n);
        });
        return [...set];
      }
      const single=normalizarNivel(v);
      return single?[single]:[];
    }

    function levelsAPartirDoProgresso(progresso){
      if(!progresso||typeof progresso!=="object") return [];
      const liberados=[];
      VALID_LEVELS.forEach(L=>{
        const units=progresso[L];
        if(!units||typeof units!=="object") return;
        for(const uk of Object.keys(units)){
          const fases=units[uk];
          if(fases && typeof fases==="object" && Object.values(fases).some(Boolean)){
            liberados.push(L);
            break;
          }
        }
      });
      return [...new Set(liberados)];
    }

    let permissionsReady=false;
    let allowedLevels=new Set();

    const permOverlay=document.getElementById("permOverlay");

    function setPermOverlay(show){
      permOverlay.style.display=show?'block':'none';
    }

    function bloquearTodosNiveis(){
      permissionsReady=false;
      allowedLevels=new Set();
      document.querySelectorAll(".level-button").forEach(b=>{
        b.style.filter="grayscale(100%)";
        b.style.pointerEvents="none";
      });
    }

    function liberarNiveis(arr){
      const alvo=new Set(arr||[]);
      allowedLevels=new Set(alvo);
      permissionsReady=true;

      document.querySelectorAll(".level-button").forEach(b=>{
        if(alvo.has(b.id)){
          b.style.filter="none";
          b.style.pointerEvents="auto";
        }else{
          b.style.filter="grayscale(100%)";
          b.style.pointerEvents="none";
        }
      });

      if(alvo.size>0){
        setPermOverlay(false);
      }
    }

    function enviarNivel(n){
      n?liberarNiveis([n]):liberarNiveis(["Level1"]);
    }

    document.addEventListener("click",(e)=>{
      const a=e.target.closest?.(".level-button");
      if(!a) return;

      const levelId=a.id;

      if(!permissionsReady || !allowedLevels.has(levelId)){
        e.preventDefault();
        if(!permissionsReady){
          setPermOverlay(true);
        }
        return false;
      }
    },true);

    /* ------- Firebase Auth Listener ------- */
    firebase.auth().onAuthStateChanged(async user=>{
      const loginLink=document.getElementById("loginLink");
      const userDropdown=document.getElementById("userDropdown");
      const subtitleLoggedOut=document.getElementById("subtitleLoggedOut");
      const subtitleLoggedIn=document.getElementById("subtitleLoggedIn");
      const roboContainer=document.getElementById("roboContainer");
      const invitationContainer=document.getElementById("invitationContainer");
      const loginContainer=document.getElementById("loginContainer");

      bloquearTodosNiveis();

      if(user){
        subtitleLoggedOut.style.display="none";
        subtitleLoggedIn.style.display="block";

        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";

        setPermOverlay(true);

        try{
          const snap=await firebase.database()
            .ref("usuarios/"+user.uid)
            .once("value");
          const d=snap.val()||{};

          const rawName=d.nome||user.email||"User";
          const name=
            rawName.trim().length>10?
            rawName.trim().slice(0,10)+"…":
            rawName.trim();

          const avatar=d.avatar?`imagens/${d.avatar}`:"imagens/bonecologin1.png";

          loginLink.innerHTML="";
          loginLink.removeAttribute("href");

          const img=document.createElement("img");
          img.className="user-icon";
          img.src=avatar;
          img.onerror=()=>{img.src='imagens/bonecologin1.png';};

          const p=document.createElement("p");
          p.className="user-name";
          p.textContent=name;

          loginLink.append(img,p);

          let dash="";

          if(d.role==="proprietario"||d.role==="professor"){
            dash=`<a href="painel_${d.role==='proprietario'?'proprietario':'professor'}.html" class="dashboard-link">${d.role.toUpperCase()} DASHBOARD</a>`;
            liberarNiveis(VALID_LEVELS);
          }else if(d.role==="aluno"){

            dash=`<a href="painel_aluno.html" class="dashboard-link">STUDENT DASHBOARD</a>`;

            const liberarPorPreferencia=(lista)=>{
              if(lista?.length){
                liberarNiveis(lista);
                return true;
              }
              return false;
            };

            const tentarAlunoDireto=()=>{
              const arrAluno=normalizarListaLevels(d.levels_liberados);
              if(liberarPorPreferencia(arrAluno)) return;

              const nAluno=normalizarNivel(d.nivel_em_curso);
              if(nAluno){ enviarNivel(nAluno); return; }

              const arrFromProg=levelsAPartirDoProgresso(d.progresso);
              if(liberarPorPreferencia(arrFromProg)) return;

              enviarNivel();
            };

            if(d.atrelado_professor){
              try{
                const snapTurmas=await firebase.database()
                  .ref("usuarios/"+d.atrelado_professor+"/turmas")
                  .once("value");
                const turmas=snapTurmas.val()||{};
                let registroAluno=null;
                for(const turmaId in turmas){
                  const st=turmas[turmaId]?.students?.[user.uid];
                  if(st){registroAluno=st; break;}
                }

                if(registroAluno){
                  const arrProf=normalizarListaLevels(registroAluno.levels_liberados);
                  if(liberarPorPreferencia(arrProf)){}else{
                    const nProf=normalizarNivel(registroAluno.nivel_em_curso);
                    if(nProf){ enviarNivel(nProf); }
                    else{ tentarAlunoDireto(); }
                  }
                }else{
                  tentarAlunoDireto();
                }

              }catch(e){
                tentarAlunoDireto();
              }
            }else{
              tentarAlunoDireto();
            }

          }

          userDropdown.innerHTML=`
            ${dash}
            <a href="#" id="logout">LEAVE</a>
          `;

          document.querySelectorAll(".dashboard-link").forEach(l=>{
            l.onclick=e=>{
              e.preventDefault();
              window.location.href=l.getAttribute("href");
            };
          });

          function toggleDropdown(open){
            const should=open ?? (userDropdown.style.display!=="block");
            userDropdown.style.display=should?"block":"none";
          }

          loginContainer.onclick=(e)=>{
            if(!firebase.auth().currentUser) return;
            e.preventDefault();
            toggleDropdown();
          };

          window.addEventListener("click",(e)=>{
            if(!loginContainer.contains(e.target)) toggleDropdown(false);
          });

          if(!permissionsReady){
            setPermOverlay(false);
          }

        }catch(e){
          console.error(e);
          bloquearTodosNiveis();
          setPermOverlay(false);
        }

      }else{
        subtitleLoggedOut.style.display="block";
        subtitleLoggedIn.style.display="none";

        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";

        loginLink.setAttribute("href","Formulario/login.html");

        bloquearTodosNiveis();
        setPermOverlay(false);
      }
    });

    /* Logout */
    document.addEventListener("click",(e)=>{
      if(e.target?.id==="logout"){
        firebase.auth().signOut().then(()=>location.reload());
      }
    });

    /* DOM Ready */
    document.addEventListener("DOMContentLoaded",()=>{
      bloquearTodosNiveis();
      englishVoice=pickVoice();

      document.getElementById("playTTSBtn").onclick=speakRobot;
      document.getElementById("invitationButton").onclick=()=>location.href="Apresentacao/propaganda.html";
      document.getElementById("freeGamesButton").onclick=()=>location.href="https://hannahenglishcourse.netlify.app/game.html";

      updateNetworkStatus();
      verificarInstalacaoInicial();
    });

    window.addEventListener("beforeunload",()=>speechSynthesis.cancel());

    /* Service Worker */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js')
        .then(r=>console.log("SW registrado:",r.scope))
        .catch(err=>console.error("SW erro:",err));
    }
  </script>

</body>
</html>

