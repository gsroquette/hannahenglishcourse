<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah English - Learning English through Bible Stories</title>
  <!-- Favicon padrão -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Favicon para navegadores com tamanhos específicos -->
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">

  <!-- Favicon para Android (Web App Manifest) -->
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png">

  <!-- Ícone para dispositivos Apple -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">

  <link rel="stylesheet" href="CSS/styles.css" />
  <!-- Manifesto para PWA -->
  <link rel="manifest" href="manifest.json" />
  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* Remove o fundo do body e ajusta para o container */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    /* Fundo do contêiner principal */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
      position: relative;
      background-image: url('imagens/fundo.png');
      background-repeat: repeat;
      background-size: 200%;
    }

    .levels {
      display: flex;
      flex-wrap: wrap;
      justify-content: center; /* Centraliza os botões */
      gap: 20px;
      padding: 20px;
    }

    .level-button {
      width: 200px;
      height: 200px;
      background-size: cover;
      background-repeat: no-repeat;
      display: inline-block;
    }

    .level0 { background-image: url('imagens/Level0_button.png'); }
    .levelA { background-image: url('imagens/levelA.png'); }
    .levelB { background-image: url('imagens/levelB.png'); }
    .levelC { background-image: url('imagens/levelC.png'); }
    .levelD { background-image: url('imagens/levelD.png'); }
    
    /* Estilo da caixa de login */
    .login-container {
      display: flex;
      align-items: center; /* Alinha verticalmente */
      gap: 10px; /* Espaço entre avatar e nome */
      position: absolute;
      top: 20px;
      right: 60px;
      z-index: 10;
      background-color: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    .user-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-name {
      font-size: 14px;
      color: #333;
      margin: 0;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 60px;
      right: 0;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1;
      border-radius: 4px;
      min-width: 150px;
    }

    .dropdown a {
      display: block;
      padding: 10px;
      text-decoration: none;
      color: #333;
      font-size: 16px;
      text-align: left;
    }

    .dropdown a:hover {
      background-color: #f2f2f2;
    }

    /* Centraliza a imagem de convite e ajusta responsividade */
    .invitation-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0; /* Espaçamento entre o título e o texto */
    }

    .invitation-button {
      max-width: 80%;
      height: auto;
      cursor: pointer;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .invitation-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <!-- Contêiner para login ou ícone de usuário -->
      <div class="login-container" id="loginContainer">
        <a href="Formulario/login.html" class="login-button" id="loginLink">Login</a>
        <div class="dropdown" id="userDropdown"></div>
      </div>

      <div class="logo-title">
        <img src="imagens/hannah_logo.png" alt="Hannah English Logo" class="logo" />
        <h1>Hannah English<br>Learning English through Bible Stories</h1>
      </div>
    </header>

    <!-- Começa com imagem ESTÁTICA -->
    <div class="invitation-container" id="invitationContainer">
      <img src="imagens/convite_still.png" 
           alt="Convite" 
           class="invitation-button" 
           id="invitationButton" />
    </div>

    <main>
      <h2>Choose your level</h2>
      <div class="levels">
        <a href="Level0/index.html" class="level-button level0" id="Level0"></a>
        <a href="Level1/index.html" class="level-button levelA" id="Level1"></a>
        <a href="Level2/index.html" class="level-button levelB" id="Level2"></a>
        <a href="Level3/index.html" class="level-button levelC" id="Level3"></a>
        <a href="Level4/index.html" class="level-button levelD" id="Level4"></a>
      </div>
    </main>
  </div>

  <!-- Firebase Auth Script -->
  <script>
    // ----------------------------------------------------
    // 1) Configuração do Firebase
    // ----------------------------------------------------
    var firebaseConfig = {
      apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain: "hannahenglishcourse.firebaseapp.com",
      databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "hannahenglishcourse",
      storageBucket: "hannahenglishcourse.appspot.com",
      messagingSenderId: "449818788486",
      appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId: "G-07VVJG9LRS"
    };
    firebase.initializeApp(firebaseConfig);

    // ----------------------------------------------------
    // 2) Variáveis para TTS e controle
    // ----------------------------------------------------
    let invitationButton = null;
    let isUserLoggedIn = false;

    let englishVoice = null;     // Armazena alguma voz "en"
    let hasEnglishVoice = false; // Se existe ao menos 1 voz com "en"
    let mustStopTTS = false;     // Se TTS deve parar
    let firstSpeechTriggered = false; // Se já falamos a primeira vez

    // ----------------------------------------------------
    // 3) Busca vozes e escolhe qualquer "en"
    // ----------------------------------------------------
    function pickAnyEnglishVoice() {
      console.log("[pickAnyEnglishVoice] Checking voices...");
      const voices = speechSynthesis.getVoices();
      console.log("[pickAnyEnglishVoice] Available voices:", voices);

      for (let voice of voices) {
        // Ex: 'en-US', 'en-GB', 'en-AU'
        if (voice.lang.toLowerCase().includes("en")) {
          console.log("[pickAnyEnglishVoice] Found an English voice:", voice.name, voice.lang);
          hasEnglishVoice = true;
          return voice;
        }
      }
      console.warn("[pickAnyEnglishVoice] No English voice found!");
      hasEnglishVoice = false;
      return null;
    }

    // ----------------------------------------------------
    // 4) Função principal de fala
    // ----------------------------------------------------
    function speakSamuelMessage() {
      // Se já pediram para parar ou se usuário logou, não fala
      if (mustStopTTS || isUserLoggedIn) {
        console.log("[speakSamuelMessage] mustStopTTS or isUserLoggedIn => not speaking.");
        return;
      }

      console.log("[speakSamuelMessage] Start speaking attempt...");
      // Mensagem a ser falada
      const text = "Hi, I'm Samuel. Click that bouncy button to discover the best way to learn English! Or log in to start studying.";
      const utterance = new SpeechSynthesisUtterance(text);

      // Se houver voz em inglês, define
      if (englishVoice) {
        console.log("[speakSamuelMessage] Using English voice:", englishVoice.name);
        utterance.voice = englishVoice;
      } else {
        console.warn("[speakSamuelMessage] No English voice -> won't speak. Keep GIF animated?");
      }

      // Ao iniciar a fala -> troca para convite.gif
      utterance.onstart = function() {
        console.log("[TTS onstart] => Switch to GIF");
        if (hasEnglishVoice) {
          invitationButton.src = "imagens/convite.gif";
        } else {
          // Se não tem voz "en", mantém GIF animado permanentemente
          invitationButton.src = "imagens/convite.gif";
        }
      };

      // Ao terminar -> volta para still e agenda nova fala
      utterance.onend = function() {
        console.log("[TTS onend] => Switch to STILL. Next speech in 5s?");
        if (hasEnglishVoice) {
          invitationButton.src = "imagens/convite_still.png";
        }

        // Espera 5s e repete, se não pararmos e não logarmos
        setTimeout(() => {
          if (!isUserLoggedIn && !mustStopTTS) {
            console.log("[TTS onend -> setTimeout] => Re-speak after 5s...");
            speakSamuelMessage();
          }
        }, 5000);
      };

      // Se não tem nenhuma voz em inglês, não chama speak (sem TTS real)
      // Mas deixa o GIF animado direto
      if (!hasEnglishVoice) {
        console.warn("[speakSamuelMessage] No English voice. Not calling speechSynthesis.speak");
        invitationButton.src = "imagens/convite.gif";
        return;
      }

      console.log("[speakSamuelMessage] *** calling speechSynthesis.speak() ***");
      speechSynthesis.speak(utterance);
    }

    // ----------------------------------------------------
    // 5) Observa estado de login do Firebase
    // ----------------------------------------------------
    firebase.auth().onAuthStateChanged(function(user) {
      console.log("[onAuthStateChanged] user:", user);
      const loginLink = document.getElementById("loginLink");
      const userDropdown = document.getElementById("userDropdown");
      const invitationContainer = document.getElementById("invitationContainer");
      invitationButton = document.getElementById("invitationButton");

      if (user) {
        console.log("[onAuthStateChanged] We have a user -> STOP TTS");
        isUserLoggedIn = true;
        mustStopTTS = true;
        speechSynthesis.cancel(); // Cancela qualquer fala pendente
        invitationContainer.style.display = "none"; // Esconde o convite

        // Carrega dados do user
        const userRef = firebase.database().ref("usuarios/" + user.uid);
        userRef.once("value").then(snapshot => {
          const userData = snapshot.val() || {};
          const userName = userData.nome || user.email;
          const userAvatar = userData.avatar ? `imagens/${userData.avatar}` : "imagens/bonecologin1.png";

          // Atualiza interface
          loginLink.innerHTML = `<img src="${userAvatar}" alt="User Icon" class="user-icon"><p class="user-name">${userName}</p>`;
          loginLink.removeAttribute("href");

          // Define o dashboard
          let dashboardLink = "";
          if (userData.role === "proprietario") {
            dashboardLink = '<a href="painel_proprietario.html" class="dashboard-link">OWNER DASHBOARD</a>';
            liberarNiveis(["Level0", "Level1", "Level2", "Level3", "Level4"]);
          } else if (userData.role === "professor") {
            dashboardLink = '<a href="painel_professor.html" class="dashboard-link">TEACHER DASHBOARD</a>';
            liberarNiveis(["Level0", "Level1", "Level2", "Level3", "Level4"]);
          } else if (userData.role === "aluno") {
            dashboardLink = '<a href="painel_aluno.html" class="dashboard-link">STUDENT DASHBOARD</a>';

            // Verifica se o aluno está atrelado a um professor
            if (userData.atrelado_professor) {
              const professorRef = firebase.database().ref("usuarios/" + userData.atrelado_professor);
              professorRef.once("value").then(profSnapshot => {
                const professorData = profSnapshot.val();
                const turmaId = "-O8mdLgStvNqNf6x-O5l"; // Ajuste ao seu BD
                const alunoId = user.uid;
                const profStudent = 
                  professorData &&
                  professorData.turmas &&
                  professorData.turmas[turmaId] &&
                  professorData.turmas[turmaId].students &&
                  professorData.turmas[turmaId].students[alunoId];
                
                const nivelLiberado = profStudent && profStudent.nivel_em_curso
                                      ? profStudent.nivel_em_curso
                                      : null;
                
                if (nivelLiberado) {
                  liberarNiveis([nivelLiberado]);
                } else {
                  console.error("Nenhum nível definido pelo professor.");
                  liberarNiveis(["Level1"]);
                }
              }).catch(err => {
                console.error("Erro ao buscar dados do professor:", err);
                liberarNiveis(["Level1"]);
              });
            } else {
              // Se não tem professor
              if (userData.progresso) {
                liberarNiveis(Object.keys(userData.progresso));
              } else {
                liberarNiveis(["Level1"]);
              }
            }
          }

          userDropdown.innerHTML = `
            ${dashboardLink}
            <a href="#" id="logout">LEAVE</a>
          `;
          document.querySelectorAll(".dashboard-link").forEach(link => {
            link.addEventListener("click", function(event) {
              event.preventDefault();
              window.location.href = this.getAttribute("href");
            });
          });
        });
      } else {
        // Não está logado
        console.log("[onAuthStateChanged] No user -> TTS can start");
        isUserLoggedIn = false;
        mustStopTTS = false;
        invitationContainer.style.display = "flex";
        loginLink.setAttribute("href", "Formulario/login.html");
        bloquearTodosNiveis();

        // Dispara TTS somente se ainda não falamos
        if (!firstSpeechTriggered) {
          firstSpeechTriggered = true;
          console.log("[onAuthStateChanged] Starting TTS cycle...");
          speakSamuelMessage();
        }
      }
    });

    // ----------------------------------------------------
    // 6) Libera/Bloqueia níveis
    // ----------------------------------------------------
    function bloquearTodosNiveis() {
      document.querySelectorAll(".level-button").forEach(button => {
        button.style.filter = "grayscale(100%)";
        button.style.pointerEvents = "none";
      });
    }
    function liberarNiveis(niveis) {
      document.querySelectorAll(".level-button").forEach(button => {
        const level = button.id;
        if (niveis.includes(level)) {
          button.style.filter = "none";
          button.style.pointerEvents = "auto";
        } else {
          button.style.filter = "grayscale(100%)";
          button.style.pointerEvents = "none";
        }
      });
    }

    // ----------------------------------------------------
    // 7) Dropdown do usuário
    // ----------------------------------------------------
    document.getElementById("loginContainer").addEventListener("click", function(e) {
      const user = firebase.auth().currentUser;
      if (!user) return;
      e.preventDefault();
      const dropdown = document.getElementById("userDropdown");
      dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
    });

    // ----------------------------------------------------
    // 8) Clique no convite -> propaganda
    // ----------------------------------------------------
    document.addEventListener("DOMContentLoaded", function() {
      invitationButton = document.getElementById("invitationButton");
      invitationButton.addEventListener("click", function() {
        console.log("[invitationButton click] => Go to propaganda.html");
        window.location.href = "Apresentacao/propaganda.html";
      });
    });

    // ----------------------------------------------------
    // 9) Fecha dropdown ao clicar fora
    // ----------------------------------------------------
    window.addEventListener("click", function(event) {
      const dropdown = document.getElementById("userDropdown");
      const loginContainer = document.getElementById("loginContainer");
      if (!loginContainer.contains(event.target)) {
        dropdown.style.display = "none";
      }
    });

    // ----------------------------------------------------
    // 10) Logout
    // ----------------------------------------------------
    document.addEventListener("click", function(e) {
      if (e.target.id === "logout") {
        console.log("[LOGOUT] => Firebase signOut()");
        firebase.auth().signOut().then(() => {
          console.log("[LOGOUT] => Done. Reloading page.");
          location.reload();
        }).catch((error) => {
          console.error("[LOGOUT] => Error:", error);
        });
      }
    });

    // ----------------------------------------------------
    // 11) Carregar vozes
    // ----------------------------------------------------
    function setupVoices() {
      englishVoice = pickAnyEnglishVoice();
    }
    // Quando vozes forem carregadas ou mudarem
    speechSynthesis.onvoiceschanged = function() {
      console.log("[onvoiceschanged] => Setting up voices...");
      setupVoices();
    };

    // Também chamamos quando a página carrega
    document.addEventListener("DOMContentLoaded", function() {
      console.log("[DOMContentLoaded] => Setting up voices now...");
      setupVoices();
    });

    // ----------------------------------------------------
    // 12) Ao sair da página, parar TTS
    // ----------------------------------------------------
    window.addEventListener("beforeunload", function() {
      console.log("[beforeunload] => Must stop TTS");
      mustStopTTS = true;
      speechSynthesis.cancel();
    });
  </script>
</body>
</html>
