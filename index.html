<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah English - Learning English through Bible Stories</title>
  <!-- Favicon padr√£o -->
  <link rel="icon" type="image/x-icon" href="favicon.ico"/>

  <!-- Favicon para navegadores com tamanhos espec√≠ficos -->
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/>

  <!-- Favicon para Android -->
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png"/>

  <!-- √çcone para dispositivos Apple -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>

  <link rel="stylesheet" href="CSS/styles.css"/>
  <!-- Manifesto PWA -->
  <link rel="manifest" href="manifest.json"/>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* ------------ layout original ------------ */
    body{margin:0;font-family:Arial, sans-serif;overflow:auto;}
    .container{width:100%;max-width:1200px;margin:0 auto;padding:20px;text-align:center;position:relative;
      background-image:url('imagens/fundo.png');background-repeat:repeat;background-size:200%;overflow:auto;}
    html,body{height:100%;}
    .subtitle{margin-top:40px;font-size:24px;font-weight:bold;color:#333;text-align:center;}
    .levels{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px;}
    .level-button{width:200px;height:200px;background-size:cover;background-repeat:no-repeat;display:inline-block;}
    .level0{background-image:url('imagens/Level0_button.png');}
    .levelA{background-image:url('imagens/levelA.png');}
    .levelB{background-image:url('imagens/levelB.png');}
    .levelC{background-image:url('imagens/levelC.png');}
    .levelD{background-image:url('imagens/levelD.png');}

    /* ------------ login box ------------ */
    .login-container{display:flex;align-items:center;gap:10px;position:absolute;top:20px;right:60px;z-index:10;
      background:#fff;padding:10px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.1);cursor:pointer;}
    .user-icon{width:40px;height:40px;border-radius:50%;}
    .user-name{font-size:14px;color:#333;margin:0;}
    .dropdown{display:none;position:absolute;top:60px;right:0;background:#fff;box-shadow:0 4px 8px rgba(0,0,0,.1);
      z-index:1;border-radius:4px;min-width:150px;}
    .dropdown a{display:block;padding:10px;text-decoration:none;color:#333;font-size:16px;text-align:left;}
    .dropdown a:hover{background:#f2f2f2;}

    /* ------------ rob√¥, bot√£o play e convites ------------ */
    .robo-container{display:flex;flex-direction:column;align-items:center;margin:20px auto;}
    .robo-img{width:300px;height:auto;}
    .play-button{margin-top:-40px;padding:8px 16px;border:2px solid #ccc;border-radius:20px;background:#fff;color:#000;
      font-weight:bold;font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,.3);display:flex;align-items:center;gap:8px;cursor:pointer;}
    .play-button:hover{background:#eee;}
    .invitation-container{display:flex;justify-content:center;align-items:center;gap:20px;margin:20px 0;}
    .invitation-button,.free-games-button{max-width:40%;height:auto;cursor:pointer;border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,.2);transition:.3s;}
    .invitation-button:hover,.free-games-button:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,0,0,.3);}

    /* ============ BOT√ÉO PWA ‚Äì NOVO DESIGN ============ */
    #installBtn{
      display:none;               /* aparece por JS */
      position:fixed;
      bottom:calc(env(safe-area-inset-bottom,0px) + 24px);
      right:24px;
      z-index:9999;
      background:linear-gradient(135deg,#ff9800 0%,#ff5722 100%);
      color:#fff;
      border:none;
      padding:14px 24px;
      border-radius:50px;
      font-size:18px;
      font-weight:700;
      box-shadow:0 6px 12px rgba(0,0,0,.25);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
    }
    #installBtn::before{content:"üì≤";font-size:24px;}
    #installBtn:hover{transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,.35);}
    /* anima√ß√£o pulse */
    @keyframes pulse{
      0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,.7);}
      70%{transform:scale(1.05);box-shadow:0 0 0 12px rgba(255,87,34,0);}
      100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,0);}
    }
    #installBtn.pulse{animation:pulse 2s infinite;}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="login-container" id="loginContainer">
        <a href="Formulario/login.html" class="login-button" id="loginLink">Login</a>
        <div class="dropdown" id="userDropdown"></div>
      </div>

      <div class="logo-title">
        <img src="imagens/hannah_logo.png" alt="Hannah English Logo" class="logo"/>
        <h1>Hannah English<br>Learning English through Bible Stories</h1>
      </div>
    </header>

    <div class="robo-container" id="roboContainer">
      <img src="imagens/robo_estatico.png" alt="Rob√¥" class="robo-img" id="roboImage">
      <button class="play-button" id="playTTSBtn"><span>‚ñ∂</span> Play</button>
    </div>

    <div class="invitation-container" id="invitationContainer">
      <img src="imagens/convite.gif" alt="Convite Animado" class="invitation-button" id="invitationButton"/>
      <img src="imagens/Free_Games.gif" alt="Jogos Gr√°tis" class="free-games-button" id="freeGamesButton"/>
    </div>

    <main>          
      <h2 class="subtitle" id="subtitleLoggedOut">Login and Start Learning English While Playing</h2>
      <h2 class="subtitle" id="subtitleLoggedIn" style="display:none;">Choose your level and Start Learning English While Playing</h2>

      <div class="levels">
        <a href="Level0/index.html" class="level-button level0" id="Level0"></a>
        <a href="Level1/index.html" class="level-button levelA" id="Level1"></a>
        <a href="Level2/index.html" class="level-button levelB" id="Level2"></a>
        <a href="Level3/index.html" class="level-button levelC" id="Level3"></a>
        <a href="Level4/index.html" class="level-button levelD" id="Level4"></a>
      </div>
    </main>
  </div>

  <!-- Bot√£o flutuante PWA -->
  <button id="installBtn">Install App</button>

  <!-- ================== SCRIPTS ================== -->
  <script>
    /* ---------- 1) Configura√ß√£o Firebase (sem altera√ß√µes) ---------- */
    var firebaseConfig={apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain:"hannahenglishcourse.firebaseapp.com",
      databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"hannahenglishcourse",
      storageBucket:"hannahenglishcourse.appspot.com",
      messagingSenderId:"449818788486",
      appId:"1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId:"G-07VVJG9LRS"};
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);}

    /* ---------- 2) Vari√°veis globais ---------- */
    let englishVoice=null,hasEnglishVoice=false,deferredPrompt;

    /* ---------- 3) Utilidades TTS ---------- */
    function pickAnyEnglishVoice(){const voices=speechSynthesis.getVoices()||[];
      for(const v of voices){if(v.lang.toLowerCase().includes("en")){hasEnglishVoice=true;return v;}}
      hasEnglishVoice=false;return null;}
    function speakRobotMessage(){
      const text="Hi, I'm Samuel! Click to discover the best and most fun way to learn English, or join us to play an exciting game!";
      const utt=new SpeechSynthesisUtterance(text);
      if(englishVoice)utt.voice=englishVoice;
      utt.onstart=()=>{document.getElementById("roboImage").src="imagens/robo_fala.gif";};
      utt.onend=()=>{document.getElementById("roboImage").src="imagens/robo_estatico.png";};
      speechSynthesis.speak(utt);
    }

    /* ---------- 4) Autentica√ß√£o & UI ---------- */
    firebase.auth().onAuthStateChanged(user=>{
      const loginLink=document.getElementById("loginLink");
      const userDropdown=document.getElementById("userDropdown");
      const roboContainer=document.getElementById("roboContainer");
      const invitationContainer=document.getElementById("invitationContainer");
      const subtitleLoggedOut=document.getElementById("subtitleLoggedOut");
      const subtitleLoggedIn=document.getElementById("subtitleLoggedIn");

      if(user){
        subtitleLoggedOut.style.display="none";
        subtitleLoggedIn.style.display="block";
        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";

        const userRef=firebase.database().ref("usuarios/"+user.uid);
        userRef.once("value").then(snap=>{
          const d=snap.val()||{};
          const name=d.nome||user.email;
          const avatar=d.avatar?`imagens/${d.avatar}`:"imagens/bonecologin1.png";
          loginLink.innerHTML=`<img src="${avatar}" class="user-icon"><p class="user-name">${name}</p>`;
          loginLink.removeAttribute("href");

          let dash="";
          if(d.role==="proprietario"||d.role==="professor"){
            dash=`<a href="painel_${d.role==='proprietario'?'proprietario':'professor'}.html" class="dashboard-link">${d.role.toUpperCase()} DASHBOARD</a>`;
            liberarNiveis(["Level0","Level1","Level2","Level3","Level4"]);
          }else if(d.role==="aluno"){
            dash='<a href="painel_aluno.html" class="dashboard-link">STUDENT DASHBOARD</a>';
            if(d.atrelado_professor){
              firebase.database().ref("usuarios/"+d.atrelado_professor).once("value").then(p=>{
                const pd=p.val();const turmaId="-O8mdLgStvNqNf6x-O5l";
                const alunoId=user.uid;
                const reg=pd?.turmas?.[turmaId]?.students?.[alunoId];
                const nivel=reg?.nivel_em_curso||null;
                nivel?liberarNiveis([nivel]):liberarNiveis(["Level1"]);
              }).catch(()=>liberarNiveis(["Level1"]));
            }else{
              d.progresso?liberarNiveis(Object.keys(d.progresso)):liberarNiveis(["Level1"]);
            }
          }
          userDropdown.innerHTML=`${dash}<a href="#" id="logout">LEAVE</a>`;
          document.querySelectorAll(".dashboard-link").forEach(l=>l.onclick=e=>{
            e.preventDefault();window.location.href=l.getAttribute("href");
          });
        });
      }else{
        subtitleLoggedOut.style.display="block";
        subtitleLoggedIn.style.display="none";
        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";
        loginLink.setAttribute("href","Formulario/login.html");
        bloquearTodosNiveis();
      }
    });

    function bloquearTodosNiveis(){
      document.querySelectorAll(".level-button").forEach(b=>{
        b.style.filter="grayscale(100%)";b.style.pointerEvents="none";
      });
    }
    function liberarNiveis(arr){
      document.querySelectorAll(".level-button").forEach(b=>{
        arr.includes(b.id)?(b.style.filter="none",b.style.pointerEvents="auto"):
                           (b.style.filter="grayscale(100%)",b.style.pointerEvents="none");
      });
    }

    /* ---------- 5) Dropdown login ---------- */
    document.getElementById("loginContainer").onclick=e=>{
      if(!firebase.auth().currentUser)return;
      e.preventDefault();
      const d=document.getElementById("userDropdown");
      d.style.display=(d.style.display==="none"||!d.style.display)?"block":"none";
    };
    window.addEventListener("click",e=>{
      if(!document.getElementById("loginContainer").contains(e.target))
        document.getElementById("userDropdown").style.display="none";
    });

    /* ---------- 6) Logout ---------- */
    document.addEventListener("click",e=>{
      if(e.target.id==="logout"){
        firebase.auth().signOut().then(()=>location.reload());
      }
    });

    /* ---------- 7) Convite & Jogos ---------- */
    document.addEventListener("DOMContentLoaded",()=>{
      document.getElementById("invitationButton").onclick=()=>window.location.href="Apresentacao/propaganda.html";
      document.getElementById("freeGamesButton").onclick=()=>window.location.href="https://hannahenglishcourse.vercel.app/game.html";
    });

    /* ---------- 8) TTS setup + scroll subtitle ---------- */
    speechSynthesis.onvoiceschanged=()=>englishVoice=pickAnyEnglishVoice();
    document.addEventListener("DOMContentLoaded",()=>{
      englishVoice=pickAnyEnglishVoice();
      document.getElementById("playTTSBtn").onclick=speakRobotMessage;
      document.getElementById("subtitleLoggedOut").onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
    });
    window.addEventListener("beforeunload",()=>speechSynthesis.cancel());

    /* ---------- 9) Bot√£o de instala√ß√£o PWA ---------- */
    const installBtn=document.getElementById("installBtn");
    window.addEventListener("beforeinstallprompt",e=>{
      e.preventDefault();
      deferredPrompt=e;
      installBtn.style.display="flex";
      installBtn.classList.add("pulse");
      console.log("[PWA] beforeinstallprompt disparou");
    });
    installBtn.onclick=()=>{
      installBtn.classList.remove("pulse");
      installBtn.style.display="none";
      if(deferredPrompt){
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(c=>{
          console.log("[PWA] escolha:",c.outcome);
          deferredPrompt=null;
        });
      }
    };
    window.addEventListener("appinstalled",()=>console.log("[PWA] instalado üéâ"));

    /* ---------- 10) Service-Worker ---------- */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg=>console.log('‚úÖ Service Worker registrado:',reg))
        .catch(err=>console.error('‚ùå SW erro:',err));
    }
  </script>
</body>
</html>
