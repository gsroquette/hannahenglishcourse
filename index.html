<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah English - Learning English through Bible Stories</title>

  <!-- FAVICONS -->
  <link rel="icon" type="image/x-icon" href="favicon.ico"/>
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/>
  <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="android-chrome-512x512.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>

  <!-- CSS PRINCIPAL -->
  <link rel="stylesheet" href="CSS/styles.css"/>

  <!-- MANIFESTO PWA -->
  <link rel="manifest" href="manifest.json"/>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* ---------- layout original ---------- */
    body{margin:0;font-family:Arial, sans-serif;overflow:auto;}
    html,body{height:100%;}
    .container{
      width:100%;max-width:1200px;margin:0 auto;padding:20px;text-align:center;position:relative;
      background-image:url('imagens/fundo.png');background-repeat:repeat;background-size:200%;overflow:auto;
    }
    .subtitle{margin-top:40px;font-size:24px;font-weight:bold;color:#333;text-align:center;}
    .levels{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px;}
    .level-button{
      width:200px;height:200px;background-size:cover;background-repeat:no-repeat;display:inline-block;
      /* NEW: estado pessimista por padr√£o (bloqueado) */
      filter:grayscale(100%); pointer-events:none;
    }
    .level0{background-image:url('imagens/Level0_button.png');}
    .levelA{background-image:url('imagens/levelA.png');}
    .levelB{background-image:url('imagens/levelB.png');}
    .levelC{background-image:url('imagens/levelC.png');}
    .levelD{background-image:url('imagens/levelD.png');}

    /* ========= AVATAR + NOME (SEM CAIXA) ========= */
    .login-container{
      position:absolute; top:16px; right:14px; z-index:20;
      display:inline-flex; flex-direction:column; align-items:center; gap:4px;
      background:none; border:none; box-shadow:none; padding:0;
      cursor:pointer;
    }
    .user-icon{
      width:55px; height:auto; display:block;
      border:none; box-shadow:none; border-radius:0; object-fit:contain;
      pointer-events:none;
    }
    .user-name{
      margin:0; line-height:1.05; text-align:center;
      font-size:13px; font-weight:700; color:#1a5f34;
      white-space:nowrap; max-width:180px; overflow:hidden; text-overflow:ellipsis;
      text-shadow: 0 1px 1px rgba(255,255,255,0.45), 0 1px 2px rgba(0,0,0,0.18);
    }
    .login-caret{ display:none !important; }

    .dropdown{
      display:none; position:absolute; right:0; top:calc(100% + 10px); z-index:25;
      min-width:220px; background:#fff; border-radius:12px;
      box-shadow:0 14px 30px rgba(0,0,0,0.16); overflow:hidden;
      border:1px solid rgba(0,0,0,0.06);
    }
    .dropdown a{display:block;padding:12px 14px;font-size:15px;color:#222;text-decoration:none;text-align:left;}
    .dropdown a:hover{background:#f2f2f2;}

    /* ---------- rob√¥, play e convites ---------- */
    .robo-container{display:flex;flex-direction:column;align-items:center;margin:20px auto;}
    .robo-img{width:300px;height:auto;}
    .play-button{margin-top:-40px;padding:8px 16px;border:2px solid #ccc;border-radius:20px;background:#fff;color:#000;
      font-weight:bold;font-size:16px;box-shadow:0 2px 4px rgba(0,0,0,.3);display:flex;align-items:center;gap:8px;cursor:pointer;}
    .play-button:hover{background:#eee;}
    .invitation-container{display:flex;justify-content:center;align-items:center;gap:20px;margin:20px 0;}
    .invitation-button,.free-games-button{max-width:40%;height:auto;cursor:pointer;border-radius:10px;
      box-shadow:0 4px 8px rgba(0,0,0,.2);transition:.3s;}
    .invitation-button:hover,.free-games-button:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,0,0,.3);}

    /* ---------- BOT√ÉO PWA ---------- */
    #installBtn{
      display:none;position:fixed;bottom:calc(env(safe-area-inset-bottom,0px) + 24px);right:24px;z-index:9999;
      background:linear-gradient(135deg,#ff9800 0%,#ff5722 100%);color:#fff;border:none;padding:14px 24px;border-radius:50px;
      font-size:18px;font-weight:700;box-shadow:0 6px 12px rgba(0,0,0,.25);cursor:pointer;align-items:center;gap:10px;}
    #installBtn::before{content:"üì≤";font-size:24px;}
    #installBtn:hover{transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,.35);}
    @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,.7);}
      70%{transform:scale(1.05);box-shadow:0 0 0 12px rgba(255,87,34,0);}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(255,87,34,0);}}
    #installBtn.pulse{animation:pulse 2s infinite;}

    /* ---------- banner iOS ---------- */
    #iosInstallBanner{display:none;position:fixed;bottom:0;left:0;right:0;background:#fffbe8;border-top:1px solid #ccc;
      padding:12px 16px;text-align:center;font-size:16px;z-index:10000;}
    #iosInstallBanner button{margin-left:10px;background:#ff5722;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}

    /* NEW: overlay de permiss√µes (UX + bloqueio de clique) */
    #permOverlay{
      position:fixed; inset:0; background:rgba(255,255,255,.6);
      display:none; z-index:30; /* acima dos bot√µes de level, abaixo do dropdown (25)? Vamos sobrepor tudo */
      backdrop-filter:saturate(180%) blur(2px);
    }
    #permOverlay .inner{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:12px 16px;
      box-shadow:0 10px 24px rgba(0,0,0,.15); font-weight:600; color:#333;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ======= Cabe√ßalho / Login ======= -->
    <header>
      <div class="login-container" id="loginContainer">
        <a href="Formulario/login.html" class="login-button" id="loginLink">Login</a>
        <div class="dropdown" id="userDropdown"></div>
      </div>

      <div class="logo-title">
        <img src="imagens/hannah_logo.png" alt="Hannah English Logo" class="logo"/>
        <h1>Hannah English<br>Learning English through Bible Stories</h1>
      </div>
    </header>

    <!-- ======= Rob√¥ + Play ======= -->
    <div class="robo-container" id="roboContainer">
      <img src="imagens/robo_estatico.png" alt="Rob√¥" class="robo-img" id="roboImage">
      <button class="play-button" id="playTTSBtn"><span>‚ñ∂</span> Play</button>
    </div>

    <!-- ======= Convites ======= -->
    <div class="invitation-container" id="invitationContainer">
      <img src="imagens/convite.gif" alt="Convite Animado" class="invitation-button" id="invitationButton"/>
      <img src="imagens/Free_Games.gif" alt="Jogos Gr√°tis" class="free-games-button" id="freeGamesButton"/>
    </div>

    <!-- ======= Conte√∫do principal ======= -->
    <main>
      <h2 class="subtitle" id="subtitleLoggedOut">Login and Start Learning English While Playing</h2>
      <h2 class="subtitle" id="subtitleLoggedIn" style="display:none;">Choose your level and Start Learning English While Playing</h2>

      <div class="levels">
        <a href="Level0/index.html" class="level-button level0" id="Level0"></a>
        <a href="Level1/index.html" class="level-button levelA" id="Level1"></a>
        <a href="Level2/index.html" class="level-button levelB" id="Level2"></a>
        <a href="Level3/index.html" class="level-button levelC" id="Level3"></a>
        <a href="Level4/index.html" class="level-button levelD" id="Level4"></a>
      </div>
    </main>
  </div>

  <!-- NEW: Overlay de carregamento de permiss√µes -->
  <div id="permOverlay" aria-hidden="true">
    <div class="inner">Loading your permissions‚Ä¶</div>
  </div>

  <!-- Bot√£o flutuante PWA -->
  <button id="installBtn" disabled>Install App</button>

  <!-- Banner iOS (EN + PT) -->
  <div id="iosInstallBanner">
    To install the app, tap the <strong>Share</strong> button and choose ‚ÄúAdd to Home Screen‚Äù.<br>
    <span style="font-size:14px;display:block;margin-top:4px;">
      Para instalar o app, toque no bot√£o <strong>Compartilhar</strong> e depois em ‚ÄúAdicionar √† Tela de In√≠cio‚Äù.
    </span>
    <button id="iosBannerClose">OK</button>
  </div>

  <!-- ================== SCRIPTS ================== -->
  <script>
    /* ---------- Firebase ---------- */
    var firebaseConfig={
      apiKey:"AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
      authDomain:"hannahenglishcourse.firebaseapp.com",
      databaseURL:"https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId:"hannahenglishcourse",
      storageBucket:"hannahenglishcourse.appspot.com",
      messagingSenderId:"449818788486",
      appId:"1:449818788486:web:8a49d3f68591e6fb3f0707",
      measurementId:"G-07VVJG9LRS"
    };
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig);}
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);

    /* ---------- PWA helpers ---------- */
    function isInStandaloneMode(){
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }
    let englishVoice=null, deferredPrompt=null;

    const installBtn=document.getElementById("installBtn");
    const ua=navigator.userAgent.toLowerCase();
    const isIOS=/iphone|ipad|ipod/.test(ua);

    /* ---------- N√≠veis helpers ---------- */
    const VALID_LEVELS=["Level0","Level1","Level2","Level3","Level4"];

    function normalizarNivel(n){
      if(!n) return null;
      const m=String(n).trim().toLowerCase();
      if(m==="level0"||m==="0"||m==="starter") return "Level0";
      if(m==="level1"||m==="1") return "Level1";
      if(m==="level2"||m==="2") return "Level2";
      if(m==="level3"||m==="3") return "Level3";
      if(m==="level4"||m==="4") return "Level4";
      return null;
    }
    function normalizarListaLevels(v){
      if(Array.isArray(v)){
        const set=new Set();
        v.forEach(x=>{const n=normalizarNivel(x); if(n) set.add(n);});
        return Array.from(set);
      }
      const single=normalizarNivel(v);
      return single ? [single] : [];
    }
    function levelsAPartirDoProgresso(progresso){
      if(!progresso||typeof progresso!=="object") return [];
      const liberados=[];
      VALID_LEVELS.forEach(L=>{
        const units=progresso[L];
        if(!units||typeof units!=="object") return;
        for(const uk of Object.keys(units)){
          const fases=units[uk];
          if(fases && typeof fases==="object" && Object.values(fases).some(Boolean)){
            liberados.push(L); break;
          }
        }
      });
      return Array.from(new Set(liberados));
    }

    /* ---------- Estado de permiss√µes + overlay (NEW) ---------- */
    let permissionsReady=false;
    let allowedLevels=new Set();

    const permOverlay=document.getElementById('permOverlay');
    function setPermOverlay(show){
      permOverlay.style.display=show?'block':'none';
      permOverlay.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    /* ---------- PWA bot√£o instalar ---------- */
    function showInstallButton(){installBtn.disabled=false;installBtn.style.display='flex';installBtn.classList.add('pulse');}
    function hideInstallButton(){installBtn.style.display='none';installBtn.classList.remove('pulse');installBtn.disabled=true;}
    function controlPWAButtons(){ if(isInStandaloneMode()){hideInstallButton();return;} if(deferredPrompt){showInstallButton();} else {hideInstallButton();}}
    if(isIOS && !isInStandaloneMode()){
      const b=document.getElementById("iosInstallBanner");
      b.style.display="block";
      document.getElementById("iosBannerClose").onclick=()=>b.style.display="none";
    }
    window.addEventListener('beforeinstallprompt',e=>{
      if(isInStandaloneMode()) return;
      e.preventDefault();
      deferredPrompt=e; showInstallButton();
    });
    installBtn.addEventListener('click',async ()=>{
      if(!deferredPrompt) return; hideInstallButton();
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; setTimeout(controlPWAButtons,500);
    });
    window.addEventListener('appinstalled',()=>{deferredPrompt=null;hideInstallButton();});
    async function verificarInstalacaoInicial(){
      if(isInStandaloneMode()){hideInstallButton();return;}
      if('getInstalledRelatedApps' in navigator){
        try{
          const apps=await navigator.getInstalledRelatedApps();
          if(apps.length>0){hideInstallButton();}
        }catch(e){}
      }
      controlPWAButtons();
    }
    function updateNetworkStatus(){
      if(!navigator.onLine) installBtn.disabled=true; else if(deferredPrompt) installBtn.disabled=false;
    }
    window.addEventListener('online',updateNetworkStatus);
    window.addEventListener('offline',updateNetworkStatus);

    /* ---------- TTS util ---------- */
    function pickVoice(){ return (speechSynthesis.getVoices()||[]).find(v=>v.lang.toLowerCase().includes('en'))||null; }
    function speakRobot(){
      const utt=new SpeechSynthesisUtterance("Hi, I'm Samuel! Click to discover the best and most fun way to learn English, or join us to play an exciting game!");
      if(englishVoice) utt.voice=englishVoice;
      utt.onstart=()=>document.getElementById("roboImage").src="imagens/robo_fala.gif";
      utt.onend  =()=>document.getElementById("roboImage").src="imagens/robo_estatico.png";
      speechSynthesis.speak(utt);
    }
    speechSynthesis.onvoiceschanged=()=>englishVoice=pickVoice();

    /* ---------- UI: n√≠veis ---------- */
    function bloquearTodosNiveis(){
      // NEW: estado interno + UI pessimista
      permissionsReady=false;
      allowedLevels = new Set();
      document.querySelectorAll(".level-button").forEach(b=>{
        b.style.filter="grayscale(100%)";
        b.style.pointerEvents="none";
      });
    }
    function liberarNiveis(arr){
      const alvo=new Set(arr||[]);
      allowedLevels = new Set(alvo);       // NEW: estado interno
      permissionsReady=true;               // NEW: estado pronto

      document.querySelectorAll(".level-button").forEach(b=>{
        if(alvo.has(b.id)){
          b.style.filter="none";
          b.style.pointerEvents="auto";
        } else {
          b.style.filter="grayscale(100%)";
          b.style.pointerEvents="none";
        }
      });

      // NEW: some overlay quando pelo menos 1 n√≠vel foi aplicado
      const hasAny=alvo.size>0;
      if(hasAny) setPermOverlay(false);
    }
    function enviarNivel(n){ n ? liberarNiveis([n]) : liberarNiveis(["Level1"]); }

    /* ---------- Guard de clique (NEW): impede navega√ß√£o sem permiss√£o ---------- */
    document.addEventListener('click', (e)=>{
      const a = e.target.closest && e.target.closest('.level-button');
      if(!a) return;
      const levelId = a.id;
      // Se ainda n√£o carregou permiss√µes ou o n√≠vel n√£o est√° permitido, cancela
      if(!permissionsReady || !allowedLevels.has(levelId)){
        e.preventDefault();
        // Overlay curto se ainda carregando; se j√° carregou e n√£o tem permiss√£o, s√≥ ignora o clique.
        if(!permissionsReady){
          setPermOverlay(true);
          // overlay ser√° fechado por liberarNiveis() ao finalizar
        }
        return false;
      }
    }, true); // capture = true para pegar antes de event handlers padr√£o

    /* ---------- Firebase Auth & N√≠veis ---------- */
    firebase.auth().onAuthStateChanged(async (user)=>{
      const loginLink=document.getElementById("loginLink");
      const userDropdown=document.getElementById("userDropdown");
      const subtitleLoggedOut=document.getElementById("subtitleLoggedOut");
      const subtitleLoggedIn=document.getElementById("subtitleLoggedIn");
      const roboContainer=document.getElementById("roboContainer");
      const invitationContainer=document.getElementById("invitationContainer");
      const loginContainer=document.getElementById("loginContainer");

      // NEW: sempre come√ßar bloqueado e overlay on quando logado
      bloquearTodosNiveis();

      if(user){
        subtitleLoggedOut.style.display="none";
        subtitleLoggedIn.style.display="block";
        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";
        setPermOverlay(true); // NEW: mostra overlay enquanto busca permiss√µes

        try{
          const snap=await firebase.database().ref("usuarios/"+user.uid).once("value");
          const d=snap.val()||{};

          // nome limitado a 10 caracteres + '‚Ä¶' se exceder
          const rawName=d.nome||user.email||"User";
          const name=(String(rawName).trim().length>10) ? String(rawName).trim().slice(0,10)+"‚Ä¶" : String(rawName).trim();

          const avatar=d.avatar?`imagens/${d.avatar}`:"imagens/bonecologin1.png";

          // s√≥ avatar + nome (sem caixa)
          loginLink.innerHTML=""; loginLink.removeAttribute("href");
          const img=document.createElement("img");
          img.className="user-icon"; img.alt="User avatar"; img.src=avatar;
          img.onerror=()=>{img.src='imagens/bonecologin1.png';};
          const p=document.createElement("p");
          p.className="user-name"; p.textContent=name;
          loginLink.append(img,p);

          let dash="";
          if(d.role==="proprietario"||d.role==="professor"){
            dash=`<a href="painel_${d.role==='proprietario'?'proprietario':'professor'}.html" class="dashboard-link">${d.role.toUpperCase()} DASHBOARD</a>`;
            liberarNiveis(VALID_LEVELS); // libera TODOS
          }else if(d.role==="aluno"){
            dash='<a href="painel_aluno.html" class="dashboard-link">STUDENT DASHBOARD</a>';

            const liberarPorPreferencia=(lista)=>{ if(Array.isArray(lista)&&lista.length){liberarNiveis(lista);return true;} return false; };
            const tentarAlunoDireto=()=>{
              const arrAluno=normalizarListaLevels(d.levels_liberados);
              if(liberarPorPreferencia(arrAluno)) return;
              const nAluno=normalizarNivel(d.nivel_em_curso);
              if(nAluno){ enviarNivel(nAluno); return; }
              const arrFromProg=levelsAPartirDoProgresso(d.progresso);
              if(liberarPorPreferencia(arrFromProg)) return;
              enviarNivel(); // default: Level1
            };

            if(d.atrelado_professor){
              try{
                const turmasSnap=await firebase.database().ref("usuarios/"+d.atrelado_professor+"/turmas").once("value");
                const turmas=turmasSnap.val()||{}; let registroAluno=null;
                for(const turmaId in turmas){
                  const st=turmas[turmaId]?.students?.[user.uid];
                  if(st){registroAluno=st; break;}
                }
                if(registroAluno){
                  const arrProf=normalizarListaLevels(registroAluno.levels_liberados);
                  if(liberarPorPreferencia(arrProf)){} else {
                    const nProf=normalizarNivel(registroAluno.nivel_em_curso);
                    if(nProf){enviarNivel(nProf);} else {tentarAlunoDireto();}
                  }
                }else{
                  tentarAlunoDireto();
                }
              }catch(e){
                tentarAlunoDireto();
              }
            }else{
              tentarAlunoDireto();
            }
          }
          userDropdown.innerHTML=`${dash}<a href="#" id="logout">LEAVE</a>`;
          document.querySelectorAll(".dashboard-link").forEach(l=>{
            l.onclick=e=>{ e.preventDefault(); window.location.href=l.getAttribute("href"); };
          });

          // Dropdown abre/fecha
          function toggleDropdown(open){
            const shouldOpen=(typeof open==="boolean")?open:(userDropdown.style.display!=="block");
            userDropdown.style.display=shouldOpen?"block":"none";
          }
          loginContainer.onclick=(e)=>{ if(!firebase.auth().currentUser) return; e.preventDefault(); toggleDropdown(); };
          window.addEventListener("click",(e)=>{ if(!loginContainer.contains(e.target)) toggleDropdown(false); });

          // NEW: se por algum motivo ningu√©m liberou nada (dados vazios), overlay some no enviarNivel/default
          if(!permissionsReady){
            // assegura que overlay n√£o fique preso caso nenhum dado v√°lido chegue
            setPermOverlay(false);
          }

        }catch(e){
          console.error(e);
          bloquearTodosNiveis();
          setPermOverlay(false); // evita overlay eterno em erro
        }
      }else{
        subtitleLoggedOut.style.display="block";
        subtitleLoggedIn.style.display="none";
        roboContainer.style.display="flex";
        invitationContainer.style.display="flex";
        document.getElementById("loginLink").setAttribute("href","Formulario/login.html");
        bloquearTodosNiveis();
        setPermOverlay(false);
      }
    });

    /* ---------- Logout ---------- */
    document.addEventListener("click",e=>{
      if(e.target && e.target.id==="logout"){
        firebase.auth().signOut().then(()=>location.reload());
      }
    });

    /* ---------- DOM Ready ---------- */
    function pickVoice(){ return (speechSynthesis.getVoices()||[]).find(v=>v.lang.toLowerCase().includes('en'))||null; }
    document.addEventListener("DOMContentLoaded",()=>{
      // NEW: garante bloqueio inicial antes de qualquer intera√ß√£o
      bloquearTodosNiveis();

      englishVoice=pickVoice();
      document.getElementById("playTTSBtn").onclick=speakRobot;
      document.getElementById("invitationButton").onclick=()=>location.href="Apresentacao/propaganda.html";
      document.getElementById("freeGamesButton").onclick   =()=>location.href="https://hannahenglishcourse.netlify.app/game.html";
      document.getElementById("subtitleLoggedOut").onclick=()=>window.scrollTo({top:0,behavior:"smooth"});
      updateNetworkStatus();
      verificarInstalacaoInicial();
    });
    window.addEventListener("beforeunload",()=>speechSynthesis.cancel());

    /* ---------- Service Worker ---------- */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/service-worker.js')
        .then(r=>console.log("SW registrado:",r.scope))
        .catch(err=>console.error("SW erro:",err));
    }

    /* ---------- Futuro (opcional): custom claims ----------
      // TODO (backend): mover "levels_liberados/nivel_em_curso" para custom claims.
      // Vantagem: permiss√µes chegam no token, reduzindo 1 leitura ao DB e a lat√™ncia.
    */
  </script>
</body>
</html>
