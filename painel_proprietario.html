<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Usuários</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Estilos de CSS aqui (igual ao original) */
  </style>
</head>

<body>
  <button class="back-button" onclick="window.history.back()">Back</button>
  <h1>Gerenciamento de Usuários</h1>
  
  <form id="cadastroForm">
    <h2>Cadastrar Novo Usuário</h2>
    <label>Email: <input type="email" id="email" required></label>
    <label>Senha: <input type="password" id="senha" required></label>
    <small>A senha deve ter pelo menos 6 caracteres.</small>
    <label>Nome: <input type="text" id="nome" required></label>
    <label>Telefone: <input type="tel" id="telefone" required></label>
    <label>Tipo de Usuário: 
      <select id="tipo">
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="visitante">Visitante</option>
        <option value="proprietario">Proprietário</option>
      </select>
    </label>
    <button type="submit">Cadastrar</button>
  </form>

  <p id="feedback"></p>
  <hr>
  <div class="unit-container">
    <h2>Pesquisar Usuários</h2>
    <label>Tipo de Usuário: 
      <select id="filtroTipo">
        <option value="">Todos</option>
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="visitante">Visitante</option>
      </select>
    </label>
    <button onclick="pesquisarUsuarios()">Pesquisar</button>
  </div>

  <h2>Resultados da Pesquisa</h2>
  <div id="resultados"></div>
  <div id="progressoAluno"></div>

  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script>
    // Configuração do Firebase
    function configurarFirebase() {
      var firebaseConfig = {
        apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
        authDomain: "hannahenglishcourse.firebaseapp.com",
        databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "hannahenglishcourse",
        storageBucket: "hannahenglishcourse.appspot.com",
        messagingSenderId: "449818788486",
        appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
        measurementId: "G-07VVJG9LRS"
      };
      firebase.initializeApp(firebaseConfig);
      return firebase.database();
    }

    const db = configurarFirebase();

    // Verificar se o usuário é "proprietário"
    function verificarProprietario(callback) {
      const user = firebase.auth().currentUser;
      if (user) {
        db.ref('usuarios/' + user.uid + '/role').once('value').then(snapshot => {
          const role = snapshot.val();
          if (role === 'proprietario') {
            callback(); // Permite o acesso
          } else {
            alert("Acesso negado. Somente proprietários podem acessar esta área.");
          }
        }).catch(error => {
          console.error("Erro ao verificar papel do usuário:", error);
        });
      } else {
        alert("Usuário não autenticado.");
      }
    }

    // Cadastro de Usuários
    function cadastrarUsuario(email, senha, nome, telefone, tipo) {
      verificarProprietario(async () => {
        const feedback = document.getElementById('feedback');
        feedback.textContent = '';
        if (senha.length < 6) {
          feedback.textContent = 'A senha deve ter pelo menos 6 caracteres.';
          return;
        }

        try {
          const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, senha);
          const userId = userCredential.user.uid;
          const dataHora = new Date().toLocaleString();
          const userData = {
            email: email,
            nome: nome,
            telefone: telefone,
            role: tipo,
            progresso: tipo === 'aluno' ? {} : null,
            dataHoraCadastro: dataHora
          };
          await db.ref('usuarios/' + userId).set(userData);
          alert("Usuário cadastrado com sucesso!");
          document.getElementById('cadastroForm').reset();
          buscarUsuarios();
        } catch (error) {
          feedback.textContent = `Erro: ${error.message}`;
        }
      });
    }

    // Função para buscar usuários com filtro
    function pesquisarUsuarios() {
      const filtroTipo = document.getElementById('filtroTipo').value;
      console.log("Filtrando por tipo:", filtroTipo); // Log para debug
      buscarUsuarios(filtroTipo);
    }

    // Função que busca todos os usuários ou por tipo específico
    function buscarUsuarios(filtroTipo = '') {
      verificarProprietario(() => {
        db.ref('usuarios').once('value').then(snapshot => {
          const resultados = snapshot.val();
          console.log("Usuários encontrados:", resultados); // Log para debug
          renderizarResultados(resultados, filtroTipo);
        }).catch(error => {
          console.error("Erro ao buscar usuários:", error);
        });
      });
    }

    // Função para renderizar os resultados da busca
    function renderizarResultados(resultados, filtroTipo) {
      const resultadosContainer = document.getElementById('resultados');
      resultadosContainer.innerHTML = '';
      for (let uid in resultados) {
        const usuario = resultados[uid];
        if (filtroTipo === '' || usuario.role === filtroTipo) {
          resultadosContainer.innerHTML += `
            <div class="result-container">
              <h3>${usuario.nome} (${usuario.role})</h3>
              <p>Email: ${usuario.email}</p>
              <p>Telefone: ${usuario.telefone}</p>
              <p>Data de Cadastro: ${usuario.dataHoraCadastro}</p>
              ${usuario.role === 'aluno' ? `<button onclick="verProgresso('${uid}')">Ver Progresso</button>` : ''}
              <button onclick="editarUsuario('${uid}')">Editar</button>
              <button onclick="confirmarExclusaoUsuario('${uid}')">Excluir</button>
              ${usuario.role === 'professor' ? `
                <div id="turmas-${uid}"></div>
                <button onclick="cadastrarTurma('${uid}')">Adicionar Turma</button>
                <button onclick="listarTurmas('${uid}')">Ver Turmas</button>` : ''}
            </div>`;
        }
      }
      console.log("Resultados renderizados com filtro:", filtroTipo); // Log para debug
    }

    // Funções restantes (verificarProprietario, listarTurmas, editarUsuario, etc.) permanecem as mesmas

    // Função de Inicialização
    function inicializarAplicacao() {
      document.getElementById('cadastroForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const senha = document.getElementById('senha').value;
        const nome = document.getElementById('nome').value;
        const telefone = document.getElementById('telefone').value;
        const tipo = document.getElementById('tipo').value;
        cadastrarUsuario(email, senha, nome, telefone, tipo);
      });
      // Carrega todos os usuários na inicialização
      buscarUsuarios();
    }

    // Autenticação e verificação de papel
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        verificarProprietario(inicializarAplicacao);
      } else {
        alert("Por favor, faça login para continuar.");
      }
    });
  </script>
</body>
</html>
