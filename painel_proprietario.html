<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Usuários</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* CSS padrão */
  </style>
</head>

<body>
  <!-- Botão Back -->
  <button class="back-button" onclick="window.history.back()">Back</button>

  <h1>Gerenciamento de Usuários</h1>

  <!-- Formulário de Cadastro -->
  <form id="cadastroForm">
    <h2>Cadastrar Novo Usuário</h2>
    <label>Email: <input type="email" id="email" required></label>
    <label>Senha: <input type="password" id="senha" required></label>
    <small>A senha deve ter pelo menos 6 caracteres.</small>
    <label>Nome: <input type="text" id="nome" required></label>
    <label>Telefone: <input type="tel" id="telefone" required></label>
    <label>Tipo de Usuário: 
      <select id="tipo">
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="visitante">Visitante</option>
        <option value="proprietario">Proprietário</option>
      </select>
    </label>
    <button type="submit">Cadastrar</button>
  </form>

  <p id="feedback"></p>

  <hr>

  <!-- Filtros de Pesquisa -->
  <div class="unit-container">
    <h2>Pesquisar Usuários</h2>
    <label>Tipo de Usuário: 
      <select id="filtroTipo">
        <option value="">Todos</option>
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="visitante">Visitante</option>
      </select>
    </label>
    <button onclick="buscarUsuarios()">Pesquisar</button>
  </div>

  <!-- Resultados da Pesquisa -->
  <h2>Resultados da Pesquisa</h2>
  <div id="resultados"></div>

  <!-- Progresso do Aluno -->
  <div id="progressoAluno"></div>

  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configuração do Firebase
      var firebaseConfig = {
        apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
        authDomain: "hannahenglishcourse.firebaseapp.com",
        databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "hannahenglishcourse",
        storageBucket: "hannahenglishcourse.appspot.com",
        messagingSenderId: "449818788486",
        appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
        measurementId: "G-07VVJG9LRS"
      };
      firebase.initializeApp(firebaseConfig);

      const db = firebase.database();

      // Função para cadastrar um novo usuário
      document.getElementById('cadastroForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const senha = document.getElementById('senha').value;
        const nome = document.getElementById('nome').value;
        const telefone = document.getElementById('telefone').value;
        const tipo = document.getElementById('tipo').value;
        const dataHora = new Date().toLocaleString();
        const feedback = document.getElementById('feedback');
        feedback.textContent = ''; // Limpa o feedback anterior

        if (senha.length < 6) {
          feedback.textContent = 'A senha deve ter pelo menos 6 caracteres.';
          return;
        }

        firebase.auth().createUserWithEmailAndPassword(email, senha)
          .then(userCredential => {
            const userId = userCredential.user.uid;
            const userData = {
              email: email,
              nome: nome,
              telefone: telefone,
              role: tipo,
              progresso: tipo === 'aluno' ? {} : null,
              dataHoraCadastro: dataHora
            };
            return db.ref('usuarios/' + userId).set(userData);
          })
          .then(() => {
            alert("Usuário cadastrado com sucesso!");
            document.getElementById('cadastroForm').reset();
            setTimeout(buscarUsuarios, 500); // Aguarda para garantir atualização no Firebase
          })
          .catch(error => {
            console.error("Erro ao cadastrar usuário:", error);
            feedback.textContent = `Erro: ${error.message}`;
          });
      });

      // Função para buscar usuários por tipo
      window.buscarUsuarios = function() {
        const filtroTipo = document.getElementById('filtroTipo').value;
        db.ref('usuarios').on('value', snapshot => {
          const resultados = snapshot.val();
          let html = '';
          
          for (let uid in resultados) {
            const usuario = resultados[uid];
            if (filtroTipo === '' || usuario.role === filtroTipo) {
              html += `<div class="result-container">
                <h3>${usuario.nome} (${usuario.role})</h3>
                <p>Email: ${usuario.email}</p>
                <p>Telefone: ${usuario.telefone}</p>
                <p>Data de Cadastro: ${usuario.dataHoraCadastro}</p>
                ${usuario.role === 'aluno' ? `<button onclick="verProgresso('${uid}')">Ver Progresso</button>` : ''}
                <button onclick="editarUsuario('${uid}')">Editar</button>
                <button onclick="confirmarExclusaoUsuario('${uid}')">Excluir</button>
                ${usuario.role === 'professor' ? `
                  <div id="turmas-${uid}"></div>
                  <button onclick="cadastrarTurma('${uid}')">Adicionar Turma</button>
                  <button onclick="listarTurmas('${uid}')">Ver Turmas</button>` : ''}
              </div>`;
            }
          }
          
          document.getElementById('resultados').innerHTML = html;
        });
      };

      // Função para listar turmas do professor
      window.listarTurmas = function(uid) {
        db.ref(`usuarios/${uid}/turmas`).once('value').then(snapshot => {
          let turmasHTML = '<h4>Turmas:</h4><ul>';
          snapshot.forEach(childSnapshot => {
            const turmaId = childSnapshot.key;
            const turma = childSnapshot.val();
            turmasHTML += `<li>${turma.nome} - ${turma.alunos} alunos 
                           <button onclick="editarTurma('${uid}', '${turmaId}')">Editar</button>
                           <button onclick="excluirTurma('${uid}', '${turmaId}')">Excluir</button>
                           </li>`;
          });
          turmasHTML += '</ul>';
          document.getElementById(`turmas-${uid}`).innerHTML = turmasHTML;
        });
      };

      // Funções de edição e exclusão de turma
      window.editarTurma = function(uid, turmaId) {
        const nome = prompt("Nome da turma:");
        const alunos = prompt("Número de alunos:");
        if (nome && alunos) {
          db.ref(`usuarios/${uid}/turmas/${turmaId}`).update({
            nome: nome,
            alunos: parseInt(alunos)
          }).then(() => {
            alert("Turma atualizada com sucesso!");
            listarTurmas(uid);
          });
        }
      };

      window.excluirTurma = function(uid, turmaId) {
        if (confirm("Tem certeza de que deseja excluir esta turma?")) {
          db.ref(`usuarios/${uid}/turmas/${turmaId}`).remove().then(() => {
            alert("Turma excluída com sucesso!");
            listarTurmas(uid);
          });
        }
      };

      // Funções relacionadas ao progresso do aluno
      window.verProgresso = function(uid) {
        db.ref(`usuarios/${uid}/progresso`).once('value', snapshot => {
          const progresso = snapshot.val();
          let progressoHTML = `<h3>Progresso do Aluno</h3><ul>`;
          for (let nivel in progresso) {
            progressoHTML += `<li><strong>Nível ${nivel}</strong><ul>`;
            for (let unidade in progresso[nivel]) {
              progressoHTML += `<li>Unidade ${unidade}: <ul>`;
              for (let fase in progresso[nivel][unidade]) {
                const status = progresso[nivel][unidade][fase] ? 'Completo' : 'Incompleto';
                progressoHTML += `<li>Fase ${fase}: ${status}</li>`;
              }
              progressoHTML += `</ul></li>`;
            }
            progressoHTML += `</ul></li>`;
          }
          progressoHTML += `</ul>`;
          document.getElementById('progressoAluno').innerHTML = progressoHTML;
        });
      };

      // Função para excluir um usuário
      window.confirmarExclusaoUsuario = function(uid) {
        if (confirm("Tem certeza de que deseja excluir este usuário?")) {
          db.ref('usuarios/' + uid).remove().then(() => {
            alert("Usuário excluído com sucesso.");
            buscarUsuarios(); // Atualiza a lista após a exclusão
          });
        }
      };

      // Função para editar um usuário
      window.editarUsuario = function(uid) {
        db.ref('usuarios/' + uid).once('value').then(snapshot => {
          const usuario = snapshot.val();
          const novoNome = prompt("Edite o nome:", usuario.nome);
          const novoTelefone = prompt("Edite o telefone:", usuario.telefone);
          const novoTipo = prompt("Edite o tipo (aluno, professor, visitante, proprietário):", usuario.role);
          if (novoNome && novoTelefone && novoTipo) {
            db.ref('usuarios/' + uid).update({
              nome: novoNome,
              telefone: novoTelefone,
              role: novoTipo
            }).then(() => {
              alert("Usuário atualizado com sucesso.");
              buscarUsuarios(); // Atualiza a lista após a edição
            });
          }
        });
      };

    });
  </script>
</body>
</html>
