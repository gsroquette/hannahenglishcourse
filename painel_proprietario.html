<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Usuários</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Estilos de CSS aqui (igual ao original) */
  </style>
</head>

<body>
  <button class="back-button" onclick="window.history.back()">Back</button>
  <h1>Gerenciamento de Usuários</h1>
  
  <form id="cadastroForm">
    <h2>Cadastrar Novo Usuário</h2>
    <label>Email: <input type="email" id="email" required></label>
    <label>Senha: <input type="password" id="senha" required></label>
    <small>A senha deve ter pelo menos 6 caracteres.</small>
    <label>Nome: <input type="text" id="nome" required></label>
    <label>Telefone: <input type="tel" id="telefone" required></label>
    <label>Tipo de Usuário: 
      <select id="tipo">
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="visitante">Visitante</option>
        <option value="proprietario">Proprietário</option>
      </select>
    </label>
    <button type="submit">Cadastrar</button>
  </form>

  <p id="feedback"></p>
  <hr>
  <div class="unit-container">
    <h2>Pesquisar Usuários</h2>
    <label>Tipo de Usuário: 
      <select id="filtroTipo">
        <option value="">Todos</option>
        <option value="aluno">Aluno</option>
        <option value="professor">Professor</option>
        <option value="visitante">Visitante</option>
      </select>
    </label>
    <button onclick="buscarUsuarios()">Pesquisar</button>
  </div>

  <h2>Resultados da Pesquisa</h2>
  <div id="resultados"></div>
  <div id="progressoAluno"></div>

  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
  <script>
    // Configuração do Firebase
    function configurarFirebase() {
      var firebaseConfig = {
        apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
        authDomain: "hannahenglishcourse.firebaseapp.com",
        databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "hannahenglishcourse",
        storageBucket: "hannahenglishcourse.appspot.com",
        messagingSenderId: "449818788486",
        appId: "1:449818788486:web:8a49d3f68591e6fb3f0707",
        measurementId: "G-07VVJG9LRS"
      };
      firebase.initializeApp(firebaseConfig);
      return firebase.database();
    }

    const db = configurarFirebase();

    // Cadastro de Usuários
    async function cadastrarUsuario(email, senha, nome, telefone, tipo) {
      const feedback = document.getElementById('feedback');
      feedback.textContent = '';
      if (senha.length < 6) {
        feedback.textContent = 'A senha deve ter pelo menos 6 caracteres.';
        return;
      }

      try {
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, senha);
        const userId = userCredential.user.uid;
        const dataHora = new Date().toLocaleString();
        const userData = {
          email: email,
          nome: nome,
          telefone: telefone,
          role: tipo,
          progresso: tipo === 'aluno' ? {} : null,
          dataHoraCadastro: dataHora
        };
        await db.ref('usuarios/' + userId).set(userData);
        alert("Usuário cadastrado com sucesso!");
        document.getElementById('cadastroForm').reset();
        buscarUsuarios();
      } catch (error) {
        feedback.textContent = `Erro: ${error.message}`;
      }
    }

    // Busca e Renderização de Usuários
    async function buscarUsuarios(filtroTipo = '') {
      try {
        const snapshot = await db.ref('usuarios').once('value');
        const resultados = snapshot.val();
        renderizarResultados(resultados, filtroTipo);
      } catch (error) {
        console.error("Erro ao buscar usuários:", error);
      }
    }

    function renderizarResultados(resultados, filtroTipo) {
      const resultadosContainer = document.getElementById('resultados');
      resultadosContainer.innerHTML = '';
      for (let uid in resultados) {
        const usuario = resultados[uid];
        if (filtroTipo === '' || usuario.role === filtroTipo) {
          resultadosContainer.innerHTML += `
            <div class="result-container">
              <h3>${usuario.nome} (${usuario.role})</h3>
              <p>Email: ${usuario.email}</p>
              <p>Telefone: ${usuario.telefone}</p>
              <p>Data de Cadastro: ${usuario.dataHoraCadastro}</p>
              ${usuario.role === 'aluno' ? `<button onclick="verProgresso('${uid}')">Ver Progresso</button>` : ''}
              <button onclick="editarUsuario('${uid}')">Editar</button>
              <button onclick="confirmarExclusaoUsuario('${uid}')">Excluir</button>
              ${usuario.role === 'professor' ? `
                <div id="turmas-${uid}"></div>
                <button onclick="cadastrarTurma('${uid}')">Adicionar Turma</button>
                <button onclick="listarTurmas('${uid}')">Ver Turmas</button>` : ''}
            </div>`;
        }
      }
    }

    // Gerenciamento de Turmas
    async function listarTurmas(uid) {
      try {
        const snapshot = await db.ref(`usuarios/${uid}/turmas`).once('value');
        let turmasHTML = '<h4>Turmas:</h4><ul>';
        snapshot.forEach(childSnapshot => {
          const turma = childSnapshot.val();
          const turmaId = childSnapshot.key;
          turmasHTML += `<li>${turma.nome} - ${turma.alunos} alunos 
                         <button onclick="editarTurma('${uid}', '${turmaId}')">Editar</button>
                         <button onclick="excluirTurma('${uid}', '${turmaId}')">Excluir</button></li>`;
        });
        turmasHTML += '</ul>';
        document.getElementById(`turmas-${uid}`).innerHTML = turmasHTML;
      } catch (error) {
        console.error("Erro ao listar turmas:", error);
      }
    }

    async function cadastrarTurma(uid) {
      const nome = prompt("Nome da turma:");
      const alunos = prompt("Número de alunos:");
      if (nome && alunos) {
        await db.ref(`usuarios/${uid}/turmas`).push({ nome: nome, alunos: parseInt(alunos) });
        listarTurmas(uid);
      }
    }

    async function editarTurma(uid, turmaId) {
      const nome = prompt("Nome da turma:");
      const alunos = prompt("Número de alunos:");
      if (nome && alunos) {
        await db.ref(`usuarios/${uid}/turmas/${turmaId}`).update({ nome: nome, alunos: parseInt(alunos) });
        listarTurmas(uid);
      }
    }

    async function excluirTurma(uid, turmaId) {
      if (confirm("Tem certeza de que deseja excluir esta turma?")) {
        await db.ref(`usuarios/${uid}/turmas/${turmaId}`).remove();
        listarTurmas(uid);
      }
    }

    // Progresso do Aluno
    async function verProgresso(uid) {
      try {
        const snapshot = await db.ref(`usuarios/${uid}/progresso`).once('value');
        const progresso = snapshot.val();
        let progressoHTML = `<h3>Progresso do Aluno</h3><ul>`;
        for (let nivel in progresso) {
          progressoHTML += `<li><strong>Nível ${nivel}</strong><ul>`;
          for (let unidade in progresso[nivel]) {
            progressoHTML += `<li>Unidade ${unidade}: <ul>`;
            for (let fase in progresso[nivel][unidade]) {
              const status = progresso[nivel][unidade][fase] ? 'Completo' : 'Incompleto';
              progressoHTML += `<li>Fase ${fase}: ${status}</li>`;
            }
            progressoHTML += `</ul></li>`;
          }
          progressoHTML += `</ul></li>`;
        }
        progressoHTML += `</ul>`;
        document.getElementById('progressoAluno').innerHTML = progressoHTML;
      } catch (error) {
        console.error("Erro ao exibir progresso do aluno:", error);
      }
    }

    // Edição e Exclusão de Usuários
    async function editarUsuario(uid) {
      const usuarioSnapshot = await db.ref('usuarios/' + uid).once('value');
      const usuario = usuarioSnapshot.val();
      const novoNome = prompt("Edite o nome:", usuario.nome);
      const novoTelefone = prompt("Edite o telefone:", usuario.telefone);
      const novoTipo = prompt("Edite o tipo (aluno, professor, visitante, proprietário):", usuario.role);
      if (novoNome && novoTelefone && novoTipo) {
        await db.ref('usuarios/' + uid).update({ nome: novoNome, telefone: novoTelefone, role: novoTipo });
        buscarUsuarios();
      }
    }

    async function confirmarExclusaoUsuario(uid) {
      if (confirm("Tem certeza de que deseja excluir este usuário?")) {
        await db.ref('usuarios/' + uid).remove();
        buscarUsuarios();
      }
    }

    // Função de Inicialização
    function inicializarAplicacao() {
      document.getElementById('cadastroForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const senha = document.getElementById('senha').value;
        const nome = document.getElementById('nome').value;
        const telefone = document.getElementById('telefone').value;
        const tipo = document.getElementById('tipo').value;
        cadastrarUsuario(email, senha, nome, telefone, tipo);
      });
      buscarUsuarios();
    }

    // Inicializar aplicação
    inicializarAplicacao();
  </script>
</body>
</html>
