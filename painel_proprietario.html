<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Usuários</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
</head>
<body>
  <h1>Gerenciamento de Usuários</h1>

  <!-- Botão Voltar -->
  <button onclick="window.history.back();">Back</button>

  <!-- Cadastro de Novo Usuário -->
  <h2>Cadastrar Novo Usuário</h2>
  <input type="text" id="email" placeholder="Email">
  <input type="password" id="senha" placeholder="Senha">
  <input type="text" id="nome" placeholder="Nome">
  <input type="text" id="telefone" placeholder="Telefone">
  <select id="tipoUsuario">
    <option value="aluno">Aluno</option>
    <option value="professor">Professor</option>
    <option value="proprietario">Proprietário</option>
  </select>
  <button onclick="cadastrarUsuario()">Cadastrar</button>

  <!-- Pesquisa de Usuários -->
  <h2>Pesquisar Usuários</h2>
  <select id="filtroTipoUsuario">
    <option value="todos">Todos</option>
    <option value="aluno">Aluno</option>
    <option value="professor">Professor</option>
    <option value="proprietario">Proprietário</option>
  </select>
  <button onclick="pesquisarUsuarios()">Pesquisar</button>

  <!-- Resultados da Pesquisa -->
  <div id="resultadosPesquisa"></div>

  <script>
    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Função para cadastrar um novo usuário
    function cadastrarUsuario() {
      const email = document.getElementById("email").value;
      const senha = document.getElementById("senha").value;
      const nome = document.getElementById("nome").value;
      const telefone = document.getElementById("telefone").value;
      const tipoUsuario = document.getElementById("tipoUsuario").value;

      firebase.auth().createUserWithEmailAndPassword(email, senha)
        .then(userCredential => {
          const uid = userCredential.user.uid;
          firebase.database().ref('usuarios/' + uid).set({
            email: email,
            nome: nome,
            telefone: telefone,
            role: tipoUsuario,
            progresso: { nivel: "nivel1", unidade: "unidade1", fase: "fase1" }
          });
          alert("Usuário cadastrado com sucesso!");
        })
        .catch(error => {
          alert("Erro ao cadastrar usuário: " + error.message);
        });
    }

    // Função para pesquisar usuários
    function pesquisarUsuarios() {
      const filtro = document.getElementById("filtroTipoUsuario").value;
      const resultadosDiv = document.getElementById("resultadosPesquisa");
      resultadosDiv.innerHTML = "";

      firebase.database().ref('usuarios').once('value')
        .then(snapshot => {
          snapshot.forEach(childSnapshot => {
            const usuario = childSnapshot.val();
            const uid = childSnapshot.key;

            if (filtro === "todos" || usuario.role === filtro) {
              const div = document.createElement("div");
              div.innerHTML = `
                <strong>${usuario.nome}</strong> (${usuario.role}) - ${usuario.email}<br>
                Telefone: ${usuario.telefone} <br>
                Progresso: Nível ${usuario.progresso.nivel}, Unidade ${usuario.progresso.unidade}, Fase ${usuario.progresso.fase} <br>
                <button onclick="editarProgresso('${uid}', '${usuario.progresso.nivel}', '${usuario.progresso.unidade}', '${usuario.progresso.fase}')">Editar Progresso</button>
                <button onclick="deletarUsuario('${uid}')">Deletar</button>
              `;
              resultadosDiv.appendChild(div);
            }
          });
        });
    }

    // Função para editar o progresso do aluno
    function editarProgresso(uid, nivelAtual, unidadeAtual, faseAtual) {
      const nivel = prompt("Digite o novo Nível:", nivelAtual);
      const unidade = prompt("Digite a nova Unidade:", unidadeAtual);
      const fase = prompt("Digite a nova Fase:", faseAtual);

      if (nivel && unidade && fase) {
        firebase.database().ref('usuarios/' + uid + '/progresso').set({
          nivel: nivel,
          unidade: unidade,
          fase: fase
        })
        .then(() => alert("Progresso atualizado com sucesso!"))
        .catch(error => alert("Erro ao atualizar progresso: " + error.message));
      }
    }

    // Função para deletar um usuário
    function deletarUsuario(uid) {
      const confirmar = confirm("Tem certeza que deseja deletar este usuário?");
      if (confirmar) {
        firebase.database().ref('usuarios/' + uid).remove()
          .then(() => alert("Usuário deletado com sucesso!"))
          .catch(error => alert("Erro ao deletar usuário: " + error.message));
      }
    }
  </script>
</body>
</html>
