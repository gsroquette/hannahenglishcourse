<!DOCTYPE html> 
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerador de Prompt ‚Äî questions.txt (Multi-Tipos)</title>
<style>
  :root{
    --bg:#0f172a; --card:#0b1022; --muted:#94a3b8; --text:#e2e8f0; --brand:#60a5fa; --ok:#22c55e; --bd:#1f2a44; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1022,#0f172a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{font-weight:900;font-size:26px;margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 18px}
  .card{background:rgba(255,255,255,.03);border:1px solid var(--bd);border-radius:14px;padding:14px;margin-bottom:14px}
  label{display:flex;justify-content:space-between;gap:10px;font-size:13px;color:#cbd5e1;margin-bottom:6px}
  textarea{width:100%;background:#0a0f1e;border:1px solid #1f2a44;border-radius:10px;color:var(--text);padding:10px;font-size:14px;min-height:120px;line-height:1.45;resize:vertical}
  .small{min-height:100px}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .inline{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  select,input[type="number"],input[type="text"],input[type="file"]{background:#0a0f1e;border:1px solid #1f2a44;border-radius:10px;color:#e2e8f0;padding:10px;font-size:14px}
  button{appearance:none;border:none;background:linear-gradient(90deg,#3b82f6,#22c55e);color:white;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid var(--bd);color:#cbd5e1}
  .badge{font-size:12px;color:var(--muted)}
  .help{color:#9fb3c8;font-size:12px;margin-top:6px}
  .cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
  .k{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px dashed #263254;border-radius:10px;padding:8px}
  .k>div{display:flex;gap:8px;align-items:center}
  .k input[type="number"]{width:88px}
  code{background:#0b1224;border:1px solid #1f2a44;border-radius:6px;padding:1px 6px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #263254;padding:8px;font-size:13px}
  th{background:#0b1224;color:#bcd0e8}
  td.actions{width:72px;text-align:center}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #263254;border-radius:999px}
  input[type="text"].sm{padding:8px;font-size:13px}
  .note{color:#fcd34d;font-weight:700}
  .stack-sm{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
</style>
</head>
<body>
<div class="wrap">
  <h1>Gerador de Prompt ‚Äî <span style="font-family:ui-monospace,monospace">questions.txt</span></h1>
  <p class="sub">Gera um <b>prompt</b> para a IA produzir <b>JSON</b> no formato do app Hannah, com os <b>tipos de quest√µes</b> que voc√™ escolher.</p>

  <!-- 0) CARREGAMENTO AUTOM√ÅTICO (NETLIFY) -->
  <div class="card">
    <label>0) Carregar automaticamente (Netlify)</label>

    <div class="inline" style="margin-top:6px">
      <div style="flex:1;min-width:260px">
        <div class="help" style="margin-bottom:6px">Base URL</div>
        <input id="baseUrl" type="text" placeholder="https://seu-site.netlify.app" />
      </div>

      <div>
        <div class="help" style="margin-bottom:6px">Level</div>
        <input id="netLevel" type="text" placeholder="Level0" />
      </div>

      <div>
        <div class="help" style="margin-bottom:6px">Unit</div>
        <input id="netUnit" type="text" placeholder="Unit4" />
      </div>

      <button id="btnLoadAuto" class="ghost">Carregar automaticamente</button>
      <span id="loadMsg" class="badge"></span>
    </div>

    <div class="help" style="margin-top:10px">
      <div><b>Texto de gram√°tica (principal):</b> <code>/${level}/${unit}/DataGrammar/texto.txt</code></div>
      <div><b>Texto inspirador (apoio):</b> <code>/${level}/${unit}/DataStory/images.txt</code></div>
    </div>
  </div>

  <!-- 1) INSPIRA√á√ÉO & GRAM√ÅTICA -->
  <div class="grid">
    <div class="card">
      <label>1A) Texto inspirador (opcional)</label>
      <textarea id="inspire" placeholder="#title: The Baby God Promised (Genesis 21)
#imagem1
&quot;Abraham and Sarah lived in Canaan...&quot;"></textarea>
      <div class="help">Pode ficar vazio se voc√™ for usar apenas o texto de <b>Gram√°tica</b>.</div>
    </div>
    <div class="card">
      <label>1B) Texto de gram√°tica (principal)</label>
      <textarea id="grammar" placeholder="(Este campo ser√° carregado automaticamente)
## 1. Let's Count to Ten!
TableStart
Number | Word
1 | one
...
TableEnd"></textarea>
      <div class="help"><b>Prioridade m√°xima:</b> as quest√µes devem ser geradas a partir deste texto.</div>
    </div>
  </div>

  <!-- 2) PAR√ÇMETROS GERAIS -->
  <div class="grid">
    <div class="card">
      <label>2) N√≠vel, quantidade, alternativas e caminhos</label>
      <div class="inline" style="margin-bottom:8px">
        <div>
          <div class="help" style="margin-bottom:6px">N√≠vel (CEFR)</div>
          <select id="cefrLevel">
            <option value="Starter" selected>Starter (Pre-A1)</option>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
          </select>
        </div>
        <div>
          <div class="help" style="margin-bottom:6px">Qtd. de quest√µes</div>
          <input id="qCount" type="number" min="4" max="60" step="1" value="12" />
        </div>
        <div>
          <div class="help" style="margin-bottom:6px">Qtd. de alternativas</div>
          <input id="altCount" type="number" min="2" max="6" step="1" value="4" />
        </div>
        <div style="flex:1">
          <div class="help" style="margin-bottom:6px">Base de m√≠dia (opcional)</div>
          <input id="mediaBase" type="text" placeholder="../../LevelX/UnitY/QA/" />
        </div>
      </div>

      <!-- 2B) Metadados Hannah -->
      <div class="inline" style="margin-top:8px">
        <div>
          <div class="help" style="margin-bottom:6px">Level do curso (Hannah)</div>
          <input id="courseLevel" type="text" placeholder="Level0" />
        </div>
        <div>
          <div class="help" style="margin-bottom:6px">Unit do curso</div>
          <input id="courseUnit" type="text" placeholder="Unit1" />
        </div>
        <div>
          <div class="help" style="margin-bottom:6px">Fase</div>
          <input id="courseFase" type="number" min="1" step="1" placeholder="7" />
        </div>
      </div>

      <div class="inline" style="margin-top:8px">
        <div>
          <div class="help" style="margin-bottom:6px">grammarTag (ponto de gram√°tica ou vocabul√°rio)</div>
          <input id="grammarTag" type="text" placeholder="grammar-to-be-present" />
        </div>
        <div>
          <div class="help" style="margin-bottom:6px">skillType</div>
          <select id="skillType">
            <option value="">(auto)</option>
            <option value="vocabulary">vocabulary</option>
            <option value="grammar">grammar</option>
            <option value="reading">reading</option>
            <option value="listening">listening</option>
            <option value="mixed">mixed</option>
          </select>
        </div>
        <div>
          <div class="help" style="margin-bottom:6px">difficulty</div>
          <select id="difficulty">
            <option value="">(auto)</option>
            <option value="easy">easy</option>
            <option value="medium" selected>medium</option>
            <option value="hard">hard</option>
          </select>
        </div>
      </div>

      <div class="help">yesno/truefalse sempre t√™m 2 op√ß√µes.</div>
    </div>
  </div>

  <!-- 3) TIPOS E DISTRIBUI√á√ÉO -->
  <div class="card">
    <label>3) Tipos de quest√µes e distribui√ß√£o</label>
    <div class="help">Marque os tipos que deseja.</div>
    <div class="cols" id="types"></div>
    <div class="inline" style="margin-top:8px">
      <div>
        <input type="checkbox" id="autoDist" checked /> <label for="autoDist" style="margin:0;gap:6px">Distribui√ß√£o autom√°tica proporcional</label>
      </div>
      <span class="badge" id="sumInfo"></span>
    </div>
  </div>

  <!-- 4) BANCO DE PALAVRAS / M√çDIA (BULK) ‚Äî OCULTO -->
  <div class="card" id="bankCard" style="display:none">
    <label>4) Banco de palavras + m√≠dia (opcional)</label>
    <div class="inline" style="gap:10px;align-items:flex-start;margin-top:6px">
      <input id="bwFile" type="file" accept=".txt" />
      <button id="btnLoadFile" class="ghost">Carregar do arquivo</button>
      <button id="btnClearWords" class="ghost" style="border-color:#ef4444;color:#ef4444">Apagar Palavras</button>
    </div>

    <textarea id="bwBulk" placeholder="DOG
CAT
BIRD
..." style="min-height:140px;margin-top:8px"></textarea>

    <div class="stack-sm" style="margin-top:8px">
      <div>
        <div class="help" style="margin-bottom:6px">Prefixo de m√≠dia</div>
        <select id="mediaPrefix" title="Prefixo para imagens e sons">
          <option value="p1" selected>../data1/...</option>
          <option value="p2">../data2/...</option>
          <option value="p3">../data3/...</option>
          <option value="p4">../DataStory/...</option>
        </select>
      </div>
      <div class="inline" style="align-items:center">
        <button id="btnAddBulk">Adicionar todos</button>
      </div>
    </div>

    <div class="help">
      Cada lote recome√ßa em imagem1/som1 independentemente da tabela j√° ter palavras.
    </div>

    <div style="margin-top:10px">
      <table id="bwTable" style="display:none">
        <thead><tr><th>Palavra</th><th>Imagem</th><th>Som</th><th class="actions">A√ß√µes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 5) A√á√ïES -->
  <div class="row" style="display:flex;gap:10px;align-items:center;margin:14px 0">
    <button id="btnGen">Gerar prompt</button>
    <button id="btnCopy" class="ghost">Copiar prompt</button>
    <span id="msg" class="badge"></span>
  </div>

  <!-- 6) SA√çDA -->
  <div class="card">
    <label>6) Prompt gerado (sa√≠da) ‚Äî cole na IA</label>
    <textarea id="out" class="small" placeholder="O prompt aparecer√° aqui‚Ä¶" readonly></textarea>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // Auto-load inputs
  const baseUrlEl  = $('baseUrl');
  const netLevelEl = $('netLevel');
  const netUnitEl  = $('netUnit');
  const btnLoadAuto= $('btnLoadAuto');
  const loadMsgEl  = $('loadMsg');

  const inspireEl   = $('inspire');
  const grammarEl   = $('grammar');
  const cefrLevelEl = $('cefrLevel');
  const qCountEl    = $('qCount');
  const altCountEl  = $('altCount');
  const mediaBaseEl = $('mediaBase');

  const courseLevelEl = $('courseLevel');
  const courseUnitEl  = $('courseUnit');
  const courseFaseEl  = $('courseFase');
  const grammarTagEl  = $('grammarTag');
  const skillTypeEl   = $('skillType');
  const difficultyEl  = $('difficulty');

  const outEl       = $('out');
  const btnGen      = $('btnGen');
  const btnCopy     = $('btnCopy');
  const msgEl       = $('msg');
  const typesWrap   = $('types');
  const autoDistEl  = $('autoDist');
  const sumInfoEl   = $('sumInfo');

  // Banco (bulk) ‚Äî mantido no c√≥digo, mas UI est√° oculta
  const bwFileEl     = $('bwFile');
  const btnLoadFile  = $('btnLoadFile');
  const bwBulkEl     = $('bwBulk');
  const btnAddBulk   = $('btnAddBulk');
  const btnClearWords= $('btnClearWords');
  const mediaPrefixEl= $('mediaPrefix');
  const bwTable      = $('bwTable');
  const bwTBody      = bwTable ? bwTable.querySelector('tbody') : null;

  // Tabela de palavras adicionadas
  // Cada item: { word, img, audio }
  let WORDS_MEDIA = [];

  // Prefixos
  const MEDIA_PREFIX_MAP = {
    p1: { img: '../data1/imagens/',   sound: '../data1/sounds/'   },
    p2: { img: '../data2/imagens/',   sound: '../data2/sounds/'   },
    p3: { img: '../data3/imagens/',   sound: '../data3/sounds/'   },
    p4: { img: '../DataStory/images/',sound: '../DataStory/sounds/'}
  };

  // Lista dos tipos
  const TYPE_LIST = [
    { key:'choice',     label:'Choice (MCQ)' },
    { key:'yesno',      label:'Yes/No' },
    { key:'truefalse',  label:'True/False' },
    { key:'picture',    label:'Picture (MCQ + imagem)' },
    { key:'audiochoice',label:'Audio (MCQ + √°udio)' },
    { key:'fillblank',  label:'Fill in the Blanks' },
    { key:'order',      label:'Order (montar frase)' },
    { key:'match',      label:'Match (correspond√™ncia)' },
  ];

  function renderTypes(){
    typesWrap.innerHTML = '';
    TYPE_LIST.forEach(t => {
      const row = document.createElement('div');
      row.className = 'k';
      row.innerHTML = `
        <div>
          <input type="checkbox" id="cb_${t.key}" data-key="${t.key}" checked />
          <label for="cb_${t.key}" style="margin:0;gap:6px">${t.label}</label>
        </div>
        <div>
          <span class="badge">Qtd.</span>
          <input type="number" id="n_${t.key}" data-key="${t.key}" min="0" max="60" step="1"
                 value="0" ${autoDistEl.checked ? 'disabled' : ''} />
        </div>
      `;
      typesWrap.appendChild(row);
    });
  }
  renderTypes();

  autoDistEl.addEventListener('change', ()=>{
    TYPE_LIST.forEach(t=>{
      const n = $('n_'+t.key);
      if(!n) return;
      n.disabled = autoDistEl.checked;
    });
    updateSumInfo();
  });

  typesWrap.addEventListener('input', updateSumInfo);
  qCountEl.addEventListener('input', updateSumInfo);

  function updateSumInfo(){
    const total = parseInt(qCountEl.value||'0',10);
    let sum = 0;
    let marked = 0;

    TYPE_LIST.forEach(t=>{
      const cb = $('cb_'+t.key);
      if(cb && cb.checked) marked++;
      const n = $('n_'+t.key);
      if(n && !n.disabled){
        sum += parseInt(n.value||'0',10);
      }
    });

    if(autoDistEl.checked){
      sumInfoEl.textContent = `Auto: ${marked} tipo(s) selecionado(s) ‚Üí ${total} distribu√≠do(s)`;
    } else {
      sumInfoEl.textContent = `Manual: soma por tipo = ${sum} / ${total}`;
    }
  }
  updateSumInfo();

  function sanitize(s){ return (s||'').trim(); }

  /* -------------------------
      AUTO LOAD (NETLIFY)
  --------------------------*/

  function normalizeBaseUrl(url){
    const u = (url||'').trim();
    if(!u) return '';
    return u.endsWith('/') ? u.slice(0,-1) : u;
  }

  async function fetchTextWithTimeout(url, ms){
    const supportsAbort = typeof AbortController !== 'undefined';
    if(!supportsAbort){
      const r = await fetch(url, { cache:'no-store' });
      return { ok: r.ok, status: r.status, text: r.ok ? await r.text() : '' };
    }
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), ms || 12000);
    try{
      const r = await fetch(url, { cache:'no-store', signal: ctrl.signal });
      const t = r.ok ? await r.text() : '';
      return { ok: r.ok, status: r.status, text: t };
    } finally {
      clearTimeout(timer);
    }
  }

  async function loadAuto(){
    loadMsgEl.textContent = '';
    msgEl.textContent = '';

    const base  = normalizeBaseUrl(baseUrlEl.value);
    const level = sanitize(netLevelEl.value);
    const unit  = sanitize(netUnitEl.value);

    if(!base || !level || !unit){
      loadMsgEl.textContent = '‚ö† Preencha Base URL, Level e Unit.';
      return;
    }

    const grammarUrl = `${base}/${level}/${unit}/DataGrammar/texto.txt`;
    const inspireUrl = `${base}/${level}/${unit}/DataStory/images.txt`;

    btnLoadAuto.disabled = true;
    btnLoadAuto.textContent = 'Carregando...';
    loadMsgEl.textContent = '‚è≥ Buscando textos...';

    try{
      const [g, i] = await Promise.all([
        fetchTextWithTimeout(grammarUrl, 15000),
        fetchTextWithTimeout(inspireUrl, 15000)
      ]);

      if(!g.ok){
        loadMsgEl.textContent = `‚ö† Erro ao carregar gram√°tica (${g.status}).`;
        return;
      }

      grammarEl.value = (g.text || '').trim();

      if(i.ok){
        inspireEl.value = (i.text || '').trim();
      } else {
        // inspirador √© opcional
        inspireEl.value = inspireEl.value || '';
      }

      // Ajuda: preencher metadados Hannah automaticamente (sem for√ßar)
      if(!sanitize(courseLevelEl.value)) courseLevelEl.value = level;
      if(!sanitize(courseUnitEl.value))  courseUnitEl.value  = unit;

      loadMsgEl.textContent = '‚úÖ Textos carregados.';
    } catch(err){
      const m = (err && err.name === 'AbortError')
        ? '‚ö† Timeout ao buscar textos. Verifique internet/base URL.'
        : '‚ö† Falha ao buscar textos. Verifique base URL/paths.';
      loadMsgEl.textContent = m;
    } finally {
      btnLoadAuto.disabled = false;
      btnLoadAuto.textContent = 'Carregar automaticamente';
    }
  }

  btnLoadAuto.addEventListener('click', loadAuto);

  // Defaults
  (function initDefaults(){
    // tenta colocar a origem atual como base (funciona bem se voc√™ hospedar isso no mesmo dom√≠nio)
    try{
      baseUrlEl.value = window.location.origin || '';
    }catch{
      baseUrlEl.value = '';
    }
  })();

  /* -------------------------
      BANCO DE PALAVRAS
      (mantido, mas UI oculta)
  --------------------------*/

  if(btnClearWords){
    btnClearWords.addEventListener('click', ()=>{
      bwBulkEl.value = '';
    });
  }

  if(btnLoadFile && bwFileEl){
    btnLoadFile.addEventListener('click', ()=>{ bwFileEl.click(); });
    bwFileEl.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file){ msgEl.textContent = '‚ö† Nenhum arquivo selecionado.'; return; }
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const prev = bwBulkEl.value;
        const txt = (ev.target.result || '').trim();
        bwBulkEl.value = prev ? (prev + '\n' + txt) : txt;
        msgEl.textContent = 'üìÑ Conte√∫do acrescentado ao campo.';
      };
      reader.onerror = ()=>{ msgEl.textContent = '‚ö† Erro ao ler o arquivo.'; };
      reader.readAsText(file, 'utf-8');
    });
  }

  function getSelectedPrefixes(){
    const key = (mediaPrefixEl && mediaPrefixEl.value) ? mediaPrefixEl.value : 'p1';
    return MEDIA_PREFIX_MAP[key] || MEDIA_PREFIX_MAP.p1;
  }

  function refreshBWTable(){
    if(!bwTable || !bwTBody) return;
    if(!WORDS_MEDIA.length){
      bwTable.style.display='none';
      bwTBody.innerHTML='';
      return;
    }
    bwTable.style.display='table';
    bwTBody.innerHTML = '';
    WORDS_MEDIA.forEach((item, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="sm" data-field="word"  data-i="${idx}" type="text" value="${item.word}" /></td>
        <td><input class="sm" data-field="img"   data-i="${idx}" type="text" value="${item.img}" /></td>
        <td><input class="sm" data-field="audio" data-i="${idx}" type="text" value="${item.audio}" /></td>
        <td class="actions"><button data-i="${idx}" class="ghost">Remover</button></td>
      `;
      bwTBody.appendChild(tr);
    });
  }

  function addManyWordsFromText(text){
    const lines = (text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!lines.length){ msgEl.textContent = '‚ö† Nada para adicionar (campo vazio).'; return; }

    const prefixes = getSelectedPrefixes();
    let batchIndex = 1;
    let added = 0;

    const existing = new Set(WORDS_MEDIA.map(w=>w.word));
    const normalizedLines = lines.map(w => w.toUpperCase());
    const hasDuplicates = normalizedLines.some(w => existing.has(w));

    let addDuplicatesToo = true;
    if(hasDuplicates){
      addDuplicatesToo = confirm(
        'Existem palavras j√° existentes na tabela.\n' +
        'Deseja adicionar mesmo assim TODAS as palavras deste lote (incluindo duplicadas)?\n\n' +
        'OK = Adicionar todas (incluindo duplicadas)\n' +
        'Cancelar = Adicionar apenas as novas'
      );
    }

    const seenInBatch = new Set();

    for(const raw of lines){
      const word = raw.toUpperCase();
      if(!word) continue;
      if(seenInBatch.has(word)) continue;
      seenInBatch.add(word);

      if(!addDuplicatesToo && existing.has(word)) continue;

      const img   = `${prefixes.img}imagem${batchIndex}.png`;
      const audio = `${prefixes.sound}som${batchIndex}.mp3`;

      WORDS_MEDIA.push({word, img, audio});
      existing.add(word);
      batchIndex++;
      added++;
    }

    if(added === 0){
      msgEl.textContent = '‚ö† Nenhuma palavra adicionada.';
    } else {
      msgEl.textContent = `‚úÖ ${added} palavra(s) adicionada(s) (numera√ß√£o reiniciada).`;
    }
    refreshBWTable();
  }

  if(btnAddBulk){
    btnAddBulk.addEventListener('click', ()=>{ addManyWordsFromText(bwBulkEl.value); });
  }

  if(bwTBody){
    bwTBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const idx = parseInt(btn.getAttribute('data-i'),10);
      if(!Number.isNaN(idx)){
        WORDS_MEDIA.splice(idx,1);
        refreshBWTable();
      }
    });

    bwTBody.addEventListener('input', (e)=>{
      const input = e.target.closest('input');
      if(!input) return;
      const idx   = parseInt(input.getAttribute('data-i'),10);
      const field = input.getAttribute('data-field');
      if(Number.isNaN(idx) || !field) return;

      const val = input.value.trim();
      if(field==='word')  WORDS_MEDIA[idx].word  = val.toUpperCase();
      if(field==='img')   WORDS_MEDIA[idx].img   = val;
      if(field==='audio') WORDS_MEDIA[idx].audio = val;
    });
  }

  /* -------------------------
      FUN√á√ïES AUX. METADADOS
  --------------------------*/

  function normalizeCourseKey(prefix, value, fallbackNum){
    const v = (value||'').trim();
    if(!v) return prefix + fallbackNum;
    const lower = v.toLowerCase();
    if(lower.startsWith(prefix.toLowerCase())) return v;
    const onlyNum = (v.match(/\d+/)||[''])[0] || fallbackNum;
    return prefix + onlyNum;
  }

  /* -------------------------
      GENERATE PROMPT
  --------------------------*/

  function getSelectedTypes(){
    return TYPE_LIST
      .filter(t=>{
        const cb = $('cb_'+t.key);
        return cb && cb.checked;
      })
      .map(t=>t.key);
  }

  function autoDistribute(total, activeTypes){
    const base = Math.floor(total / activeTypes.length);
    const rest = total % activeTypes.length;
    const map = {};
    activeTypes.forEach((t,i)=>{ map[t] = base + (i < rest ? 1 : 0); });
    return map;
  }

  function manualDistribution(){
    const map = {};
    TYPE_LIST.forEach(t=>{
      const cb = $('cb_'+t.key);
      if(!cb || !cb.checked) return;
      const n = $('n_'+t.key);
      const v = parseInt(n.value||'0',10);
      map[t.key] = v;
    });
    return map;
  }

  function buildPrompt({
    textoInsp,
    textoGram,
    cefrLevel,
    total,
    altCount,
    mediaBase,
    types,
    dist,
    courseLevelKey,
    courseUnitKey,
    courseFase,
    grammarTagDefault,
    skillTypeDefault,
    difficultyDefault
  }){
    // Prioriza√ß√£o expl√≠cita: gram√°tica √© principal
    const textoFonte = [
      textoGram ? `TEXTO PRINCIPAL (GRAM√ÅTICA):\n${textoGram}` : '',
      textoInsp ? `\n\nTEXTO DE APOIO (INSPIRADOR):\n${textoInsp}` : ''
    ].filter(Boolean).join('\n');

    const SPEC = `INSTRU√á√ïES COMPLETAS PARA GERAR questions.txt (INCORPORADAS NO PROMPT)

OBJETIVO PEDAG√ìGICO (MUITO IMPORTANTE)
‚Ä¢ Gere as quest√µes para EXPLICAR e TREINAR o conte√∫do do TEXTO PRINCIPAL (GRAM√ÅTICA).
‚Ä¢ Use o TEXTO DE APOIO (INSPIRADOR) apenas como CONTEXTO e VOCABUL√ÅRIO secund√°rio.
‚Ä¢ N√£o fuja do ponto de gram√°tica descrito no TEXTO PRINCIPAL.

FORMATO OBRIGAT√ìRIO DO ARQUIVO
{
  "title": string,
  "questions": [ array de quest√µes ]
}

PARA CADA QUEST√ÉO (OBJETO DENTRO DE "questions"):
CAMPOS OBRIGAT√ìRIOS
‚Ä¢ id: string curto, min√∫sculo, padr√£o "q001", "q002", ...
‚Ä¢ type: tipo de quest√£o, por exemplo "mcq", "yesno", "fillblank", "order", "match".
‚Ä¢ prompt: texto da pergunta em ingl√™s.
‚Ä¢ options: array de op√ß√µes (para mcq/yesno/truefalse/audiochoice/picture/fillblank) com objetos:
  { "label": string, "value": string, "image"?: string, "emoji"?: string, "audio"?: string, "tts"?: string, "sub"?: string, "aria"?: string }
‚Ä¢ answer: resposta correta.
    - Para MCQ/yesno/truefalse: string igual ao value correto.
    - Para fillblank simples: string ou array de strings.
    - Para order: array de strings na ordem correta.
    - Para match: estrutura adequada de pares (voc√™ pode usar um campo "pairs").

METADADOS QUE DEVEM APARECER EM TODAS AS QUEST√ïES
Use SEMPRE os seguintes campos em cada objeto de quest√£o:
‚Ä¢ level: string ‚Üí level do curso Hannah (ex.: "Level0").
‚Ä¢ unit: string ‚Üí unidade (ex.: "Unit1").
‚Ä¢ fase: string ou number ‚Üí n√∫mero da fase (ex.: "7").
‚Ä¢ grammarTag: string curto que identifica a gram√°tica ou vocabul√°rio alvo.
‚Ä¢ skillType: string, por exemplo: "vocabulary", "grammar", "reading", "listening" ou "mixed".
‚Ä¢ difficulty: string, um de: "easy", "medium", "hard".

OUTROS CAMPOS OPCIONAIS
‚Ä¢ image: caminho da imagem relativa √† base fornecida.
‚Ä¢ promptAudio: caminho do √°udio da pergunta (se n√£o houver, TTS l√™ o prompt).
‚Ä¢ tts: string alternativa para o TTS ler, se quiser uma fala diferente do prompt.
‚Ä¢ shuffleOptions: boolean; se omitido, considere true.
‚Ä¢ qualquer outro campo √∫til, desde que o JSON permane√ßa v√°lido.

REGRAS GERAIS DO PLAYER
‚Ä¢ Compare respostas por value (min√∫sculas + trim).
‚Ä¢ Caminhos de m√≠dia relativos √† base ${mediaBase || '../../LevelX/UnitY/QA/'} (ou URL http/https).
‚Ä¢ √Åudio da pergunta: se promptAudio falhar, TTS l√™ prompt (ou tts se fornecido).
‚Ä¢ √Åudio da op√ß√£o: tocar ao clicar e s√≥ depois validar.
‚Ä¢ Embaralhar op√ß√µes: "shuffleOptions": true por padr√£o.
‚Ä¢ IDs √∫nicos sequenciais: q001, q002, ...
‚Ä¢ Prompts em INGL√äS, curtos e adequados ao n√≠vel.

AVISOS IMPORTANTES
‚Ä¢ N√ÉO REPLICAR OS EXEMPLOS. GERE NOVAS QUEST√ïES ALINHADAS AO TEXTO-FONTE.
‚Ä¢ USE IDs ZERO-PADDED (q001, q002, ‚Ä¶) NO ARQUIVO FINAL.
‚Ä¢ EM FILLBLANK, SEMPRE INCLUA {blank}/{bN}/___ NO prompt.
`;

    const levelGuide = {
      'Starter':'Use frases curt√≠ssimas (3‚Äì6 palavras), vocabul√°rio concreto e repeti√ß√£o; prompts simples e claros.',
      'A1':'Frases curtas; linguagem concreta; 1 ideia por quest√£o.',
      'A2':'Frases simples; pode usar 2 ideias curtas.',
      'B1':'Frases breves, coesas; evite constru√ß√µes complexas.',
      'B2':'Frases curtas e objetivas; precis√£o lexical.'
    }[cefrLevel] || 'Use linguagem simples e clara, adequada ao n√≠vel.';

    const activeLabels = TYPE_LIST
      .filter(t=>types.includes(t.key))
      .map(t=>t.label)
      .join(', ');

    const distLines = Object.entries(dist)
      .map(([k,v])=>`‚Ä¢ ${k}: ${v}`)
      .join('\n');

    const metaHannah = `
METADADOS DO CURSO HANNAH (USE EM TODAS AS QUEST√ïES)
‚Ä¢ level (fixo em todas as quest√µes): "${courseLevelKey || 'LevelX'}"
‚Ä¢ unit  (fixo em todas as quest√µes): "${courseUnitKey || 'UnitY'}"
‚Ä¢ fase  (fixo em todas as quest√µes): "${courseFase || '1'}"
‚Ä¢ grammarTag padr√£o: ${grammarTagDefault ? `"${grammarTagDefault}"` : 'crie uma tag curta relacionada √† gram√°tica/vocabul√°rio principal desta atividade.'}
‚Ä¢ skillType padr√£o: ${skillTypeDefault ? `"${skillTypeDefault}"` : 'escolha entre "vocabulary", "grammar", "reading", "listening" ou "mixed".'}
‚Ä¢ difficulty padr√£o: ${difficultyDefault ? `"${difficultyDefault}"` : 'classifique como "easy", "medium" ou "hard".'}

INSTRU√á√ÉO IMPORTANTE:
Em CADA objeto dentro de "questions", inclua explicitamente:
  "level", "unit", "fase", "grammarTag", "skillType", "difficulty".
Se houver um valor padr√£o acima (n√£o marcado como "crie/ escolha"), use EXATAMENTE esse valor em todas as quest√µes.
`;

    return (
`Crie um arquivo JSON para <questions.txt> seguindo ESTRITAMENTE o FORMATO e as REGRAS abaixo. Gere ${total} quest√µes com os TIPOS: ${activeLabels}.

TEXTO-FONTE:
${textoFonte}

ESPECIFICA√á√ÉO COMPLETA (copie as instru√ß√µes e siga √† risca):
${SPEC}

${metaHannah}

N√çVEL CEFR (lingu√≠stico): ${cefrLevel}. ${levelGuide}

QUANTIDADE TOTAL DE QUEST√ïES: ${total}
QUANTIDADE DE ALTERNATIVAS POR QUEST√ÉO: ${altCount}
(yes/no e true/false continuam com apenas 2 alternativas coerentes.)

DISTRIBUI√á√ÉO POR TIPO (aproximada, mas respeite as quantidades):
${distLines}

SA√çDA EXIGIDA:
‚Ä¢ Apenas o JSON V√ÅLIDO, sem Markdown, sem explica√ß√µes.
‚Ä¢ O JSON deve ter exatamente:
  { "title": string, "questions": [ { ... }, { ... } ] }`
    );
  }

  // Gerar prompt
  btnGen.addEventListener('click', ()=>{
    const textoInsp = sanitize(inspireEl.value);
    const textoGram = sanitize(grammarEl.value);
    const cefrLevel = cefrLevelEl.value;
    const total     = parseInt(qCountEl.value||'12',10);
    const altCount  = parseInt(altCountEl.value||'4',10);
    const mediaBase = sanitize(mediaBaseEl.value);

    const cLevelRaw = sanitize(courseLevelEl.value);
    const cUnitRaw  = sanitize(courseUnitEl.value);
    const cFaseRaw  = sanitize(courseFaseEl.value);

    const courseLevelKey = cLevelRaw ? normalizeCourseKey('Level', cLevelRaw, '0') : '';
    const courseUnitKey  = cUnitRaw  ? normalizeCourseKey('Unit',  cUnitRaw,  '1') : '';
    const courseFase     = cFaseRaw || '';

    const grammarTagDefault = sanitize(grammarTagEl.value);
    const skillTypeDefault  = skillTypeEl.value || '';
    const difficultyDefault = difficultyEl.value || '';

    if(!textoInsp && !textoGram){
      msgEl.textContent = '‚ö† Preencha ao menos um dos textos (inspirador ou gram√°tica).';
      outEl.value = '';
      return;
    }

    const types = getSelectedTypes();
    if(!types.length){
      msgEl.textContent = '‚ö† Selecione ao menos 1 tipo!';
      outEl.value = '';
      return;
    }

    let dist = {};
    if(autoDistEl.checked){
      dist = autoDistribute(total, types);
    } else {
      dist = manualDistribution();
      const sum = Object.values(dist).reduce((a,b)=>a+(+b||0),0);
      if(sum !== total){
        msgEl.textContent = `‚ö† Soma manual (${sum}) ‚â† total (${total}).`;
        outEl.value = '';
        return;
      }
      dist = Object.fromEntries(
        Object.entries(dist).filter(([k,v])=>types.includes(k) && v>0)
      );
    }

    const prompt = buildPrompt({
      textoInsp,
      textoGram,
      cefrLevel,
      total,
      altCount,
      mediaBase,
      types,
      dist,
      courseLevelKey,
      courseUnitKey,
      courseFase,
      grammarTagDefault,
      skillTypeDefault,
      difficultyDefault
    });

    outEl.value = prompt;
    outEl.focus();
    outEl.select();
    msgEl.textContent = '‚úÖ Prompt pronto!';
  });

  // Copiar prompt
  btnCopy.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(outEl.value || '');
      btnCopy.textContent = 'Copiado!';
      setTimeout(()=> btnCopy.textContent='Copiar prompt', 1100);
    }catch{
      outEl.select();
      document.execCommand('copy');
    }
  });

})();
</script>
</body>
</html>