<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gerador de Prompt ‚Äî Di√°logo (Robot Samuel & Hannah)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:16px; line-height:1.35}
    label{font-weight:600}
    textarea, select, input{
      width:100%; max-width:1100px; padding:10px; margin-top:6px;
      border:1px solid #cfd6df; border-radius:10px;
    }
    textarea{min-height:110px}
    .row{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; max-width:1100px}
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:12px; max-width:1100px}
    .btn{
      padding:12px 14px; border:0; border-radius:12px; background:#2563eb; color:#fff;
      font-weight:700; cursor:pointer
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btnSecondary{
      padding:10px 12px; border:1px solid #cfd6df; border-radius:12px; background:#fff; color:#111827;
      font-weight:700; cursor:pointer
    }
    .btnSecondary:disabled{opacity:.6; cursor:not-allowed}
    .card{max-width:1100px; border:1px solid #e5e7eb; border-radius:14px; padding:12px; margin:14px 0}
    .muted{color:#6b7280; font-size:14px}
    .status{
      white-space:pre-wrap; font-size:13px; background:#f7f9fc; border:1px dashed #cfd6df;
      border-radius:12px; padding:10px; max-width:1100px
    }
    .small{font-size:13px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      max-width:1100px; margin-top:10px
    }
    .toast{
      display:inline-block; padding:8px 10px; border-radius:999px; font-size:12px;
      background:#111827; color:#fff; opacity:0; transform:translateY(6px);
      transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>

  <h2>Gerador de Prompt ‚Äî Di√°logo</h2>
  <div class="muted">
    Este gerador busca automaticamente o vocabul√°rio (<code>words.txt</code>) da <b>Unit atual</b> + <b>2 Units anteriores</b> (wrap entre Levels, considerando 20 Units por Level).
    Tamb√©m busca a gram√°tica de <code>/grammar/grammar.json</code> (na Base URL).
    <br><br>
    <b>Regra-chave:</b> a <b>LI√á√ÉO</b> manda no di√°logo. O vocabul√°rio puxado serve como <b>verifica√ß√£o</b> (filtro final), n√£o como fonte para criar conte√∫do.
    <br>
    O prompt √© em <b>2 etapas</b> dentro do mesmo texto: <b>(1) gerar</b> + <b>(2) revisar e substituir palavras fora do repert√≥rio</b>.
  </div>

  <div class="card">
    <label for="baseUrl">Base URL (onde est√£o os arquivos do curso):</label>
    <input id="baseUrl" value="https://hannahenglishcourse.netlify.app" />
    <div class="muted small">
      Se voc√™ estiver rodando este HTML localmente, este campo precisa apontar para o seu Netlify.
      Ex.: <span class="mono">https://hannahenglishcourse.netlify.app</span>
    </div>

    <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0"/>

    <label for="lessonInput">Li√ß√£o de Conversa√ß√£o (FONTE PRIM√ÅRIA ‚Äî OBRIGAT√ìRIA):</label>
    <textarea id="lessonInput">Cole aqui a li√ß√£o completa (objetivo, key phrases, exemplos). O di√°logo deve ensinar e praticar esta li√ß√£o.</textarea>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="englishLevel">N√≠vel (CEFR):</label>
        <select id="englishLevel">
          <option value="Starter">Starter (antes do A1)</option>
          <option value="A1">A1 - Iniciante</option>
          <option value="A2">A2 - B√°sico</option>
          <option value="B1">B1 - Intermedi√°rio</option>
          <option value="B2">B2 - Intermedi√°rio Superior</option>
          <option value="C1">C1 - Avan√ßado</option>
          <option value="C2">C2 - Profici√™ncia</option>
        </select>
      </div>
      <div>
        <label for="levelNumber">Level atual (n√∫mero):</label>
        <input id="levelNumber" type="number" min="0" step="1" value="0"/>
        <div class="muted small">Ex.: 0, 1, 2, 3, 4</div>
      </div>
      <div>
        <label for="unitNumber">Unit atual (n√∫mero):</label>
        <input id="unitNumber" type="number" min="1" step="1" value="3"/>
        <div class="muted small">Ex.: 1 at√© 20</div>
      </div>
    </div>

    <div class="row2" style="margin-top:12px">
      <div>
        <label for="unitsPerLevel">Units por Level (padr√£o 20):</label>
        <input id="unitsPerLevel" type="number" min="1" step="1" value="20"/>
      </div>
      <div>
        <label for="maxWords">M√°ximo de palavras do repert√≥rio no prompt (padr√£o 200):</label>
        <input id="maxWords" type="number" min="30" step="1" value="200"/>
        <div class="muted small">
          Como agora √© <b>verifica√ß√£o</b>, d√° para mandar mais palavras sem ‚Äúfor√ßar uso‚Äù.
          (Ainda assim, evite valores gigantes).
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label for="inspirationInput">Texto inspirador (opcional ‚Äî apoio leve):</label>
      <textarea id="inspirationInput" placeholder="Opcional. Se voc√™ preencher, entra como apoio (algumas palavras/express√µes). N√ÉO copiar frases completas."></textarea>
      <div class="muted small">
        A li√ß√£o continua mandando. O texto inspirador s√≥ ajuda com vocabul√°rio/express√µes relevantes.
      </div>
    </div>

    <div class="toolbar">
      <button id="btnGerar" class="btn" onclick="gerarPrompt()">Gerar Prompt (2 etapas)</button>
      <button id="btnCopiar" class="btnSecondary" onclick="copiarPrompt()" disabled>Copiar Prompt</button>
      <span id="toast" class="toast">Copiado!</span>
    </div>

    <div style="margin-top:12px">
      <div class="status" id="statusBox">Status: pronto.</div>
    </div>

    <div style="margin-top:12px">
      <label for="debugBox">Debug (URLs tentadas e status):</label>
      <textarea id="debugBox" class="mono" style="min-height:160px" spellcheck="false"></textarea>
      <div class="muted small">
        Se aparecer 404: caminho inexistente. Se ‚ÄúFailed to fetch‚Äù: Base URL/CORS/rede.
      </div>
    </div>
  </div>

  <div class="card">
    <label for="promptOutput">Prompt Gerado:</label>
    <textarea id="promptOutput" style="min-height:360px" spellcheck="false"></textarea>
    <div class="muted small">Copie e cole na IA para gerar o <code>dialogo.txt</code>.</div>
  </div>

<script>
/** ===== UI helpers ===== */
function setStatus(msg){ document.getElementById("statusBox").textContent = msg; }
function debugLog(line){
  const box = document.getElementById("debugBox");
  box.value = (box.value ? box.value + "\n" : "") + line;
}
function clearDebug(){ document.getElementById("debugBox").value = ""; }
function clampInt(n, min, max){
  n = Number(n);
  if(!Number.isFinite(n)) return min;
  n = Math.floor(n);
  if(n < min) return min;
  if(typeof max === "number" && n > max) return max;
  return n;
}
function unitKey(unitNumber){ return "Unit" + unitNumber; }
function levelKey(levelNumber){ return "Level" + levelNumber; }
function normalizeBaseUrl(raw){
  const s = (raw || "").trim();
  if(!s) return "";
  return s.replace(/\/+$/, "");
}
function buildUrl(baseUrl, path){
  baseUrl = normalizeBaseUrl(baseUrl);
  if(!path.startsWith("/")) path = "/" + path;
  return baseUrl + path;
}

/** ===== Linear index helpers (wrap across levels) ===== */
function toLinearIndex(levelNum, unitNum, unitsPerLevel){
  return (levelNum * unitsPerLevel) + unitNum; // unitNum starts at 1
}
function fromLinearIndex(idx, unitsPerLevel){
  const zeroBased = idx - 1;
  const levelNum = Math.floor(zeroBased / unitsPerLevel);
  const unitNum  = (zeroBased % unitsPerLevel) + 1;
  return { levelNum, unitNum };
}

/** ===== Fetch helpers ===== */
async function fetchTextSafeAbs(url){
  try{
    const res = await fetch(url, { cache:"no-store" });
    debugLog(`${res.status} ${url}`);
    if(!res.ok) return null;
    return await res.text();
  }catch(e){
    debugLog(`ERR  ${url}  -> ${e && e.message ? e.message : String(e)}`);
    return null;
  }
}
async function fetchJsonSafeAbs(url){
  try{
    const res = await fetch(url, { cache:"no-store" });
    debugLog(`${res.status} ${url}`);
    if(!res.ok) return null;
    return await res.json();
  }catch(e){
    debugLog(`ERR  ${url}  -> ${e && e.message ? e.message : String(e)}`);
    return null;
  }
}

/**
 * words.txt no seu projeto pode estar:
 * - uma palavra/express√£o por linha (ex.: "STAND UP")
 * - OU listas longas em uma linha (tokens)
 * Heur√≠stica:
 * - 1 a 3 tokens => considerar a linha como uma express√£o (mant√©m "STAND UP")
 * - 4+ tokens => split em tokens (lista)
 */
function parseWordsTxt(txt){
  const lines = txt.split(/\r?\n/g).map(s => (s || "").trim()).filter(Boolean);
  const out = [];
  for(const line of lines){
    const tokens = line.split(/\s+/).filter(Boolean);
    if(tokens.length >= 4){
      out.push(...tokens);
    }else{
      out.push(line);
    }
  }
  return out.map(w => w.trim()).filter(Boolean);
}

/** ===== Vocabulary fetch ===== */
async function fetchWordsForUnit(baseUrl, levelNum, unitNum){
  const base = `/${levelKey(levelNum)}/${unitKey(unitNum)}`;
  const dataFolders = ["data1","data2","data3","Data1","Data2","Data3"];
  const all = [];

  for(const df of dataFolders){
    const url = buildUrl(baseUrl, `${base}/${df}/words.txt`);
    const txt = await fetchTextSafeAbs(url);
    if(txt) all.push(...parseWordsTxt(txt));
  }
  return Array.from(new Set(all));
}

/** ===== Grammar fetch ===== */
async function fetchGrammarJSON(baseUrl){
  const url = buildUrl(baseUrl, "/grammar/grammar.json");
  return await fetchJsonSafeAbs(url);
}
function getGrammarForUnit(grammarData, levelNum, unitNum){
  if(!grammarData) return [];
  const L = grammarData[levelKey(levelNum)];
  if(!L) return [];
  const U = L[unitKey(unitNum)];
  if(!Array.isArray(U)) return [];
  return U.map(s => (s || "").trim()).filter(Boolean);
}

/** ===== Prompt building ===== */
function buildLevelRules(englishLevel){
  const rules = {
    Starter: [
      "P√∫blico: crian√ßas pequenas (primeiro contato com ingl√™s).",
      "Linguagem MUITO simples, concreta e repetitiva.",
      "Frases curtas (prefer√™ncia: 2‚Äì6 palavras; m√°ximo: 8).",
      "Evitar: passado, futuro, continuous, phrasal verbs, idioms, g√≠rias.",
      "Repetir estruturas importantes 2‚Äì3 vezes com pequenas varia√ß√µes.",
      "Usar exatamente as frases-alvo da li√ß√£o (quando existirem)."
    ],
    A1: [
      "Frases simples e diretas. Vocabul√°rio b√°sico.",
      "Perguntas/respostas curtas com pequenas varia√ß√µes.",
      "Evitar explica√ß√µes longas."
    ],
    A2: [
      "Frases curtas a m√©dias. Mais varia√ß√µes de perguntas.",
      "Pode usar conectores simples (and, but, because) com modera√ß√£o."
    ],
    B1: [
      "Di√°logo natural, com pequenos detalhes e justificativas simples.",
      "Pode incluir opini√µes curtas."
    ],
    B2: [
      "Mais flu√™ncia. Vocabul√°rio mais amplo, mas sempre ligado ao tema.",
      "Pode incluir reformula√ß√µes e nuances."
    ],
    C1: [
      "Di√°logo sofisticado, vocabul√°rio avan√ßado e natural.",
      "Pode incluir explica√ß√µes e precis√£o lingu√≠stica."
    ],
    C2: [
      "M√°xima naturalidade e precis√£o. Registro apropriado ao contexto."
    ]
  };
  return (rules[englishLevel] || rules.Starter).map(x => `- ${x}`).join("\n");
}

function formatList(title, items){
  if(!items || !items.length) return `${title}\n- (nenhum)\n`;
  return `${title}\n${items.map(x => `- ${x}`).join("\n")}\n`;
}
function mergeDedup(arr){
  return Array.from(new Set((arr || []).map(s => (s || "").trim()).filter(Boolean)));
}
function selectWordsWithPriority(currentWords, prev1Words, prev2Words, maxWords){
  const result = [];
  const seen = new Set();
  function pushFrom(list){
    for(const w of list){
      const key = (w || "").trim();
      if(!key) continue;
      if(seen.has(key)) continue;
      seen.add(key);
      result.push(key);
      if(result.length >= maxWords) return false;
    }
    return true;
  }
  pushFrom(currentWords);
  if(result.length < maxWords) pushFrom(prev1Words);
  if(result.length < maxWords) pushFrom(prev2Words);
  return result;
}

/** ===== Copy button (with Safari fallback) ===== */
async function copiarPrompt(){
  const text = document.getElementById("promptOutput").value || "";
  if(!text.trim()) return;

  // Modern clipboard
  try{
    if(navigator.clipboard && window.isSecureContext){
      await navigator.clipboard.writeText(text);
      showToast("Copiado!");
      return;
    }
  }catch(e){ /* fallback below */ }

  // Fallback (execCommand), works on many browsers including older Safari
  try{
    const ta = document.getElementById("promptOutput");
    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);
    const ok = document.execCommand("copy");
    showToast(ok ? "Copiado!" : "N√£o foi poss√≠vel copiar");
  }catch(e){
    showToast("N√£o foi poss√≠vel copiar");
  }
}
function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1200);
}

/** ===== Main ===== */
async function gerarPrompt(){
  const btn = document.getElementById("btnGerar");
  const btnCopy = document.getElementById("btnCopiar");
  btn.disabled = true;
  btnCopy.disabled = true;
  clearDebug();

  try{
    const baseUrl = normalizeBaseUrl(document.getElementById("baseUrl").value);
    const lesson = document.getElementById("lessonInput").value.trim();
    const inspiration = document.getElementById("inspirationInput").value.trim();
    const englishLevel = document.getElementById("englishLevel").value;

    const unitsPerLevel = clampInt(document.getElementById("unitsPerLevel").value, 1, 200);
    const maxWords = clampInt(document.getElementById("maxWords").value, 30, 600);

    const levelNum = clampInt(document.getElementById("levelNumber").value, 0, 999);
    const unitNum  = clampInt(document.getElementById("unitNumber").value, 1, unitsPerLevel);

    if(!baseUrl){
      setStatus("Status: erro ‚Äî Base URL est√° vazia.");
      btn.disabled = false;
      return;
    }
    if(!lesson){
      setStatus("Status: erro ‚Äî a LI√á√ÉO (fonte prim√°ria) est√° vazia.");
      btn.disabled = false;
      return;
    }

    setStatus("Status: buscando repert√≥rio (words.txt) na Base URL...");
    const currentIdx = toLinearIndex(levelNum, unitNum, unitsPerLevel);
    const idxs = [currentIdx, currentIdx - 1, currentIdx - 2].filter(i => i >= 1);
    const targets = idxs.map(i => fromLinearIndex(i, unitsPerLevel));

    const wordsByTarget = [];
    for(const t of targets){
      setStatus(`Status: repert√≥rio ${levelKey(t.levelNum)} / ${unitKey(t.unitNum)}...`);
      const words = await fetchWordsForUnit(baseUrl, t.levelNum, t.unitNum);
      wordsByTarget.push(words);
    }

    const currentWords = wordsByTarget[0] || [];
    const prev1Words   = wordsByTarget[1] || [];
    const prev2Words   = wordsByTarget[2] || [];
    const repertoireWords = selectWordsWithPriority(currentWords, prev1Words, prev2Words, maxWords);

    setStatus("Status: buscando gram√°tica (grammar.json) na Base URL...");
    const grammarData = await fetchGrammarJSON(baseUrl);

    const grammarLists = targets.map(t => getGrammarForUnit(grammarData, t.levelNum, t.unitNum));
    const allowedGrammar = mergeDedup([].concat(...grammarLists));

    const basicWordsAllowed = [
      "I","YOU","HE","SHE","IT","WE","THEY",
      "MY","YOUR","HIS","HER","OUR","THEIR",
      "A","AN","THE",
      "AM","IS","ARE",
      "YES","NO",
      "WHAT","HOW","WHO","WHERE",
      "AND","OR","BUT",
      "PLEASE","THANK YOU",
      "OK","HELLO","HI","GOOD MORNING","GOODBYE"
    ];

    const levelRulesText = buildLevelRules(englishLevel);

    const inspirationBlock = inspiration
      ? `\nTEXTO INSPIRADOR (OPCIONAL ‚Äî APOIO LEVE)\n- Use como fonte de algumas palavras/express√µes relevantes.\n- N√ÉO copiar frases completas.\n${inspiration}\n`
      : "";

    const prompt = `
Voc√™ √© um gerador de di√°logos para ensino de ingl√™s. Seu objetivo final √© produzir o conte√∫do do arquivo "dialogo.txt" (uma fala por linha), com um di√°logo did√°tico e realista entre o Robot Samuel e a menina Hannah.

üî¥ REGRA M√ÅXIMA
A LI√á√ÉO abaixo √© a FONTE PRIM√ÅRIA e MANDA no di√°logo. O di√°logo deve ensinar e praticar exatamente essa li√ß√£o.

N√çVEL DE INGL√äS (CEFR)
- N√≠vel escolhido: ${englishLevel}

REGRAS DO N√çVEL (OBRIGAT√ìRIAS)
${levelRulesText}

GRAM√ÅTICA PERMITIDA (LIMITE)
- Use apenas as estruturas listadas em GRAM√ÅTICA PERMITIDA.
- N√ÉO use tempos verbais/estruturas n√£o ensinados (past, future, continuous, etc.).
- Se houver d√∫vida, escolha a forma mais simples.

FOCO NO TEMA (OBRIGAT√ìRIO)
- O di√°logo deve permanecer 100% no tema da li√ß√£o.
- N√ÉO introduzir novos t√≥picos.
- N√ÉO mudar o assunto.

USO OBRIGAT√ìRIO DAS FRASES-ALVO (OBRIGAT√ìRIO)
- O di√°logo DEVE incluir explicitamente as frases-alvo/‚Äúkey phrases‚Äù que aparecem na LI√á√ÉO.
- Essas frases devem aparecer v√°rias vezes ao longo do di√°logo.
- N√£o substitua por sin√¥nimos (ex.: n√£o trocar ‚ÄúHow old are you?‚Äù por ‚ÄúWhat is your age?‚Äù).

PADR√ÉO DO DI√ÅLOGO (OBRIGAT√ìRIO)
- Siga o ciclo de pr√°tica: PERGUNTA ‚Üí RESPOSTA ‚Üí REPETI√á√ÉO com varia√ß√£o.
- Repita as frases-alvo 2‚Äì3 vezes com pequenas varia√ß√µes (mudando apenas o n√∫mero, nome, etc.).
- Exemplo do padr√£o:
  How old are you?
  I am six years old.
  How old are you?
  I am seven years old.

FORMATO DO ARQUIVO "dialogo.txt" (OBRIGAT√ìRIO)
- Apenas falas (uma fala por linha).
- Sem t√≠tulos, sem explica√ß√µes, sem coment√°rios, sem listas.
- Sem marca√ß√µes extras.
- Robot Samuel e Hannah devem alternar as falas.
- Tamanho sugerido:
  - Starter/A1: 10 a 16 linhas
  - A2/B1: 12 a 22 linhas
  - B2/C1/C2: 14 a 26 linhas

========================================
ETAPA 1 ‚Äî GERAR O DI√ÅLOGO (CRIA√á√ÉO)
========================================
1) Gere um di√°logo que ensine a LI√á√ÉO (fonte prim√°ria).
2) Use basicamente o conte√∫do da LI√á√ÉO e BASIC WORDS ALLOWED para ligar frases.
3) Se usar palavras extras, mantenha simples e dentro do n√≠vel.
4) N√ÉO use a lista REPERT√ìRIO DO ALUNO como fonte para inventar conte√∫do. Ela ser√° usada apenas na ETAPA 2 (verifica√ß√£o).

========================================
ETAPA 2 ‚Äî REVISAR VOCABUL√ÅRIO (VERIFICA√á√ÉO)
========================================
Agora revise o di√°logo gerado e fa√ßa uma checagem de conformidade:

- Para cada palavra ‚Äúextra‚Äù (fora das frases da LI√á√ÉO e fora de BASIC WORDS ALLOWED),
  verifique se ela aparece no REPERT√ìRIO DO ALUNO.
- Se alguma palavra n√£o estiver no REPERT√ìRIO DO ALUNO:
  (a) substitua por uma palavra mais simples que esteja no REPERT√ìRIO DO ALUNO, OU
  (b) remova a palavra sem perder o sentido.
- N√£o adicione novos t√≥picos.
- N√£o mude as frases-alvo.
- N√£o aumente o tamanho desnecessariamente.
- Entregue como resultado final apenas o "dialogo.txt" j√° revisado.

${formatList("GRAM√ÅTICA PERMITIDA (CUMULATIVA):", allowedGrammar).trim()}

${formatList("BASIC WORDS ALLOWED (VOCABUL√ÅRIO B√ÅSICO DE LIGA√á√ÉO):", basicWordsAllowed).trim()}

${formatList("REPERT√ìRIO DO ALUNO (APENAS PARA VERIFICA√á√ÉO NA ETAPA 2 ‚Äî N√ÉO √â PARA ‚ÄúPUXAR IDEIAS‚Äù):", repertoireWords).trim()}

${inspirationBlock ? inspirationBlock.trim() + "\n" : ""}

--- LI√á√ÉO (FONTE PRIM√ÅRIA ‚Äî O DI√ÅLOGO DEVE ENSINAR ISTO) ---
${lesson}
--- FIM DA LI√á√ÉO ---

Agora, gere APENAS o conte√∫do final do arquivo "dialogo.txt" (uma fala por linha), seguindo todas as regras acima.
`.trim();

    document.getElementById("promptOutput").value = prompt;

    const info = [
      "Status: pronto.",
      `Base URL: ${baseUrl}`,
      `N√≠vel atual: ${levelKey(levelNum)} / ${unitKey(unitNum)} (unitsPerLevel=${unitsPerLevel})`,
      `Units usadas (wrap): ${targets.map(t => `${levelKey(t.levelNum)}/${unitKey(t.unitNum)}`).join(" , ")}`,
      `Repert√≥rio: current=${currentWords.length}, prev1=${prev1Words.length}, prev2=${prev2Words.length} => inclu√≠das=${repertoireWords.length} (max=${maxWords})`,
      `Gram√°tica (cumulativa): itens=${allowedGrammar.length}`,
      grammarData ? "grammar.json: carregado." : "grammar.json: N√ÉO carregado (verifique /grammar/grammar.json)."
    ].join("\n");

    setStatus(info);
    btnCopy.disabled = false;

  }catch(err){
    setStatus("Status: erro inesperado.\n" + (err && err.message ? err.message : String(err)));
  }finally{
    btn.disabled = false;
  }
}
</script>

</body>
</html>
