<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hannah Questions ‚Äì Admin</title>
<style>
  :root{
    --bg:#f1f5f9; --card:#ffffff; --text:#0f172a; --muted:#64748b;
    --brand:#2563eb; --brand-soft:#dbeafe; --border:#e2e8f0;
    --ok:#16a34a; --err:#ef4444;
    --radius:16px; --shadow:0 10px 25px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background:radial-gradient(circle at top,#e0f2fe,#f9fafb);
    color:var(--text);
  }
  .wrap{
    max-width:1100px;
    margin:24px auto 40px;
    padding:0 16px;
  }
  h1{
    margin:0 0 4px;
    font-size:26px;
    font-weight:900;
    letter-spacing:.01em;
  }
  .sub{
    margin:0 0 18px;
    color:var(--muted);
    font-size:14px;
  }
  .top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:16px;
  }
  .pill-link{
    border-radius:999px;
    padding:8px 14px;
    background:#0f172a;
    color:#e5e7eb;
    font-size:13px;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:18px 16px;
    margin-bottom:16px;
    border:1px solid rgba(148,163,184,.35);
  }
  label{
    font-size:13px;
    color:#0f172a;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }
  .input, select, textarea{
    width:100%;
    border-radius:12px;
    border:1px solid var(--border);
    padding:8px 10px;
    font-size:14px;
    font-family:inherit;
    outline:none;
    background:#f8fafc;
  }
  textarea{
    min-height:110px;
    resize:vertical;
  }
  .input:focus, select:focus, textarea:focus{
    border-color:#93c5fd;
    box-shadow:0 0 0 1px rgba(59,130,246,.3);
    background:#ffffff;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
  }
  .col-3{flex:1 1 160px;}
  .col-2{flex:1 1 200px;}
  .col-full{flex:1 1 100%;}
  .hint{font-size:11px;color:var(--muted);margin-top:2px}
  .badge{
    font-size:12px;
    color:var(--muted);
  }
  button{
    appearance:none;
    border:none;
    border-radius:999px;
    padding:9px 14px;
    font-weight:700;
    font-size:14px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .btn-primary{
    background:linear-gradient(90deg,#3b82f6,#22c55e);
    color:#ffffff;
    box-shadow:0 8px 16px rgba(34,197,94,.22);
  }
  .btn-ghost{
    background:#0f172a;
    color:#e5e7eb;
  }
  .btn-soft{
    background:var(--brand-soft);
    color:#1d4ed8;
  }
  .btn-outline{
    background:transparent;
    border:1px solid var(--border);
    color:#0f172a;
  }
  .btn-small{
    padding:6px 10px;
    font-size:12px;
  }
  .section-title{
    font-size:14px;
    font-weight:700;
    margin:0 0 8px;
    color:#0f172a;
  }
  .type-tag{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #e2e8f0;
    background:#f9fafb;
  }
  .divider{
    border-top:1px dashed #e2e8f0;
    margin:12px 0;
  }
  .options-wrap{
    display:flex;
    flex-direction:column;
    gap:8px;
    margin-top:6px;
  }
  .option-row{
    display:grid;
    grid-template-columns:minmax(0,2fr) minmax(0,2fr) minmax(0,2fr) auto auto;
    gap:6px;
    align-items:center;
  }
  .option-row.small-media{
    grid-template-columns:minmax(0,2.2fr) minmax(0,1.6fr) minmax(0,1.8fr) minmax(0,1.8fr) auto auto;
  }
  .option-row input{
    font-size:13px;
  }
  .option-label{
    font-size:12px;
    color:var(--muted);
  }
  .json-area{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;
    font-size:13px;
    background:#020617;
    color:#e5e7eb;
    border-radius:12px;
    padding:10px;
    border:1px solid #1e293b;
  }
  .status{
    margin-left:8px;
    font-size:13px;
  }
  .status.ok{color:var(--ok);}
  .status.err{color:var(--err);}
  .status.neutral{color:var(--muted);}
  .tag-flex{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:4px;
  }
  .pair-row{
    display:grid;
    grid-template-columns:minmax(0,2fr) minmax(0,2fr) minmax(0,2fr) auto;
    gap:6px;
    align-items:center;
  }
  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:4px;
    font-size:11px;
    color:var(--muted);
  }
  .chip{
    border-radius:999px;
    background:#e2e8f0;
    padding:2px 8px;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="top-bar">
    <div>
      <h1>Hannah Questions ‚Äì Admin</h1>
      <p class="sub">Criar / atualizar quest√µes e vincular √† atividade <b>(Level / Unit / Fase)</b> sem precisar editar JSON na m√£o.</p>
    </div>
    <a href="./owner-dashboard.html" class="pill-link">
      ‚¨Ö Owner Dashboard
    </a>
  </div>

  <!-- META DA QUEST√ÉO -->
  <div class="card">
    <div class="row">
      <div class="col-3">
        <label for="levelInput">Level</label>
        <input id="levelInput" class="input" placeholder="Ex.: Level0" />
        <div class="hint">Se digitar s√≥ ‚Äú0‚Äù, o sistema transforma em ‚ÄúLevel0‚Äù.</div>
      </div>
      <div class="col-3">
        <label for="unitInput">Unit</label>
        <input id="unitInput" class="input" placeholder="Ex.: Unit1" />
        <div class="hint">Se digitar s√≥ ‚Äú1‚Äù, o sistema transforma em ‚ÄúUnit1‚Äù.</div>
      </div>
      <div class="col-3">
        <label for="faseInput">Fase</label>
        <input id="faseInput" class="input" placeholder="Ex.: 7" />
        <div class="hint">N√∫mero da fase (ex.: 7). Ser√° salvo como <code>fase7</code>.</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <div class="col-3">
        <label for="orderInput">Ordem na atividade</label>
        <input id="orderInput" class="input" placeholder="Ex.: 1" />
        <div class="hint">1 = primeira quest√£o; se vazio, o sistema tenta colocar ao final.</div>
      </div>
      <div class="col-3">
        <label for="qidInput">Question ID (opcional)</label>
        <input id="qidInput" class="input" placeholder="Ex.: L0_U1_F7_Q01" />
        <div class="hint">Se vazio, ser√° gerado automaticamente (<code>L0_U1_F7_Q_timestamp</code>).</div>
      </div>
      <div class="col-3">
        <label for="typeSelect">Tipo de quest√£o</label>
        <select id="typeSelect" class="input">
          <option value="">‚Äî selecione ‚Äî</option>
          <option value="choice">MCQ (texto)</option>
          <option value="yesno">Yes / No</option>
          <option value="truefalse">True / False</option>
          <option value="picture">Picture choice (imagem nas op√ß√µes)</option>
          <option value="audiochoice">Audio choice (som nas op√ß√µes)</option>
          <option value="fillblank">Fill in the blanks</option>
          <option value="order">Order (montar frase)</option>
          <option value="match">Match (correspond√™ncia)</option>
        </select>
        <div class="hint">Esse valor ser√° salvo em <code>type</code> dentro do JSON.</div>
      </div>
    </div>
  </div>

  <!-- CAMPOS COMUNS + ESPEC√çFICOS POR TIPO -->
  <div class="card">
    <p class="section-title">2) Dados da quest√£o (formul√°rio amig√°vel)</p>

    <!-- CAMPOS COMUNS -->
    <div class="row">
      <div class="col-full">
        <label for="promptInput">Enunciado (prompt em ingl√™s)</label>
        <textarea id="promptInput" class="input" placeholder="Ex.: What is this?"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col-3">
        <label for="imageInput">Imagem da pergunta (opcional)</label>
        <input id="imageInput" class="input" placeholder="Ex.: images/apple.png" />
      </div>
      <div class="col-3">
        <label for="promptAudioInput">√Åudio da pergunta (opcional)</label>
        <input id="promptAudioInput" class="input" placeholder="Ex.: sounds/q01_prompt.mp3" />
      </div>
      <div class="col-3">
        <label for="ttsInput">Texto TTS da pergunta (opcional)</label>
        <input id="ttsInput" class="input" placeholder="Se vazio, usa o pr√≥prio prompt." />
      </div>
    </div>

    <div class="row">
      <div class="col-3">
        <label for="grammarTagInput">Grammar tag (opcional)</label>
        <input id="grammarTagInput" class="input" placeholder="Ex.: tobe-present, my-your-his-her" />
      </div>
      <div class="col-3">
        <label for="skillTypeInput">Skill (opcional)</label>
        <select id="skillTypeInput" class="input">
          <option value="">‚Äî n√£o marcar ‚Äî</option>
          <option value="vocabulary">Vocabulary</option>
          <option value="grammar">Grammar</option>
          <option value="listening">Listening</option>
          <option value="reading">Reading</option>
          <option value="speaking">Speaking</option>
        </select>
      </div>
      <div class="col-3">
        <label for="difficultyInput">Dificuldade</label>
        <select id="difficultyInput" class="input">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col-3">
        <label>
          <input type="checkbox" id="shuffleInput" checked />
          Embaralhar op√ß√µes (quando aplic√°vel)
        </label>
        <div class="hint">Ignorado em tipos que n√£o usam alternativas (order/match/fillblank sem banco).</div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- CAMPOS ESPEC√çFICOS POR TIPO -->
    <p class="section-title">
      3) Campos espec√≠ficos do tipo
      <span id="typeTag" class="type-tag" style="margin-left:6px;display:none"></span>
    </p>
    <div id="typeFields">
      <span class="badge">Selecione um tipo de quest√£o acima para aparecerem os campos correspondentes.</span>
    </div>
  </div>

  <!-- JSON & A√á√ïES -->
  <div class="card">
    <p class="section-title">4) Objeto da quest√£o (JSON)</p>
    <p class="chips">
      <span class="chip">‚¨áÔ∏è ‚ÄúGerar JSON‚Äù usa os campos do formul√°rio.</span>
      <span class="chip">‚¨ÜÔ∏è ‚ÄúCarregar do JSON‚Äù preenche o formul√°rio a partir do JSON colado.</span>
    </p>
    <textarea id="jsonInput" class="json-area" spellcheck="false" placeholder='Cole ou visualize aqui o objeto JSON da quest√£o.'></textarea>
    <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center">
      <button type="button" class="btn-soft" id="btnBuildJson">‚¨áÔ∏è Gerar JSON a partir do formul√°rio</button>
      <button type="button" class="btn-outline" id="btnLoadFromJson">‚¨ÜÔ∏è Carregar formul√°rio a partir do JSON</button>
      <span id="jsonStatus" class="status neutral">Aguardando a√ß√£o‚Ä¶</span>
    </div>
  </div>

  <!-- SALVAR -->
  <div class="card">
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center">
      <button type="button" class="btn-primary" id="btnSave">
        üíæ Salvar quest√£o no Firebase
      </button>
      <button type="button" class="btn-ghost btn-small" id="btnClearForm">
        Limpar formul√°rio
      </button>
      <span id="saveStatus" class="status neutral">Status: nenhuma opera√ß√£o ainda.</span>
    </div>
  </div>

  <p class="badge">Status de autentica√ß√£o: <span id="authInfo">verificando‚Ä¶</span></p>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* =========================
   Firebase init (v8)
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
};
firebase.initializeApp(firebaseConfig);

let currentUser = null;
firebase.auth().onAuthStateChanged(function(user){
  currentUser = user || null;
  const authInfo = document.getElementById('authInfo');
  if(user){
    authInfo.textContent = 'autenticado como: ' + (user.email || user.uid);
  }else{
    authInfo.textContent = 'n√£o autenticado (fa√ßa login em outra aba).';
  }
});

/* =========================
   Helpers b√°sicos
========================= */
function $(id){ return document.getElementById(id); }

function normalizeDir(prefix, value, fallbackNum){
  if(!value) return prefix + fallbackNum;
  const lower = String(value).toLowerCase().trim();
  if(lower.startsWith(prefix.toLowerCase())) return value.trim();
  const onlyNum = (lower.match(/\d+/)||[''])[0] || fallbackNum;
  return prefix + onlyNum;
}
function normalizeStr(v){
  return String(v||'').trim();
}
function toNumberOrNull(v){
  const n = parseInt(String(v||'').trim(),10);
  return Number.isFinite(n) ? n : null;
}
function showStatus(el, msg, kind){
  el.textContent = msg;
  el.classList.remove('ok','err','neutral');
  el.classList.add(kind||'neutral');
}
function normalizeValueForCompare(v){
  return String(v||'').trim().toLowerCase();
}

/* =========================
   Refer√™ncias de elementos
========================= */
const levelInput        = $('levelInput');
const unitInput         = $('unitInput');
const faseInput         = $('faseInput');
const orderInput        = $('orderInput');
const qidInput          = $('qidInput');
const typeSelect        = $('typeSelect');

const promptInput       = $('promptInput');
const imageInput        = $('imageInput');
const promptAudioInput  = $('promptAudioInput');
const ttsInput          = $('ttsInput');
const grammarTagInput   = $('grammarTagInput');
const skillTypeInput    = $('skillTypeInput');
const difficultyInput   = $('difficultyInput');
const shuffleInput      = $('shuffleInput');

const typeFields        = $('typeFields');
const typeTag           = $('typeTag');

const jsonInput         = $('jsonInput');
const jsonStatus        = $('jsonStatus');
const saveStatus        = $('saveStatus');

const btnBuildJson      = $('btnBuildJson');
const btnLoadFromJson   = $('btnLoadFromJson');
const btnSave           = $('btnSave');
const btnClearForm      = $('btnClearForm');

/* =========================
   RENDERIZA√á√ÉO POR TIPO
========================= */

const TYPE_LABELS = {
  'choice':'MCQ (texto)',
  'yesno':'Yes / No',
  'truefalse':'True / False',
  'picture':'Picture choice',
  'audiochoice':'Audio choice',
  'fillblank':'Fill in the blanks',
  'order':'Order',
  'match':'Match'
};

function renderTypeFields(type){
  typeFields.innerHTML = '';
  if(!type){
    typeTag.style.display='none';
    typeFields.innerHTML = '<span class="badge">Selecione um tipo de quest√£o acima para aparecerem os campos correspondentes.</span>';
    return;
  }
  typeTag.style.display='inline-flex';
  typeTag.textContent = TYPE_LABELS[type] || type;

  if(['choice','yesno','truefalse','picture','audiochoice'].includes(type)){
    renderMCQFields(type);
  }else if(type === 'fillblank'){
    renderFillblankFields();
  }else if(type === 'order'){
    renderOrderFields();
  }else if(type === 'match'){
    renderMatchFields();
  }else{
    typeFields.innerHTML = '<span class="badge">Tipo desconhecido. Edite somente pelo JSON.</span>';
  }
}

/* ---------- MCQ-like ---------- */
function renderMCQFields(type){
  const wrap = document.createElement('div');

  const info = document.createElement('p');
  info.className = 'hint';
  info.textContent = 'Use as linhas abaixo para definir as alternativas. Marque qual √© a correta.';
  wrap.appendChild(info);

  const optionsWrap = document.createElement('div');
  optionsWrap.id = 'optionsWrap';
  optionsWrap.className = 'options-wrap';
  wrap.appendChild(optionsWrap);

  const buttonsRow = document.createElement('div');
  buttonsRow.style.marginTop = '6px';
  buttonsRow.style.display = 'flex';
  buttonsRow.style.gap = '8px';
  const btnAdd = document.createElement('button');
  btnAdd.type = 'button';
  btnAdd.className = 'btn-soft btn-small';
  btnAdd.textContent = '+ Adicionar op√ß√£o';
  btnAdd.onclick = () => addOptionRow(type);
  buttonsRow.appendChild(btnAdd);

  const btnPreset = document.createElement('button');
  btnPreset.type = 'button';
  btnPreset.className = 'btn-outline btn-small';
  btnPreset.textContent = 'Preencher padr√£o (Yes/No ou True/False)';
  btnPreset.onclick = () => presetYesNoTF(type);
  buttonsRow.appendChild(btnPreset);

  wrap.appendChild(buttonsRow);

  typeFields.appendChild(wrap);

  // adiciona algumas op√ß√µes iniciais
  if(type === 'yesno'){
    presetYesNoTF('yesno');
  }else if(type === 'truefalse'){
    presetYesNoTF('truefalse');
  }else{
    addOptionRow(type);
    addOptionRow(type);
    addOptionRow(type);
    addOptionRow(type);
  }
}

function addOptionRow(type, data){
  const optionsWrap = $('optionsWrap');
  if(!optionsWrap) return;

  const row = document.createElement('div');
  row.className = 'option-row small-media';

  const label = document.createElement('div');
  label.innerHTML = '<div class="option-label">Label</div><input class="input opt-label" placeholder="Ex.: Apple" />';
  row.appendChild(label);

  const vDiv = document.createElement('div');
  vDiv.innerHTML = '<div class="option-label">Value (se vazio, copia do label)</div><input class="input opt-value" placeholder="Ex.: apple" />';
  row.appendChild(vDiv);

  const imageDiv = document.createElement('div');
  imageDiv.className = 'opt-image-block';
  imageDiv.innerHTML = '<div class="option-label">Imagem (opcional)</div><input class="input opt-image" placeholder="Ex.: images/apple.png" />';
  row.appendChild(imageDiv);

  const audioDiv = document.createElement('div');
  audioDiv.className = 'opt-audio-block';
  audioDiv.innerHTML = '<div class="option-label">√Åudio (opcional)</div><input class="input opt-audio" placeholder="Ex.: sounds/apple.mp3" />';
  row.appendChild(audioDiv);

  const correctDiv = document.createElement('div');
  correctDiv.innerHTML = '<div class="option-label">Correta?</div><input type="radio" name="optCorrect" class="opt-correct" />';
  row.appendChild(correctDiv);

  const removeDiv = document.createElement('div');
  const btnRem = document.createElement('button');
  btnRem.type = 'button';
  btnRem.className = 'btn-outline btn-small';
  btnRem.textContent = '‚úï';
  btnRem.onclick = () => {
    optionsWrap.removeChild(row);
  };
  removeDiv.appendChild(btnRem);
  row.appendChild(removeDiv);

  optionsWrap.appendChild(row);

  // Visibilidade de imagem/√°udio por tipo
  if(!['picture','audiochoice'].includes(type)){
    imageDiv.style.display = 'none';
  }
  if(type !== 'audiochoice'){
    audioDiv.style.display = 'none';
  }

  if(data){
    const [lab, val, img, aud, isCorrect] = data;
    row.querySelector('.opt-label').value = lab || '';
    row.querySelector('.opt-value').value = val || '';
    row.querySelector('.opt-image').value = img || '';
    row.querySelector('.opt-audio').value = aud || '';
    if(isCorrect){
      row.querySelector('.opt-correct').checked = true;
    }
  }
}

function presetYesNoTF(type){
  const optionsWrap = $('optionsWrap');
  if(!optionsWrap) return;
  optionsWrap.innerHTML = '';

  if(type === 'yesno'){
    addOptionRow(type, ['Yes','yes','','',true]);
    addOptionRow(type, ['No','no','','',false]);
  }else if(type === 'truefalse'){
    addOptionRow(type, ['True','true','','',true]);
    addOptionRow(type, ['False','false','','',false]);
  }
}

/* ---------- Fill in the blanks ---------- */
function renderFillblankFields(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <p class="hint">Use <code>{blank}</code> ou <code>___</code> no enunciado para marcar o espa√ßo da resposta.</p>
    <div class="row">
      <div class="col-3">
        <label for="fbAnswer">Resposta correta (ou v√°rias, separadas por ponto e v√≠rgula)</label>
        <input id="fbAnswer" class="input" placeholder="Ex.: am ; 'm" />
        <div class="hint">Para m√∫ltiplas respostas aceitas, separe com <code>;</code>.</div>
      </div>
      <div class="col-3">
        <label for="fbWordBank">Banco de palavras (opcional)</label>
        <input id="fbWordBank" class="input" placeholder="Ex.: am, is, are" />
        <div class="hint">Se quiser mostrar op√ß√µes para a crian√ßa, separe-as por v√≠rgula.</div>
      </div>
    </div>
  `;
  typeFields.appendChild(wrap);
}

/* ---------- Order ---------- */
function renderOrderFields(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <p class="hint">Escreva a frase CORRETA, separando as partes com barra vertical <code>|</code>.</p>
    <label for="orderTokens">Partes da frase (na ordem correta)</label>
    <textarea id="orderTokens" class="input" placeholder="Ex.: I | am | a | boy"></textarea>
  `;
  typeFields.appendChild(wrap);
}

/* ---------- Match ---------- */
function renderMatchFields(){
  const wrap = document.createElement('div');

  const info = document.createElement('p');
  info.className = 'hint';
  info.textContent = 'Cada linha √© um par. O lado direito pode ser texto ou imagem (se campo imagem estiver preenchido).';
  wrap.appendChild(info);

  const pairsWrap = document.createElement('div');
  pairsWrap.id = 'pairsWrap';
  pairsWrap.style.display = 'flex';
  pairsWrap.style.flexDirection = 'column';
  pairsWrap.style.gap = '8px';
  wrap.appendChild(pairsWrap);

  const buttonsRow = document.createElement('div');
  buttonsRow.style.marginTop = '6px';
  const btnAdd = document.createElement('button');
  btnAdd.type = 'button';
  btnAdd.className = 'btn-soft btn-small';
  btnAdd.textContent = '+ Adicionar par';
  btnAdd.onclick = () => addPairRow();
  buttonsRow.appendChild(btnAdd);
  wrap.appendChild(buttonsRow);

  typeFields.appendChild(wrap);

  addPairRow();
  addPairRow();
}

function addPairRow(data){
  const pairsWrap = $('pairsWrap');
  if(!pairsWrap) return;

  const row = document.createElement('div');
  row.className = 'pair-row';

  row.innerHTML = `
    <div>
      <div class="option-label">Lado esquerdo (texto)</div>
      <input class="input pair-left" placeholder="Ex.: one" />
    </div>
    <div>
      <div class="option-label">Lado direito (texto alternativo)</div>
      <input class="input pair-right-label" placeholder="Ex.: 1 (one)" />
    </div>
    <div>
      <div class="option-label">Imagem lado direito (opcional)</div>
      <input class="input pair-right-image" placeholder="Ex.: images/1.png" />
    </div>
    <div style="text-align:right">
      <button type="button" class="btn-outline btn-small pair-remove">‚úï</button>
    </div>
  `;

  if(data){
    row.querySelector('.pair-left').value = data.left || '';
    row.querySelector('.pair-right-label').value = data.rightLabel || '';
    row.querySelector('.pair-right-image').value = data.rightImage || '';
  }

  row.querySelector('.pair-remove').onclick = () => {
    pairsWrap.removeChild(row);
  };

  pairsWrap.appendChild(row);
}

/* =========================
   Construir objeto da quest√£o
========================= */
function buildQuestionObjectFromForm(){
  const levelDir = normalizeDir('Level', levelInput.value, '0');
  const unitDir  = normalizeDir('Unit',  unitInput.value,  '1');
  const faseRaw  = normalizeStr(faseInput.value);
  const faseNum  = (faseRaw.match(/\d+/)||[''])[0] || '1';
  const faseKey  = 'fase' + faseNum;

  const orderNum = toNumberOrNull(orderInput.value) || null;
  const type = normalizeStr(typeSelect.value);
  if(!levelDir || !unitDir || !faseRaw){
    throw new Error('Preencha Level, Unit e Fase.');
  }
  if(!type){
    throw new Error('Selecione o tipo de quest√£o.');
  }

  const base = {
    type,
    prompt: normalizeStr(promptInput.value),
    image:  normalizeStr(imageInput.value) || undefined,
    promptAudio: normalizeStr(promptAudioInput.value) || undefined,
    tts: normalizeStr(ttsInput.value) || undefined,
    grammarTag: normalizeStr(grammarTagInput.value) || undefined,
    skillType: normalizeStr(skillTypeInput.value) || undefined,
    difficulty: normalizeStr(difficultyInput.value || 'easy'),
    shuffleOptions: !!shuffleInput.checked
  };

  if(!base.prompt){
    throw new Error('O enunciado (prompt) n√£o pode ficar vazio.');
  }

  let q = {...base};

  if(['choice','yesno','truefalse','picture','audiochoice'].includes(type)){
    const rows = Array.from(document.querySelectorAll('#optionsWrap .option-row'));
    if(!rows.length){
      throw new Error('Adicione pelo menos uma op√ß√£o.');
    }
    const options = [];
    let answerValue = null;

    rows.forEach(row => {
      const lab   = normalizeStr(row.querySelector('.opt-label').value);
      const valIn = normalizeStr(row.querySelector('.opt-value').value);
      const val   = valIn || lab;
      if(!lab && !val){
        return; // pula linha vazia
      }
      const img   = row.querySelector('.opt-image') ? normalizeStr(row.querySelector('.opt-image').value) : '';
      const aud   = row.querySelector('.opt-audio') ? normalizeStr(row.querySelector('.opt-audio').value) : '';
      const isCorrect = row.querySelector('.opt-correct').checked;

      const opt = {
        label: lab || val,
        value: val
      };
      if(img) opt.image = img;
      if(aud) opt.audio = aud;

      options.push(opt);
      if(isCorrect){
        answerValue = val;
      }
    });

    if(!options.length){
      throw new Error('Voc√™ removeu todas as op√ß√µes. Adicione pelo menos uma.');
    }
    if(answerValue == null){
      throw new Error('Marque qual op√ß√£o √© a correta.');
    }

    q.options = options;
    q.answer  = answerValue;
  }else if(type === 'fillblank'){
    const fbAnsEl = $('fbAnswer');
    const fbWBEl  = $('fbWordBank');
    if(!fbAnsEl){
      throw new Error('Campos de fillblank n√£o foram renderizados. Selecione o tipo novamente.');
    }
    const rawAns = normalizeStr(fbAnsEl.value);
    if(!rawAns){
      throw new Error('Preencha a resposta correta.');
    }
    if(rawAns.includes(';')){
      q.answer = rawAns.split(';').map(s=>normalizeStr(s)).filter(Boolean);
    }else{
      q.answer = rawAns;
    }
    const wb = normalizeStr(fbWBEl.value);
    if(wb){
      q.options = wb.split(',').map(s=>normalizeStr(s)).filter(Boolean);
    }
  }else if(type === 'order'){
    const tokensEl = $('orderTokens');
    if(!tokensEl){
      throw new Error('Campos de order n√£o foram renderizados.');
    }
    const raw = normalizeStr(tokensEl.value);
    if(!raw){
      throw new Error('Preencha as partes da frase para o tipo Order.');
    }
    const tokens = raw.split('|').map(s=>normalizeStr(s)).filter(Boolean);
    if(tokens.length < 2){
      throw new Error('Use pelo menos duas partes na frase (separe com "|").');
    }
    q.options = tokens.slice();
    q.answer  = tokens.slice(); // ordem correta
  }else if(type === 'match'){
    const rows = Array.from(document.querySelectorAll('#pairsWrap .pair-row'));
    if(!rows.length){
      throw new Error('Adicione ao menos 1 par.');
    }
    const pairs = [];
    rows.forEach(row => {
      const left  = normalizeStr(row.querySelector('.pair-left').value);
      const rLab  = normalizeStr(row.querySelector('.pair-right-label').value);
      const rImg  = normalizeStr(row.querySelector('.pair-right-image').value);
      if(!left){ return; }
      const leftObj = { label:left, value:left };
      let rightObj;
      if(rImg){
        rightObj = { image:rImg, value:rLab || rImg, label: rLab || undefined };
      }else{
        const val = rLab || left;
        rightObj = { label:rLab || val, value:val };
      }
      pairs.push({ left:leftObj, right:rightObj });
    });
    if(!pairs.length){
      throw new Error('Os pares ficaram vazios. Preencha pelo menos um.');
    }
    q.pairs = pairs;
  }

  // meta
  const now = Date.now();
  const faseRawForId = faseNum;
  const levelClean   = levelDir.replace(/\s+/g,'');
  const unitClean    = unitDir.replace(/\s+/g,'');

  let qid = normalizeStr(qidInput.value);
  if(!qid){
    qid = `${levelClean}_${unitClean}_F${faseRawForId}_Q${now}`;
  }

  q.id      = qid;
  q.level   = levelDir;
  q.unit    = unitDir;
  q.fase    = faseKey;
  if(orderNum != null) q.order = orderNum;
  q.updatedAt = now;
  if(!q.createdAt) q.createdAt = now;

  return { question: q, meta:{ levelDir, unitDir, faseKey, qid } };
}

/* =========================
   Preencher formul√°rio a partir de objeto
========================= */
function fillFormFromQuestion(q){
  // meta b√°sicos se existirem
  if(q.level){ levelInput.value = q.level; }
  if(q.unit){  unitInput.value  = q.unit;  }
  if(q.fase){
    const n = (String(q.fase).match(/\d+/)||[''])[0] || '';
    faseInput.value = n;
  }
  if(q.order != null){ orderInput.value = q.order; }
  if(q.id){ qidInput.value = q.id; }

  typeSelect.value = q.type || '';
  renderTypeFields(q.type || '');

  // comuns
  promptInput.value      = q.prompt || '';
  imageInput.value       = q.image || '';
  promptAudioInput.value = q.promptAudio || '';
  ttsInput.value         = q.tts || '';
  grammarTagInput.value  = q.grammarTag || '';
  skillTypeInput.value   = q.skillType || '';
  difficultyInput.value  = q.difficulty || 'easy';
  shuffleInput.checked   = (q.shuffleOptions !== false);

  const type = q.type;

  if(['choice','yesno','truefalse','picture','audiochoice'].includes(type)){
    const optionsWrap = $('optionsWrap');
    if(optionsWrap){
      optionsWrap.innerHTML = '';
      const opts = Array.isArray(q.options) ? q.options : [];
      const ans  = q.answer;
      opts.forEach(opt => {
        const lab = opt.label || opt.value || '';
        const val = opt.value || lab;
        const img = opt.image || '';
        const aud = opt.audio || '';
        const isCorrect = normalizeValueForCompare(val) === normalizeValueForCompare(ans);
        addOptionRow(type, [lab,val,img,aud,isCorrect]);
      });
    }
  }else if(type === 'fillblank'){
    if($('fbAnswer')){
      if(Array.isArray(q.answer)){
        $('fbAnswer').value = q.answer.join(' ; ');
      }else{
        $('fbAnswer').value = q.answer || '';
      }
    }
    if($('fbWordBank')){
      if(Array.isArray(q.options)){
        $('fbWordBank').value = q.options.join(', ');
      }else if(typeof q.options === 'string'){
        $('fbWordBank').value = q.options;
      }
    }
  }else if(type === 'order'){
    if($('orderTokens')){
      const tokens = Array.isArray(q.answer) ? q.answer : (Array.isArray(q.options) ? q.options : []);
      $('orderTokens').value = tokens.join(' | ');
    }
  }else if(type === 'match'){
    const pairsWrap = $('pairsWrap');
    if(pairsWrap){
      pairsWrap.innerHTML = '';
      const pairs = Array.isArray(q.pairs) ? q.pairs : [];
      pairs.forEach(p => {
        const left  = (p.left && (p.left.label || p.left.value)) || '';
        const rLab  = (p.right && (p.right.label || '')) || '';
        const rImg  = (p.right && (p.right.image || '')) || '';
        addPairRow({left, rightLabel:rLab, rightImage:rImg});
      });
    }
  }
}

/* =========================
   Eventos principais
========================= */

// mudar tipo
typeSelect.addEventListener('change', function(){
  renderTypeFields(this.value || '');
});

// gerar JSON a partir do formul√°rio
btnBuildJson.addEventListener('click', function(){
  try{
    const { question } = buildQuestionObjectFromForm();
    const json = JSON.stringify(question, null, 2);
    jsonInput.value = json;
    showStatus(jsonStatus, 'JSON gerado com sucesso a partir do formul√°rio.', 'ok');
  }catch(err){
    console.error(err);
    showStatus(jsonStatus, 'Erro: ' + err.message, 'err');
  }
});

// carregar formul√°rio a partir do JSON
btnLoadFromJson.addEventListener('click', function(){
  const txt = jsonInput.value.trim();
  if(!txt){
    showStatus(jsonStatus, 'Campo JSON est√° vazio.', 'err');
    return;
  }
  try{
    const obj = JSON.parse(txt);
    fillFormFromQuestion(obj);
    showStatus(jsonStatus, 'Formul√°rio preenchido a partir do JSON.', 'ok');
  }catch(err){
    console.error(err);
    showStatus(jsonStatus, 'JSON inv√°lido: ' + err.message, 'err');
  }
});

// salvar no Firebase
btnSave.addEventListener('click', async function(){
  if(!currentUser){
    showStatus(saveStatus, 'Voc√™ n√£o est√° autenticado. Fa√ßa login em outra aba.', 'err');
    return;
  }
  try{
    const { question, meta } = buildQuestionObjectFromForm();
    const refPath = `qaQuestions/${meta.levelDir}/${meta.unitDir}/${meta.faseKey}/${meta.qid}`;
    const ref = firebase.database().ref(refPath);
    await ref.set(question);
    const json = JSON.stringify(question, null, 2);
    jsonInput.value = json;
    showStatus(saveStatus, 'Quest√£o salva com sucesso em: ' + refPath, 'ok');
    showStatus(jsonStatus, 'JSON atualizado e salvo.', 'ok');
  }catch(err){
    console.error(err);
    showStatus(saveStatus, 'Erro ao salvar: ' + err.message, 'err');
  }
});

// limpar formul√°rio
btnClearForm.addEventListener('click', function(){
  levelInput.value = '';
  unitInput.value  = '';
  faseInput.value  = '';
  orderInput.value = '';
  qidInput.value   = '';

  promptInput.value      = '';
  imageInput.value       = '';
  promptAudioInput.value = '';
  ttsInput.value         = '';
  grammarTagInput.value  = '';
  skillTypeInput.value   = '';
  difficultyInput.value  = 'easy';
  shuffleInput.checked   = true;

  typeSelect.value = '';
  renderTypeFields('');
  jsonInput.value = '';
  showStatus(jsonStatus, 'Formul√°rio limpo.', 'neutral');
  showStatus(saveStatus, 'Status: nenhuma opera√ß√£o ainda.', 'neutral');
});

// estado inicial
renderTypeFields('');
showStatus(jsonStatus, 'Aguardando a√ß√£o‚Ä¶', 'neutral');
showStatus(saveStatus, 'Status: nenhuma opera√ß√£o ainda.', 'neutral');
</script>
</body>
</html>
