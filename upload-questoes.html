<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hannah — Upload de Questões (QA)</title>
<style>
  :root{
    --bg:#0f172a; --card:#0b1120; --muted:#94a3b8; --text:#e2e8f0;
    --brand:#38bdf8; --brand2:#22c55e; --err:#f97373; --bd:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
    background:radial-gradient(circle at top,#1e293b,#020617);
    color:var(--text);
  }
  .wrap{
    max-width:1100px;
    margin:24px auto 40px auto;
    padding:0 16px;
  }
  h1{margin:0 0 4px;font-size:26px;font-weight:900}
  .sub{margin:0 0 18px;color:var(--muted);font-size:14px}
  .card{
    background:rgba(15,23,42,.96);
    border:1px solid #1f2937;
    border-radius:14px;
    padding:14px;
    margin-bottom:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.35);
  }
  label{display:block;font-size:13px;color:#cbd5e1;margin-bottom:4px}
  input[type="text"],input[type="number"],select,textarea{
    width:100%;
    background:#020617;
    border:1px solid #1f2937;
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    color:var(--text);
  }
  textarea{min-height:80px;resize:vertical;line-height:1.4}
  small{color:var(--muted);font-size:11px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 160px;min-width:150px}
  .badge{font-size:12px;color:var(--muted)}
  button{
    appearance:none;
    border:none;
    border-radius:999px;
    padding:9px 16px;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
  }
  button.primary{
    background:linear-gradient(90deg,#0ea5e9,#22c55e);
    color:white;
  }
  button.ghost{
    background:transparent;
    border:1px solid #1f2937;
    color:#e2e8f0;
  }
  button.warn{
    background:#7f1d1d;
    color:#fecaca;
    border:1px solid #b91c1c;
  }
  .mt-1{margin-top:4px}
  .mt-2{margin-top:8px}
  .mt-3{margin-top:12px}
  .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:900px){.grid-2{grid-template-columns:1.1fr 1.4fr}}
  .field-inline{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
  .field-inline > div{flex:1 1 120px}
  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid #1f2937;
    font-size:12px;
    color:#var(--muted);
  }
  .msg{margin-top:6px;font-size:13px}
  .msg.ok{color:#22c55e}
  .msg.err{color:#fb7185}
  .section-title{
    font-size:14px;
    font-weight:700;
    margin-bottom:6px;
    color:#e2e8f0;
  }
  .editor-block{
    border-radius:12px;
    border:1px solid #1f2937;
    padding:10px;
    margin-top:6px;
    background:#020617;
  }
  .editor-block h3{
    margin:0 0 6px;
    font-size:14px;
    color:#e5e7eb;
  }
  .editor-block .row{margin-top:6px}
  .chips-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
  .chip{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #1e293b;
    color:#9ca3af;
  }
  table{width:100%;border-collapse:collapse;margin-top:6px;font-size:13px}
  th,td{border:1px solid #1f2937;padding:4px 6px;text-align:left}
  th{background:#020617;color:#cbd5e1;font-weight:600}
  td.actions{text-align:center;width:70px}
  td input{width:100%}
  .tag-row{display:flex;gap:6px;flex-wrap:wrap}
  .tag-row input{flex:1 1 140px;min-width:110px}
  .json-view{
    background:#020617;
    border-radius:10px;
    border:1px solid #1f2937;
    padding:8px;
    font-family:ui-monospace,monospace;
    font-size:12px;
    max-height:240px;
    overflow:auto;
    white-space:pre;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Upload de Questões — QA</h1>
  <p class="sub">
    Monte a questão pelo formulário, visualize o JSON, faça <b>upload para o Firebase</b> e use
    <b>Preview</b> para ver como ela ficará no app.
  </p>

  <!-- 1. METADADOS DA QUESTÃO -->
  <div class="card">
    <div class="section-title">1) Metadados (onde esta questão vive?)</div>
    <div class="row">
      <div class="col">
        <label>Nível (Level)*</label>
        <input id="metaLevel" type="text" placeholder="Ex.: Level0" value="Level0">
        <small>Mesmo texto usado na URL (Level0, Level1…)</small>
      </div>
      <div class="col">
        <label>Unidade (Unit)*</label>
        <input id="metaUnit" type="text" placeholder="Ex.: Unit1" value="Unit1">
        <small>Mesmo texto usado na URL (Unit1, Unit2…)</small>
      </div>
      <div class="col">
        <label>Fase*</label>
        <input id="metaFase" type="text" placeholder="Ex.: 7 ou last ou end" value="1">
        <small>Mesma lógica de fase da URL (número, last, end)</small>
      </div>
    </div>

    <div class="row mt-2">
      <div class="col">
        <label>ID da questão (id)*</label>
        <input id="metaQid" type="text" placeholder="Ex.: q001">
        <small>Usar padrão q001, q002… (único dentro da fase).</small>
      </div>
      <div class="col">
        <label>Ordem na atividade (order)</label>
        <input id="metaOrder" type="number" min="1" step="1" value="1">
        <small>1, 2, 3… (apenas para organização).</small>
      </div>
      <div class="col">
        <label>Dificuldade</label>
        <select id="metaDifficulty">
          <option value="easy">easy</option>
          <option value="medium" selected>medium</option>
          <option value="hard">hard</option>
        </select>
        <small>Opcional, só para análise.</small>
      </div>
    </div>

    <div class="mt-2">
      <label>Rótulos pedagógicos (tags)</label>
      <div class="tag-row">
        <input id="metaTagGrammar" type="text" placeholder="grammar: ex. verb to be">
        <input id="metaTagVocab" type="text" placeholder="vocabulary: ex. family, colors">
        <input id="metaTagSkill" type="text" placeholder="skill: ex. listening, reading">
      </div>
      <small>Servem para filtrar depois: revisão por gramática, vocabulário, etc.</small>
    </div>
  </div>

  <!-- 2. TIPO DA QUESTÃO -->
  <div class="card">
    <div class="section-title">2) Tipo da questão</div>
    <div class="row">
      <div class="col">
        <label>Tipo*</label>
        <select id="qType">
          <option value="choice">Choice (MCQ texto)</option>
          <option value="yesno">Yes / No</option>
          <option value="truefalse">True / False</option>
          <option value="picture">Picture (MCQ + imagem)</option>
          <option value="audiochoice">Audio (MCQ + áudio)</option>
          <option value="fillblank">Fill in the Blanks</option>
          <option value="order">Order (montar frase)</option>
          <option value="match">Match (correspondência)</option>
        </select>
      </div>
      <div class="col">
        <label>Embaralhar opções?</label>
        <select id="qShuffle">
          <option value="true" selected>Sim (default)</option>
          <option value="false">Não</option>
        </select>
      </div>
      <div class="col">
        <label>Base de mídia (apenas referência visual)</label>
        <input id="qMediaBase" type="text" placeholder="../../LevelX/UnitY/QA/">
        <small>O caminho real das imagens/sons continua no projeto.</small>
      </div>
    </div>
    <div class="chips-row mt-1">
      <span class="chip">choice / yesno / truefalse → múltipla escolha texto</span>
      <span class="chip">picture → opções com imagem</span>
      <span class="chip">audiochoice → opções com áudio</span>
      <span class="chip">fillblank → lacuna(s) no enunciado</span>
      <span class="chip">order → montar frase na ordem certa</span>
      <span class="chip">match → pares (palavra ↔ imagem / palavra)</span>
    </div>
  </div>

  <!-- 3. EDITOR DA QUESTÃO -->
  <div class="card">
    <div class="section-title">3) Conteúdo da questão</div>
    <div class="grid-2">
      <!-- COLUNA ESQUERDA: ENUNCIADO/MÍDIA -->
      <div>
        <div class="editor-block">
          <h3>3.1) Enunciado e mídia</h3>
          <label>Prompt (enunciado em inglês)*</label>
          <textarea id="qPrompt" placeholder="Ex.: What is Sarah doing?"></textarea>
          <small>Use {blank} ou {b1}, {b2} etc. no caso de Fill in the Blanks.</small>

          <div class="mt-2">
            <label>Texto para TTS da pergunta (opcional)</label>
            <textarea id="qTts" placeholder="Se vazio, o app usa o próprio prompt."></textarea>
          </div>

          <div class="mt-2 field-inline">
            <div>
              <label>Imagem principal (prompt image)</label>
              <input id="qImage" type="text" placeholder="Ex.: images/imagem1.png">
            </div>
            <div>
              <label>Áudio da pergunta (promptAudio)</label>
              <input id="qPromptAudio" type="text" placeholder="Ex.: sounds/pergunta1.mp3">
            </div>
          </div>
        </div>

        <!-- FILLBLANK EXTRA -->
        <div class="editor-block mt-2" id="blockFill" style="display:none">
          <h3>3.2) Respostas do Fill in the Blanks</h3>
          <label>Resposta(s) esperada(s)</label>
          <textarea id="fbAnswers" placeholder="Se for 1 lacuna: escreva apenas a resposta (ex.: playing).
Se forem várias lacunas com {b1}, {b2}, {b3}:
linha 1 → resposta do {b1}
linha 2 → resposta do {b2}
..."></textarea>
          <small>O preview vai transformar internamente em <code>answer</code> adequado.</small>
        </div>

        <!-- ORDER EXTRA -->
        <div class="editor-block mt-2" id="blockOrder" style="display:none">
          <h3>3.3) Palavras/fragmentos para Order</h3>
          <label>Palavras/fragmentos (uma por linha, na ORDEM CORRETA)</label>
          <textarea id="ordWords" placeholder="Ex.:
She
is
playing
the
guitar"></textarea>
          <small>O app embaralha automaticamente se "embaralhar" estiver ligado.</small>
        </div>
      </div>

      <!-- COLUNA DIREITA: OPÇÕES / PARES -->
      <div>
        <!-- MCQ / YESNO / TRUEFALSE / PICTURE / AUDIOCHOICE -->
        <div class="editor-block" id="blockOptions">
          <h3>3.2) Opções (para múltipla escolha)</h3>
          <div class="field-inline mt-1">
            <div>
              <label>Opções pré-definidas</label>
              <select id="presetOpts">
                <option value="">-- Nenhum preset --</option>
                <option value="yesno">YES / NO</option>
                <option value="truefalse">TRUE / FALSE</option>
              </select>
              <small>Útil para yesno / truefalse.</small>
            </div>
            <div>
              <button id="btnAddOption" class="ghost" type="button">+ Adicionar opção</button>
            </div>
          </div>
          <table id="tblOptions">
            <thead>
              <tr>
                <th>Label</th>
                <th>Value</th>
                <th>Img</th>
                <th>Áudio</th>
                <th>Correta?</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <small>Em picture, preencha "Img". Em audiochoice, preencha "Áudio".</small>
        </div>

        <!-- MATCH -->
        <div class="editor-block mt-2" id="blockMatch" style="display:none">
          <h3>3.3) Pares para Match</h3>
          <button id="btnAddPair" class="ghost" type="button">+ Adicionar par</button>
          <table id="tblPairs">
            <thead>
              <tr>
                <th>Left (label)</th>
                <th>Right (label ou img)</th>
                <th>Right Img</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <small>Cada linha vira: { left:{label}, right:{label/image} }.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- 4. JSON GERADO + AÇÕES -->
  <div class="card">
    <div class="section-title">4) JSON gerado + ações</div>
    <div class="row">
      <div class="col">
        <button id="btnBuild" class="primary" type="button">Gerar JSON (preencher abaixo)</button>
      </div>
      <div class="col">
        <button id="btnPreview" class="ghost" type="button">Preview (abrir qa-preview.html)</button>
      </div>
      <div class="col">
        <button id="btnUpload" class="ghost" type="button">Salvar no Firebase</button>
      </div>
    </div>
    <div class="mt-1">
      <span class="pill" id="pillInfo">Nenhum JSON gerado ainda.</span>
    </div>
    <div class="mt-2 json-view" id="jsonView">{}</div>
    <div id="msg" class="msg"></div>
  </div>
</div>

<!-- Firebase SDK v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* =========================
   Firebase init (v8)
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
  authDomain: "hannahenglishcourse.firebaseapp.com",
  databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "hannahenglishcourse",
  storageBucket: "hannahenglishcourse.appspot.com",
  messagingSenderId: "449818788486",
  appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
};
firebase.initializeApp(firebaseConfig);
</script>

<script>
(function(){
  const $ = id => document.getElementById(id);

  // Metadados
  const metaLevel      = $('metaLevel');
  const metaUnit       = $('metaUnit');
  const metaFase       = $('metaFase');
  const metaQid        = $('metaQid');
  const metaOrder      = $('metaOrder');
  const metaDifficulty = $('metaDifficulty');
  const metaTagGrammar = $('metaTagGrammar');
  const metaTagVocab   = $('metaTagVocab');
  const metaTagSkill   = $('metaTagSkill');

  // Tipo / config
  const qType      = $('qType');
  const qShuffle   = $('qShuffle');
  const qMediaBase = $('qMediaBase');

  // Enunciado / mídia
  const qPrompt      = $('qPrompt');
  const qTts         = $('qTts');
  const qImage       = $('qImage');
  const qPromptAudio = $('qPromptAudio');

  // Extras
  const blockFill   = $('blockFill');
  const fbAnswers   = $('fbAnswers');
  const blockOrder  = $('blockOrder');
  const ordWords    = $('ordWords');
  const blockMatch  = $('blockMatch');
  const blockOptions= $('blockOptions');

  // Options (MCQ)
  const btnAddOption = $('btnAddOption');
  const presetOpts   = $('presetOpts');
  const tblOptions   = $('tblOptions').querySelector('tbody');

  // Match
  const btnAddPair   = $('btnAddPair');
  const tblPairs     = $('tblPairs').querySelector('tbody');

  // JSON + ações
  const btnBuild   = $('btnBuild');
  const btnPreview = $('btnPreview');
  const btnUpload  = $('btnUpload');
  const jsonView   = $('jsonView');
  const msgEl      = $('msg');
  const pillInfo   = $('pillInfo');

  /* ========= Helpers ========= */
  function toast(msg, ok=false){
    msgEl.textContent = msg || '';
    msgEl.className = 'msg ' + (ok ? 'ok' : 'err');
  }
  function clearMsg(){
    msgEl.textContent = '';
    msgEl.className = 'msg';
  }
  function norm(v){ return String(v||'').trim(); }

  /* ========= Mostrar/ocultar blocos por tipo ========= */
  function updateTypeUI(){
    const t = qType.value;
    blockFill.style.display   = (t === 'fillblank') ? 'block' : 'none';
    blockOrder.style.display  = (t === 'order') ? 'block' : 'none';
    blockMatch.style.display  = (t === 'match') ? 'block' : 'none';

    // Options aparecem para todos exceto match
    if (t === 'match'){
      blockOptions.style.display = 'none';
    } else {
      blockOptions.style.display = 'block';
    }
  }
  qType.addEventListener('change', updateTypeUI);
  updateTypeUI();

  /* ========= OPTIONS: CRUD ========= */
  function addOptionRow(data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" data-field="label"  value="${data?.label || ''}"></td>
      <td><input type="text" data-field="value"  value="${data?.value || ''}"></td>
      <td><input type="text" data-field="image"  value="${data?.image || ''}"></td>
      <td><input type="text" data-field="audio"  value="${data?.audio || ''}"></td>
      <td style="text-align:center">
        <input type="radio" name="optCorrect" ${data?.correct ? 'checked' : ''}>
      </td>
      <td class="actions">
        <button type="button" class="ghost btnDelOpt">X</button>
      </td>
    `;
    tblOptions.appendChild(tr);
  }

  btnAddOption.addEventListener('click', () => {
    addOptionRow({});
  });

  presetOpts.addEventListener('change', () => {
    const val = presetOpts.value;
    if (!val) return;
    tblOptions.innerHTML = '';
    if (val === 'yesno'){
      addOptionRow({label:'YES', value:'yes', correct:true});
      addOptionRow({label:'NO',  value:'no'});
    } else if (val === 'truefalse'){
      addOptionRow({label:'TRUE',  value:'true', correct:true});
      addOptionRow({label:'FALSE', value:'false'});
    }
  });

  tblOptions.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btnDelOpt');
    if (!btn) return;
    const tr = btn.closest('tr');
    if (tr) tr.remove();
  });

  function readOptions(){
    const rows = Array.from(tblOptions.querySelectorAll('tr'));
    const out = [];
    let correctIndex = -1;

    rows.forEach((tr, idx)=>{
      const inputs = tr.querySelectorAll('input[type="text"]');
      const label = norm(inputs[0]?.value);
      const value = norm(inputs[1]?.value);
      const image = norm(inputs[2]?.value);
      const audio = norm(inputs[3]?.value);
      const radio = tr.querySelector('input[type="radio"]');
      const isCorrect = radio && radio.checked;

      if (!label && !value && !image && !audio) return;

      const opt = {};
      if (label) opt.label = label;
      if (value) opt.value = value;
      if (image) opt.image = image;
      if (audio) opt.audio = audio;
      out.push(opt);
      if (isCorrect) correctIndex = out.length - 1;
    });

    return { options: out, correctIndex };
  }

  /* ========= MATCH: CRUD ========= */
  function addPairRow(data){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" data-field="leftLabel"  value="${data?.leftLabel || ''}"></td>
      <td><input type="text" data-field="rightLabel" value="${data?.rightLabel || ''}"></td>
      <td><input type="text" data-field="rightImg"   value="${data?.rightImg || ''}"></td>
      <td class="actions"><button type="button" class="ghost btnDelPair">X</button></td>
    `;
    tblPairs.appendChild(tr);
  }

  btnAddPair.addEventListener('click', () => {
    addPairRow({});
  });

  tblPairs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btnDelPair');
    if (!btn) return;
    const tr = btn.closest('tr');
    if (tr) tr.remove();
  });

  function readPairs(){
    const rows = Array.from(tblPairs.querySelectorAll('tr'));
    const pairs = [];
    rows.forEach(tr => {
      const leftLabel  = norm(tr.querySelector('input[data-field="leftLabel"]')?.value);
      const rightLabel = norm(tr.querySelector('input[data-field="rightLabel"]')?.value);
      const rightImg   = norm(tr.querySelector('input[data-field="rightImg"]')?.value);
      if (!leftLabel && !rightLabel && !rightImg) return;

      const pair = {
        left: { label: leftLabel || rightLabel || 'Left' },
        right: {}
      };
      if (rightImg){
        pair.right.image = rightImg;
      }
      if (rightLabel){
        pair.right.label = rightLabel;
      }
      pairs.push(pair);
    });
    return pairs;
  }

  /* ========= BUILD QUESTION JSON ========= */
  function buildQuestionObject(){
    clearMsg();

    const level = norm(metaLevel.value);
    const unit  = norm(metaUnit.value);
    const fase  = norm(metaFase.value);
    const qid   = norm(metaQid.value);

    if(!level || !unit || !fase || !qid){
      toast('Preencha Level, Unit, Fase e ID da questão (q001, q002…).');
      return null;
    }
    if(!norm(qPrompt.value)){
      toast('O prompt (enunciado) é obrigatório.');
      return null;
    }

    const t = qType.value;
    const baseQuestion = {
      id: qid,
      type: t,
      prompt: qPrompt.value,
    };

    const img = norm(qImage.value);
    const pAudio = norm(qPromptAudio.value);
    const tts = norm(qTts.value);
    if (img) baseQuestion.image = img;
    if (pAudio) baseQuestion.promptAudio = pAudio;
    if (tts) baseQuestion.tts = tts;

    const shuffle = (qShuffle.value === 'true');
    if (shuffle === false) baseQuestion.shuffleOptions = false;

    if (t === 'fillblank'){
      const linesRaw = norm(fbAnswers.value);
      const lines = linesRaw
        ? linesRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
        : [];
      if (!lines.length){
        toast('Para Fill in the Blanks, preencha ao menos uma resposta em "Respostas esperadas".');
        return null;
      }
      if (lines.length === 1){
        baseQuestion.answer = lines[0];
      } else {
        const obj = {};
        lines.forEach((ans, i) => {
          obj['b'+(i+1)] = ans;
        });
        baseQuestion.answer = obj;
      }
    } else if (t === 'order'){
      const wordsRaw = norm(ordWords.value);
      const words = wordsRaw
        ? wordsRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
        : [];
      if (!words.length){
        toast('Para Order, preencha as palavras/fragmentos (uma por linha).');
        return null;
      }
      baseQuestion.options = words;
      baseQuestion.answer  = words.slice();
    } else if (t === 'match'){
      const pairs = readPairs();
      if (!pairs.length){
        toast('Para Match, adicione ao menos 1 par.');
        return null;
      }
      baseQuestion.pairs = pairs;
    } else {
      // MCQ family
      const { options, correctIndex } = readOptions();
      if (!options.length){
        toast('Adicione ao menos 2 opções para múltipla escolha.');
        return null;
      }
      if (correctIndex < 0){
        toast('Marque uma opção como correta.');
        return null;
      }
      baseQuestion.options = options;

      const ansOpt = options[correctIndex];
      const ansVal = norm(ansOpt.value || ansOpt.label);
      if (!ansVal){
        toast('A opção correta precisa ter value ou label preenchido.');
        return null;
      }
      baseQuestion.answer = ansVal;
    }

    // Metadados pedagógicos
    const meta = {
      level,
      unit,
      fase,
      questionId: qid,
      order: Number(metaOrder.value || 1),
      difficulty: metaDifficulty.value || 'medium',
      tags: {
        grammar: norm(metaTagGrammar.value),
        vocabulary: norm(metaTagVocab.value),
        skill: norm(metaTagSkill.value)
      }
    };

    const payload = { meta, question: baseQuestion };

    return payload;
  }

  /* ========= BOTÃO: GERAR JSON ========= */
  btnBuild.addEventListener('click', ()=>{
    const payload = buildQuestionObject();
    if (!payload) return;
    jsonView.textContent = JSON.stringify(payload, null, 2);
    pillInfo.textContent =
      `JSON gerado para ${payload.meta.level} / ${payload.meta.unit} / fase ${payload.meta.fase} / ${payload.meta.questionId}`;
    toast('JSON gerado com sucesso. Você pode enviar ao Firebase ou usar Preview.', true);
  });

  /* ========= BOTÃO: PREVIEW =========
     - Gera payload
     - Salva em localStorage com a chave esperada pelo qa-preview.html
       (hannahQA_preview)
     - Abre qa-preview.html em nova aba
  ==================================== */
  btnPreview.addEventListener('click', ()=>{
    const payload = buildQuestionObject();
    if (!payload) return;

    try{
      // >>> chave alinhada com qa-preview.html <<<
      localStorage.setItem('hannahQA_preview', JSON.stringify(payload));
    }catch(e){
      console.error('Erro ao salvar no localStorage:', e);
      toast('Não foi possível salvar no localStorage para o Preview.', false);
      return;
    }

    toast('Preview salvo (hannahQA_preview). Abrindo qa-preview.html...', true);

    // Ajuste o caminho abaixo se o qa-preview.html estiver em outra pasta
    window.open('qa-preview.html', '_blank');
  });

  /* ========= BOTÃO: UPLOAD PARA FIREBASE ========= */
  btnUpload.addEventListener('click', ()=>{
    const payload = buildQuestionObject();
    if (!payload) return;

    const { meta, question } = payload;
    const path = `questoes/${meta.level}/${meta.unit}/${meta.fase}/${meta.questionId}`;
    const ref  = firebase.database().ref(path);

    ref.set({
      meta,
      question
    }).then(()=>{
      toast(`Questão salva em: ${path}`, true);
    }).catch(err=>{
      console.error(err);
      toast('Erro ao salvar no Firebase: ' + err.message);
    });
  });

})();
</script>
</body>
</html>
