<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hannah Questions ‚Äì Admin Uploader</title>
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --brand:#2563eb; --brand-soft:#dbeafe; --danger:#ef4444; --ok:#16a34a;
    --radius:16px; --shadow:0 10px 25px rgba(15,23,42,.12);
  }
  *{box-sizing:border-box;}
  html,body{margin:0;padding:0;}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
    background:linear-gradient(135deg,#eff6ff,#fef9c3);
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:16px;
    color:var(--text);
  }
  .app{
    width:100%;
    max-width:960px;
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px 18px 22px;
  }
  .header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:16px;
  }
  .title{
    font-size:20px;
    font-weight:800;
  }
  .subtitle{
    font-size:13px;
    color:var(--muted);
    margin-top:2px;
  }
  .badge{
    background:var(--brand-soft);
    color:var(--brand);
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }

  form{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:14px 16px;
  }
  .field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .field.full{
    grid-column:1/-1;
  }
  label{
    font-size:13px;
    font-weight:600;
    color:var(--muted);
  }
  input,select,textarea{
    border-radius:10px;
    border:1px solid #e5e7eb;
    padding:8px 10px;
    font-size:14px;
    font-family:inherit;
    resize:vertical;
  }
  textarea{
    min-height:180px;
    line-height:1.4;
  }
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 1px rgba(37,99,235,.3);
  }
  .hint{
    font-size:11px;
    color:var(--muted);
  }

  .buttons{
    grid-column:1/-1;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-top:4px;
  }
  button{
    border:none;
    border-radius:999px;
    padding:8px 14px;
    font-size:14px;
    font-weight:700;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  .btn-secondary{
    background:#e5e7eb;
    color:#111827;
  }
  .btn-primary{
    background:linear-gradient(90deg,#3b82f6,#22c55e);
    color:#fff;
    box-shadow:0 8px 16px rgba(34,197,94,.25);
  }
  .btn-primary[disabled]{
    opacity:.5;
    cursor:default;
    box-shadow:none;
  }

  .status{
    margin-top:12px;
    font-size:13px;
    color:var(--muted);
  }
  .status b{color:#111827;}

  .pill-ok{
    display:inline-block;
    margin-top:4px;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    background:#dcfce7;
    color:#166534;
  }
  .pill-err{
    display:inline-block;
    margin-top:4px;
    padding:4px 8px;
    border-radius:999px;
    font-size:11px;
    background:#fee2e2;
    color:#b91c1c;
  }

  .toast{
    position:fixed;
    left:50%;
    bottom:20px;
    transform:translateX(-50%);
    background:#111827;
    color:#f9fafb;
    padding:10px 14px;
    border-radius:12px;
    font-size:13px;
    box-shadow:var(--shadow);
    z-index:9999;
  }

  .loading-overlay{
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9998;
    backdrop-filter:blur(2px);
  }
  .spinner{
    width:38px;height:38px;
    border-radius:50%;
    border:4px solid #bfdbfe;
    border-top-color:#2563eb;
    animation:spin 1s linear infinite;
    margin-right:10px;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading-box{
    display:flex;
    align-items:center;
    background:#111827;
    color:#e5e7eb;
    padding:10px 16px;
    border-radius:999px;
    box-shadow:var(--shadow);
    font-size:13px;
  }

  @media(max-width:720px){
    .app{padding:14px 10px 18px;}
    form{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div>
      <div class="title">Hannah Questions ‚Äì Admin</div>
      <div class="subtitle">
        Crie/atualize quest√µes e vincule √† atividade (Level / Unit / Fase).
      </div>
    </div>
    <div class="badge">Owner Dashboard</div>
  </div>

  <form id="q-form">
    <div class="field">
      <label for="level">Level</label>
      <input id="level" type="text" placeholder="Ex.: Level0" required />
      <div class="hint">Se digitar s√≥ ‚Äú0‚Äù, o sistema transforma em ‚ÄúLevel0‚Äù.</div>
    </div>

    <div class="field">
      <label for="unit">Unit</label>
      <input id="unit" type="text" placeholder="Ex.: Unit1" required />
      <div class="hint">Se digitar s√≥ ‚Äú1‚Äù, o sistema transforma em ‚ÄúUnit1‚Äù.</div>
    </div>

    <div class="field">
      <label for="fase">Fase</label>
      <input id="fase" type="number" min="1" step="1" placeholder="Ex.: 7" required />
      <div class="hint">N√∫mero da fase (ex.: 7).</div>
    </div>

    <div class="field">
      <label for="questionId">Question ID (opcional)</label>
      <input id="questionId" type="text" placeholder="Ex.: L0_U1_F7_Q01" />
      <div class="hint">Se vazio, ser√° gerado automaticamente (Q_timestamp).</div>
    </div>

    <div class="field">
      <label for="order">Ordem na atividade</label>
      <input id="order" type="number" min="1" step="1" placeholder="Ex.: 1" />
      <div class="hint">1 = primeira quest√£o; se vazio, ser√° adicionada ao final.</div>
    </div>

    <div class="field">
      <label for="typeQuick">Tipo (r√≥tulo r√°pido)</label>
      <select id="typeQuick">
        <option value="">‚Äî n√£o for√ßar ‚Äî</option>
        <option value="mcq">MCQ (m√∫ltipla escolha)</option>
        <option value="yesno">Yes/No (MCQ especial)</option>
        <option value="fillblank">Fill in the blank</option>
        <option value="order">Order sentence</option>
        <option value="match">Match pairs</option>
      </select>
      <div class="hint">S√≥ preenche o campo type dentro do JSON se voc√™ quiser.</div>
    </div>

    <div class="field full">
      <label for="json">Objeto da quest√£o (JSON)</label>
      <textarea id="json" spellcheck="false"></textarea>
      <div class="hint">
        Cole/edite aqui um objeto JSON com os campos da quest√£o.<br>
        Exemplo b√°sico para MCQ:
        <code>
{"type":"mcq","prompt":"What is this?","image":"images/apple.png","options":[{"label":"Apple","value":"apple"},{"label":"Banana","value":"banana"}],"answer":"apple","grammarTag":"vocabulary-fruits","skillType":"vocabulary","difficulty":"easy"}
        </code>
      </div>
    </div>

    <div class="buttons">
      <button type="button" class="btn-secondary" id="btnTemplateMcq">MCQ template</button>
      <button type="button" class="btn-secondary" id="btnTemplateFill">Fillblank template</button>
      <button type="submit" class="btn-primary" id="btnSave">
        üíæ Salvar quest√£o
      </button>
    </div>
  </form>

  <div class="status" id="status">
    <b>Status:</b> aguardando dados‚Ä¶
  </div>
</div>

<div class="loading-overlay" id="loading">
  <div class="loading-box">
    <div class="spinner"></div>
    <span>Salvando no Firebase‚Ä¶</span>
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // ==== Firebase init (mesma config do app) ====
  const firebaseConfig = {
    apiKey: "AIzaSyDGgo2H_hDKXF88xN7XnLFNUj8ikMY7Xdc",
    authDomain: "hannahenglishcourse.firebaseapp.com",
    databaseURL: "https://hannahenglishcourse-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "hannahenglishcourse",
    storageBucket: "hannahenglishcourse.appspot.com",
    messagingSenderId: "449818788486",
    appId: "1:449818788486:web:8a49d3f68591e6fb3f0707"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  let currentUserId = null;
  firebase.auth().onAuthStateChanged(user => {
    currentUserId = user ? user.uid : null;
    const st = document.getElementById('status');
    if (!user) {
      st.innerHTML = "<b>Status:</b> usu√°rio n√£o autenticado. Fa√ßa login em outra aba.";
    } else {
      st.innerHTML = "<b>Status:</b> autenticado como: " + (user.email || user.uid);
    }
  });

  // ==== helpers ====
  function normalizeDir(prefix, value, fallbackNum){
    if (!value) return prefix + fallbackNum;
    const lower = String(value).toLowerCase().trim();
    if (lower.startsWith(prefix.toLowerCase())) return value.trim();
    const onlyNum = (lower.match(/\d+/)||[''])[0];
    return prefix + (onlyNum || fallbackNum);
  }

  function showToast(msg){
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2600);
  }

  function setStatus(html){
    const st = document.getElementById('status');
    st.innerHTML = html;
  }

  function showLoading(flag){
    const el = document.getElementById('loading');
    if (!el) return;
    el.style.display = flag ? 'flex' : 'none';
    document.getElementById('btnSave').disabled = !!flag;
  }

  // ==== Templates r√°pidos para JSON ====
  const txtJson = document.getElementById('json');
  document.getElementById('btnTemplateMcq').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "mcq",
      prompt: "What is this?",
      image: "images/example.png",
      options: [
        { label: "Apple",  value: "apple" },
        { label: "Banana", value: "banana" },
        { label: "Orange", value: "orange" },
        { label: "Grape",  value: "grape" }
      ],
      answer: "apple",
      grammarTag: "vocabulary-fruits",
      skillType: "vocabulary",
      difficulty: "easy"
    }, null, 2);
  };

  document.getElementById('btnTemplateFill').onclick = () => {
    txtJson.value = JSON.stringify({
      type: "fillblank",
      prompt: "Jesus was born in {blank}.",
      image: "images/bethlehem.png",
      options: [
        { label: "Nazareth",  value: "Nazareth" },
        { label: "Bethlehem", value: "Bethlehem" }
      ],
      answer: "Bethlehem",
      grammarTag: "vocabulary-places",
      skillType: "reading",
      difficulty: "medium"
    }, null, 2);
  };

  // ==== Salvando quest√£o + activity ====
  document.getElementById('q-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!currentUserId) {
      showToast("Voc√™ n√£o est√° autenticado. Fa√ßa login primeiro.");
      setStatus("<b>Status:</b> n√£o autenticado.");
      return;
    }

    const levelRaw = document.getElementById('level').value.trim();
    const unitRaw  = document.getElementById('unit').value.trim();
    const faseRaw  = document.getElementById('fase').value.trim();
    let   qId      = document.getElementById('questionId').value.trim();
    const orderRaw = document.getElementById('order').value.trim();
    const typeQuick= document.getElementById('typeQuick').value;
    const jsonStr  = txtJson.value.trim();

    if (!levelRaw || !unitRaw || !faseRaw || !jsonStr) {
      showToast("Preencha Level, Unit, Fase e o JSON da quest√£o.");
      return;
    }

    const levelKey = normalizeDir("Level", levelRaw, "0");
    const unitKey  = normalizeDir("Unit",  unitRaw,  "1");
    const faseKey  = String(parseInt(faseRaw, 10) || 1);
    const activityKey = `${levelKey}_${unitKey}_Fase${faseKey}`;

    if (!qId) {
      qId = `Q_${Date.now()}`;
    }

    let orderNum = null;
    if (orderRaw) {
      const n = parseInt(orderRaw, 10);
      if (!isNaN(n) && n > 0) orderNum = n;
    }

    let obj;
    try {
      obj = JSON.parse(jsonStr);
    } catch (err) {
      console.error("JSON inv√°lido:", err);
      showToast("Erro: JSON inv√°lido. Verifique a sintaxe.");
      setStatus("<b>Status:</b> erro ao fazer parse do JSON (veja console).<span class='pill-err'>JSON inv√°lido</span>");
      return;
    }

    // For√ßa alguns metadados importantes
    obj.id    = qId;
    obj.level = obj.level || levelKey;
    obj.unit  = obj.unit  || unitKey;
    obj.fase  = obj.fase  || faseKey;
    if (orderNum != null) {
      obj.order = orderNum;
    } else if (obj.order == null) {
      obj.order = null;
    }

    if (typeQuick && !obj.type) {
      obj.type = typeQuick;
    }

    showLoading(true);
    setStatus("<b>Status:</b> salvando quest√£o em <code>questions/"+qId+"</code>‚Ä¶");

    try {
      // 1) salva em questions/{qId}
      await firebase.database().ref("questions/"+qId).set(obj);

      // 2) atualiza activities/{activityKey}/questionIds
      const actRef = firebase.database().ref("activities/"+activityKey);
      const snap = await actRef.once("value");
      const act  = snap.val() || {};
      let ids    = Array.isArray(act.questionIds) ? act.questionIds.slice() : [];

      if (!ids.includes(qId)) {
        if (orderNum != null) {
          // insere na posi√ß√£o (order-1), limitado ao tamanho
          const idx = Math.max(0, Math.min(orderNum - 1, ids.length));
          ids.splice(idx, 0, qId);
        } else {
          ids.push(qId);
        }
      }

      act.level      = act.level      || levelKey;
      act.unit       = act.unit       || unitKey;
      act.fase       = act.fase       || faseKey;
      act.questionIds= ids;

      await actRef.set(act);

      showToast("Quest√£o salva com sucesso!");
      setStatus(
        "<b>Status:</b> salvo com sucesso.<br>" +
        "questions/<code>" + qId + "</code><br>" +
        "activities/<code>" + activityKey + "</code> " +
        "<span class='pill-ok'>OK</span>"
      );
    } catch (err) {
      console.error("Erro ao salvar no Firebase:", err);
      showToast("Erro ao salvar no Firebase. Veja o console.");
      setStatus("<b>Status:</b> erro ao salvar no Firebase.<span class='pill-err'>Erro</span>");
    } finally {
      showLoading(false);
    }
  });
</script>
</body>
</html>
